<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="诗和田野" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="诗和田野">
<meta property="og:url" content="http://chucz.club/page/3/index.html">
<meta property="og:site_name" content="诗和田野">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="诗和田野">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://chucz.club/page/3/"/>





  <title>诗和田野</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">诗和田野</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">生活不苟且</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/首页" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/标签/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/分类/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/归档/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/05/20/ELK-Sentinl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/20/ELK-Sentinl/" itemprop="url">ELK Sentinl</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-21T02:14:12+08:00">
                2018-05-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Sentinl简介"><a href="#Sentinl简介" class="headerlink" title="Sentinl简介"></a><a href="#Sentinl简介" title="Sentinl简介"></a>Sentinl简介</h3><p>Sentinl 5扩展自Kibi / Kibana 5，具有警报和报告功能，可使用标准查询，可编程验证器和各种可配置操作来监控，通知和报告数据系列更改 - 将其视为一个独立的“观察者” “报告”功能（PNG / PDFs快照）。</p>
<p>SENTINEL还旨在通过直接在Kibana UI中整合来简化在Kibi / Kibana中创建和管理警报和报告的过程。</p>
<h3 id="功能模块"><a href="#功能模块" class="headerlink" title="功能模块"></a><a href="#功能模块" title="功能模块"></a>功能模块</h3><p>Watchers<br>Alarms<br>Reports<br>Watchers是Sentinl核心，主要由 input,Condition,Transform,Actions几大块组成，可以和X-Pack一一对应，部分文档可参考X-Pack，但需要注意的是它和X-Pack还有一些区别，主要体现在input只实现了search，其他并未实现，Actions也并未都实现</p>
<h3 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a><a href="#安装与配置" title="安装与配置"></a>安装与配置</h3><ul>
<li>安装</li>
</ul>
<p>/usr/share/kibana/bin/kibana-plugin install <a href="https://github.com/sirensolutions/sentinl/releases/download/tag-5.5/sentinl-v5.6.5.zip" target="_blank" rel="noopener">https://github.com/sirensolutions/sentinl/releases/download/tag-5.5/sentinl-v5.6.5.zip</a></p>
<ul>
<li>config</li>
</ul>
<p>kibana.yml config:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sentinl:</span></span><br><span class="line"><span class="attr">  es:</span></span><br><span class="line"><span class="attr">    timefield:</span> <span class="string">‘@timestamp’</span></span><br><span class="line"><span class="attr">    default_index:</span> <span class="string">watcher</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">    alarm_index:</span> <span class="string">watcher_alarms</span></span><br><span class="line"><span class="attr">  sentinl:</span></span><br><span class="line"><span class="attr">    history:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">    results:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">  settings:</span></span><br><span class="line"><span class="attr">    email:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">username</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">password</span></span><br><span class="line"><span class="attr">      host:</span> <span class="string">smtp.server.com</span></span><br><span class="line"><span class="attr">      ssl:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">10000</span>  <span class="comment"># mail server connection timeout</span></span><br><span class="line"><span class="attr">    slack:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">username</span></span><br><span class="line"><span class="attr">      hook:</span> <span class="string">‘<a href="https://hooks.slack.com/services/&lt;token&gt;&#39;" target="_blank" rel="noopener">https://hooks.slack.com/services/&lt;token&gt;&#39;</a></span></span><br><span class="line"><span class="attr">      channel:</span> <span class="string">‘#channel’</span></span><br><span class="line"><span class="attr">    report:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      tmp_path:</span> <span class="string">/tmp/</span></span><br><span class="line"><span class="attr">    pushapps:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      api_key:</span> <span class="string">‘&lt;pushapps API Key&gt;’</span></span><br></pre></td></tr></table></figure>

<ul>
<li>raw<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">“input”</span>: &#123;</span><br><span class="line">      <span class="string">“search”</span>: &#123;</span><br><span class="line">        <span class="string">“request”</span>: &#123;</span><br><span class="line">          <span class="string">“index”</span>: [</span><br><span class="line">            <span class="string">“&lt;xxx-&#123;now/d&#125;&gt;”</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">“body”</span>: &#123;</span><br><span class="line">            <span class="string">“query”</span>: &#123;</span><br><span class="line">              <span class="string">“bool”</span>: &#123;</span><br><span class="line">                <span class="string">“should”</span>: [</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="string">“match”</span>: &#123;</span><br><span class="line">                      <span class="string">“status”</span>: <span class="string">“502”</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="string">“match”</span>: &#123;</span><br><span class="line">                      <span class="string">“status”</span>: <span class="string">“404”</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">“minimum_should_match”</span>: <span class="number">1</span>,  #must setup</span><br><span class="line">                <span class="string">“filter”</span>: &#123;</span><br><span class="line">                  <span class="string">“range”</span>: &#123;</span><br><span class="line">                    <span class="string">“@timestamp”</span>: &#123;</span><br><span class="line">                      <span class="string">“gte”</span>: <span class="string">“now-60s”</span>,</span><br><span class="line">                      <span class="string">“lte”</span>: <span class="string">“now”</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">“condition”</span>: &#123;</span><br><span class="line">      <span class="string">“script”</span>: &#123;</span><br><span class="line">        <span class="string">“script”</span>: <span class="string">“payload.hits.total &gt; 30”</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/05/20/端口扫描器的几种代码实现方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/20/端口扫描器的几种代码实现方案/" itemprop="url">端口扫描器的几种代码实现方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-21T02:13:36+08:00">
                2018-05-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>这雨夜太漫长 失眠的我 在谁梦里 歌唱<br>　　搞安全的应该都知道端口扫描在渗透测试、漏洞扫描过程中的重要性，其与URL爬虫等技术构成了漏洞扫描的第一阶段，即目标信息收集。因此能否开发出一款高效稳定的端口扫描器，往往决定了漏洞扫描器的好坏。那么说到端口扫描器，我们往往会先想到nmap、masscan等神器，它们是这个领域的标杆。但本篇并不是为了介绍这几款工具，而是谈谈如何自研一款高效稳定的端口扫描器。<br><a id="more"></a><br>　　端口扫描器，顾名思义就是为了探测服务器上的某个端口是否开放，究其原理可以分为很多种探测方式，比如tcp三次握手扫描，syn扫描等等，本篇并不打算详细介绍这些扫描方式的区别，有兴趣的可以看下nmap的文档，对这几种扫描方式有详细的介绍。<br>　　那么说下本文重点，基于这几天我研究并尝试利用python、go开发tcp扫描器、tcp-syn扫描器，以及对比它们之间的速度性能、稳定性差异情况，将测试结果在此做个记录，并分享一下代码以及方案。</p>
</blockquote>
<p>说明：文章结尾将给出本篇所使用代码的Github地址，可供大家测试，代码测试环境为centos7。</p>
<h3 id="scan-for-Python-Socket"><a href="#scan-for-Python-Socket" class="headerlink" title="scan for Python Socket"></a><a href="#scan-for-Python-Socket" title="scan for Python Socket"></a>scan for Python Socket</h3><p>Python的Socket模块可以创建套接字，创建tcp三次握手连接，以此探测目标端口是否存活。本篇将使用socket模块编写tcp扫描以及syn扫描，并对比两者的差异。</p>
<h4 id="tcp-scan"><a href="#tcp-scan" class="headerlink" title="tcp scan"></a><a href="#tcp-scan" title="tcp scan"></a>tcp scan</h4><p>快来看代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line">import time</div><div class="line">import socket</div><div class="line"></div><div class="line">socket_timeout = 0.1</div><div class="line"></div><div class="line">def tcp_scan(ip,port):</div><div class="line">    try:</div><div class="line">        s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</div><div class="line">        s.settimeout(socket_timeout)</div><div class="line">        c=s.connect_ex((ip,port))</div><div class="line">        <span class="keyword">if</span> c==0:</div><div class="line">            <span class="built_in">print</span> <span class="string">“%s:%s is open”</span> % (ip,port)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="comment"># print “%s:%s is not open” % (ip,port)</span></div><div class="line">            pass</div><div class="line">    except Exception,e:</div><div class="line">        <span class="built_in">print</span> e</div><div class="line">    </div><div class="line">    s.close()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong>==<span class="string">“<strong>main</strong>“</span>:</div><div class="line">    s_time = time.time()</div><div class="line">    ip = <span class="string">“14.215.177.38”</span></div><div class="line">    <span class="keyword">for</span> port <span class="keyword">in</span> range(0,1024):</div><div class="line">        <span class="string">‘’</span><span class="string">‘ 此处可用协作 ‘</span><span class="string">‘’</span></div><div class="line">        tcp_scan(ip,port)   </div><div class="line">    e_time = time.time()</div><div class="line">    <span class="built_in">print</span> <span class="string">“scan time is “</span>,e_time-s_time</div></pre></td></tr></table></figure>

<p>运行结果：<br><img src="/upload_image/20180517/socket_tcp.png" alt=""></p>
<p>说明一下：可以看到此代码扫描1024个端口用了102s，当然代码并没有用多线程、协程等方式提高扫描效率（使用协程测试过扫65535个端口用时400s左右），因为python在这方面的能力比较弱；由于扫描过程中会建立tcp三次握手，因此比较消耗资源。</p>
<h4 id="tcp-syn-scan"><a href="#tcp-syn-scan" class="headerlink" title="tcp syn scan"></a><a href="#tcp-syn-scan" title="tcp syn scan"></a>tcp syn scan</h4><p>　　相对tcp扫描，tcp syn扫描方式更为隐蔽，也更节省资源，那么如何利用socket模块实现tcp syn扫描呢？这里需要用到SOCK_RAW，这个在socket编程中相对少用，资料也不多。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -<em>- coding: UTF-8 -</em>- </span></div><div class="line"></div><div class="line">import time</div><div class="line">import random</div><div class="line">import socket</div><div class="line">import sys</div><div class="line">from struct import <em></em></div><div class="line"></div><div class="line"><span class="string">‘’</span><span class="string">‘</span></div><div class="line">Warning:must run it as root</div><div class="line"></div><div class="line">yum install python-devel libpcap-devel</div><div class="line">pip install pcap</div><div class="line"></div><div class="line">‘<span class="string">‘’</span></div><div class="line"></div><div class="line">def checksum(msg):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ Check Summing ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    s = 0</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(0,len(msg),2):</div><div class="line">        w = (ord(msg[i]) &lt;&lt; 8) + (ord(msg[i+1]))</div><div class="line">        s = s+w</div><div class="line"></div><div class="line">    s = (s&gt;&gt;16) + (s &amp; 0xffff)</div><div class="line">    s = ~s &amp; 0xffff</div><div class="line"></div><div class="line">    <span class="built_in">return</span> s</div><div class="line"></div><div class="line"></div><div class="line">def CreateSocket(source_ip,dest_ip):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ create socket connection ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    try:</div><div class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_TCP)</div><div class="line">    except socket.error, msg:</div><div class="line">        <span class="built_in">print</span> <span class="string">‘Socket create error: ‘</span>,str(msg[0]),<span class="string">‘message: ‘</span>,msg[1]</div><div class="line">        sys.exit()</div><div class="line"></div><div class="line">    <span class="string">‘’</span><span class="string">‘ Set the IP header manually ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    s.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, 1)</div><div class="line">    </div><div class="line">    <span class="built_in">return</span> s</div><div class="line"></div><div class="line"></div><div class="line">def CreateIpHeader(source_ip, dest_ip):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ create ip header ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    <span class="comment"># packet = ‘’</span></div><div class="line"></div><div class="line">    <span class="comment"># ip header option</span></div><div class="line"></div><div class="line">    headerlen = 5</div><div class="line">    version = 4</div><div class="line">    tos = 0</div><div class="line">    tot_len = 20 + 20</div><div class="line">    id = random.randrange(18000,65535,1)</div><div class="line">    frag_off = 0</div><div class="line">    ttl = 255</div><div class="line">    protocol = socket.IPPROTO_TCP</div><div class="line">    check = 10</div><div class="line">    saddr = socket.inet_aton ( source_ip )</div><div class="line">    daddr = socket.inet_aton ( dest_ip )</div><div class="line">    hl_version = (version &lt;&lt; 4) + headerlen</div><div class="line">    ip_header = pack(<span class="string">‘!BBHHHBBH4s4s’</span>, hl_version, tos, tot_len, id, frag_off, ttl, protocol, check, saddr, daddr)</div><div class="line"></div><div class="line">    <span class="built_in">return</span> ip_header</div><div class="line"></div><div class="line"></div><div class="line">def create_tcp_syn_header(source_ip, dest_ip, dest_port):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ create tcp syn header function ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    <span class="built_in">source</span> = random.randrange(32000,62000,1) <span class="comment"># randon select one source_port </span></div><div class="line">    seq = 0</div><div class="line">    ack_seq = 0</div><div class="line">    doff = 5</div><div class="line">    </div><div class="line">    <span class="string">‘’</span><span class="string">‘ tcp flags ‘</span><span class="string">‘’</span></div><div class="line">    fin = 0</div><div class="line">    syn = 1</div><div class="line">    rst = 0</div><div class="line">    psh = 0</div><div class="line">    ack = 0</div><div class="line">    urg = 0</div><div class="line">    window = socket.htons (8192)    <span class="comment"># max windows size</span></div><div class="line">    check = 0</div><div class="line">    urg_ptr = 0</div><div class="line">    offset_res = (doff &lt;&lt; 4) + 0</div><div class="line">    tcp_flags = fin + (syn&lt;&lt;1) + (rst&lt;&lt;2) + (psh&lt;&lt;3) + (ack&lt;&lt;4) + (urg&lt;&lt;5)</div><div class="line">    tcp_header = pack(<span class="string">‘!HHLLBBHHH’</span>, <span class="built_in">source</span>, dest_port, seq, ack_seq, offset_res, tcp_flags, window, check, urg_ptr)</div><div class="line">    </div><div class="line">    <span class="string">‘’</span><span class="string">‘ headers option ‘</span><span class="string">‘’</span></div><div class="line">    source_address = socket.inet_aton( source_ip )</div><div class="line">    dest_address = socket.inet_aton( dest_ip )</div><div class="line">    placeholder = 0</div><div class="line">    protocol = socket.IPPROTO_TCP</div><div class="line">    tcp_length = len(tcp_header)</div><div class="line">    psh = pack(<span class="string">‘!4s4sBBH’</span>, source_address, dest_address, placeholder, protocol, tcp_length);</div><div class="line">    psh = psh + tcp_header;</div><div class="line">    tcp_checksum = checksum(psh)</div><div class="line"></div><div class="line">    <span class="string">‘’</span><span class="string">‘ Repack the TCP header and fill in the correct checksum ‘</span><span class="string">‘’</span></div><div class="line">    tcp_header = pack(<span class="string">‘!HHLLBBHHH’</span>, <span class="built_in">source</span>, dest_port, seq, ack_seq, offset_res, tcp_flags, window, tcp_checksum, urg_ptr)</div><div class="line">    </div><div class="line">    <span class="built_in">return</span> tcp_header</div><div class="line"></div><div class="line"></div><div class="line">def syn_scan(source_ip, dest_ip, des_port) :</div><div class="line"></div><div class="line">    s = CreateSocket(source_ip, dest_ip)</div><div class="line">    ip_header = CreateIpHeader(source_ip, dest_ip)</div><div class="line">    tcp_header = create_tcp_syn_header(source_ip, dest_ip, des_port)</div><div class="line">    packet = ip_header + tcp_header</div><div class="line"></div><div class="line">    s.sendto(packet, (dest_ip, 0))</div><div class="line">    data = s.recvfrom(1024) [0][0:]</div><div class="line"></div><div class="line">    ip_header_len = (ord(data[0]) &amp; 0x0f)  4</div><div class="line">    <span class="comment"># ip_header_ret = data[0: ip_header_len - 1]</span></div><div class="line">    tcp_header_len = (ord(data[32]) &amp; 0xf0)&gt;&gt;2</div><div class="line"></div><div class="line">    tcp_header_ret = data[ip_header_len:ip_header_len+tcp_header_len - 1]</div><div class="line"></div><div class="line">    <span class="string">‘’</span><span class="string">‘ SYN/ACK flags ‘</span><span class="string">‘’</span></div><div class="line">    <span class="keyword">if</span> ord(tcp_header_ret[13]) == 0x12:</div><div class="line">        <span class="built_in">print</span>  <span class="string">“%s:%s is open”</span> % (dest_ip,des_port)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="built_in">print</span> <span class="string">“%s:%s is not open”</span> % (dest_ip,des_port)</div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong>==<span class="string">“<strong>main</strong>“</span>:</div><div class="line"></div><div class="line">    t_s = time.time()</div><div class="line">    source_ip = <span class="string">‘’</span> <span class="comment"># 填写本机ip</span></div><div class="line">    dest_ip = <span class="string">‘14.215.177.38’</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> des_port <span class="keyword">in</span> range(1024):</div><div class="line">        syn_scan(source_ip, dest_ip, des_port)</div><div class="line"></div><div class="line">    t_e = time.time()</div><div class="line">    <span class="built_in">print</span> <span class="string">“time is “</span>,(t_e-t_s)</div></pre></td></tr></table></figure>

<p>有一点需要注意的，运行这段代码前，需要在系统上安装依赖:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install python-devel libpcap-devel</div><div class="line">pip install pcap</div></pre></td></tr></table></figure>

<p>运行结果：<br><img src="/upload_image/20180517/socket_syn.png" alt=""></p>
<p>说明：从运行结果上来看，并没有很准确，而且速度也不快，不清楚是不是代码上有问题。</p>
<h3 id="scan-for-Python-scapy"><a href="#scan-for-Python-scapy" class="headerlink" title="scan for Python scapy"></a><a href="#scan-for-Python-scapy" title="scan for Python scapy"></a>scan for Python scapy</h3><p>除了socket模块外，python还有一个scapy模块，可以用来模拟发包，但只能在linux下使用，其他操作系统不建议使用此模块。</p>
<h4 id="tcp-syn-csan"><a href="#tcp-syn-csan" class="headerlink" title="tcp syn csan"></a><a href="#tcp-syn-csan" title="tcp syn csan"></a>tcp syn csan</h4><p>代码在这里：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line">import time</div><div class="line">from scapy.all import *</div><div class="line"></div><div class="line"></div><div class="line">ip = <span class="string">“14.215.177.38”</span></div><div class="line">TIMEOUT = 0.5</div><div class="line">threads = 500</div><div class="line">port_range = 1024</div><div class="line">retry = 1</div><div class="line"></div><div class="line"></div><div class="line">def is_up(ip):</div><div class="line">    <span class="string">“”</span><span class="string">“ Tests if host is up “</span><span class="string">“”</span></div><div class="line"></div><div class="line">    icmp = IP(dst=ip)/ICMP()</div><div class="line">    resp = sr1(icmp, timeout=TIMEOUT)</div><div class="line">    <span class="keyword">if</span> resp == None:</div><div class="line">        <span class="built_in">return</span> False</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="built_in">return</span> True</div><div class="line"></div><div class="line">def reset_half_open(ip, ports):</div><div class="line">    <span class="comment"># Reset the connection to stop half-open connections from pooling up</span></div><div class="line"></div><div class="line">    sr(IP(dst=ip)/TCP(dport=ports, flags=<span class="string">‘AR’</span>), timeout=TIMEOUT)</div><div class="line"></div><div class="line"></div><div class="line">def is_open(ip, ports):</div><div class="line"></div><div class="line">    to_reset = []</div><div class="line">    results = []</div><div class="line"></div><div class="line">    p = IP(dst=ip)/TCP(dport=ports, flags=<span class="string">‘S’</span>)  <span class="comment"># Forging SYN packet</span></div><div class="line">    answers, un_answered = sr(p, verbose=False, retry=retry ,timeout=TIMEOUT) <span class="comment"># Send the packets</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> req, resp <span class="keyword">in</span> answers:</div><div class="line">        <span class="keyword">if</span> not resp.haslayer(TCP):</div><div class="line">            <span class="built_in">continue</span></div><div class="line">        tcp_layer = resp.getlayer(TCP)</div><div class="line">        <span class="keyword">if</span> tcp_layer.flags == 0x12:</div><div class="line">            <span class="comment"># port is open</span></div><div class="line">            to_reset.append(tcp_layer.sport)</div><div class="line">            results.append(tcp_layer.sport)</div><div class="line"></div><div class="line">        <span class="keyword">elif</span> tcp_layer.flags == 0x14:</div><div class="line">            <span class="comment"># port is open</span></div><div class="line">            pass</div><div class="line"></div><div class="line">    reset_half_open(ip, to_reset)</div><div class="line">    </div><div class="line">    <span class="built_in">return</span> results</div><div class="line"></div><div class="line"></div><div class="line">def chunks(l, n):</div><div class="line">    <span class="string">“”</span><span class="string">“Yield successive n-sized chunks from l.”</span><span class="string">“”</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(0, len(l), n):</div><div class="line">        yield l[i:i + n]</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong> == <span class="string">‘<strong>main</strong>‘</span>:</div><div class="line"></div><div class="line">    start_time = time.time()</div><div class="line">    open_port_list = []</div><div class="line"></div><div class="line">    <span class="keyword">for</span> ports <span class="keyword">in</span> chunks(list(range(port_range)), threads):</div><div class="line">        results = is_open(ip, ports)</div><div class="line">        <span class="keyword">if</span> results:</div><div class="line">           open_port_list += results</div><div class="line">                </div><div class="line">    end_time = time.time()</div><div class="line">    <span class="built_in">print</span> <span class="string">“%s %s”</span> % (ip,open_port_list)</div><div class="line">    <span class="built_in">print</span> <span class="string">“%s Scan Completed in %fs”</span> % (ip, end_time-start_time)</div></pre></td></tr></table></figure>

<p>运行结果：<br><img src="/upload_image/20180517/scapy_syn.png" alt=""></p>
<p>说明：由于scapy可以一次性发多个syn包，因此速度相对socket更快一些，但稳定性没有很好。</p>
<h3 id="scan-for-python-nmap"><a href="#scan-for-python-nmap" class="headerlink" title="scan for python+nmap"></a><a href="#scan-for-python-nmap" title="scan for python+nmap"></a>scan for python+nmap</h3><p>文章开头提到了nmap，其实在python中也可以直接调用nmap，看代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line"><span class="string">‘’</span><span class="string">‘</span></div><div class="line">pip install python-nmap</div><div class="line">‘<span class="string">‘’</span></div><div class="line"></div><div class="line">import nmap</div><div class="line">nm =nmap.PortScanner()</div><div class="line"></div><div class="line">def scan(ip,port,arg):</div><div class="line">    try:</div><div class="line">        nm.scan(ip, arguments=arg+str(port))</div><div class="line">    except nmap.nmap.PortScannerError:</div><div class="line">        <span class="built_in">print</span> <span class="string">“Please run -O method for root privileges”</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">for</span> host <span class="keyword">in</span> nm.all_hosts():</div><div class="line">            <span class="keyword">for</span> proto <span class="keyword">in</span> nm[host].all_protocols():</div><div class="line">                lport = nm[host][proto].keys()</div><div class="line">                lport.sort()</div><div class="line">                <span class="keyword">for</span> port <span class="keyword">in</span> lport:</div><div class="line">                    <span class="built_in">print</span> (<span class="string">‘port : %s\tstate : %s’</span> % (port, nm[host][proto][port][<span class="string">‘state’</span>]))</div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong>==<span class="string">“<strong>main</strong>“</span>:</div><div class="line">    port=<span class="string">“80,443,22,21”</span></div><div class="line">    scan(ip=<span class="string">“14.215.177.38”</span>,port=port,arg=<span class="string">“-sS -Pn -p”</span>)</div><div class="line">    <span class="comment"># tcp scan -sT</span></div><div class="line">    <span class="comment"># tcp syn scan -sS</span></div></pre></td></tr></table></figure>

<p>运行结果：<br><img src="/upload_image/20180517/nmap_scan.png" alt=""><br>由于nmap扫描速度相对比较慢，因此这里只演示扫描4个端口，不做速度的对比，当然其稳定性还是可以的。</p>
<h3 id="scan-for-go"><a href="#scan-for-go" class="headerlink" title="scan for go"></a><a href="#scan-for-go" title="scan for go"></a>scan for go</h3><p>　　前文一直在介绍使用python语言开发端口扫描器，然而由于python在多线程方面的弱势，扫描器的性能可想而知，因此我又利用go语言的高并发性优势，尝试开发端口扫描器。（题外话：为此我花了半天时间看了下go语言的基础，勉强看懂了扫描代码，并做了一些修改）</p>
<h4 id="tcp-scan-1"><a href="#tcp-scan-1" class="headerlink" title="tcp scan"></a><a href="#tcp-scan-1" title="tcp scan"></a>tcp scan</h4><p>直接看代码吧：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line">package main</div><div class="line"></div><div class="line">// port tcp scan</div><div class="line"></div><div class="line">import (</div><div class="line">    <span class="string">“fmt”</span></div><div class="line">    <span class="string">“net”</span></div><div class="line">    <span class="string">“os”</span></div><div class="line">    <span class="string">“runtime”</span></div><div class="line">    <span class="string">“strconv”</span></div><div class="line">    <span class="string">“sync”</span></div><div class="line">    <span class="string">“time”</span></div><div class="line">)</div><div class="line"></div><div class="line">func loop(inport chan int, startport, endport int) &#123;</div><div class="line">    <span class="keyword">for</span> i := startport; i &lt;= endport; i++ &#123;</div><div class="line">        inport &lt;- i</div><div class="line">    &#125;</div><div class="line">    close(inport)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">type</span> ScanSafeCount struct &#123;</div><div class="line">    // 结构体</div><div class="line">    count int</div><div class="line">    mux   sync.Mutex</div><div class="line">&#125;</div><div class="line"></div><div class="line">var scanCount ScanSafeCount</div><div class="line"></div><div class="line"></div><div class="line">func scanner(inport int, outport chan int, ip string, endport int) &#123;</div><div class="line">    // 扫描函数</div><div class="line"></div><div class="line">    <span class="keyword">in</span> := inport // 定义要扫描的端口号</div><div class="line">    // fmt.Printf(<span class="string">“ %d “</span>, <span class="keyword">in</span>) // 输出扫描的端口</div><div class="line"></div><div class="line">    host := fmt.Sprintf(<span class="string">“%s:%d”</span>, ip, <span class="keyword">in</span>) // 类似（ip,port）</div><div class="line"></div><div class="line">    tcpAddr, err := net.ResolveTCPAddr(<span class="string">“tcp4”</span>, host) // 根据域名查找ip</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        // 域名解析ip失败</div><div class="line">        outport &lt;- 0</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        conn, err := net.DialTimeout(<span class="string">“tcp”</span>, tcpAddr.String(), 10<em>time.Second) //建立tcp连接</em></div><div class="line">        <span class="keyword">if</span> err != nil &#123;</div><div class="line">            // tcp连接失败</div><div class="line">            outport &lt;- 0</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            // tcp连接成功</div><div class="line">            outport &lt;- <span class="keyword">in</span> // 将端口写入outport信号</div><div class="line">            fmt.Printf(<span class="string">“\n <strong><strong><em>**</em></strong></strong>( %d 可以 )<strong><strong><strong><strong>*</strong></strong></strong></strong>\n”</span>, <span class="keyword">in</span>)</div><div class="line">            conn.Close()</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 线程锁</div><div class="line">    scanCount.mux.Lock()</div><div class="line">    scanCount.count = scanCount.count - 1</div><div class="line">    <span class="keyword">if</span> scanCount.count &lt;= 0 &#123;</div><div class="line">        close(outport)</div><div class="line">    &#125;</div><div class="line">    scanCount.mux.Unlock()</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">func <span class="function"><span class="title">main</span></span>() &#123;</div><div class="line">    runtime.GOMAXPROCS(runtime.NumCPU()) // 设置最大可使用的cpu核数</div><div class="line"></div><div class="line">    // 定义变量</div><div class="line">    inport := make(chan int) // 信号变量，类似python中的queue</div><div class="line">    outport := make(chan int)</div><div class="line">    collect := []int&#123;&#125; // 定义一个切片变量，类似python中的list</div><div class="line"></div><div class="line">    // fmt.Println(os.Args, len(os.Args)) // 获取命令行参数并输出</div><div class="line"></div><div class="line">    <span class="keyword">if</span> len(os.Args) != 4 &#123;</div><div class="line">        // 命令行参数个数有误</div><div class="line">        fmt.Println(<span class="string">“使用方式： port_scanner IP startport endport”</span>)</div><div class="line">        os.Exit(0)</div><div class="line">    &#125;</div><div class="line">    s_time := time.Now().Unix()</div><div class="line"></div><div class="line">    // fmt.Println(<span class="string">“扫描开始：”</span>) // 获取当前时间</div><div class="line"></div><div class="line">    ip := string(os.Args[1]) // 获取参数中的ip</div><div class="line">    startport, _ := strconv.Atoi(os.Args[2]) // 获取参数中的启始端口</div><div class="line">    endport, _ := strconv.Atoi(os.Args[3]) // 获取参数中的结束端口</div><div class="line"></div><div class="line">    <span class="keyword">if</span> startport &gt; endport &#123;</div><div class="line">        fmt.Println(<span class="string">“Usage: scanner IP startport endport”</span>)</div><div class="line">        fmt.Println(<span class="string">“Endport must be larger than startport”</span>)</div><div class="line">        os.Exit(0)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        // 定义scanCount变量为ScanSafeCount结构体，即计算扫描的端口数量</div><div class="line">        scanCount = ScanSafeCount&#123;count: (endport - startport + 1)&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">“扫描 %s：%d———-%d\n”</span>, ip, startport, endport)</div><div class="line"></div><div class="line">    go loop(inport, startport, endport)  // 执行loop函数将端口写入input信号</div><div class="line"></div><div class="line">    <span class="keyword">for</span> v := range inport &#123;</div><div class="line">        // 开始循环input</div><div class="line">        go scanner(v, outport, ip, endport)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 输出结果</div><div class="line">    <span class="keyword">for</span> port := range outport &#123;</div><div class="line">        <span class="keyword">if</span> port != 0 &#123;</div><div class="line">            collect = append(collect, port)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">“–”</span>)</div><div class="line">    fmt.Println(collect)</div><div class="line">    e_time := time.Now().Unix()</div><div class="line">    fmt.Println(<span class="string">“扫描时间:”</span>, e_time-s_time)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>

<p>　　代码我就不解释了（我在代码中加了些注释，应该大致可以看懂），本文也不打算介绍go的用法，毕竟自己也是刚开始学习go，有兴趣的可以看看go的文档，然后再回过头来看看这段代码。</p>
<p>代码运行结果：<br><img src="/upload_image/20180517/go_tcp.png" alt=""></p>
<p>说明：由于是tcp扫描，所以多少还是占资源的，而且测试发现稳定性不是很好。</p>
<h4 id="tcp-syn-scan-1"><a href="#tcp-syn-scan-1" class="headerlink" title="tcp syn scan"></a><a href="#tcp-syn-scan-1" title="tcp syn scan"></a>tcp syn scan</h4><p>看代码看代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div></pre></td><td class="code"><pre><div class="line">package main</div><div class="line"></div><div class="line">// port tcp syn scan</div><div class="line"></div><div class="line">import (</div><div class="line">    <span class="string">“bytes”</span></div><div class="line">    <span class="string">“encoding/binary”</span></div><div class="line">    <span class="string">“flag”</span></div><div class="line">    <span class="string">“fmt”</span></div><div class="line">    <span class="string">“log”</span></div><div class="line">    <span class="string">“math/rand”</span></div><div class="line">    <span class="string">“net”</span></div><div class="line">    <span class="string">“os”</span></div><div class="line">    <span class="string">“strconv”</span></div><div class="line">    <span class="string">“strings”</span></div><div class="line">    <span class="string">“time”</span></div><div class="line">    <span class="string">“errors”</span></div><div class="line">)</div><div class="line"></div><div class="line">//TCPHeader <span class="built_in">test</span></div><div class="line"><span class="built_in">type</span> TCPHeader struct &#123;</div><div class="line">    SrcPort       uint16</div><div class="line">    DstPort       uint16</div><div class="line">    SeqNum        uint32</div><div class="line">    AckNum        uint32</div><div class="line">    Flags         uint16</div><div class="line">    Window        uint16</div><div class="line">    ChkSum        uint16</div><div class="line">    UrgentPointer uint16</div><div class="line">&#125;</div><div class="line"></div><div class="line">//TCPOption <span class="built_in">test</span></div><div class="line"><span class="built_in">type</span> TCPOption struct &#123;</div><div class="line">    Kind   uint8</div><div class="line">    Length uint8</div><div class="line">    Data   []byte</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">type</span> scanResult struct &#123;</div><div class="line">    Port   uint16</div><div class="line">    Opened bool</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">type</span> scanJob struct &#123;</div><div class="line">    Laddr string</div><div class="line">    Raddr string</div><div class="line">    SPort uint16</div><div class="line">    DPort uint16</div><div class="line">    Stop  uint8</div><div class="line">&#125;</div><div class="line"></div><div class="line">var stopFlag = make(chan uint8, 1)</div><div class="line"></div><div class="line">func <span class="function"><span class="title">main</span></span>() &#123;</div><div class="line"></div><div class="line">    rate := time.Second / 400</div><div class="line">    throttle := time.Tick(rate)</div><div class="line">    <span class="built_in">jobs</span> := make(chan <em>scanJob, 65536)</em></div><div class="line">    results := make(chan scanResult, 1000)</div><div class="line">    <span class="keyword">for</span> w := 0; w &lt; 10; w++ &#123;</div><div class="line">        go worker(w, <span class="built_in">jobs</span>, throttle, results)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 获取命令行参数</div><div class="line"></div><div class="line">    ifaceName := flag.String(<span class="string">“i”</span>, <span class="string">“eth0”</span>, <span class="string">“Specify network”</span>)</div><div class="line">    remote := flag.String(<span class="string">“r”</span>, <span class="string">“”</span>, <span class="string">“remote address”</span>)</div><div class="line">    portRange := flag.String(<span class="string">“p”</span>, <span class="string">“1-1024”</span>, <span class="string">“port range: -p 1-1024”</span>)</div><div class="line">    flag.Parse()</div><div class="line"></div><div class="line">    // ifaceName := &amp;interfaceName_</div><div class="line">    // remote := &amp;remote_</div><div class="line">    // portRange := &amp;portRange_</div><div class="line"></div><div class="line">    s_time := time.Now().Unix()</div><div class="line"></div><div class="line">    laddr := interfaceAddress(<em>ifaceName) //</em></div><div class="line">    raddr := remote</div><div class="line">    minPort , maxPort := portSplit(portRange)</div><div class="line"></div><div class="line">    // fmt.Println(laddr, raddr) // 输出源ip地址，目标ip地址</div><div class="line"></div><div class="line">    go func(num int)&#123;</div><div class="line">        <span class="keyword">for</span> i := 0; i &lt; num; i++ &#123;</div><div class="line">            recvSynAck(laddr, raddr, results)</div><div class="line">        &#125;</div><div class="line">    &#125;(10)</div><div class="line"></div><div class="line">    go func(jobLength int) &#123;</div><div class="line">        <span class="keyword">for</span> j := minPort; j &lt; maxPort + 1; j++ &#123;</div><div class="line">            s := scanJob&#123;</div><div class="line">                Laddr: laddr,</div><div class="line">                Raddr: raddr,</div><div class="line">                SPort: uint16(random(10000, 65535)),</div><div class="line">                DPort: uint16(j + 1),</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">jobs</span> &lt;- &amp;s</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">jobs</span> &lt;- &amp;scanJob&#123;Stop: 1&#125;</div><div class="line">    &#125;(1024)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        select &#123;</div><div class="line">        <span class="keyword">case</span> res := &lt;-results:</div><div class="line">            fmt.Println(<span class="string">“扫描到开放的端口:”</span>,res.Port)</div><div class="line">        <span class="keyword">case</span> &lt;-stopFlag:</div><div class="line">            e_time := time.Now().Unix()</div><div class="line">            fmt.Println(<span class="string">“总共用了多少时间(s):”</span>,e_time-s_time)</div><div class="line">            os.Exit(0)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func worker(id int, <span class="built_in">jobs</span> &lt;-chan <em>scanJob, th &lt;-chan time.Time, results chan&lt;- </em>scanResult) &#123;</div><div class="line">    <span class="keyword">for</span> j := range <span class="built_in">jobs</span> &#123;</div><div class="line">        <span class="keyword">if</span> j.Stop != 1 &#123;</div><div class="line">            sendSyn(j.Laddr, j.Raddr, j.SPort, j.DPort)</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            stopFlag &lt;- j.Stop</div><div class="line">        &#125;</div><div class="line">        &lt;-th</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func checkError(err error) &#123;</div><div class="line">    // 错误check</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        log.Println(err)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//CheckSum <span class="built_in">test</span></div><div class="line">func CheckSum(data []byte, src, dst [4]byte) uint16 &#123;</div><div class="line">    pseudoHeader := []byte&#123;</div><div class="line">        src[0], src[1], src[2], src[3],</div><div class="line">        dst[0], dst[1], dst[2], dst[3],</div><div class="line">        0,</div><div class="line">        6,</div><div class="line">        0,</div><div class="line">        byte(len(data)),</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    totalLength := len(pseudoHeader) + len(data)</div><div class="line">    <span class="keyword">if</span> totalLength%2 != 0 &#123;</div><div class="line">        totalLength++</div><div class="line">    &#125;</div><div class="line">    d := make([]byte, 0, totalLength)</div><div class="line">    d = append(d, pseudoHeader…)</div><div class="line">    d = append(d, data…)</div><div class="line"></div><div class="line">    <span class="built_in">return</span> ^mySum(d)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func mySum(data []byte) uint16 &#123;</div><div class="line">    var sum uint32</div><div class="line">    <span class="keyword">for</span> i := 0; i &lt; len(data)-1; i += 2 &#123;</div><div class="line">        sum += uint32(uint16(data[i])&lt;&lt;8 | uint16(data[i+1]))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sum = (sum &gt;&gt; 16) + (sum &amp; 0xffff)</div><div class="line">    sum = sum + (sum &gt;&gt; 16)</div><div class="line">    <span class="built_in">return</span> uint16(sum)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func sendSyn(laddr, raddr string, sport, dport uint16) &#123;</div><div class="line">    conn, err := net.Dial(<span class="string">“ip4:tcp”</span>, raddr)</div><div class="line">    checkError(err)</div><div class="line">    defer conn.Close()</div><div class="line">    op := []TCPOption&#123;</div><div class="line">        TCPOption&#123;</div><div class="line">            Kind:   2,</div><div class="line">            Length: 4,</div><div class="line">            Data:   []byte&#123;0x05, 0xb4&#125;,</div><div class="line">        &#125;,</div><div class="line">        TCPOption&#123;</div><div class="line">            Kind: 0,</div><div class="line">        &#125;,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    tcpH := TCPHeader&#123;</div><div class="line">        SrcPort:       sport,</div><div class="line">        DstPort:       dport,</div><div class="line">        SeqNum:        rand.Uint32(),</div><div class="line">        AckNum:        0,</div><div class="line">        Flags:         0x8002,</div><div class="line">        Window:        8192,</div><div class="line">        ChkSum:        0,</div><div class="line">        UrgentPointer: 0,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    buff := new(bytes.Buffer)</div><div class="line"></div><div class="line">    err = binary.Write(buff, binary.BigEndian, tcpH)</div><div class="line">    checkError(err)</div><div class="line">    <span class="keyword">for</span> i := range op &#123;</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Kind)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Length)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Data)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    binary.Write(buff, binary.BigEndian, [6]byte&#123;&#125;)</div><div class="line"></div><div class="line">    data := buff.Bytes()</div><div class="line">    checkSum := CheckSum(data, ipstr2Bytes(laddr), ipstr2Bytes(raddr))</div><div class="line">    //fmt.Printf(<span class="string">“CheckSum 0x%X\n”</span>, checkSum)</div><div class="line">    tcpH.ChkSum = checkSum</div><div class="line"></div><div class="line">    buff = new(bytes.Buffer)</div><div class="line">    binary.Write(buff, binary.BigEndian, tcpH)</div><div class="line">    <span class="keyword">for</span> i := range op &#123;</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Kind)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Length)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Data)</div><div class="line">    &#125;</div><div class="line">    binary.Write(buff, binary.BigEndian, [6]byte&#123;&#125;)</div><div class="line">    data = buff.Bytes()</div><div class="line"></div><div class="line">    //fmt.Printf(<span class="string">“% X\n”</span>, data)</div><div class="line">    _, err = conn.Write(data)</div><div class="line">    checkError(err)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func recvSynAck(laddr, raddr string, res chan&lt;- <em>scanResult) error &#123;</em></div><div class="line">    listenAddr, err := net.ResolveIPAddr(<span class="string">“ip4”</span>, laddr) // 解析域名为ip</div><div class="line">    checkError(err)</div><div class="line">    conn, err := net.ListenIP(<span class="string">“ip4:tcp”</span>, listenAddr)</div><div class="line">    defer conn.Close()</div><div class="line">    checkError(err)</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        buff := make([]byte, 1024)</div><div class="line">        _, addr, err := conn.ReadFrom(buff)</div><div class="line">        <span class="keyword">if</span> err != nil &#123;</div><div class="line">            <span class="built_in">continue</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> addr.String() != raddr || buff[13] != 0x12 &#123;</div><div class="line">            <span class="built_in">continue</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        var port uint16</div><div class="line">        binary.Read(bytes.NewReader(buff), binary.BigEndian, &amp;port)</div><div class="line">        res &lt;- &amp;scanResult&#123;</div><div class="line">            Port:   port,</div><div class="line">            Opened: <span class="literal">true</span>,</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func ipstr2Bytes(addr string) [4]byte &#123;</div><div class="line">    s := strings.Split(addr, <span class="string">“.”</span>)</div><div class="line">    b0, _ := strconv.Atoi(s[0])</div><div class="line">    b1, _ := strconv.Atoi(s[1])</div><div class="line">    b2, _ := strconv.Atoi(s[2])</div><div class="line">    b3, _ := strconv.Atoi(s[3])</div><div class="line">    <span class="built_in">return</span> [4]byte&#123;byte(b0), byte(b1), byte(b2), byte(b3)&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func random(min, max int) int &#123;</div><div class="line">    <span class="built_in">return</span> rand.Intn(max-min) + min</div><div class="line">&#125;</div><div class="line"></div><div class="line">func interfaceAddress(ifaceName string ) string &#123;</div><div class="line">    iface, err:= net.InterfaceByName(ifaceName)</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    addr, err := iface.Addrs()</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    addrStr := strings.Split(addr[0].String(), <span class="string">“/“</span>)[0]</div><div class="line">    <span class="built_in">return</span> addrStr</div><div class="line">&#125;</div><div class="line"></div><div class="line">func portSplit(portRange string) (uint16, uint16) &#123;</div><div class="line">    ports := strings.Split(*portRange, <span class="string">“-“</span>)</div><div class="line">    minPort, err := strconv.ParseUint(ports[0], 10, 16)</div><div class="line">    <span class="keyword">if</span> err !=nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    maxPort, err := strconv.ParseUint(ports[1], 10, 16)</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> minPort &gt; maxPort &#123;</div><div class="line">        panic(errors.New(<span class="string">“minPort must greater than maxPort”</span>))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">return</span> uint16(minPort), uint16(maxPort)</div><div class="line">&#125;</div></pre></td></tr></table></figure>

<p>代码运行结果：<br><img src="/upload_image/20180517/go_syn.png" alt=""><br>没错，就是2s！我测试了扫描全端口（0-65535），大概120s左右，而且稳定性不错。</p>
<h3 id="scan-for-go-python"><a href="#scan-for-go-python" class="headerlink" title="scan for go+python"></a><a href="#scan-for-go-python" title="scan for go+python"></a>scan for go+python</h3><p>　　经过前面的测试我们不难发现，在并发的性能上，go完胜python，但go不适合做复杂的逻辑处理，以及web开发之类的。因此如何整合python跟go呢？这里我想了两种方案，第一种将go语言打包成.so动态连接库，利用python的ctypes模块可以调用；第二种是go写成接口，提供python调用。写成接口的方式相对简单一些，因此这里不介绍了，说说如何打包go，即如何利用python调用go的方法或者说函数。</p>
<p>先看下修改过后的tcp_syn_scan.go代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div></pre></td><td class="code"><pre><div class="line">package main</div><div class="line"></div><div class="line">// port tcp syn scan</div><div class="line"></div><div class="line">import (</div><div class="line">    <span class="string">“C”</span></div><div class="line">    <span class="string">“os”</span></div><div class="line">    <span class="string">“bytes”</span></div><div class="line">    <span class="string">“encoding/binary”</span></div><div class="line">    <span class="string">“fmt”</span></div><div class="line">    <span class="string">“log”</span></div><div class="line">    <span class="string">“math/rand”</span></div><div class="line">    <span class="string">“net”</span></div><div class="line">    <span class="string">“strconv”</span></div><div class="line">    <span class="string">“strings”</span></div><div class="line">    <span class="string">“time”</span></div><div class="line">    <span class="string">“errors”</span></div><div class="line">)</div><div class="line"></div><div class="line">//TCPHeader <span class="built_in">test</span></div><div class="line"><span class="built_in">type</span> TCPHeader struct &#123;</div><div class="line">    SrcPort       uint16</div><div class="line">    DstPort       uint16</div><div class="line">    SeqNum        uint32</div><div class="line">    AckNum        uint32</div><div class="line">    Flags         uint16</div><div class="line">    Window        uint16</div><div class="line">    ChkSum        uint16</div><div class="line">    UrgentPointer uint16</div><div class="line">&#125;</div><div class="line"></div><div class="line">//TCPOption <span class="built_in">test</span></div><div class="line"><span class="built_in">type</span> TCPOption struct &#123;</div><div class="line">    Kind   uint8</div><div class="line">    Length uint8</div><div class="line">    Data   []byte</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">type</span> scanResult struct &#123;</div><div class="line">    Port   uint16</div><div class="line">    Opened bool</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">type</span> scanJob struct &#123;</div><div class="line">    Laddr string</div><div class="line">    Raddr string</div><div class="line">    SPort uint16</div><div class="line">    DPort uint16</div><div class="line">    Stop  uint8</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">var stopFlag = make(chan uint8, 1)</div><div class="line"></div><div class="line">//<span class="built_in">export</span> Scan</div><div class="line">func Scan(remote_ <em>C.char, portRange_ </em>C.char, interfaceName_ <em>C.char) &#123;</em></div><div class="line">    </div><div class="line">    rate := time.Second / 400</div><div class="line">    throttle := time.Tick(rate)</div><div class="line">    <span class="built_in">jobs</span> := make(chan scanJob, 65536)</div><div class="line">    results := make(chan <em>scanResult, 1000)</em></div><div class="line">    <span class="keyword">for</span> w := 0; w &lt; 10; w++ &#123;</div><div class="line">        go worker(w, <span class="built_in">jobs</span>, throttle, results)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 获取命令行参数</div><div class="line"></div><div class="line">    // ifaceName := flag.String(<span class="string">“i”</span>, <span class="string">“eth0”</span>, <span class="string">“Specify network”</span>)</div><div class="line">    // remote := flag.String(<span class="string">“r”</span>, <span class="string">“”</span>, <span class="string">“remote address”</span>)</div><div class="line">    // portRange := flag.String(<span class="string">“p”</span>, <span class="string">“1-1024”</span>, <span class="string">“port range: -p 1-1024”</span>)</div><div class="line">    // flag.Parse()</div><div class="line">    </div><div class="line">    interfaceName_1 := C.GoString(interfaceName_)</div><div class="line">    remote_1 := C.GoString(remote_)</div><div class="line">    portRange_1 := C.GoString(portRange_) </div><div class="line"></div><div class="line">    ifaceName := &amp;interfaceName_1</div><div class="line">    remote := &amp;remote_1</div><div class="line">    portRange := &amp;portRange_1</div><div class="line"></div><div class="line">    s_time := time.Now().Unix()</div><div class="line">    </div><div class="line">    laddr := interfaceAddress(ifaceName) //</div><div class="line">    raddr := <em>remote</em></div><div class="line">    minPort , maxPort := portSplit(portRange)</div><div class="line"></div><div class="line">    fmt.Println(laddr, raddr) // 输出源ip地址，目标ip地址</div><div class="line"></div><div class="line">    go func(num int)&#123;</div><div class="line">        <span class="keyword">for</span> i := 0; i &lt; num; i++ &#123;</div><div class="line">            recvSynAck(laddr, raddr, results)</div><div class="line">        &#125;</div><div class="line">    &#125;(10)</div><div class="line"></div><div class="line">    go func(jobLength int) &#123;</div><div class="line">        <span class="keyword">for</span> j := minPort; j &lt; maxPort + 1; j++ &#123;</div><div class="line">            s := scanJob&#123;</div><div class="line">                Laddr: laddr,</div><div class="line">                Raddr: raddr,</div><div class="line">                SPort: uint16(random(10000, 65535)),</div><div class="line">                DPort: uint16(j + 1),</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">jobs</span> &lt;- &amp;s</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">jobs</span> &lt;- &amp;scanJob&#123;Stop: 1&#125;</div><div class="line">    &#125;(1024)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        select &#123;</div><div class="line">        <span class="keyword">case</span> res := &lt;-results:</div><div class="line">            fmt.Println(<span class="string">“扫描到开放的端口：”</span>,res.Port) //输出开放的端口号</div><div class="line">        <span class="keyword">case</span> &lt;-stopFlag:</div><div class="line">            e_time := time.Now().Unix()</div><div class="line">            fmt.Println(<span class="string">“本次扫描总共耗时(s):”</span>,e_time-s_time)</div><div class="line">            os.Exit(0)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func worker(id int, <span class="built_in">jobs</span> &lt;-chan scanJob, th &lt;-chan time.Time, results chan&lt;- <em>scanResult) &#123;</em></div><div class="line">    <span class="keyword">for</span> j := range <span class="built_in">jobs</span> &#123;</div><div class="line">        <span class="keyword">if</span> j.Stop != 1 &#123;</div><div class="line">            sendSyn(j.Laddr, j.Raddr, j.SPort, j.DPort)</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            stopFlag &lt;- j.Stop</div><div class="line">        &#125;</div><div class="line">        &lt;-th</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func checkError(err error) &#123;</div><div class="line">    // 错误check</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        log.Println(err)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//CheckSum <span class="built_in">test</span></div><div class="line">func CheckSum(data []byte, src, dst [4]byte) uint16 &#123;</div><div class="line">    pseudoHeader := []byte&#123;</div><div class="line">        src[0], src[1], src[2], src[3],</div><div class="line">        dst[0], dst[1], dst[2], dst[3],</div><div class="line">        0,</div><div class="line">        6,</div><div class="line">        0,</div><div class="line">        byte(len(data)),</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    totalLength := len(pseudoHeader) + len(data)</div><div class="line">    <span class="keyword">if</span> totalLength%2 != 0 &#123;</div><div class="line">        totalLength++</div><div class="line">    &#125;</div><div class="line">    d := make([]byte, 0, totalLength)</div><div class="line">    d = append(d, pseudoHeader…)</div><div class="line">    d = append(d, data…)</div><div class="line"></div><div class="line">    <span class="built_in">return</span> ^mySum(d)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func mySum(data []byte) uint16 &#123;</div><div class="line">    var sum uint32</div><div class="line">    <span class="keyword">for</span> i := 0; i &lt; len(data)-1; i += 2 &#123;</div><div class="line">        sum += uint32(uint16(data[i])&lt;&lt;8 | uint16(data[i+1]))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sum = (sum &gt;&gt; 16) + (sum &amp; 0xffff)</div><div class="line">    sum = sum + (sum &gt;&gt; 16)</div><div class="line">    <span class="built_in">return</span> uint16(sum)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func sendSyn(laddr, raddr string, sport, dport uint16) &#123;</div><div class="line">    conn, err := net.Dial(<span class="string">“ip4:tcp”</span>, raddr)</div><div class="line">    checkError(err)</div><div class="line">    defer conn.Close()</div><div class="line">    op := []TCPOption&#123;</div><div class="line">        TCPOption&#123;</div><div class="line">            Kind:   2,</div><div class="line">            Length: 4,</div><div class="line">            Data:   []byte&#123;0x05, 0xb4&#125;,</div><div class="line">        &#125;,</div><div class="line">        TCPOption&#123;</div><div class="line">            Kind: 0,</div><div class="line">        &#125;,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    tcpH := TCPHeader&#123;</div><div class="line">        SrcPort:       sport,</div><div class="line">        DstPort:       dport,</div><div class="line">        SeqNum:        rand.Uint32(),</div><div class="line">        AckNum:        0,</div><div class="line">        Flags:         0x8002,</div><div class="line">        Window:        8192,</div><div class="line">        ChkSum:        0,</div><div class="line">        UrgentPointer: 0,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    buff := new(bytes.Buffer)</div><div class="line"></div><div class="line">    err = binary.Write(buff, binary.BigEndian, tcpH)</div><div class="line">    checkError(err)</div><div class="line">    <span class="keyword">for</span> i := range op &#123;</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Kind)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Length)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Data)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    binary.Write(buff, binary.BigEndian, [6]byte&#123;&#125;)</div><div class="line"></div><div class="line">    data := buff.Bytes()</div><div class="line">    checkSum := CheckSum(data, ipstr2Bytes(laddr), ipstr2Bytes(raddr))</div><div class="line">    //fmt.Printf(<span class="string">“CheckSum 0x%X\n”</span>, checkSum)</div><div class="line">    tcpH.ChkSum = checkSum</div><div class="line"></div><div class="line">    buff = new(bytes.Buffer)</div><div class="line">    binary.Write(buff, binary.BigEndian, tcpH)</div><div class="line">    <span class="keyword">for</span> i := range op &#123;</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Kind)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Length)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Data)</div><div class="line">    &#125;</div><div class="line">    binary.Write(buff, binary.BigEndian, [6]byte&#123;&#125;)</div><div class="line">    data = buff.Bytes()</div><div class="line"></div><div class="line">    //fmt.Printf(<span class="string">“% X\n”</span>, data)</div><div class="line">    _, err = conn.Write(data)</div><div class="line">    checkError(err)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func recvSynAck(laddr, raddr string, res chan&lt;- scanResult) error &#123;</div><div class="line">    listenAddr, err := net.ResolveIPAddr(<span class="string">“ip4”</span>, laddr) // 解析域名为ip</div><div class="line">    checkError(err)</div><div class="line">    conn, err := net.ListenIP(<span class="string">“ip4:tcp”</span>, listenAddr)</div><div class="line">    defer conn.Close()</div><div class="line">    checkError(err)</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        buff := make([]byte, 1024)</div><div class="line">        _, addr, err := conn.ReadFrom(buff)</div><div class="line">        <span class="keyword">if</span> err != nil &#123;</div><div class="line">            <span class="built_in">continue</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> addr.String() != raddr || buff[13] != 0x12 &#123;</div><div class="line">            <span class="built_in">continue</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        var port uint16</div><div class="line">        binary.Read(bytes.NewReader(buff), binary.BigEndian, &amp;port)</div><div class="line">        res &lt;- &amp;scanResult&#123;</div><div class="line">            Port:   port,</div><div class="line">            Opened: <span class="literal">true</span>,</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func ipstr2Bytes(addr string) [4]byte &#123;</div><div class="line">    s := strings.Split(addr, <span class="string">“.”</span>)</div><div class="line">    b0, _ := strconv.Atoi(s[0])</div><div class="line">    b1, _ := strconv.Atoi(s[1])</div><div class="line">    b2, _ := strconv.Atoi(s[2])</div><div class="line">    b3, _ := strconv.Atoi(s[3])</div><div class="line">    <span class="built_in">return</span> [4]byte&#123;byte(b0), byte(b1), byte(b2), byte(b3)&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func random(min, max int) int &#123;</div><div class="line">    <span class="built_in">return</span> rand.Intn(max-min) + min</div><div class="line">&#125;</div><div class="line"></div><div class="line">func interfaceAddress(ifaceName string ) string &#123;</div><div class="line">    iface, err:= net.InterfaceByName(ifaceName)</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    addr, err := iface.Addrs()</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    addrStr := strings.Split(addr[0].String(), <span class="string">“/“</span>)[0]</div><div class="line">    <span class="built_in">return</span> addrStr</div><div class="line">&#125;</div><div class="line"></div><div class="line">func portSplit(portRange <em>string) (uint16, uint16) &#123;</em></div><div class="line">    ports := strings.Split(portRange, <span class="string">“-“</span>)</div><div class="line">    minPort, err := strconv.ParseUint(ports[0], 10, 16)</div><div class="line">    <span class="keyword">if</span> err !=nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    maxPort, err := strconv.ParseUint(ports[1], 10, 16)</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> minPort &gt; maxPort &#123;</div><div class="line">        panic(errors.New(<span class="string">“minPort must greater than maxPort”</span>))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">return</span> uint16(minPort), uint16(maxPort)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func <span class="function"><span class="title">main</span></span>() &#123; &#125;</div></pre></td></tr></table></figure>

<p>然后利用go自身的build命令，将其打包成.so库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">go build -buildmode=c-shared -o tcp_syn_scan.so tcp_syn_scan.go</div></pre></td></tr></table></figure>

<p>打包后会得到一个tcp_syn_scan.so和一个tcp_syn_scan.h。然后利用下面的python代码就可以调用Go代码中的Scan()函数了，创建一个tcp_syn_scan.py文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line">from ctypes import *</div><div class="line">lib = cdll.LoadLibrary(u<span class="string">‘./scan.so’</span>)</div><div class="line">lib.Scan(<span class="string">“14.215.177.38”</span>,<span class="string">“1-1024”</span>,<span class="string">“eth0”</span>) <span class="comment"># ip,端口范围，网卡</span></div></pre></td></tr></table></figure>

<p>代码运行结果：<br><img src="/upload_image/20180517/python_go_syn_scan.png" alt=""></p>
<p>说明：相当原生的go，利用python去调用go会损耗一些性能，但总体上还可以。</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a><a href="#后记" title="后记"></a>后记</h3><p>本文结论就是可以利用go开发扫描模块（性能更佳），并结合python调用。<br>本文代码项目地址：<a href="https://github.com/tengzhangchao/PortScan" target="_blank" rel="noopener">https://github.com/tengzhangchao/PortScan</a></p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a><a href="#参考文章" title="参考文章"></a>参考文章</h3><p><a href="https://blog.csdn.net/pwc1996/article/details/73469850" target="_blank" rel="noopener">https://blog.csdn.net/pwc1996/article/details/73469850</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/05/07/利用python开发app实战/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/07/利用python开发app实战/" itemprop="url">利用python开发app实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-08T05:35:25+08:00">
                2018-05-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>你说，我们的未来<br>被装进棺材，染不上尘埃</p>
</blockquote>
<p>　　我很早之前就想开发一款app玩玩，无奈对java不够熟悉，之前也没有开发app的经验，因此一直耽搁了。最近想到尝试用python开发一款app，google搜索了一番后，发现确实有路可寻，目前也有了一些相对成熟的模块，于是便开始了动手实战，过程中发现这其中有很多坑，好在最终依靠google解决了，因此小记一番。<br><a id="more"></a></p>
<h3 id="说在前面的话"><a href="#说在前面的话" class="headerlink" title="说在前面的话"></a><a href="#说在前面的话" title="说在前面的话"></a>说在前面的话</h3><p>　　python语言虽然很万能，但用它来开发app还是显得有点不对路，因此用python开发的app应当是作为编码练习、或者自娱自乐所用，加上目前这方面的模块还不是特别成熟，bug比较多，总而言之，劝君莫轻入。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a><a href="#准备工作" title="准备工作"></a>准备工作</h3><p>　　利用python开发app需要用到python的一个模块–<a href="https://github.com/kivy/kivy" target="_blank" rel="noopener">kivy</a>，kivy是一个开源的，跨平台的Python开发框架，用于开发使用创新的应用程序。简而言之，这是一个python桌面程序开发框架（类似wxpython等模块），强大的是kivy支持linux、mac、windows、android、ios平台，这也是为什么开发app需要用到这个模块。<br>　　虽然kivy是跨平台的，但是想要在不同的平台使用python代码，还需要将python代码打包成对应平台的可执行程序，好在kivy项目下有个打包工具项目–<a href="https://github.com/kivy/buildozer" target="_blank" rel="noopener">buildozer</a>，这是官方推荐的打包工具，因为相对比较简单，自动化程度高，其他项目比如：<a href="https://github.com/kivy/python-for-android" target="_blank" rel="noopener">python-for-android</a>也能起到类似的作用，这里不展开介绍。</p>
<h3 id="搭建kivy开发环境"><a href="#搭建kivy开发环境" class="headerlink" title="搭建kivy开发环境"></a><a href="#搭建kivy开发环境" title="搭建kivy开发环境"></a>搭建kivy开发环境</h3><p>需要在pc上安装kivy开发环境，这里演示下mac与linux下的安装过程。</p>
<h4 id="install-kivy-for-mac"><a href="#install-kivy-for-mac" class="headerlink" title="install kivy for mac"></a><a href="#install-kivy-for-mac" title="install kivy for mac"></a>install kivy for mac</h4><p>安装一些依赖包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install pkg-config sdl2 sdl2_image sdl2_ttf sdl2_mixer gstreamer</div></pre></td></tr></table></figure>

<p>安装cython以及kivy：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pip install cython==0.25</div><div class="line">pip install kivy</div></pre></td></tr></table></figure>

<p>如果安装kivy报错，则使用下面的方式安装kivy：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> <a href="https://github.com/kivy/kivy" target="_blank" rel="noopener">https://github.com/kivy/kivy</a></div><div class="line">python setup.py install</div></pre></td></tr></table></figure>

<p>安装后测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$python</span></div><div class="line">Python 2.7.10 (default, Jul 15 2017, 17:16:57)</div><div class="line">[GCC 4.2.1 Compatible Apple LLVM 9.0.0 (clang-900.0.31)] on darwin</div><div class="line">Type <span class="string">“help”</span>, <span class="string">“copyright”</span>, <span class="string">“credits”</span> or <span class="string">“license”</span> <span class="keyword">for</span> more information.</div><div class="line">&gt;&gt;&gt;</div><div class="line">&gt;&gt;&gt; import kivy</div><div class="line">[INFO   ] [Logger      ] Record <span class="built_in">log</span> <span class="keyword">in</span> /Users/didi/.kivy/logs/kivy_18-05-08_4.txt</div><div class="line">[INFO   ] [Kivy        ] v1.10.1.dev0, git-5f6c66e, 20180507</div><div class="line">[INFO   ] [Python      ] v2.7.10 (default, Jul 15 2017, 17:16:57)</div><div class="line">[GCC 4.2.1 Compatible Apple LLVM 9.0.0 (clang-900.0.31)]</div></pre></td></tr></table></figure>

<p>说明：导入kivy模块没有报错则说明安装成功。</p>
<h4 id="install-kivy-for-centos7"><a href="#install-kivy-for-centos7" class="headerlink" title="install kivy for centos7"></a><a href="#install-kivy-for-centos7" title="install kivy for centos7"></a>install kivy for centos7</h4><p>先安装依赖：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">yum install \</div><div class="line">    make \</div><div class="line">    mercurial \</div><div class="line">    automake \</div><div class="line">    gcc \</div><div class="line">    gcc-c++ \</div><div class="line">    SDL_ttf-devel \</div><div class="line">    SDL_mixer-devel \</div><div class="line">    khrplatform-devel \</div><div class="line">    mesa-libGLES \</div><div class="line">    mesa-libGLES-devel \</div><div class="line">    gstreamer-plugins-good \</div><div class="line">    gstreamer \</div><div class="line">    gstreamer-python \</div><div class="line">    mtdev-devel \</div><div class="line">    python-devel \</div><div class="line">    python-pip \</div><div class="line">    java-devel</div></pre></td></tr></table></figure>

<p>安装cython以及kivy:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pip install Cython==0.20</div><div class="line">pip install kivy</div></pre></td></tr></table></figure>

<p>centos安装kivy参考：<a href="https://kivy.org/docs/installation/installation-linux.html#using-software-packages" target="_blank" rel="noopener">https://kivy.org/docs/installation/installation-linux.html#using-software-packages</a></p>
<p>说明：其他安装kivy方式可移步：<a href="https://kivy.org/#download（需要翻墙）" target="_blank" rel="noopener">https://kivy.org/#download（需要翻墙）</a></p>
<h3 id="用kivy开发第一个python-app"><a href="#用kivy开发第一个python-app" class="headerlink" title="用kivy开发第一个python app"></a><a href="#用kivy开发第一个python-app" title="用kivy开发第一个python app"></a>用kivy开发第一个python app</h3><p>安装完kivy就可以开发app程序了，这里演示下hello-world程序，关于kivy更复杂的用法不是本文重点，后面再成文介绍。<br>1) 创建一个main.py文件，写入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line">from kivy.app import App</div><div class="line"></div><div class="line">class HelloApp(App):</div><div class="line">    pass</div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong> == <span class="string">‘<strong>main</strong>‘</span>:</div><div class="line">    HelloApp().run()</div></pre></td></tr></table></figure>

<p>2)创建一个hello.kv文件，写入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Label:</div><div class="line">    text: <span class="string">‘Hello, World! I am nMask’</span></div></pre></td></tr></table></figure>

<p>简单说明：main.py是入口函数，定义了一个HelloApp类，该类继承kivy.app；hello.kv文件是kivy程序，相当于定义界面风格等，该文件命名规则为类名小写且去除app。</p>
<h3 id="运行第一个python-app"><a href="#运行第一个python-app" class="headerlink" title="运行第一个python app"></a><a href="#运行第一个python-app" title="运行第一个python app"></a>运行第一个python app</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python main.py</div></pre></td></tr></table></figure>

<p>运行结果：<br><img src="/upload_image/20180508/1.png" alt=""></p>
<h3 id="安装buildozer工具"><a href="#安装buildozer工具" class="headerlink" title="安装buildozer工具"></a><a href="#安装buildozer工具" title="安装buildozer工具"></a>安装buildozer工具</h3><p>　　通过以上的编码，我创建了自己的第一个python app程序，该程序可以直接在mac、linux、windows平台下运行，那么如何让它在安卓或者苹果手机上运行呢？我们知道在安卓上运行，需要将其打包成apk安装程序，因此就需要用到前面提到过的buildozer工具，（buildozer工具可以打包kivy程序，支持android、ios等），buildozer的安装过程比较简单：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install buildozer</div></pre></td></tr></table></figure>

<h3 id="使用buildozer工具将kivy程序打包成apk"><a href="#使用buildozer工具将kivy程序打包成apk" class="headerlink" title="使用buildozer工具将kivy程序打包成apk"></a><a href="#使用buildozer工具将kivy程序打包成apk" title="使用buildozer工具将kivy程序打包成apk"></a>使用buildozer工具将kivy程序打包成apk</h3><p>在python项目目录下运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">buildozer init</div></pre></td></tr></table></figure>

<p>运行成功将会创建一个配置文件buildozer.spec，可以通过修改配置文件更改app的名称等，然后运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">buildozer android debug deploy run</div></pre></td></tr></table></figure>

<p>运行以上命令将会生成跨平台的安装包，可适用安卓、ios等，如果用于安卓，则是利用<a href="https://github.com/kivy/python-for-android" target="_blank" rel="noopener">python-for-android</a>项目。</p>
<p>在第一次运行以上命令的时候，会自动在系统中下载安卓sdk等必要文件，如下图。（过程需要翻墙，而且有很多依赖需要下载）<br><img src="/upload_image/20180508/2.png" alt=""></p>
<p>说明：这里只演示打包成apk文件，iso平台的可自行研究，参考文档：<a href="https://github.com/kivy/buildozer。" target="_blank" rel="noopener">https://github.com/kivy/buildozer。</a></p>
<h3 id="python-apk程序测试"><a href="#python-apk程序测试" class="headerlink" title="python apk程序测试"></a><a href="#python-apk程序测试" title="python apk程序测试"></a>python apk程序测试</h3><p>如果以上步骤都运行成功的话，应该会在项目目录下的bin目录下生成一个apk文件，类似如下：<br><img src="/upload_image/20180508/3.png" alt=""></p>
<p>然后将apk下载到安卓系统的手机上，安装即可，测试效果如下：<br><img src="/upload_image/20180508/4.png" alt=""><br>打开app：<br><img src="/upload_image/20180508/5.png" alt=""></p>
<h3 id="buildozer使用说明"><a href="#buildozer使用说明" class="headerlink" title="buildozer使用说明"></a><a href="#buildozer使用说明" title="buildozer使用说明"></a>buildozer使用说明</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">Usage:</div><div class="line">    buildozer [–profile &lt;name&gt;] [–verbose] [target] &lt;<span class="built_in">command</span>&gt;…</div><div class="line">    buildozer –version</div><div class="line"></div><div class="line">Available targets:</div><div class="line">  android        Android target, based on python-for-android project</div><div class="line">  ios            iOS target, based on kivy-ios project</div><div class="line">  android_old    Android target, based on python-for-android project (old toolchain)</div><div class="line"></div><div class="line">Global commands (without target):</div><div class="line">  distclean          Clean the whole Buildozer environment.</div><div class="line">  <span class="built_in">help</span>               Show the Buildozer <span class="built_in">help</span>.</div><div class="line">  init               Create a initial buildozer.spec <span class="keyword">in</span> the current directory</div><div class="line">  serve              Serve the bin directory via SimpleHTTPServer</div><div class="line">  setdefault         Set the default <span class="built_in">command</span> to run when no arguments are given</div><div class="line">  version            Show the Buildozer version</div><div class="line"></div><div class="line">Target commands:</div><div class="line">  clean      Clean the target environment</div><div class="line">  update     Update the target dependencies</div><div class="line">  debug      Build the application <span class="keyword">in</span> debug mode</div><div class="line">  release    Build the application <span class="keyword">in</span> release mode</div><div class="line">  deploy     Deploy the application on the device</div><div class="line">  run        Run the application on the device</div><div class="line">  serve      Serve the bin directory via SimpleHTTPServer</div><div class="line"></div><div class="line">Target <span class="string">“android_old”</span> commands:</div><div class="line">  adb                Run adb from the Android SDK. Args must come after –, or</div><div class="line">                     use –<span class="built_in">alias</span> to make an <span class="built_in">alias</span></div><div class="line">  logcat             Show the <span class="built_in">log</span> from the device</div><div class="line"></div><div class="line">Target <span class="string">“ios”</span> commands:</div><div class="line">  list_identities    List the available identities to use <span class="keyword">for</span> signing.</div><div class="line">  xcode              Open the xcode project.</div><div class="line"></div><div class="line">Target <span class="string">“android”</span> commands:</div><div class="line">  adb                Run adb from the Android SDK. Args must come after –, or</div><div class="line">                     use –<span class="built_in">alias</span> to make an <span class="built_in">alias</span></div><div class="line">  logcat             Show the <span class="built_in">log</span> from the device</div><div class="line">  p4a                Run p4a commands. Args must come after –, or use –<span class="built_in">alias</span></div><div class="line">                     to make an <span class="built_in">alias</span></div></pre></td></tr></table></figure>

<h3 id="buildozer打包过程中的坑点"><a href="#buildozer打包过程中的坑点" class="headerlink" title="buildozer打包过程中的坑点"></a><a href="#buildozer打包过程中的坑点" title="buildozer打包过程中的坑点"></a>buildozer打包过程中的坑点</h3><p>如果在打包过程中遇到报错，可以修改buildozer.spec配置文件中的log_level为2，然后重新运行，可以看具体的错误信息。</p>
<h4 id="报错：You-might-have-missed-to-install-32bits-libs"><a href="#报错：You-might-have-missed-to-install-32bits-libs" class="headerlink" title="报错：You might have missed to install 32bits libs"></a><a href="#报错：You-might-have-missed-to-install-32bits-libs" title="报错：You might have missed to install 32bits libs"></a>报错：You might have missed to install 32bits libs</h4><p>这个错是我在centos7上运行时报的错，大意是系统缺少了某些32位的依赖文件。<br>解决方案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install –skip-broken glibc.i686 arts.i686 audiofile.i686 bzip2-libs.i686 cairo.i686 cyrus-sasl-lib.i686 dbus-libs.i686 directfb.i686 esound-libs.i686 fltk.i686 freeglut.i686 gtk2.i686 hal-libs.i686 imlib.i686 lcms-libs.i686 lesstif.i686 libacl.i686 libao.i686 libattr.i686 libcap.i686 libdrm.i686 libexif.i686 libgnomecanvas.i686 libICE.i686 libieee1284.i686 libsigc++20.i686 libSM.i686 libtool-ltdl.i686 libusb.i686 libwmf.i686 libwmf-lite.i686 libX11.i686 libXau.i686 libXaw.i686 libXcomposite.i686 libXdamage.i686 libXdmcp.i686 libXext.i686 libXfixes.i686 libxkbfile.i686 libxml2.i686 libXmu.i686 libXp.i686 libXpm.i686 libXScrnSaver.i686 libxslt.i686 libXt.i686 libXtst.i686 libXv.i686 libXxf86vm.i686 lzo.i686 mesa-libGL.i686 mesa-libGLU.i686 nas-libs.i686 nss_ldap.i686 cdk.i686 openldap.i686 pam.i686 popt.i686 pulseaudio-libs.i686 sane-backends-libs-gphoto2.i686 sane-backends-libs.i686 SDL.i686 svgalib.i686 unixODBC.i686 zlib.i686 compat-expat1.i686 compat-libstdc++-33.i686 openal-soft.i686 alsa-oss-libs.i686 redhat-lsb.i686 alsa-plugins-pulseaudio.i686 alsa-plugins-oss.i686 alsa-lib.i686 nspluginwrapper.i686 libXv.i686 libXScrnSaver.i686 qt.i686 qt-x11.i686 pulseaudio-libs.i686 pulseaudio-libs-glib2.i686 alsa-plugins-pulseaudio.i686 python-matplotli</div></pre></td></tr></table></figure>

<p>参考：<a href="https://ask.fedoraproject.org/en/question/9556/how-do-i-install-32bit-libraries-on-a-64-bit-fedora/" target="_blank" rel="noopener">https://ask.fedoraproject.org/en/question/9556/how-do-i-install-32bit-libraries-on-a-64-bit-fedora/</a></p>
<h4 id="报错：Error-compiling-Cython-file"><a href="#报错：Error-compiling-Cython-file" class="headerlink" title="报错：Error compiling Cython file"></a><a href="#报错：Error-compiling-Cython-file" title="报错：Error compiling Cython file"></a>报错：Error compiling Cython file</h4><p>错误大意为cython文件出错，可能是cython模块没有安装，或者版本有问题。<br>解决方案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install cython==0.25</div></pre></td></tr></table></figure>

<h4 id="报错：IOError-Errno-2-No-such-file-or-directory…"><a href="#报错：IOError-Errno-2-No-such-file-or-directory…" class="headerlink" title="报错：IOError: [Errno 2] No such file or directory….."></a><a href="#报错：IOError-Errno-2-No-such-file-or-directory…" title="报错：IOError: [Errno 2] No such file or directory….."></a>报错：IOError: [Errno 2] No such file or directory…..</h4><p>这是在打包的最后一步，将apk文件copy到项目bin目录下时报的错，是buildozer的一个bug。<br>解决方案：<br>修改/usr/local/lib/python2.7/dist-packages/buildozer/tagets/android.py文件：<br>(1)在文件开头导入:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">from distutils.version import LooseVersion</div></pre></td></tr></table></figure>

<p>(2) 将786行:XXX found how the apk name is really built from the title这一行以下的代码替换为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><strong>sdk_dir = self.android_sdk_dir</strong></div><div class="line">build_tools_versions = os.listdir(join(sdk_dir, <span class="string">‘build-tools’</span>))</div><div class="line">build_tools_versions = sorted(build_tools_versions, key=LooseVersion)</div><div class="line">build_tools_version = build_tools_versions[-1]</div><div class="line">gradle_files = [<span class="string">“build.gradle”</span>, <span class="string">“gradle”</span>, <span class="string">“gradlew”</span>]</div><div class="line">is_gradle_build = any((exists(join(dist_dir, x)) <span class="keyword">for</span> x <span class="keyword">in</span> gradle_files)) and build_tools_version &gt;= ’25.0<span class="string">‘</span></div></pre></td></tr></table></figure>

<h3 id="buildozer虚拟机"><a href="#buildozer虚拟机" class="headerlink" title="buildozer虚拟机"></a><a href="#buildozer虚拟机" title="buildozer虚拟机"></a>buildozer虚拟机</h3><p>　　kivy官方推出了一个buildozer虚拟机镜像，已经安装好了buildozer以及一些依赖文件，为buildozer打包测试提供平台。由于之前我在mac上利用buildozer打包一直报错，后来换成centos也依然没有成功，因此便下载了此虚拟机，测试效果如下：<br><img src="/upload_image/20180508/6.png" alt=""></p>
<p>虚拟机下载地址：<a href="http://txzone.net/files/torrents/kivy-buildozer-vm-2.0.zip" target="_blank" rel="noopener">http://txzone.net/files/torrents/kivy-buildozer-vm-2.0.zip</a></p>
<p>说明：对于无法解决依赖问题的朋友，可以使用此虚拟机进行程序打包，开发环境还是推荐用自己的本机。</p>
<h3 id="kivy开发实例"><a href="#kivy开发实例" class="headerlink" title="kivy开发实例"></a><a href="#kivy开发实例" title="kivy开发实例"></a>kivy开发实例</h3><p>　　因为本文重点在于介绍如何利用kivy+buildozer开发一款python app，因此对于kivy的开发过程，以及app功能进行了最简化。想要学习如何开发更复杂的app，可参考：<a href="https://muxuezi.github.io/posts/kivy-perface.html#" target="_blank" rel="noopener">https://muxuezi.github.io/posts/kivy-perface.html#</a></p>
<p><em>～！～ 折腾python使我快乐，……，想想还是滚回去学java吧 ～！～</em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/05/04/burpsuite插件开发之检测越权访问漏洞/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/04/burpsuite插件开发之检测越权访问漏洞/" itemprop="url">burpsuite插件开发之检测越权访问漏洞</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-04T08:26:28+08:00">
                2018-05-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>那个喝醉的夜晚，挡不住我们的步伐</p>
</blockquote>
<p>　　前些天公司买了些BurpSuite的License，终于可以用上正版了，先给公司来波赞！好啦，言归正传，BurpSuite作为Web安全测试的一大神器，其中一个优势就是其扩展性好。BurpSuite支持Java、Python、Ruby作为其插件的扩展语言，而在其内置的Bapp_Store中也有很多很强大的插件。作为一名程序猿，心想是时候自己动手开发一款专属插件了，抱着此心态我便开始尝试学习摸索着Coding，于是便有了此文。<br><a id="more"></a></p>
<h3 id="插件语言的选择"><a href="#插件语言的选择" class="headerlink" title="插件语言的选择"></a><a href="#插件语言的选择" title="插件语言的选择"></a>插件语言的选择</h3><p>　　以上所述Burp支持Java、Python、Ruby语言的扩展，相对来说我更熟悉Python，因此就用Python开始学习写插件，对于速度要求高的朋友可以用Java写。熟悉Python的朋友肯定知道，Python分为Cython、Jython等。前者就是我们通常所说的Python，后者是Java版本的Python，简单理解就是用Jython可以调用Java的库。</p>
<h3 id="burpsuite-jython开发环境"><a href="#burpsuite-jython开发环境" class="headerlink" title="burpsuite jython开发环境"></a><a href="#burpsuite-jython开发环境" title="burpsuite jython开发环境"></a>burpsuite jython开发环境</h3><p>　　想要开发使用一款属于自己的BurpSuite插件，必须要部署好Jython开发环境以及Jython运行环境。前者需要在开发jython程序的平台上搭建环境，后者需要在运行burpsuite的平台搭建环境。鉴于一般开发以及使用插件都在用一个平台上，比如mac，因此本文介绍一下如何在mac上安装jython环境。</p>
<h4 id="install-jython-for-Mac"><a href="#install-jython-for-Mac" class="headerlink" title="install jython for Mac"></a><a href="#install-jython-for-Mac" title="install jython for Mac"></a>install jython for Mac</h4><p>首先我们需要在mac上安装jython的环境以便开发jython程序，就像安装python环境一样，mac上安装jython命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install jython</div></pre></td></tr></table></figure>

<p>安装完以后，jython安装在/usr/local/Cellar/jython/目录下，需要设置环境变量，将/usr/local/Cellar/jython/2.7.1/libexec/bin添加到环境变量，然后在shell中输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$jython</span></div><div class="line">Jython 2.7.1 (default:0df7adb1b397, Jun 30 2017, 19:02:43)</div><div class="line">[Java HotSpot(TM) 64-Bit Server VM (Oracle Corporation)] on java1.8.0_111</div><div class="line">Type <span class="string">“help”</span>, <span class="string">“copyright”</span>, <span class="string">“credits”</span> or <span class="string">“license”</span> <span class="keyword">for</span> more information.</div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure>

<p>说明：其他平台（windows，linux）安装jython方式请自行google，应该比较类似。</p>
<h4 id="Load-Jython-to-Burpsuite"><a href="#Load-Jython-to-Burpsuite" class="headerlink" title="Load Jython to Burpsuite"></a><a href="#Load-Jython-to-Burpsuite" title="Load Jython to Burpsuite"></a>Load Jython to Burpsuite</h4><p>mac上安装完jython环境后，需要在burpsuite中加载jython环境，注意这里选择的是jar文件。<br><img src="/upload_image/20180504/1.png" alt=""></p>
<h3 id="开发jython程序"><a href="#开发jython程序" class="headerlink" title="开发jython程序"></a><a href="#开发jython程序" title="开发jython程序"></a>开发jython程序</h3><p>本篇以开发一款检测未授权访问漏洞的插件为例介绍一下插件的开发过程，由于本文重点在于介绍如何开发一款bp插件，以及一些不可抗因素，本文介绍的插件均为简化后的版本。</p>
<h4 id="创建main-py文件"><a href="#创建main-py文件" class="headerlink" title="创建main.py文件"></a><a href="#创建main-py文件" title="创建main.py文件"></a>创建main.py文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line">import re</div><div class="line">from burp import IBurpExtender <span class="comment"># 定义插件的基本信息类</span></div><div class="line">from burp import IHttpListener <span class="comment"># http流量监听类</span></div><div class="line">from noauth import noauth_request</div><div class="line"></div><div class="line"><span class="comment"># 敏感接口检测，并输出敏感接口信息</span></div><div class="line">res_host = re.compile(r<span class="string">‘Host: ([^,]<em>)’</em></span>)</div><div class="line">res_path = re.compile(r<span class="string">‘(GET|POST) ([^ ]) HTTP/‘</span>)</div><div class="line"></div><div class="line"></div><div class="line">class BurpExtender(IBurpExtender, IHttpListener):</div><div class="line">    def registerExtenderCallbacks(self, callbacks):</div><div class="line">        self._callbacks = callbacks</div><div class="line">        self._helpers = callbacks.getHelpers() <span class="comment"># 通用函数</span></div><div class="line">        self._callbacks.setExtensionName(<span class="string">“sensitive_interface_scan”</span>)</div><div class="line"></div><div class="line">        <span class="built_in">print</span> <span class="string">“load sensitive_interface_scan plugin success!”</span></div><div class="line">        <span class="built_in">print</span> <span class="string">“=============================================”</span></div><div class="line">        <span class="built_in">print</span> <span class="string">“”</span></div><div class="line"></div><div class="line">        <span class="comment"># register ourselves as an HTTP listener</span></div><div class="line">        callbacks.registerHttpListener(self)</div><div class="line">    </div><div class="line">    def processHttpMessage(self, toolFlag, messageIsRequest, messageInfo):</div><div class="line">        <span class="keyword">if</span> toolFlag == 4:</div><div class="line">            <span class="keyword">if</span> not messageIsRequest:</div><div class="line">                response = messageInfo.getResponse() <span class="comment"># get response</span></div><div class="line">                analyzedResponse = self._helpers.analyzeResponse(response)</div><div class="line">                body = response[analyzedResponse.getBodyOffset():] </div><div class="line">                body_string = body.tostring() <span class="comment"># get response_body</span></div><div class="line"></div><div class="line">                request = messageInfo.getRequest()</div><div class="line">                analyzedRequest = self._helpers.analyzeResponse(request)</div><div class="line">                request_header = analyzedRequest.getHeaders() </div><div class="line">                try:</div><div class="line">                    method,path = res_path.findall(request_header[0])[0]</div><div class="line">                    host = res_host.findall(request_header[1])[0]</div><div class="line">                    url = method+<span class="string">“ “</span>+host+path</div><div class="line">                except:</div><div class="line">                    url = <span class="string">“”</span></div><div class="line"></div><div class="line">                <span class="keyword">if</span> method==<span class="string">“GET”</span>:</div><div class="line">                    <span class="comment"># 检测GET请求的接口</span></div><div class="line"></div><div class="line">                    <span class="built_in">print</span> <span class="string">“[Info]Check url is “</span>,url</div><div class="line"></div><div class="line">                    cur = noauth_request(host,path,body_string)</div><div class="line">                    noauth_result = cur.run()</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> noauth_result: </div><div class="line">                        <span class="built_in">print</span> <span class="string">“[Info]Found it is a noauth Interface %s”</span> % noauth_result[0][0]</div><div class="line">                        <span class="built_in">print</span> <span class="string">“[Info]remove param is “</span>,noauth_result[0][1]</div><div class="line"></div><div class="line">                    <span class="built_in">print</span> <span class="string">“======================================================================================”</span></div><div class="line">                    <span class="built_in">print</span> <span class="string">“”</span></div></pre></td></tr></table></figure>

<p>说明：此文件为插件入口文件，其中导入的burp内置类IBurpExtender为基类，即所有插件都需要使用继承此类，IHttpListener类用来获取http请求以及响应内容。</p>
<h4 id="创建noauth-py文件"><a href="#创建noauth-py文件" class="headerlink" title="创建noauth.py文件"></a><a href="#创建noauth-py文件" title="创建noauth.py文件"></a>创建noauth.py文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line"><span class="string">‘’</span><span class="string">‘未授权访问poc(GET)’</span><span class="string">‘’</span></div><div class="line"></div><div class="line">import requests</div><div class="line">from furl import furl</div><div class="line"></div><div class="line">auth_params=[<span class="string">“token”</span>,<span class="string">“sign”</span>,<span class="string">“ticket”</span>]</div><div class="line"></div><div class="line"><span class="comment"># headers 里面除去cookie</span></div><div class="line"></div><div class="line">headers=&#123;</div><div class="line">    </div><div class="line">    <span class="string">“User-Agent”</span>:<span class="string">“Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.139 Safari/537.36”</span>,</div><div class="line">    <span class="string">“Accept-Language”</span>:<span class="string">“zh-CN,zh;q=0.9,en;q=0.8,mt;q=0.7,zh-TW;q=0.6”</span>,</div><div class="line">    <span class="string">“Accept-Encoding”</span>:<span class="string">“gzip, deflate”</span>,</div><div class="line">    <span class="string">“Accept”</span>:<span class="string">“text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,<em>/</em>;q=0.8”</span>,</div><div class="line">    <span class="string">“Cookie”</span>:<span class="string">“test”</span>,</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">class noauth_request(object):</div><div class="line">    <span class="comment"># 未授权访问漏洞检测</span></div><div class="line"></div><div class="line">    def <strong>init</strong>(self,host,path,body_string):</div><div class="line"></div><div class="line">        self.url = <span class="string">“http://“</span>+host+path</div><div class="line">        self.uri = str(furl(self.url).remove(args=True))</div><div class="line">        self.body_string = body_string</div><div class="line">        self.param = dict(furl(self.url).args)</div><div class="line">        self.remove_param = []</div><div class="line"></div><div class="line">    def run(self):</div><div class="line">        </div><div class="line">        result_list=[]</div><div class="line"></div><div class="line">        self.remove_auth() <span class="comment"># remove params,example:auth,token,sign……</span></div><div class="line"></div><div class="line">        response_body,current_url = self.get_response()</div><div class="line"></div><div class="line">        <span class="keyword">if</span> response_body == self.body_string:</div><div class="line"></div><div class="line">            result_list.append((current_url,self.remove_param,response_body))</div><div class="line">        </div><div class="line">        <span class="built_in">return</span> result_list</div><div class="line"></div><div class="line">    def remove_auth(self):</div><div class="line">        <span class="comment"># 删除用户认证的参数</span></div><div class="line"></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> auth_params:</div><div class="line">            <span class="keyword">if</span> self.param.has_key(i):</div><div class="line">                self.remove_param.append(i)</div><div class="line">                self.param.pop(i)</div><div class="line"></div><div class="line">    def get_response(self):</div><div class="line">        <span class="comment"># 重放接口获取返回值</span></div><div class="line"></div><div class="line">        current_url = <span class="string">“”</span></div><div class="line">        response_body = <span class="string">“”</span></div><div class="line"></div><div class="line">        try:</div><div class="line">            res=requests.get(url=self.uri, params=self.param, timeout=20, headers=headers)</div><div class="line">        except Exception,e:</div><div class="line">            <span class="built_in">print</span> <span class="string">“[noauth_request:get_response]”</span>+str(e)</div><div class="line"></div><div class="line">            <span class="keyword">if</span> <span class="string">“HTTPSConnectionPool”</span> <span class="keyword">in</span> str(e):</div><div class="line">                try:</div><div class="line">                    res=requests.get(url=self.uri.replace(<span class="string">“http://“</span>,<span class="string">“https://“</span>), params=self.param, timeout=20, headers=headers)</div><div class="line">                except Exception,e:</div><div class="line">                    <span class="built_in">print</span> <span class="string">“[noauth_request:get_response]”</span>+str(e)</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    current_url = res.url</div><div class="line">                    response_body = res.text</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            current_url = res.url</div><div class="line">            response_body = res.text</div><div class="line"></div><div class="line">        <span class="built_in">return</span> response_body,current_url</div></pre></td></tr></table></figure>

<p>说明：此文件为检测未授权访问类，功能比较简单，获取原始请求以及响应包，去除请求接口的cookie以及token等认证后重放，查看返回结果有没有变化。一般情况下还会检测响应包是否包含敏感信息，这里为了方便演示，简化了插件功能。</p>
<h3 id="将jython程序添加到burpsuite中"><a href="#将jython程序添加到burpsuite中" class="headerlink" title="将jython程序添加到burpsuite中"></a><a href="#将jython程序添加到burpsuite中" title="将jython程序添加到burpsuite中"></a>将jython程序添加到burpsuite中</h3><p>选择添加一个插件：<br><img src="/upload_image/20180504/2.png" alt=""><br>注意下图中的标记部分：<br><img src="/upload_image/20180504/3.png" alt=""><br>说明：类型选择python，文件选择入口文件，burpsuite会自动获取本地的依赖文件；输出这里选择在控制台输出，因为此插件没有写ui界面。</p>
<p>加载成功后，会在控制台输出：<br><img src="/upload_image/20180504/4.png" alt=""></p>
<p>然后我们就去开启浏览器代理，关闭bp拦截，愉快的进行web系统测试吧，若插件检测到了未授权访问的接口，则会输出类似如下：</p>
<p><img src="/upload_image/20180504/6.png" alt=""></p>
<h3 id="增加UI界面代码"><a href="#增加UI界面代码" class="headerlink" title="增加UI界面代码"></a><a href="#增加UI界面代码" title="增加UI界面代码"></a>增加UI界面代码</h3><p>在控制台输出的方式总归没有那么优雅，因此如果能像其内置的功能那样在界面上输出就更好了。以下是一段简单的ui界面开发代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line"><span class="comment"># 导入 burp 接口</span></div><div class="line">from burp import IBurpExtender, ITab</div><div class="line"></div><div class="line"><span class="comment"># 导入 Java 库</span></div><div class="line">from javax.swing import JPanel</div><div class="line">from javax.swing import JButton</div><div class="line"></div><div class="line">class BurpExtender(IBurpExtender, ITab):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ 继承burp java父类 ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    def registerExtenderCallbacks(self, callbacks):</div><div class="line">        <span class="comment"># 注册插件信息</span></div><div class="line"></div><div class="line">        self._cb = callbacks <span class="comment"># 回调</span></div><div class="line">        self._hp = callbacks.getHelpers() <span class="comment"># 帮助信息</span></div><div class="line"></div><div class="line">        self._cb.setExtensionName(<span class="string">‘python_test_plugin’</span>) <span class="comment"># 插件名称</span></div><div class="line"></div><div class="line">        <span class="built_in">print</span> <span class="string">‘load python_test_plugin success!’</span></div><div class="line"></div><div class="line">        self.mainPanel = JPanel() <span class="comment"># 面板</span></div><div class="line">        </div><div class="line">        self.testBtn = JButton(u<span class="string">‘一个按钮’</span>, actionPerformed=self.testBtn_onClick) <span class="comment"># 初始化一个 JButton 并绑定单击事件</span></div><div class="line"></div><div class="line">        self.mainPanel.add(self.testBtn) <span class="comment"># 面板中添加这个按钮</span></div><div class="line"></div><div class="line">        self._cb.customizeUiComponent(self.mainPanel) </div><div class="line">        self._cb.addSuiteTab(self)</div><div class="line"></div><div class="line">    def testBtn_onClick(self, event):</div><div class="line">        <span class="comment"># 点击按钮事件</span></div><div class="line"></div><div class="line">        <span class="built_in">print</span> <span class="string">“click button”</span></div><div class="line"></div><div class="line">    def getTabCaption(self):</div><div class="line">        <span class="comment"># 获取tab按钮名称</span></div><div class="line"></div><div class="line">        <span class="built_in">return</span> <span class="string">‘python_test_plugin’</span></div><div class="line"></div><div class="line">    def getUiComponent(self):</div><div class="line">        <span class="comment"># 获取面板内容·</span></div><div class="line"></div><div class="line">        <span class="built_in">return</span> self.mainPanel</div></pre></td></tr></table></figure>

<p>说明：这只是一个ui界面开发的demo，效果如下：</p>
<p><img src="/upload_image/20180504/5.png" alt=""></p>
<h3 id="burp插件开发文档"><a href="#burp插件开发文档" class="headerlink" title="burp插件开发文档"></a><a href="#burp插件开发文档" title="burp插件开发文档"></a>burp插件开发文档</h3><p>这里介绍几个常用的burp类：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">1. 插件入口和帮助接口类：IBurpExtender、IBurpExtenderCallbacks、IExtensionHelpers、IExtensionStateListener</div><div class="line">IBurpExtender接口类是Burp插件的入口，所有Burp的插件均需要实现此接口，并且类命名为BurpExtender。 IBurpExtenderCallbacks接口类是IBurpExtender接口的实现类与Burp其他各个组件（Scanner、Intruder、Spider……）、各个通信对象（HttpRequestResponse、HttpService、SessionHandlingAction）之间的纽带。 IExtensionHelpers、IExtensionStateListener这两个接口类是插件的帮助和管理操作的接口定义。</div><div class="line"></div><div class="line">2. UI相关接口类：IContextMenuFactory、IContextMenuInvocation、ITab、ITextEditor、IMessageEditor、IMenuItemHandler</div><div class="line">这类接口类主要是定义Burp插件的UI显示和动作的处理事件，主要是软件交互中使用。</div><div class="line"></div><div class="line">3. Burp工具组件接口类：IInterceptedProxyMessage、IIntruderAttack、IIntruderPayloadGenerator、IIntruderPayloadGeneratorFactory、IIntruderPayloadProcessor、IProxyListener、IScanIssue、IScannerCheck、IScannerInsertionPoint、IScannerInsertionPointProvider、IScannerListener、IScanQueueItem、IScopeChangeListener</div><div class="line">这些接口类的功能非常好理解，Burp在接口定义的命名中使用了的见名知意的规范，看到接口类的名称，基本就能猜测出来这个接口是适用于哪个工具组件。</div><div class="line"></div><div class="line">4. HTTP消息处理接口类：ICookie、IHttpListener、IHttpRequestResponse、IHttpRequestResponsePersisted、IHttpRequestResponseWithMarkers、IHttpService、IRequestInfo、IParameter、IResponseInfo</div><div class="line"></div><div class="line">这些接口的定义主要是围绕HTTP消息通信过程中涉及的Cookie、Request、Response、Parameter几大消息对象，通过对通信消息头、消息体的数据处理，来达到控制HTTP消息传递的目的。</div></pre></td></tr></table></figure>

<p>关于更多关于burp开发相关的文档，可以参考下：<a href="https://portswigger.net/burp/extender/" target="_blank" rel="noopener">https://portswigger.net/burp/extender/</a></p>
<h3 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a><a href="#本文参考" title="本文参考"></a>本文参考</h3><p><a href="http://xdxd.love/2015/04/20/burpsuite%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E4%B9%8Bpython%E7%AF%87/" target="_blank" rel="noopener">http://xdxd.love/2015/04/20/burpsuite%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E4%B9%8Bpython%E7%AF%87/</a></p>
<p>写不动了<del>~</del></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/04/20/hexo修改默认端口/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/20/hexo修改默认端口/" itemprop="url">hexo修改默认端口</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-20T08:29:31+08:00">
                2018-04-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>默认使用4000端口，用hexo s -p 80 ，可以暂时修改启动端口。</p>
<p>但是每次启动都要写”-p 80”才行，过于繁琐。</p>
<p>修改方法：<br>找到node_modules\hexo-server\index.js文件，可以修改默认的port值！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/04/18/Falcon-For-Python-REST-API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/18/Falcon-For-Python-REST-API/" itemprop="url">Falcon For Python REST API</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-18T08:02:35+08:00">
                2018-04-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>一杯敬明天，一杯敬过往<br>　　说到Web Api，以往我一直使用Django来写，但众所周知Django框架很厚重，用来写web Api未免显得不够简便。虽然Django有一个专门写Api的框架，<a href="https://www.google.com.hk/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0ahUKEwjkrczd297XAhWBypQKHfcKAIcQFggoMAA&amp;url=http%3A%2F%2Fwww.django-rest-framework.org%2F&amp;usg=AOvVaw29pzSINqgKLUWpQ2vWBvg1" target="_blank" rel="noopener"><code>Django REST Framework</code></a>（适合写比较复杂的Api，后面我会单独成文介绍），但感觉还是偏厚重了点。那么有没有几行代码就能写出一个Api的方案呢？Falcon框架就是为此而生的。(除此之外，Flask等框架也可用来写Api，但个人认为最轻便的就属Falcon了)<br><a id="more"></a><br>　　Falcon是一个构建云Api的高性能Python框架，它鼓励使用REST架构风格，尽可能以最少的力气做最多的事情，简单来说它就是用来写Web Api的，有多简便，往下看了就知道。</p>
</blockquote>
<p>Falcon官方文档：<a href="http://falcon.readthedocs.io/en/stable/api/request_and_response.html" target="_blank" rel="noopener">http://falcon.readthedocs.io/en/stable/api/request_and_response.html</a><br>Falcon开源地址：<a href="https://github.com/falconry/falcon" target="_blank" rel="noopener">https://github.com/falconry/falcon</a></p>
<h3 id="Falcon安装"><a href="#Falcon安装" class="headerlink" title="Falcon安装"></a><a href="#Falcon安装" title="Falcon安装"></a>Falcon安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install falcon</div></pre></td></tr></table></figure>

<h3 id="Falcon写一个简单的api"><a href="#Falcon写一个简单的api" class="headerlink" title="Falcon写一个简单的api"></a><a href="#Falcon写一个简单的api" title="Falcon写一个简单的api"></a>Falcon写一个简单的api</h3><p>新建一个app.py文件，写入以下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">from wsgiref import simple_server</div><div class="line">import falcon</div><div class="line"></div><div class="line">class HelloWorld(object):</div><div class="line"></div><div class="line">    def on_get(self, req, resp):</div><div class="line"></div><div class="line">        <span class="built_in">print</span> req.context</div><div class="line">        <span class="built_in">print</span> req.scheme</div><div class="line">        <span class="built_in">print</span> req.params</div><div class="line"></div><div class="line">        resp.status = falcon.HTTP_200</div><div class="line">        resp.body = (<span class="string">‘Get hello world’</span>)</div><div class="line">    </div><div class="line">    def on_post(self, req, resp):</div><div class="line"></div><div class="line">        <span class="built_in">print</span> req.stream.read() 获取post_data</div><div class="line"></div><div class="line">        resp.status = falcon.HTTP_200</div><div class="line">        resp.body = (<span class="string">‘Post hello world’</span>)</div><div class="line"></div><div class="line"></div><div class="line">app = falcon.API()</div><div class="line">hello = HelloWorld()</div><div class="line">app.add_route(<span class="string">‘/‘</span>, hello)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong> == <span class="string">‘<strong>main</strong>‘</span>:</div><div class="line">    httpd = simple_server.make_server(<span class="string">‘127.0.0.1’</span>, 8000, app)</div><div class="line">    httpd.serve_forever()</div></pre></td></tr></table></figure>

<p>运行app.py文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python app.py</div></pre></td></tr></table></figure>

<p>运行程序将会在本地监听8000端口，我们可以使用curl或者http工具测试一番：<br>先发一个GET请求：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">http GET <a href="http://127.0.0.1:8000/" target="_blank" rel="noopener">http://127.0.0.1:8000/</a></div><div class="line"></div><div class="line">HTTP/1.0 200 OK</div><div class="line">Date: Mon, 27 Nov 2017 11:50:36 GMT</div><div class="line">Server: WSGIServer/0.1 Python/2.7.10</div><div class="line">content-length: 15</div><div class="line">content-type: application/json; charset=UTF-8</div><div class="line"></div><div class="line">Get hello world</div></pre></td></tr></table></figure>

<p>尝试发POST请求：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">http POST <a href="http://127.0.0.1:8000/" target="_blank" rel="noopener">http://127.0.0.1:8000/</a></div><div class="line"></div><div class="line">HTTP/1.0 200 OK</div><div class="line">Date: Mon, 27 Nov 2017 11:50:45 GMT</div><div class="line">Server: WSGIServer/0.1 Python/2.7.10</div><div class="line">content-length: 16</div><div class="line">content-type: application/json; charset=UTF-8</div><div class="line"></div><div class="line">Post hello world</div></pre></td></tr></table></figure>

<p>说明：Falcon支持任何类型的请求，比如OPTIONS，PUT，HEAD等，当然前提是需要在app.py代码中定义，定义方式为on_*，比如：on_get、on_post、on_put等。</p>
<p>更复杂一些的api例子，可以参考官网。关于request与response的一些方法，官网有很详细的介绍，这里不再记录。</p>
<h3 id="使用gunicorn代替内置的服务器"><a href="#使用gunicorn代替内置的服务器" class="headerlink" title="使用gunicorn代替内置的服务器"></a><a href="#使用gunicorn代替内置的服务器" title="使用gunicorn代替内置的服务器"></a>使用gunicorn代替内置的服务器</h3><p>使用python app.py的方式运行api，其实是使用了其内置的服务器，类似于django的manage.py。用于生产环境时，通常会使用gunicorn来代替内置的服务器，当然代码也可以简略为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">import falcon</div><div class="line"></div><div class="line">class HelloWorld(object):</div><div class="line"></div><div class="line">    def on_get(self, req, resp):</div><div class="line"></div><div class="line">        <span class="built_in">print</span> req.context</div><div class="line">        <span class="built_in">print</span> req.scheme</div><div class="line">        <span class="built_in">print</span> req.params</div><div class="line"></div><div class="line">        resp.status = falcon.HTTP_200</div><div class="line">        resp.body = (<span class="string">‘Get hello world’</span>)</div><div class="line">    </div><div class="line">    def on_post(self, req, resp):</div><div class="line"></div><div class="line">        resp.status = falcon.HTTP_200</div><div class="line">        resp.body = (<span class="string">‘Post hello world’</span>)</div><div class="line"></div><div class="line"></div><div class="line">app = falcon.API()</div><div class="line">hello = HelloWorld()</div><div class="line">app.add_route(<span class="string">‘/‘</span>, hello)</div></pre></td></tr></table></figure>

<h4 id="安装gunicorn"><a href="#安装gunicorn" class="headerlink" title="安装gunicorn"></a><a href="#安装gunicorn" title="安装gunicorn"></a>安装gunicorn</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install gunicorn</div></pre></td></tr></table></figure>

<h4 id="使用gunicorn"><a href="#使用gunicorn" class="headerlink" title="使用gunicorn"></a><a href="#使用gunicorn" title="使用gunicorn"></a>使用gunicorn</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gunicorn app:app -b 127.0.0.1:8080</div></pre></td></tr></table></figure>

<p>注意：:前的app是指app.py，:后的app是指app.py文件中的app对象。</p>
<p>gunicorn只支持unix（linux、mac），如果是windows用户，可用waitress替代。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ pip install waitress</div><div class="line">$ waitress-serve –port=8000 app:app</div></pre></td></tr></table></figure>

<p>关于gunicorn更多的用法，比如指定端口号之类的，可以<code>gunicorn --help</code>查看帮助。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/04/13/logstash吞吐率优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/13/logstash吞吐率优化/" itemprop="url">logstash吞吐率优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-13T09:03:34+08:00">
                2018-04-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="问题一"><a href="#问题一" class="headerlink" title="问题一"></a><a href="#问题一" title="问题一"></a>问题一</h2><p>最近发现kibana的日志传的很慢，常常查不到日志，由于所有的日志收集都只传输到了一个logstash进行收集和过滤，于是怀疑是否是由于logstash的吞吐量存在瓶颈。一看，还真是到了瓶颈。</p>
<h3 id="优化过程"><a href="#优化过程" class="headerlink" title="优化过程"></a><a href="#优化过程" title="优化过程"></a>优化过程</h3><p>经过查询logstash完整配置文件，有几个参数需要调整</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># pipeline线程数，官方建议是等于CPU内核数</span></span><br><span class="line"><span class="symbol">pipeline.workers:</span> <span class="number">24</span></span><br><span class="line"><span class="meta"># 实际output时的线程数</span></span><br><span class="line"><span class="symbol">pipeline.output.workers:</span> <span class="number">24</span></span><br><span class="line"><span class="meta"># 每次发送的事件数</span></span><br><span class="line"><span class="symbol">pipeline.batch.size:</span> <span class="number">3000</span></span><br><span class="line"><span class="meta"># 发送延时</span></span><br><span class="line"><span class="symbol">pipeline.batch.delay:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>PS:由于我们的ES集群数据量较大（&gt;28T），所以具体配置数值视自身生产环境</p>
<h3 id="优化结果"><a href="#优化结果" class="headerlink" title="优化结果"></a><a href="#优化结果" title="优化结果"></a>优化结果</h3><p>ES的吞吐由每秒9817/s提升到41183/s,具体可以通过x-pack的monitor查看。</p>
<h2 id="问题二"><a href="#问题二" class="headerlink" title="问题二"></a><a href="#问题二" title="问题二"></a>问题二</h2><p>在查看logstash日志过程中，我们看到了大量的以下报错</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">2017-03-18T09:46:21,043</span>][<span class="symbol">INFO </span>][<span class="string">logstash.outputs.elasticsearch</span>] retrying failed action with response code: 429 (&#123;”type”=&gt;”es<span class="emphasis"><em>rejected</em></span>execution_exception”, “reason”=&gt;”rejected execution of org.elasticsearch.transport.TransportService$6@6918cf2e on EsThreadPoolExecutor[bulk, queue capacity = 50, org.elasticsearch.common.util.concurrent.EsThreadPoolExecutor@55337655[Running, pool size = 24, active threads = 24, queued tasks = 50, completed tasks = 1767887463]]”&#125;)</span><br><span class="line">[<span class="string">2017-03-18T09:46:21,043</span>][<span class="symbol">ERROR</span>][<span class="string">logstash.outputs.elasticsearch</span>] Retrying individual actions</span><br></pre></td></tr></table></figure>

<p>查询官网，确认为时ES的写入遇到了瓶颈</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Make sure <span class="built_in">to</span> watch <span class="keyword">for</span> TOO_MANY_REQUESTS (<span class="number">429</span>) response codes (EsRejectedExecutionException <span class="keyword">with</span> <span class="keyword">the</span> Java client), which is <span class="keyword">the</span> way that Elasticsearch tells you that <span class="keyword">it</span> cannot keep up <span class="keyword">with</span> <span class="keyword">the</span> current indexing rate. When <span class="keyword">it</span> happens, you should pause indexing <span class="keyword">a</span> bit <span class="keyword">before</span> trying again, ideally <span class="keyword">with</span> randomized exponential backoff.</span><br></pre></td></tr></table></figure>

<p>我们首先想到的是来调整ES的线程数，但是官网写到”Don’t Touch There Settings!”, 那怎么办？于是乎官方建议我们修改logstash的参数pipeline.batch.size</p>
<p>在ES5.0以后，es将bulk、flush、get、index、search等线程池完全分离，自身的写入不会影响其他功能的性能。<br>来查询一下ES当前的线程情况：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">GET _nodes/stats/thread_pool?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“_nodes”</span>: &#123;</span><br><span class="line">    <span class="string">“total”</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="string">“successful”</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="string">“failed”</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“cluster_name”</span>: <span class="string">“dev-elasticstack5.0”</span>,</span><br><span class="line">  <span class="string">“nodes”</span>: &#123;</span><br><span class="line">    <span class="string">“nnfCv8FrSh-p223gsbJVMA”</span>: &#123;</span><br><span class="line">      <span class="string">“timestamp”</span>: <span class="number">1489804973926</span>,</span><br><span class="line">      <span class="string">“name”</span>: <span class="string">“node-3”</span>,</span><br><span class="line">      <span class="string">“transport_address”</span>: <span class="string">“192.168.3.<strong><em>:9301”</em></strong></span>,</span><br><span class="line">      <span class="string">“host”</span>: <span class="string">“192.168.3.“</span>,</span><br><span class="line">      <span class="string">“ip”</span>: <span class="string">“192.168.3.***:9301”</span>,</span><br><span class="line">      <span class="string">“roles”</span>: [</span><br><span class="line">        <span class="string">“master”</span>,</span><br><span class="line">        <span class="string">“data”</span>,</span><br><span class="line">        <span class="string">“ingest”</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">“attributes”</span>: &#123;</span><br><span class="line">        <span class="string">“rack”</span>: <span class="string">“r1”</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">“thread_pool”</span>: &#123;</span><br><span class="line">        <span class="string">“bulk”</span>: &#123;</span><br><span class="line">          <span class="string">“threads”</span>: <span class="number">24</span>,</span><br><span class="line">          <span class="string">“queue”</span>: <span class="number">214</span>,</span><br><span class="line">          <span class="string">“active”</span>: <span class="number">24</span>,</span><br><span class="line">          <span class="string">“rejected”</span>: <span class="number">30804543</span>,</span><br><span class="line">          <span class="string">“largest”</span>: <span class="number">24</span>,</span><br><span class="line">          <span class="string">“completed”</span>: <span class="number">1047606679</span></span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        ……</span><br><span class="line"></span><br><span class="line">        <span class="string">“watcher”</span>: &#123;</span><br><span class="line">  <span class="string">“threads”</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">“queue”</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">“active”</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">“rejected”</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">“largest”</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">“completed”</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中：”bulk”模板的线程数24，当前活跃的线程数24，证明所有的线程是busy的状态，queue队列214，rejected为30804543。那么问题就找到了，所有的线程都在忙，队列堵满后再有进程写入就会被拒绝，而当前拒绝数为30804543。</p>
<h3 id="优化方案"><a href="#优化方案" class="headerlink" title="优化方案"></a><a href="#优化方案" title="优化方案"></a>优化方案</h3><p>问题找到了，如何优化呢。官方的建议是提高每次批处理的数量，调节传输间歇时间。当batch.size增大，es处理的事件数就会变少，写入也就越快了。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/logstash/logstash.yml</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="symbol">pipeline.workers:</span> <span class="number">24</span></span><br><span class="line"><span class="symbol">pipeline.output.workers:</span> <span class="number">24</span></span><br><span class="line"><span class="symbol">pipeline.batch.size:</span> <span class="number">10000</span></span><br><span class="line"><span class="symbol">pipeline.batch.delay:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>具体的worker/output.workers数量建议等于CPU数，batch.size/batch.delay根据实际的数据量逐渐增大来测试最优值。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/04/13/kafka性能调优/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/13/kafka性能调优/" itemprop="url">kafka性能调优</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-13T08:47:49+08:00">
                2018-04-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Kafka的配置详尽、复杂，想要进行全面的性能调优需要掌握大量信息，这里只记录一下我在日常工作使用中走过的坑和经验来对kafka集群进行优化常用的几点。"><a href="#Kafka的配置详尽、复杂，想要进行全面的性能调优需要掌握大量信息，这里只记录一下我在日常工作使用中走过的坑和经验来对kafka集群进行优化常用的几点。" class="headerlink" title="Kafka的配置详尽、复杂，想要进行全面的性能调优需要掌握大量信息，这里只记录一下我在日常工作使用中走过的坑和经验来对kafka集群进行优化常用的几点。"></a><a href="#Kafka的配置详尽、复杂，想要进行全面的性能调优需要掌握大量信息，这里只记录一下我在日常工作使用中走过的坑和经验来对kafka集群进行优化常用的几点。" title="Kafka的配置详尽、复杂，想要进行全面的性能调优需要掌握大量信息，这里只记录一下我在日常工作使用中走过的坑和经验来对kafka集群进行优化常用的几点。"></a>Kafka的配置详尽、复杂，想要进行全面的性能调优需要掌握大量信息，这里只记录一下我在日常工作使用中走过的坑和经验来对kafka集群进行优化常用的几点。</h2><h3 id="1-JVM的优化"><a href="#1-JVM的优化" class="headerlink" title="1.JVM的优化"></a><a href="#1-JVM的优化" title="1.JVM的优化"></a>1.JVM的优化</h3><p>java相关系统自然离不开JVM的优化。首先想到的肯定是Heap Size的调整。</p>
<p>vim bin/kafka-server-start.sh   </p>
<p>调整KAFKA_HEAP_OPTS=”-Xmx16G -Xms16G”的值<br>推荐配置：一般HEAP SIZE的大小不超过主机内存的50%。</p>
<h3 id="2-网络和ios操作线程配置优化："><a href="#2-网络和ios操作线程配置优化：" class="headerlink" title="2.网络和ios操作线程配置优化："></a><a href="#2-网络和ios操作线程配置优化：" title="2.网络和ios操作线程配置优化："></a>2.网络和ios操作线程配置优化：</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># broker处理消息的最大线程数</span></span><br><span class="line">num.network.<span class="attribute">threads</span>=9</span><br><span class="line"><span class="comment"># broker处理磁盘IO的线程数</span></span><br><span class="line">num.io.<span class="attribute">threads</span>=16</span><br></pre></td></tr></table></figure>

<p>推荐配置：<br>num.network.threads主要处理网络io，读写缓冲区数据，基本没有io等待，配置线程数量为cpu核数加1。</p>
<p>num.io.threads主要进行磁盘io操作，高峰期可能有些io等待，因此配置需要大些。配置线程数量为cpu核数2倍，最大不超过3倍。</p>
<h3 id="3-socket-server可接受数据大小-防止OOM异常-："><a href="#3-socket-server可接受数据大小-防止OOM异常-：" class="headerlink" title="3.socket server可接受数据大小(防止OOM异常)："></a><a href="#3-socket-server可接受数据大小-防止OOM异常-：" title="3.socket server可接受数据大小(防止OOM异常)："></a>3.socket server可接受数据大小(防止OOM异常)：</h3><p>socket.request.max.bytes=2147483600</p>
<p>推荐配置：</p>
<p>根据自己业务数据包的大小适当调大。这里取值是int类型的，而受限于java int类型的取值范围又不能太大：</p>
<p>java int的取值范围为（-2147483648~2147483647），占用4个字节（-2的31次方到2的31次方-1，不能超出，超出之后报错：org.apache.kafka.common.config.ConfigException: Invalid value 8589934592 for configuration socket.request.max.bytes: Not a number of type INT。</p>
<h3 id="4-log数据文件刷盘策略"><a href="#4-log数据文件刷盘策略" class="headerlink" title="4.log数据文件刷盘策略"></a><a href="#4-log数据文件刷盘策略" title="4.log数据文件刷盘策略"></a>4.log数据文件刷盘策略</h3><p>—每当producer写入10000条消息时，刷数据到磁盘—<br>log.flush.interval.messages=10000</p>
<p>—每间隔1秒钟时间，刷数据到磁盘—<br>log.flush.interval.ms=1000</p>
<p>推荐配置：</p>
<p>为了大幅度提高producer写入吞吐量，需要定期批量写文件。一般无需改动，如果topic的数据量较小可以考虑减少log.flush.interval.ms和log.flush.interval.messages来强制刷写数据，减少可能由于缓存数据未写盘带来的不一致。推荐配置分别message 10000，间隔1s。</p>
<h3 id="5-日志保留策略配置"><a href="#5-日志保留策略配置" class="headerlink" title="5.日志保留策略配置"></a><a href="#5-日志保留策略配置" title="5.日志保留策略配置"></a>5.日志保留策略配置</h3><p>—日志保留时长—<br>log.retention.hours=72</p>
<p>—段文件配置—<br>log.segment.bytes=1073741824</p>
<p>推荐配置：</p>
<p>日志建议保留三天，也可以更短；段文件配置1GB，有利于快速回收磁盘空间，重启kafka加载也会加快（kafka启动时是单线程扫描目录(log.dir)下所有数据文件）。如果文件过小，则文件数量比较多。</p>
<h3 id="6-replica复制配置"><a href="#6-replica复制配置" class="headerlink" title="6.replica复制配置"></a><a href="#6-replica复制配置" title="6.replica复制配置"></a>6.replica复制配置</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">num<span class="selector-class">.replica</span><span class="selector-class">.fetchers</span>=<span class="number">3</span></span><br><span class="line">replica<span class="selector-class">.fetch</span><span class="selector-class">.min</span><span class="selector-class">.bytes</span>=<span class="number">1</span></span><br><span class="line">replica<span class="selector-class">.fetch</span><span class="selector-class">.max</span><span class="selector-class">.bytes</span>=<span class="number">5242880</span></span><br></pre></td></tr></table></figure>

<p>推荐配置：</p>
<p>每个follow从leader拉取消息进行同步数据，follow同步性能由这几个参数决定，分别为:</p>
<p>拉取线程数(num.replica.fetchers):fetcher配置多可以提高follower的I/O并发度，单位时间内leader持有更多请求，相应负载会增大，需要根据机器硬件资源做权衡，建议适当调大；</p>
<p>最小字节数(replica.fetch.min.bytes):一般无需更改，默认值即可；</p>
<p>最大字节数(replica.fetch.max.bytes)：默认为1MB，这个值太小，推荐5M，根据业务情况调整</p>
<p>最大等待时间(replica.fetch.wait.max.ms):follow拉取频率，频率过高，leader会积压大量无效请求情况，无法进行数据同步，导致cpu飙升。配置时谨慎使用，建议默认值，无需配置。</p>
<h3 id="7-分区数量配置"><a href="#7-分区数量配置" class="headerlink" title="7.分区数量配置"></a><a href="#7-分区数量配置" title="7.分区数量配置"></a>7.分区数量配置</h3><p>num.partitions=5</p>
<p>推荐配置：</p>
<p>默认partition数量1，如果topic在创建时没有指定partition数量，默认使用此值。Partition的数量选取也会直接影响到Kafka集群的吞吐性能，配置过小会影响消费性能，建议改为5。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/04/12/基于余弦相似性的404页面识别/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/12/基于余弦相似性的404页面识别/" itemprop="url">基于余弦相似性的404页面识别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-13T01:44:08+08:00">
                2018-04-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>也许老街的腔调，是属于我的忧伤</p>
</blockquote>
<p>　　写过爬虫或者漏洞扫描器的朋友肯定遇到过一个问题，就是如何判断一个url对应的页面是个404页面，因为这对之后的逻辑判断尤为重要。然而由于存在一些特殊情况，导致404页面判断没有想象中的那么简单，这往往跟服务器配置有关。本篇作为《<a href="https://thief.one/2018/03/16/1/" target="_blank" rel="noopener">漫谈漏洞扫描器的设计与开发</a>》的一个分支文章，重点谈谈如何判断一个页面是否为404页面。<br><a id="more"></a></p>
<h3 id="404页面"><a href="#404页面" class="headerlink" title="404页面"></a><a href="#404页面" title="404页面"></a>404页面</h3><p>　　一般情况下，判断一个网页是否为404页面，主要看其返回的响应码。若响应码为404，则说明这是一个不存在的页面，若不是则说明是一个存在的页面。然而出于对用户的友好，有些网站往往会优化404页面，大致有以下几种优化方式。</p>
<h4 id="跳转到指定页面"><a href="#跳转到指定页面" class="headerlink" title="跳转到指定页面"></a><a href="#跳转到指定页面" title="跳转到指定页面"></a>跳转到指定页面</h4><p>　　第一种优化方式是：一旦用户访问了一个不存在的页面，服务器会将请求跳转到一个指定的url，往往是网站首页，或者是网站登陆页面。这种情况下，请求一个不存在的页面的响应码会从302变为200（服务端跳转），或者响应码直接为200（客户端跳转，用户可感）；网页内容为网站首页或者网站登陆页面等指定页面的内容。<br>例子：<a href="http://didichuxing.com/nmask" target="_blank" rel="noopener">http://didichuxing.com/nmask</a><br><img src="/upload_image/20180412/6.png" alt=""></p>
<h4 id="跳转到优化后的404页面"><a href="#跳转到优化后的404页面" class="headerlink" title="跳转到优化后的404页面"></a><a href="#跳转到优化后的404页面" title="跳转到优化后的404页面"></a>跳转到优化后的404页面</h4><p>　　第二种优化方式是：一旦用户访问了一个不存在的页面，服务器会将请求跳转到404页面，与第一种方式不同的是跳转后的这个页面确实是404页面，但是是经过特殊处理优化的。这种情况下，请求一个不存在的页面的响应码会从302变为200（服务端跳转），或者响应码为200（客户端跳转），网页内容为一个经过优化的404页面内容。<br>例子：<a href="https://www.jd.com/nmask" target="_blank" rel="noopener">https://www.jd.com/nmask</a><br><img src="/upload_image/20180412/5.png" alt=""></p>
<h4 id="直接显示404页面"><a href="#直接显示404页面" class="headerlink" title="直接显示404页面"></a><a href="#直接显示404页面" title="直接显示404页面"></a>直接显示404页面</h4><p>　　第三种方式是：一旦用户访问了一个不存在的页面，页面直接显示为404页面（服务器默认）。这种情况下，请求一个不存在的页面的响应码可能是404（默认情况），也可能是200，页面内容为默认404或者处理后的404页面。<br>例子：<a href="http://www.alibaba.com/nmask" target="_blank" rel="noopener">http://www.alibaba.com/nmask</a><br><img src="/upload_image/20180412/4.png" alt=""></p>
<h4 id="总结404页面的特征"><a href="#总结404页面的特征" class="headerlink" title="总结404页面的特征"></a><a href="#总结404页面的特征" title="总结404页面的特征"></a>总结404页面的特征</h4><p>　　综上所诉，一个404页面的响应码可能为：404，302，200（当然不排除有其他情况）；一个404页面的页面内容可能是：网站首页内容（指定页面）、优化后的404页面内容、服务器默认的404页面内容。</p>
<h3 id="如何科学的判断一个404页面？"><a href="#如何科学的判断一个404页面？" class="headerlink" title="如何科学的判断一个404页面？"></a><a href="#如何科学的判断一个404页面？" title="如何科学的判断一个404页面？"></a>如何科学的判断一个404页面？</h3><p>综上所诉，我们大致可以得到这样的判断逻辑：(伪代码如下)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> 响应码 == 404:</div><div class="line">    <span class="built_in">return</span> this_is_404_page</div><div class="line"><span class="keyword">elif</span> 目标网页内容 与 网站404页面内容 相似：</div><div class="line">    <span class="built_in">return</span> this_is_404_page</div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="built_in">return</span> this_is_not_404_page</div></pre></td></tr></table></figure>

<p>　　但要通过以上的逻辑判断，需要解决两个问题。问题一：如何提前收集网站的404页面内容；问题二：如何判断目标网页内容与网站404页面内容是否相似。<br>　　先解决下问题一，这个比较好解决，我们可以构造一些不存在的路径（比如:/this_is_a_404_nmask_page），请求获取页面内容。<br>　　第二个问题比较麻烦，首先我们需要注意这里指的是网页相似而非相同。为何这里不直接判断是否相同呢？因为一些404页面内容包含随机因子，比如当前时间，或者页面包含一些推广的信息，导致每个404页面内容都有差异。因此如何判断目标网页内容与网站404页面内容是否相似，而非相同，才是识别一个网页是否为404页面的科学方法。<br>　　那么该如何判断2个网页是否相似呢？这里借鉴了判断文章相似性的算法—余弦相似性算法。那么什么叫余弦相似性算法，它又怎么用于判断网页相似性呢？请往下看。</p>
<h4 id="余弦相似性算法介绍"><a href="#余弦相似性算法介绍" class="headerlink" title="余弦相似性算法介绍"></a><a href="#余弦相似性算法介绍" title="余弦相似性算法介绍"></a>余弦相似性算法介绍</h4><p>假设我们有需求：判断两篇文章是否相似？<br>实现方案：<br>（1）使用TF-IDF算法，找出两篇文章的关键词；<br>（2）每篇文章各取出若干个关键词（比如20个），合并成一个集合，计算每篇文章对于这个集合中的词的词频（为了避免文章长度的差异，可以使用相对词频）；<br>（3）生成两篇文章各自的词频向量；<br>（4）计算两个向量的余弦相似度，值越大就表示越相似。</p>
<p>具体例子：<br>句子A：我/喜欢/看/电视，不/喜欢/看/电影。<br>句子B：我/不/喜欢/看/电视，也/不/喜欢/看/电影。</p>
<p>得出所有分词为：我，喜欢，看，电视，电影，不，也。</p>
<p>计算词频：（出现的次数）<br>句子A：我 1，喜欢 2，看 2，电视 1，电影 1，不 1，也 0。<br>句子B：我 1，喜欢 2，看 2，电视 1，电影 1，不 2，也 1。</p>
<p>计算词频向量：<br>句子A：[1, 2, 2, 1, 1, 1, 0]<br>句子B：[1, 2, 2, 1, 1, 2, 1]<br><img src="/upload_image/20180412/1.png" alt=""></p>
<p>我们可以把它们想象成空间中的两条线段,我们可以通过夹角的大小，来判断向量的相似程度。夹角越小，就代表越相似。</p>
<p>计算公式：<br><img src="/upload_image/20180412/2.png" alt=""></p>
<p>计算结果：<br><img src="/upload_image/20180412/3.png" alt=""></p>
<p>说明：余弦值越接近1，就表明夹角越接近0度，也就是两个向量越相似，这就叫”余弦相似性”。</p>
<h4 id="基于余弦相似性算法的网页相似性判断方法"><a href="#基于余弦相似性算法的网页相似性判断方法" class="headerlink" title="基于余弦相似性算法的网页相似性判断方法"></a><a href="#基于余弦相似性算法的网页相似性判断方法" title="基于余弦相似性算法的网页相似性判断方法"></a>基于余弦相似性算法的网页相似性判断方法</h4><p>下面列举了余弦相似性算法与汉明距离算法，测试发现对于判断网页相似性余弦相似性算法准确率更高一些。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">一）网页标签相似性（筛选出网页所有标签，只选标签名称）</div><div class="line"></div><div class="line">    先计算出两个网页所有标签的向量：</div><div class="line">    A：(a,b,c,d,e,f,g,a,b,c)</div><div class="line">    B：(a,c,b,d,e,f,g,a,c)</div><div class="line"></div><div class="line">    1）计算A与B的汉明距离：</div><div class="line">    a,b,c,d,e,f,g,a,b,c</div><div class="line">    a,c,b,d,e,f,g,a,c</div><div class="line">    ——————————————————</div><div class="line">    0 1 1 0 0 0 0 0 1 1</div><div class="line"></div><div class="line">    A与B的汉明距离为 1+1+1+1=4，相似度为：(10-4)/10=60%</div><div class="line"></div><div class="line">    2）计算A与B的余弦相似性：</div><div class="line">    A: a 2 b 2 c 2 d 1 e 1 f 1 g 1</div><div class="line">    B: a 2 b 1 c 2 d 1 e 1 f 1 g 1</div><div class="line"></div><div class="line">    继续简化：</div><div class="line">    A: [2,2,2,1,1,1,1]</div><div class="line">    B: [2,1,2,1,1,1,1]</div><div class="line"></div><div class="line">    余弦相似性：</div><div class="line"></div><div class="line">                            2<em>2+2</em>1+2<em>2+1</em>1+1<em>1+1</em>1+1<em>1</em></div><div class="line">    ——————————————————————————</div><div class="line">    ((2^2+2^2+2^2+1^2+1^2+1^2+1^2) ** 0.5)  ((2^2+1^2+2^2+1^2+1^2+1^2+1^2) <strong> 0.5)</strong></div><div class="line"></div><div class="line">           14</div><div class="line">    = ————-</div><div class="line">       4 * (130.5)</div><div class="line"></div><div class="line">    = 0.97</div><div class="line"></div><div class="line">    即相似性为97%</div><div class="line"></div><div class="line"></div><div class="line">二）网页文本相似性计算</div><div class="line">与标签判断算法一样，只是需要筛选出网页文本，并进行分词</div></pre></td></tr></table></figure>

<p>说明：汉明距离更注重顺序相似，比如一个网页的标签排序顺序是否相似；而余弦相似性更关注整体标签的个数关系，对顺序不敏感。汉明距离可以看成是点与点间的距离，余弦相似性可以看成是线与线之间的夹角或者说距离。</p>
<h3 id="更加严谨的科学判断"><a href="#更加严谨的科学判断" class="headerlink" title="更加严谨的科学判断"></a><a href="#更加严谨的科学判断" title="更加严谨的科学判断"></a>更加严谨的科学判断</h3><p>　　通过余弦相似性算法，我们大致可以计算出两个网页的相似度。那么看似以上逻辑判断应该就可以判断出404页面了。然而实际情况还要更复杂些，比如如何设置相似度的阀值，还需要大量的打标数据去计算。再比如如何降低一些特殊url带来的误报。这里特殊的url包含网站首页、登陆页面等，因为当访问一些404页面时，可能会跳转到此页面上，导致网页相似性计算结果很接近。这些问题的解决方案这里就不介绍了。</p>
<h3 id="判断404页面的测试接口"><a href="#判断404页面的测试接口" class="headerlink" title="判断404页面的测试接口"></a><a href="#判断404页面的测试接口" title="判断404页面的测试接口"></a>判断404页面的测试接口</h3><p>基于以上理论，我自己部署了一个判断404页面的api接口，可供大家测试一下准确性。<br>api接口地址：<a href="http://api.nmask.cn/not_exist_page_calculation/?target_url=http://www.baidu.com/nmask" target="_blank" rel="noopener">http://api.nmask.cn/not_exist_page_calculation/?target_url=http://www.baidu.com/nmask</a><br>若遇到判断错误的url，可在下方留言，或者邮件：<a href="mailto:tzc@maskghost.com" target="_blank" rel="noopener">tzc@maskghost.com</a>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/04/12/漫谈漏洞扫描器的设计与开发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/12/漫谈漏洞扫描器的设计与开发/" itemprop="url">漫谈漏洞扫描器的设计与开发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-12T08:09:39+08:00">
                2018-04-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>世界の果てまで、君と離れたくない。<br>　　前几天在TSRC换了本《白帽子讲WEB扫描》，昨天凑空拜读了一遍。整体读下来的感觉是，书中关于WEB漏洞扫描器设计与开发所需的知识描述得比较全面，包括一些坑点也有涉及。但对于每一方面的内容描述得不够深入不够细致，适合从0开始学习设计开发漏洞扫描器的工程师，给其提供一些设计思路，避免一些不必要的坑点。当然设计开发扫描器本身就是一个很复杂的工程，作者也不可能在一本书中详细描述，再者有些坑还得自己踩过才知道。<br><a id="more"></a><br>　　本篇文章作为《白帽子讲WEB扫描》一书读后感，或者说读后总结，也算是本人对漏洞扫描器设计与开发的一次总结。在正式开始总结之前，先感谢下本书作者：刘漩，本文很多内容均借鉴此书，若有转载本文，请务必说明出处。</p>
</blockquote>
<p><code>本文涉及到的知识点比较多，我先列个大致介绍目录，请容我慢慢补充完善.....因为篇幅有限，有些内容本文也只做简单介绍（比如爬虫开发），后面我会对每块内容单独成文详细介绍。</code></p>
<h3 id="省略一些前言后语"><a href="#省略一些前言后语" class="headerlink" title="省略一些前言后语"></a><a href="#省略一些前言后语" title="省略一些前言后语"></a>省略一些前言后语</h3><p>　　关于为何要开发一款漏洞扫描器，以及不同扫描器（白、黑、灰）的区别、其作用、有何优缺点等问题，此处省略一万字……</p>
<h3 id="本文概要"><a href="#本文概要" class="headerlink" title="本文概要"></a><a href="#本文概要" title="本文概要"></a>本文概要</h3><p>　　本文主要介绍以下两种扫描器的设计与开发：1）基于URL的WEB漏洞扫描器、2）基于指纹的漏洞扫描器。目前市面上很多商业扫描器是包含这两种扫描功能的，但为了能更清楚的知道其原理，我觉得有必要分别介绍。有必要说明一下的是，本文介绍的扫描器均是<code>主动型扫描器</code>，即会主动发起http请求的。至于被动型扫描器，其主要利用http代理（burpsuite）或者流量镜像（绿盟某扫描器）的方式进行扫描，即不会主动发起请求，只是获取请求的内容进行分析。</p>
<h3 id="如何设计基于URL的WEB漏洞扫描器"><a href="#如何设计基于URL的WEB漏洞扫描器" class="headerlink" title="如何设计基于URL的WEB漏洞扫描器"></a><a href="#如何设计基于URL的WEB漏洞扫描器" title="如何设计基于URL的WEB漏洞扫描器"></a>如何设计基于URL的WEB漏洞扫描器</h3><p>　　从本节标题至少可以读出两点信息：第一漏洞扫描器的输入源是URL，第二漏洞扫描主要针对WEB。开发这样一款扫描器至少需要解决以下两个问题：</p>
<ul>
<li><p>如何采集输入源（即采集网站URL）</p>
<pre><code>*   基于流量清洗
</code></pre><ul>
<li>基于日志提取</li>
<li>基于爬虫爬取</li>
</ul>
</li>
<li><p>如何调用扫描插件（即对URL进行扫描）</p>
</li>
</ul>
<h4 id="从流量中获取URL数据"><a href="#从流量中获取URL数据" class="headerlink" title="从流量中获取URL数据"></a><a href="#从流量中获取URL数据" title="从流量中获取URL数据"></a>从流量中获取URL数据</h4><p>　　一般在甲方开发扫描器会涉及到此块内容，因为基于流量获取url是对业务影响最小，且覆盖面最全的一个方案。而一般乙方开发的商业扫描器很多没有涉及到流量清洗，因为部署等难点。</p>
<h5 id="流量收集获取"><a href="#流量收集获取" class="headerlink" title="流量收集获取"></a><a href="#流量收集获取" title="流量收集获取"></a>流量收集获取</h5><p>　　可以从企业入口主交换机上镜像一份流量到某台服务器上，再通过一些工具从服务器网卡上获取流量，清洗后提取url、post_body、response等数据。获取流量的工具有很多，比如<a href="https://thief.one/2017/09/27/1/" target="_blank" rel="noopener">justniffer</a>，suricata等。</p>
<h5 id="流量中获取扫描源有何坑点"><a href="#流量中获取扫描源有何坑点" class="headerlink" title="流量中获取扫描源有何坑点"></a><a href="#流量中获取扫描源有何坑点" title="流量中获取扫描源有何坑点"></a>流量中获取扫描源有何坑点</h5><p>　　一般流量中是没有https数据的，因为无法解密；流量中包含用户认证信息，如何优雅地处理，使之对用法没有影响。</p>
<h4 id="从日志中获取请求数据"><a href="#从日志中获取请求数据" class="headerlink" title="从日志中获取请求数据"></a><a href="#从日志中获取请求数据" title="从日志中获取请求数据"></a>从日志中获取请求数据</h4><p>　　一般在甲方开发扫描器会涉及到此块内容，因为基于日志获取url也是对业务影响很小，且覆盖面比较全的一个方案。</p>
<h5 id="日志收集获取"><a href="#日志收集获取" class="headerlink" title="日志收集获取"></a><a href="#日志收集获取" title="日志收集获取"></a>日志收集获取</h5><p>怎么在服务器上配置nginx收集日志就不说了，如果对于nginx不熟悉，可移步学习：<a href="https://thief.one/2017/08/22/1/" target="_blank" rel="noopener">nginx负载均衡</a></p>
<h5 id="日志中获取扫描源有何坑点"><a href="#日志中获取扫描源有何坑点" class="headerlink" title="日志中获取扫描源有何坑点"></a><a href="#日志中获取扫描源有何坑点" title="日志中获取扫描源有何坑点"></a>日志中获取扫描源有何坑点</h5><p>　　一般不包含post_body，以及response数据，因为每天产生的日志量非常庞大，如果需要存储这么多数据的话，成本很高，所以一般在服务器上只记录url、时间戳等简单信息。</p>
<h4 id="设计开发一款爬虫"><a href="#设计开发一款爬虫" class="headerlink" title="设计开发一款爬虫"></a><a href="#设计开发一款爬虫" title="设计开发一款爬虫"></a>设计开发一款爬虫</h4><p>　　区别于一般的网络爬虫，漏洞扫描涉及到的爬虫是针对同一个站点爬取所有URL的爬虫。想要开发一款好用的爬虫，前提是必须对HTTP协议熟悉。本文不展开介绍http协议，只总结开发爬虫过程中一些注意的点。如果对爬虫不甚了解，可以移步学习：<br><a href="">Python爬虫基础（不好意思，还没写….）</a><br><a href="">基于Python的漏洞扫描爬虫（不好意思，也还没写….）</a></p>
<h5 id="HEAD替代GET省资源"><a href="#HEAD替代GET省资源" class="headerlink" title="HEAD替代GET省资源"></a><a href="#HEAD替代GET省资源" title="HEAD替代GET省资源"></a>HEAD替代GET省资源</h5><p>　　注意不是所有请求都用HEAD，而是一部分不需要响应主体的请求可以用HEAD代替GET。head请求唯一区别与get请求的是其不会返回响应主体，只有响应头。</p>
<h5 id="有Cookie闯新大陆"><a href="#有Cookie闯新大陆" class="headerlink" title="有Cookie闯新大陆"></a><a href="#有Cookie闯新大陆" title="有Cookie闯新大陆"></a>有Cookie闯新大陆</h5><p>　　有些网站有最基础的反爬策略（检测请求头），或者有些页面需要登录凭证（cookie认证），因此在爬虫中也需要在请求头中加上cookie。</p>
<h5 id="DNS缓存来提速"><a href="#DNS缓存来提速" class="headerlink" title="DNS缓存来提速"></a><a href="#DNS缓存来提速" title="DNS缓存来提速"></a>DNS缓存来提速</h5><p>　　当我们每次请求一个域名时，都会先向dns服务器获取域名对应的ip地址，而这个解析记录一般情况下是不太会变的，因此可以一开始爬取的时候解析一次，然后缓存到系统内，后面的请求直接从系统中获取，可以节省资源。</p>
<h5 id="页面获取新URL"><a href="#页面获取新URL" class="headerlink" title="页面获取新URL"></a><a href="#页面获取新URL" title="页面获取新URL"></a>页面获取新URL</h5><p>涉及获取不同标签内的url，以及处理动态链接、静态链接，同源策略，重复url去除等。</p>
<h5 id="处理页面跳转"><a href="#处理页面跳转" class="headerlink" title="处理页面跳转"></a><a href="#处理页面跳转" title="处理页面跳转"></a>处理页面跳转</h5><p>　　页面跳转主要分为服务端跳转、客户端跳转，具体介绍可移步:<a href="https://thief.one/2016/10/10/%E9%BB%91%E5%B8%BDSEO%E4%B9%8B%E9%A1%B5%E9%9D%A2%E8%B7%B3%E8%BD%AC/" target="_blank" rel="noopener">【黑帽seo系列】页面跳转
</a>。客户端跳转对用户是可见的，即在第一次请求时，响应码为301或者302，在响应头的Location中返回了跳转的地址，第二次请求跳转的地址，再返回结果；而服务端请求对用户不可见，即只有一次请求，跳转是在服务端处理的。</p>
<h5 id="处理识别404页面"><a href="#处理识别404页面" class="headerlink" title="处理识别404页面"></a><a href="#处理识别404页面" title="处理识别404页面"></a>处理识别404页面</h5><p>　　一般网页不存在，响应码便是404。但有些网站为了对用户友好，当访问不存在的页面是会跳转到一个存在的页面（响应码302、301），或者页面直接显示主页内容（响应码200），或者显示404提示页面（响应码200）。针对这些复杂的情况，仅仅对响应码进行判断显然是不够的，需要结合响应码跟页面内容。<br>　　解决方案：先访问一些不存在的页面，获取页面内容，标为C1；再访问目标页面，若响应码为404则表示页面不存在，若不为404，则比较页面源码C2与C1的相似性，若相似也表示不存在。<br>关于如何判断一个页面为404页面的详细内容，请移步：<a href="https://thief.one/2018/04/12/1/" target="_blank" rel="noopener">https://thief.one/2018/04/12/1/</a></p>
<h5 id="处理重复URL"><a href="#处理重复URL" class="headerlink" title="处理重复URL"></a><a href="#处理重复URL" title="处理重复URL"></a>处理重复URL</h5><p>　　去除重复的URL，以免重复抓取相同的页面，当然对于一些相似的URL也需要处理。处理方案可以是将url hash以后存入内存中，比如python的list对象中，然后判断新的url的hash在不在此list中，不存在则将url放入队列进行爬取。</p>
<h5 id="计算页面相似性"><a href="#计算页面相似性" class="headerlink" title="计算页面相似性"></a><a href="#计算页面相似性" title="计算页面相似性"></a>计算页面相似性</h5><p>具体可使用汉明距离计算，这对识别404页面有很大的帮助。</p>
<h5 id="请求断开重试"><a href="#请求断开重试" class="headerlink" title="请求断开重试"></a><a href="#请求断开重试" title="请求断开重试"></a>请求断开重试</h5><p>有些时候由于网络延迟，会导致请求断开，这时候就需要重试，直到次数达到重试次数阀值。</p>
<h5 id="解析页面表单"><a href="#解析页面表单" class="headerlink" title="解析页面表单"></a><a href="#解析页面表单" title="解析页面表单"></a>解析页面表单</h5><p>　　如果单纯只是抓取页面中的URL，会少了很多请求，比如点击事件、表单发送等。获取表单信息比较简单，只要匹配页面中的form标签，以及其内部的input标签。当需要爬虫能够自动填充这些字段内容，比如电话字段，需要填充正确的电话号码，因为大部分网站会在前后端对数据格式进行校验。这就需要维护一个表单字段库，对于每个常见的字段都设置了常用值。</p>
<h5 id="解析事件以及ajax请求"><a href="#解析事件以及ajax请求" class="headerlink" title="解析事件以及ajax请求"></a><a href="#解析事件以及ajax请求" title="解析事件以及ajax请求"></a>解析事件以及ajax请求</h5><p>　　目前很多网页通过ajax发送请求，因此也要求我们的爬虫能够解析ajax请求。包括一些页面上的事件，也需要爬虫去触发。</p>
<h5 id="Web2-0爬虫"><a href="#Web2-0爬虫" class="headerlink" title="Web2.0爬虫"></a><a href="#Web2-0爬虫" title="Web2.0爬虫"></a>Web2.0爬虫</h5><p>　　web2.0与web1.0最大的区别，就是增加了很多动态的内容，很多页面内容是js动态生成的。因此这便要求我们的爬虫有解析js的能力。这里推荐几个模块，<a href="https://thief.one/2017/03/31/Phantomjs%E6%AD%A3%E7%A1%AE%E6%89%93%E5%BC%80%E6%96%B9%E5%BC%8F/" target="_blank" rel="noopener">phantomjs</a>、<a href="https://thief.one/2018/03/06/1/" target="_blank" rel="noopener">chromeheadless</a>等。</p>
<h4 id="维护漏洞库"><a href="#维护漏洞库" class="headerlink" title="维护漏洞库"></a><a href="#维护漏洞库" title="维护漏洞库"></a>维护漏洞库</h4><p>　　简单来说，漏洞扫描器主要分为输入与扫描两大块功能，光有输入源还不行，必须得有扫描能力，而扫描能力主要依靠扫描插件的堆积。</p>
<h4 id="如何优雅地对url进行重放请求"><a href="#如何优雅地对url进行重放请求" class="headerlink" title="如何优雅地对url进行重放请求"></a><a href="#如何优雅地对url进行重放请求" title="如何优雅地对url进行重放请求"></a>如何优雅地对url进行重放请求</h4><p>　　从流量中可以获取到一些url，以及post的数据信息（其中包含了认证），由于我们设计的是主动型扫描器，需要主动发起请求，因此如何去优雅地重放这些请求变成了一个难题。由于有些网站cookie过期时间很长，重放请求势必会造成对业务的影响，而不使用cookie，则很多页面无法访问到。<br>　　一种解决方案可以是对cookie进行替换，换成测试账户的cookie，这样就对用户没有影响了，但是其中的坑也很多。</p>
<h3 id="如何设计基于指纹的漏洞扫描器"><a href="#如何设计基于指纹的漏洞扫描器" class="headerlink" title="如何设计基于指纹的漏洞扫描器"></a><a href="#如何设计基于指纹的漏洞扫描器" title="如何设计基于指纹的漏洞扫描器"></a>如何设计基于指纹的漏洞扫描器</h3><p>　　从本节标题也至少可以看出两个信息：第一漏洞扫描器的输入源是服务指纹，第二漏洞扫描针对WEB+服务。<br>开发这样一款扫描器至少需要以下两个步骤：</p>
<ul>
<li><p>采集输入源（即采集系统指纹）</p>
<pre><code>*   端口扫描
</code></pre><ul>
<li>指纹扫描</li>
<li>指纹匹配</li>
</ul>
</li>
<li><p>调用扫描插件（即匹配指纹进行漏洞扫描）</p>
</li>
</ul>
<h4 id="开发端口扫描器"><a href="#开发端口扫描器" class="headerlink" title="开发端口扫描器"></a><a href="#开发端口扫描器" title="开发端口扫描器"></a>开发端口扫描器</h4><p>　　可以使用python的socket模块开发tcp扫描，或者用<a href="https://thief.one/2017/05/02/1/" target="_blank" rel="noopener">nmap</a>、masscan、zmap等开源工具进行扫描。</p>
<h4 id="开发指纹扫描器"><a href="#开发指纹扫描器" class="headerlink" title="开发指纹扫描器"></a><a href="#开发指纹扫描器" title="开发指纹扫描器"></a>开发指纹扫描器</h4><p>　　可以使用nmap扫描，因为nmap内含了很多指纹探针，可以识别出大部分服务指纹信息。针对web指纹，则需要先发起http请求，获取响应内容，再借助web指纹库识别，或者借助开源的指纹扫描器，比如<a href="https://thief.one/2018/01/11/1/" target="_blank" rel="noopener">Whatweb</a>等。</p>
<h4 id="维护指纹库"><a href="#维护指纹库" class="headerlink" title="维护指纹库"></a><a href="#维护指纹库" title="维护指纹库"></a>维护指纹库</h4><p>　　只有指纹没有指纹库也是不行的，指纹好比是一些身份信息，而我们最终是要定位到某个人，因此还需要有一个指纹库，将指纹信息与人对应起来。</p>
<h3 id="输入源-gt-队列-gt-任务分发-gt-扫描节点-gt-存储-如何设计"><a href="#输入源-gt-队列-gt-任务分发-gt-扫描节点-gt-存储-如何设计" class="headerlink" title="输入源-&gt;队列-&gt;任务分发-&gt;扫描节点-&gt;存储 如何设计"></a><a href="#输入源-gt-队列-gt-任务分发-gt-扫描节点-gt-存储-如何设计" title="输入源-&gt;队列-&gt;任务分发-&gt;扫描节点-&gt;存储 如何设计"></a>输入源-&gt;队列-&gt;任务分发-&gt;扫描节点-&gt;存储 如何设计</h3><p>　　以上简单介绍了设计开发两种扫描器所需要解决的问题，而站在整体角度看，需要解决的问题还远远不够。比如当需要扫描的系统非常庞大时，如何进行分布式的部署，这就要求我们的扫描框架满足分布式部署的需求。</p>
<p>推荐技术栈：python+<a href="https://thief.one/2017/04/06/RabbitMQ/" target="_blank" rel="noopener">rabbitmq</a>+<a href="https://thief.one/2017/08/25/1/" target="_blank" rel="noopener">celery</a>+<a href="https://thief.one/2017/07/26/1/" target="_blank" rel="noopener">mysql</a></p>
<p><code>你以为只有这样就结束了？不不不，今天有点累了，过几天再继续补充，比如添加一些基础的代码以及再补充一些更细的内容。还有，网上有很多资料，我还得先整理学习一波。</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">chucz</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/归档/">
              
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/livecityccz" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:livecityccz@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/livecityccz" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/livecityccz" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/livecityccz" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i>FB Page</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://youtube.com/livecityccz" target="_blank" title="YouTube">
                      
                        <i class="fa fa-fw fa-youtube"></i>YouTube</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chucz</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
