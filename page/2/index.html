<!-- build time:Wed Oct 17 2018 05:57:14 GMT+0000 (Coordinated Universal Time) --><!DOCTYPE html><html class="theme-next muse use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Hexo, NexT"><link rel="alternate" href="/atom.xml" title="褚成志的博客" type="application/atom+xml"><meta name="description" content="关注互联网的科技博客"><meta name="keywords" content="IT"><meta property="og:type" content="website"><meta property="og:title" content="褚成志的博客"><meta property="og:url" content="http://www.chucz.club/page/2/index.html"><meta property="og:site_name" content="褚成志的博客"><meta property="og:description" content="关注互联网的科技博客"><meta property="og:locale" content="zh-Hans"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="褚成志的博客"><meta name="twitter:description" content="关注互联网的科技博客"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"ZM9CKN0W4R",apiKey:"5bc5819b162e1cd440b44b16ef207a44",indexName:"chucz.club",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://www.chucz.club/page/2/"><title>褚成志的博客</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-home"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">褚成志的博客</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">青青子衿, 悠悠我心</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><section id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.chucz.club/2018/08/16/kubernetes-jenkins-ci-cd/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="褚成志"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="褚成志的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/08/16/kubernetes-jenkins-ci-cd/" itemprop="url">kubernetes-jenkins-ci-cd</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-17T07:53:11+08:00">2018-08-17</time></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="流程图："><a href="#流程图：" class="headerlink" title="流程图："></a><a href="#流程图：" title="流程图："></a>流程图：</h3><p>基于Jenkins的CI/CD流程如下所示:<br><img src="https://cos.leiyawu.com/docker/k8s/kubernetes-jenkins-ci-cd.png" alt="kubernetes-jenkins-ci-cd"></p><h3 id="流程说明："><a href="#流程说明：" class="headerlink" title="流程说明："></a><a href="#流程说明：" title="流程说明："></a>流程说明：</h3><ol><li>用户向Gitlab提交代码，代码中必须包含Dockerfile</li><li>将代码提交到远程仓库</li><li>用户在发布应用时需要填写git仓库地址和分支、服务类型、服务名称、资源数量、实例个数，确定后触发Jenkins自动构建</li><li>Jenkins的CI流水线自动编译代码并打包成docker镜像推送到Harbor镜像仓库</li><li>Jenkins的CI流水线中包括了自定义脚本，根据我们已准备好的kubernetes的YAML模板，将其中的变量替换成用户输入的选项</li><li>生成应用的kubernetes YAML配置文件</li><li>更新Ingress的配置，根据新部署的应用的名称，在ingress的配置文件中增加一条路由信息</li><li>更新PowerDNS，向其中插入一条DNS记录，IP地址是边缘节点的IP地址。关于边缘节点，请查看<a href="https://jimmysong.io/kubernetes-handbook/practice/edge-node-configuration.html" target="_blank" rel="noopener">边缘节点配置</a></li><li>Jenkins调用kubernetes的API，部署应用</li></ol></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.chucz.club/2018/07/26/Nginx配置相关笔记/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="褚成志"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="褚成志的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/07/26/Nginx配置相关笔记/" itemprop="url">Nginx配置相关笔记</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-27T03:47:15+08:00">2018-07-27</time></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>好久没更，来水一篇～！～<br>就在刚刚，我花了四百大洋租了台腾讯云香港的服务器（～心在滴血～），因此我的博客终于可以宣告回国了。PS：之前一直使用github-page，众所周知速度贼慢，后面换成了新加坡的VPS服务器，速度就更慢了，没办法只能花大价钱买国内的云服务器。博客迁移得过程比较简单，无非就是添加nginx解析，因此本篇有点水，主要为了记录一下nginx配置web服务的一些笔记。<br><a id="more"></a></p></blockquote><h3 id="http-301-https"><a href="#http-301-https" class="headerlink" title="http 301 https"></a><a href="#http-301-https" title="http 301 https"></a>http 301 https</h3><p>我的博客使用了腾讯云免费签发的证书，因此可以使用https访问，默认情况下http也是可以访问的，那么如何将http请求301重定向到https，便是第一个要解决的问题。<br>编辑/etc/nginx/nginx.conf文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">……</div><div class="line">server &#123;</div><div class="line">       listen         80;</div><div class="line">       server_name    thief.one;</div><div class="line">       <span class="built_in">return</span>         301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">    listen 443;</div><div class="line">    server_name thief.one;</div><div class="line">    ……</div><div class="line">&#125;</div><div class="line">……</div></pre></td></tr></table></figure><p>创建一个80端口，一个443端口的web服务，并且将80端口的服务重定向到<em>https://….</em>。重启nginx后，访问<em><a href="http://thief.one" target="_blank" rel="noopener">http://thief.one</a></em>会被301重定向到<em><a href="https://thief.one" target="_blank" rel="noopener">https://thief.one</a></em></p><h3 id="禁止访问某些目录文件"><a href="#禁止访问某些目录文件" class="headerlink" title="禁止访问某些目录文件"></a><a href="#禁止访问某些目录文件" title="禁止访问某些目录文件"></a>禁止访问某些目录文件</h3><p>由于我的博客项目存放在git上，因此服务器web目录内含有.git目录，也算是敏感信息泄露（当然都是一些静态的网页，其实也没有什么危害），那么如何在nginx中配置访问.git目录403是要解决的第二个问题。<br>编辑/etc/nginx/nginx.conf文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 443;</div><div class="line">    server_name thief.one;</div><div class="line">    ……</div><div class="line"></div><div class="line">    location /.git/ &#123;</div><div class="line">            deny    all;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>添加一个location，禁止访问某目录。重启nginx后，尝试访问<em><a href="https://thief.one/.git/config" target="_blank" rel="noopener">https://thief.one/.git/config</a></em> 返回403</p><h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a><a href="#负载均衡" title="负载均衡"></a>负载均衡</h3><p>这个之前总结过：<a href="https://thief.one/2017/08/22/1/" target="_blank" rel="noopener">https://thief.one/2017/08/22/1/</a></p><h3 id="只能通过域名访问"><a href="#只能通过域名访问" class="headerlink" title="只能通过域名访问"></a><a href="#只能通过域名访问" title="只能通过域名访问"></a>只能通过域名访问</h3><p>如果博客不想通过IP被访问到，需要在nginx上配置禁止ip访问，或者访问ip跳转到域名。<br>编辑/etc/nginx/nginx.conf文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">        listen       80 default_server;</div><div class="line">        listen       443 default_server;</div><div class="line">        <span class="built_in">return</span> 403</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>重启nginx，访问：<em><a href="http://150.109.106.49/" target="_blank" rel="noopener">http://150.109.106.49/</a></em> 返回403。</p><h3 id="权限问题"><a href="#权限问题" class="headerlink" title="权限问题"></a><a href="#权限问题" title="权限问题"></a>权限问题</h3><p>首先说明一下，一般我不推荐使用root权限启动nginx服务。但如果nginx服务是用root权限安装的，且网站放在root目录下，启动nginx解析网站会有权限问题（因为配置文件中默认不是用root权限启动），因此需要更改配置文件为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">user root;</div></pre></td></tr></table></figure><p>更安全的方法是用普通用户权限安装nginx，并将web目录移到普通用户目录下，用普通用户权限启动nginx服务。</p><p><em>nginx配置相关问题笔记，之后我都会记录在此篇中</em></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.chucz.club/2018/07/09/Headless-Chrome-and-API/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="褚成志"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="褚成志的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/07/09/Headless-Chrome-and-API/" itemprop="url">Headless Chrome and API</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-09T08:59:10+08:00">2018-07-09</time></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>我已爬遍了全世界，而你却迟迟不见</p></blockquote><p>自从Google在chrome59版本后加入了 <a href="https://chromium.googlesource.com/chromium/src/+/lkgr/headless/README.md" target="_blank" rel="noopener">Headless Chrome</a>，类似phantomjs、selenium等工具作者都放弃了维护自身的产品（原因可参考文章 <a href="https://paper.seebug.org/537/?from=timeline&amp;isappinstalled=0" target="_blank" rel="noopener">QtWebkit or Headless Chrome</a>）。因此作为使用者的我们也是时候放弃phantomjs，转而研究Headless Chrome了。由于网上对于Headless Chrome的资料还很少，因此我先收集整理一波，随后慢慢学习研究，渐渐将本篇内容补充完善。<br><a id="more"></a></p><h3 id="Headless-Chrome-介绍"><a href="#Headless-Chrome-介绍" class="headerlink" title="Headless Chrome 介绍"></a><a href="#Headless-Chrome-介绍" title="Headless Chrome 介绍"></a>Headless Chrome 介绍</h3><p>headless chrome意思是无头chrome浏览器，相对于传统的chrome浏览器，这是一个可以在后台用命令行操作浏览器的工具，对于爬虫编写以及web自动化测试都有很大的作用。相比较同类工具Phantomjs，其更加强大（主要因为其依赖的webkit更新）。</p><h3 id="Headless-Chrome-安装"><a href="#Headless-Chrome-安装" class="headerlink" title="Headless Chrome 安装"></a><a href="#Headless-Chrome-安装" title="Headless Chrome 安装"></a>Headless Chrome 安装</h3><p>目前只支持mac与linux系统，需要下载chrome浏览器并安装。</p><h4 id="mac-install-headless-chrome"><a href="#mac-install-headless-chrome" class="headerlink" title="mac install headless chrome"></a><a href="#mac-install-headless-chrome" title="mac install headless chrome"></a>mac install headless chrome</h4><p>mac下直接去官网下载安装包即可，mac下chrome浏览器位置，为了方便使用，用alias别名启动。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">alias</span> chrome=<span class="string">“/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome”</span></div><div class="line"><span class="built_in">alias</span> chrome-canary=<span class="string">“/Applications/Google\ Chrome\ Canary.app/Contents/MacOS/Google\ Chrome\ Canary”</span></div><div class="line"><span class="built_in">alias</span> chromium=<span class="string">“/Applications/Chromium.app/Contents/MacOS/Chromium”</span></div></pre></td></tr></table></figure><p>下载<a href="https://www.google.com/chrome/browser/canary.html" target="_blank" rel="noopener">chrome-canary</a>版</p><p>说明：<code>Mac 和 Linux 上的 Chrome 59 都可以运行无需显示模式。对 Windows 的支持将在 Chrome 60 中提供。要检查你使用的 Chrome 版本，请在浏览器中打开 chrome://version。</code></p><h4 id="linux-install-headless-chrome"><a href="#linux-install-headless-chrome" class="headerlink" title="linux install headless chrome"></a><a href="#linux-install-headless-chrome" title="linux install headless chrome"></a>linux install headless chrome</h4><p>添加源：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">vim /etc/yum.repos.d/chrome.repo</div><div class="line">写入以下内容：</div><div class="line"></div><div class="line">[google-chrome]</div><div class="line">name=google-chrome</div><div class="line">baseurl=<a href="http://dl.google.com/linux/chrome/rpm/stable/" target="_blank" rel="noopener">http://dl.google.com/linux/chrome/rpm/stable/</a><span class="variable">$basearch</span></div><div class="line">enabled=1</div><div class="line">gpgcheck=0</div><div class="line">gpgkey=<a href="https://dl-ssl.google.com/linux/linux_signing_key.pub" target="_blank" rel="noopener">https://dl-ssl.google.com/linux/linux_signing_key.pub</a></div></pre></td></tr></table></figure><p>安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y google-chrome-stable</div></pre></td></tr></table></figure><p>测试运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">google-chrome –headless –<span class="built_in">print</span>-to-pdf <a href="https://thief.one" target="_blank" rel="noopener">https://thief.one</a></div></pre></td></tr></table></figure><p>报错处理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Running as root without –no-sandbox is not supported <span class="comment"># 错误信息</span></div></pre></td></tr></table></figure><p>解析方案：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vim /opt/google/chrome/google-chrome</div><div class="line">找到 <span class="built_in">exec</span> -a <span class="string">“<span class="variable">$0</span>“</span> <span class="string">“<span class="variable">$HERE</span>/chrome”</span> <span class="string">“<span class="variable">$@</span>“</span></div><div class="line">改为 <span class="built_in">exec</span> -a <span class="string">“<span class="variable">$0</span>“</span> <span class="string">“<span class="variable">$HERE</span>/chrome”</span> <span class="string">“<span class="variable">$@</span>“</span> –user-data-dir –no-sandbox</div></pre></td></tr></table></figure><p><code>说明：若在安装过程中报错，则将源文件中的gpgcheck改为0</code></p><p>linux安装headless chrome参考：<a href="http://akai-tsuki.hatenablog.com/entry/2017/06/18/000000" target="_blank" rel="noopener">http://akai-tsuki.hatenablog.com/entry/2017/06/18/000000</a></p><h3 id="Headless-Chrome-基础用法"><a href="#Headless-Chrome-基础用法" class="headerlink" title="Headless Chrome 基础用法"></a><a href="#Headless-Chrome-基础用法" title="Headless Chrome 基础用法"></a>Headless Chrome 基础用法</h3><p>HELP信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">chrome \</div><div class="line">–headless \                   <span class="comment"># Runs Chrome in headless mode.</span></div><div class="line">–<span class="built_in">disable</span>-gpu \                <span class="comment"># Temporarily needed for now.</span></div><div class="line">–remote-debugging-address=127.0.0.1</div><div class="line">–remote-debugging-port=9222 \</div><div class="line"> <a href="https://thief.one" target="_blank" rel="noopener">https://thief.one</a>   <span class="comment"># URL to open. Defaults to about:blank.</span></div></pre></td></tr></table></figure><h4 id="访问一个网页获取源码"><a href="#访问一个网页获取源码" class="headerlink" title="访问一个网页获取源码"></a><a href="#访问一个网页获取源码" title="访问一个网页获取源码"></a>访问一个网页获取源码</h4><p>–dump-dom 标志将打印 document.body.innerHTML 到标准输出：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chrome –headless –<span class="built_in">disable</span>-gpu –dump-dom <a href="https://thief.one/" target="_blank" rel="noopener">https://thief.one/</a></div></pre></td></tr></table></figure><h4 id="访问一个网页将源码创建成一个PDF"><a href="#访问一个网页将源码创建成一个PDF" class="headerlink" title="访问一个网页将源码创建成一个PDF"></a><a href="#访问一个网页将源码创建成一个PDF" title="访问一个网页将源码创建成一个PDF"></a>访问一个网页将源码创建成一个PDF</h4><p>–print-to-pdf 标志将页面转出为 PDF 文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chrome –headless –<span class="built_in">disable</span>-gpu –<span class="built_in">print</span>-to-pdf <a href="https://thief.one/" target="_blank" rel="noopener">https://thief.one/</a></div></pre></td></tr></table></figure><h4 id="访问一个网页并截图"><a href="#访问一个网页并截图" class="headerlink" title="访问一个网页并截图"></a><a href="#访问一个网页并截图" title="访问一个网页并截图"></a>访问一个网页并截图</h4><p>使用–screenshot标志运行 Headless Chrome 将在当前工作目录中生成一个名为 screenshot.png的文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">chrome –headless –<span class="built_in">disable</span>-gpu –screenshot <a href="https://thief.one/" target="_blank" rel="noopener">https://thief.one/</a></div><div class="line"></div><div class="line"><span class="comment"># 设置图片大小</span></div><div class="line">chrome –headless –<span class="built_in">disable</span>-gpu –screenshot –window-size=1280,1696 <a href="https://thief.one/" target="_blank" rel="noopener">https://thief.one/</a></div></pre></td></tr></table></figure><h4 id="访问一个网页并进行js交互（REPL模式）"><a href="#访问一个网页并进行js交互（REPL模式）" class="headerlink" title="访问一个网页并进行js交互（REPL模式）"></a><a href="#访问一个网页并进行js交互（REPL模式）" title="访问一个网页并进行js交互（REPL模式）"></a>访问一个网页并进行js交互（REPL模式）</h4><p>–repl 标志可以使 Headless Chrome 运行在一个你可以使用浏览器评估 JS 表达式的模式下。执行下面的命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">chrome –headless –<span class="built_in">disable</span>-gpu –repl <a href="https://thief.one" target="_blank" rel="noopener">https://thief.one</a></div><div class="line">&gt;&gt;&gt; location.href</div><div class="line">&#123;<span class="string">“result”</span>:&#123;<span class="string">“type”</span>:<span class="string">“string”</span>,<span class="string">“value”</span>:<span class="string">“<a href="https://thief.one&quot;" target="_blank" rel="noopener">https://thief.one&quot;</a></span>&#125;&#125;</div><div class="line">&gt;&gt;&gt; quit</div></pre></td></tr></table></figure><h4 id="启动一个监听端口"><a href="#启动一个监听端口" class="headerlink" title="启动一个监听端口"></a><a href="#启动一个监听端口" title="启动一个监听端口"></a>启动一个监听端口</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chrome –remote-debugging-port=9222 –remote-debugging-address=0.0.0.0</div></pre></td></tr></table></figure><p>可以通过浏览器打开：<a href="http://0.0.0.0:9222" target="_blank" rel="noopener">http://0.0.0.0:9222</a></p><h3 id="Headless-Chrome-API"><a href="#Headless-Chrome-API" class="headerlink" title="Headless Chrome API"></a><a href="#Headless-Chrome-API" title="Headless Chrome API"></a>Headless Chrome API</h3><p>以上演示了使用命令行的方式操作headless chrome，那么怎么在代码中使用它呢？<br>api工具如下：<br>官方：<a href="https://github.com/GoogleChrome/puppeteer" target="_blank" rel="noopener">puppeteer</a><br>底层：<a href="https://github.com/cyrus-and/chrome-remote-interface/" target="_blank" rel="noopener">chrome-remote-interface</a><br>活跃：<a href="https://github.com/graphcool/chromeless" target="_blank" rel="noopener">chromeless</a><br>非官方：<a href="https://github.com/yujiosaka/headless-chrome-crawler" target="_blank" rel="noopener">headless-chrome-crawler</a></p><p>Python相关的API：<br><a href="https://github.com/fate0/pychrome" target="_blank" rel="noopener">pychrome</a><br><a href="https://github.com/miyakogi/pyppeteer" target="_blank" rel="noopener">Pyppeteer 推荐</a><br><a href="https://github.com/iiSeymour/chromote" target="_blank" rel="noopener">chromote</a><br><a href="https://github.com/wasiher/chrome_remote_interface_python" target="_blank" rel="noopener">chrome_remote_interface_python</a></p><h4 id="puppeteer-介绍"><a href="#puppeteer-介绍" class="headerlink" title="puppeteer 介绍"></a><a href="#puppeteer-介绍" title="puppeteer 介绍"></a>puppeteer 介绍</h4><p>Puppeteer 是一个由 Chrome 团队开发的 Node 库。它提供了一个高层次的 API 来控制无需显示版（或 完全版）的 Chrome。它与其他自动化测试库，如 Phantom 和 NightmareJS 相类似，但是只适用于最新版本的 Chrome。</p><h4 id="puppeteer-安装"><a href="#puppeteer-安装" class="headerlink" title="puppeteer 安装"></a><a href="#puppeteer-安装" title="puppeteer 安装"></a>puppeteer 安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mkdir puppeteer_test <span class="comment"># 创建一个项目目录</span></div><div class="line"><span class="built_in">cd</span> puppeteer_test</div><div class="line">npm init</div><div class="line">npm i –save puppeteer</div></pre></td></tr></table></figure><p>安装puppeteer前需要在系统上安装nodejs与npm；安装完puppeteer，默认会自动安装最新版本的chromium。<br>注意：<code>系统默认安装的npm与nodejs版本都很低，而使用puppeteer需要node6.4.0+，async/await需要node7.6.0+，因此建议安装node7.6.0版本，否则会导致无法使用。</code></p><h5 id="安装升级nodejs与npm"><a href="#安装升级nodejs与npm" class="headerlink" title="安装升级nodejs与npm"></a><a href="#安装升级nodejs与npm" title="安装升级nodejs与npm"></a>安装升级nodejs与npm</h5><p>要安装puppeteer，需要先安装npm与nodejs，而puppeteer对nodejs版本有要求，因此不能用系统默认安装的nodejs版本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget <a href="http://nodejs.org/dist/v7.6.0/node-v7.6.0-linux-x64.tar.gz" target="_blank" rel="noopener">http://nodejs.org/dist/v7.6.0/node-v7.6.0-linux-x64.tar.gz</a></div><div class="line">tar -zvxf node-v7.6.0-linux-x64.tar.gz</div></pre></td></tr></table></figure><p>共享至全局</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">rm -rf /usr/bin/node /usr/bin/npm</div><div class="line">ln -s /path/node-v7.6.0-linux-x64/bin/node /usr/bin/node  </div><div class="line">ln -s /path/node-v7.6.0-linux-x64/bin/npm /usr/bin/npm</div></pre></td></tr></table></figure><p>若用yum安装过nodejs，需要移除其他版本:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum remove npm</div><div class="line">yum remove nodejs</div></pre></td></tr></table></figure><p>查看nodejs与npm版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">node -v</div><div class="line">npm -v</div></pre></td></tr></table></figure><p>安装升级nodejs过程参考：<a href="http://jeeinn.com/2017/02/236/" target="_blank" rel="noopener">http://jeeinn.com/2017/02/236/</a></p><h4 id="puppeteer-使用"><a href="#puppeteer-使用" class="headerlink" title="puppeteer 使用"></a><a href="#puppeteer-使用" title="puppeteer 使用"></a>puppeteer 使用</h4><p>在使用puppeteer前，先要确定puppeteer、nodejs、npm安装成功（版本正确），且headless chrome安装成功。<br>官方API文档：<a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md" target="_blank" rel="noopener">https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md</a></p><h5 id="打印用户代理："><a href="#打印用户代理：" class="headerlink" title="打印用户代理："></a><a href="#打印用户代理：" title="打印用户代理："></a>打印用户代理：</h5><p>在puppeteer_test目录下创建一个example1.js文件，写入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">const puppeteer = require(<span class="string">‘puppeteer’</span>);</div><div class="line"></div><div class="line">(async() =&gt; &#123;</div><div class="line"> const browser = await puppeteer.launch(&#123;</div><div class="line">    headless: <span class="literal">true</span>,</div><div class="line">    args: [<span class="string">‘–no-sandbox’</span>, <span class="string">‘–disable-setuid-sandbox’</span>],</div><div class="line">&#125;);</div><div class="line"> console.log(await browser.version());</div><div class="line"> browser.close();</div><div class="line">&#125;)();</div></pre></td></tr></table></figure><p>运行代码:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node example1.js</div></pre></td></tr></table></figure><h5 id="获取页面的屏幕截图："><a href="#获取页面的屏幕截图：" class="headerlink" title="获取页面的屏幕截图："></a><a href="#获取页面的屏幕截图：" title="获取页面的屏幕截图："></a>获取页面的屏幕截图：</h5><p>创建一个example2.js文件，写入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">const puppeteer = require(<span class="string">‘puppeteer’</span>);</div><div class="line"></div><div class="line">(async() =&gt; &#123;</div><div class="line"></div><div class="line">const browser = await puppeteer.launch(&#123;</div><div class="line">    headless: <span class="literal">true</span>,</div><div class="line">    args: [<span class="string">‘–no-sandbox’</span>, <span class="string">‘–disable-setuid-sandbox’</span>],</div><div class="line">&#125;);</div><div class="line">const page = await browser.newPage();</div><div class="line">await page.goto(<span class="string">‘<a href="https://thief.one&#39;" target="_blank" rel="noopener">https://thief.one&#39;</a></span>, &#123;waitUntil: <span class="string">‘networkidle2’</span>&#125;);</div><div class="line">await page.pdf(&#123;path: <span class="string">‘screen.pdf’</span>, format: <span class="string">‘A4’</span>&#125;);</div><div class="line"></div><div class="line">browser.close();</div><div class="line">&#125;)();</div></pre></td></tr></table></figure><p>运行代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node example2.js</div></pre></td></tr></table></figure><p>说明：在运行puppeteer之前不需要额外开启一个headless-chrome进程，因为其本身就会去开启。</p><h5 id="发送POST请求获取源码"><a href="#发送POST请求获取源码" class="headerlink" title="发送POST请求获取源码"></a><a href="#发送POST请求获取源码" title="发送POST请求获取源码"></a>发送POST请求获取源码</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">const puppeteer = require(<span class="string">‘puppeteer’</span>);</div><div class="line"></div><div class="line">puppeteer.launch(&#123;headless: <span class="literal">true</span>,args: [<span class="string">‘–no-sandbox’</span>, <span class="string">‘–disable-setuid-sandbox’</span>],&#125;).<span class="keyword">then</span>(async browser =&gt; &#123;</div><div class="line"></div><div class="line">  const page = await browser.newPage();</div><div class="line">  await page.setRequestInterception(<span class="literal">true</span>); // 开启请求捕捉</div><div class="line">  page.on(<span class="string">‘request’</span>, interceptedRequest =&gt; &#123;</div><div class="line">    const overrides = &#123;&#125;;</div><div class="line">    //console.log(interceptedRequest.url()); // 输出捕捉到的请求URL</div><div class="line">    <span class="keyword">if</span> (interceptedRequest.url()==<span class="string">‘<a href="http://127.0.0.1:8000/&#39;" target="_blank" rel="noopener">http://127.0.0.1:8000/&#39;</a></span>)&#123;</div><div class="line">       overrides.method = <span class="string">‘POST’</span>;</div><div class="line">       overrides.postData = <span class="string">‘&#123;”id”:”2”&#125;’</span>;</div><div class="line">    &#125;</div><div class="line">    interceptedRequest.continue(overrides); // 重放</div><div class="line">   &#125;);</div><div class="line">  await page.goto(<span class="string">‘<a href="http://127.0.0.1:8000/&#39;" target="_blank" rel="noopener">http://127.0.0.1:8000/&#39;</a></span>);</div><div class="line">  await console.log(await page.content()); // 输出源码</div><div class="line">  await browser.close();</div><div class="line">&#125;);</div></pre></td></tr></table></figure><h5 id="安装puppeteer报错"><a href="#安装puppeteer报错" class="headerlink" title="安装puppeteer报错"></a><a href="#安装puppeteer报错" title="安装puppeteer报错"></a>安装puppeteer报错</h5><p>在linux下安装puppeteer报错，即:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm i –save puppeteer 命令没有运行成功</div></pre></td></tr></table></figure><p>失败原因可能是linux版本不支持，centos7下成功，centos6下测试失败。</p><h5 id="运行puppeteer报错处理"><a href="#运行puppeteer报错处理" class="headerlink" title="运行puppeteer报错处理"></a><a href="#运行puppeteer报错处理" title="运行puppeteer报错处理"></a>运行puppeteer报错处理</h5><p>报错如下，说明代码语法有问题，或者node版本太低，不符合要求：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SyntaxError: Unexpected token <span class="keyword">function</span></div></pre></td></tr></table></figure><p>报错如下，说明代码中需要设置headless状态为true</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Failed to launch chrome</div></pre></td></tr></table></figure><p>解决方案，修改代码为如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">const browser = await puppeteer.launch(&#123;</div><div class="line">    headless: <span class="literal">true</span>,</div><div class="line">    args: [<span class="string">‘–no-sandbox’</span>, <span class="string">‘–disable-setuid-sandbox’</span>],</div><div class="line">  &#125;);</div></pre></td></tr></table></figure><p>报错如下，与上面解决方案一致：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">1025/084740.006078:ERROR:zygote_host_impl_linux.cc(88)] Running as root without –no-sandbox is not supported. See <a href="https://crbug.com/638180" target="_blank" rel="noopener">https://crbug.com/638180</a>.</div></pre></td></tr></table></figure><h4 id="pyppeteer"><a href="#pyppeteer" class="headerlink" title="pyppeteer"></a><a href="#pyppeteer" title="pyppeteer"></a>pyppeteer</h4><p>pyppeteer模版是对puppeteer的python封装，因为puppeteer是用nodejs写的，所以要在python中使用得用pyppeteer模块。</p><h5 id="pyppeteer安装"><a href="#pyppeteer安装" class="headerlink" title="pyppeteer安装"></a><a href="#pyppeteer安装" title="pyppeteer安装"></a>pyppeteer安装</h5><p>pyppeteer模版只支持python3.5以上版本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python3 -m pip install pyppeteer</div></pre></td></tr></table></figure><h5 id="pyppeteer简单的例子"><a href="#pyppeteer简单的例子" class="headerlink" title="pyppeteer简单的例子"></a><a href="#pyppeteer简单的例子" title="pyppeteer简单的例子"></a>pyppeteer简单的例子</h5><p>截图：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line">from pyppeteer import launch</div><div class="line"></div><div class="line">async def main():</div><div class="line">    browser = await launch(args=[<span class="string">‘–no-sandbox’</span>])</div><div class="line">    page = await browser.newPage()</div><div class="line">    await page.goto(<span class="string">‘<a href="http://example.com&#39;" target="_blank" rel="noopener">http://example.com&#39;</a></span>)</div><div class="line">    await page.screenshot(&#123;<span class="string">‘path’</span>: <span class="string">‘example.png’</span>&#125;)</div><div class="line">    await browser.close()</div><div class="line"></div><div class="line">asyncio.get_event_loop().run_until_complete(main())</div></pre></td></tr></table></figure><p>说明：在使用pyppeteer时，不需要额外开启headless-chrome进程（与puppeteer一样）。更多pyppeteer模版使用方法，参考：<a href="https://miyakogi.github.io/pyppeteer/reference.html#page-class" target="_blank" rel="noopener">https://miyakogi.github.io/pyppeteer/reference.html#page-class</a></p><h5 id="pyppeteer报错处理"><a href="#pyppeteer报错处理" class="headerlink" title="pyppeteer报错处理"></a><a href="#pyppeteer报错处理" title="pyppeteer报错处理"></a>pyppeteer报错处理</h5><p>错误类似如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pyppeteer.errors.BrowserError: Failed to connect to browser port: <a href="http://127.0.0.1:58871/json/version" target="_blank" rel="noopener">http://127.0.0.1:58871/json/version</a></div></pre></td></tr></table></figure><p>解决方案：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">加上：args=[<span class="string">‘–no-sandbox’</span>]，同puppeteer类似。</div><div class="line"></div><div class="line">browser = await launch(args=[<span class="string">‘–no-sandbox’</span>])</div></pre></td></tr></table></figure><h4 id="chrome-remote-interface工具"><a href="#chrome-remote-interface工具" class="headerlink" title="chrome-remote-interface工具"></a><a href="#chrome-remote-interface工具" title="chrome-remote-interface工具"></a>chrome-remote-interface工具</h4><p>可以用来分析渲染一个页面过程中所有的请求过程，包括获取所有的请求接口以及响应内容等。再运行chrome-remote-interface代码前，需要先启动headless chrome进程，即：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chrome –headless –remote-debugging-port=9222</div></pre></td></tr></table></figure><p>安装chrome-remote-interface：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install chrome-remote-interface</div></pre></td></tr></table></figure><p>然后编写代码：(以获取所有请求url为例)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">const CDP = require(<span class="string">‘chrome-remote-interface’</span>);</div><div class="line"></div><div class="line">// node nmask.js <a href="https://nmask.cn" target="_blank" rel="noopener">https://nmask.cn</a></div><div class="line"></div><div class="line">var options = process.argv;</div><div class="line">var target_url = options[2];</div><div class="line"></div><div class="line">CDP((client) =&gt; &#123;</div><div class="line">    // extract domains</div><div class="line">    const &#123;Network, Page&#125; = client;</div><div class="line">    </div><div class="line">    // setup handlers</div><div class="line">    Network.requestWillBeSent((params) =&gt; &#123;</div><div class="line">        console.log(params.request.url);</div><div class="line">    &#125;);</div><div class="line">    Page.loadEventFired(() =&gt; &#123;</div><div class="line">        client.close();</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    // <span class="built_in">enable</span> events <span class="keyword">then</span> start!</div><div class="line">    Promise.all([</div><div class="line">        Network.enable(),</div><div class="line">        Page.enable()</div><div class="line">    ]).<span class="keyword">then</span>(() =&gt; &#123;</div><div class="line">        <span class="built_in">return</span> Page.navigate(&#123;url: target_url&#125;);//输出请求的url</div><div class="line">    &#125;).catch((err) =&gt; &#123;</div><div class="line">        console.error(err);</div><div class="line">        client.close();</div><div class="line">    &#125;);</div><div class="line">&#125;).on(<span class="string">‘error’</span>, (err) =&gt; &#123;</div><div class="line">    console.error(err);</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>运行这段代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node nmask.js <a href="https://thief.one" target="_blank" rel="noopener">https://thief.one</a></div></pre></td></tr></table></figure><h4 id="chromeless介绍"><a href="#chromeless介绍" class="headerlink" title="chromeless介绍"></a><a href="#chromeless介绍" title="chromeless介绍"></a>chromeless介绍</h4><p>chromeless社区比较火热，代码更新也非常频繁，个人比较看好。</p><h4 id="chromeless安装"><a href="#chromeless安装" class="headerlink" title="chromeless安装"></a><a href="#chromeless安装" title="chromeless安装"></a>chromeless安装</h4><p>chromeless对nodejs版本要求是&gt;8.2(centos7下node7.6测试可以)，因此需要先升级nodejs，升级方法参考前文；升级完以后，再安装chromeless项目环境。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mkdir chromeless_test</div><div class="line"><span class="built_in">cd</span> chromeless_test</div><div class="line">npm init</div><div class="line">npm install chromeless</div></pre></td></tr></table></figure><h4 id="chromeless使用"><a href="#chromeless使用" class="headerlink" title="chromeless使用"></a><a href="#chromeless使用" title="chromeless使用"></a>chromeless使用</h4><p>官方API文档：<a href="https://github.com/graphcool/chromeless/blob/master/docs/api.md#api-goto" target="_blank" rel="noopener">https://github.com/graphcool/chromeless/blob/master/docs/api.md#api-goto</a><br>在线代码运行环境：<a href="https://chromeless.netlify.com/#src=" target="_blank" rel="noopener">https://chromeless.netlify.com</a></p><p>创建chromeless_test.js,写入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">const &#123; Chromeless &#125; = require(<span class="string">‘chromeless’</span>)</div><div class="line"></div><div class="line">async <span class="keyword">function</span> <span class="function"><span class="title">run</span></span>() &#123;</div><div class="line">  const chromeless = new Chromeless()</div><div class="line"></div><div class="line">  const screenshot = await chromeless</div><div class="line">    .goto(<span class="string">‘<a href="https://www.baidu.com&#39;" target="_blank" rel="noopener">https://www.baidu.com&#39;</a></span>)</div><div class="line">    //.<span class="built_in">type</span>(<span class="string">‘chromeless’</span>, <span class="string">‘input[name=”q”]’</span>)</div><div class="line">    //.press(13)</div><div class="line">    //.<span class="built_in">wait</span>(<span class="string">‘#resultStats’</span>)</div><div class="line">    .screenshot()</div><div class="line"></div><div class="line">  console.log(screenshot) // prints <span class="built_in">local</span> file path or S3 url</div><div class="line"></div><div class="line">  await chromeless.end()</div><div class="line">&#125;</div><div class="line"></div><div class="line">run().catch(console.error.bind(console))</div></pre></td></tr></table></figure><p>运行代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nohup google-chrome –headless –remote-debugging-port=9222 &amp; <span class="comment">#开启本地headless chrome</span></div><div class="line">node chromeless_test.js</div></pre></td></tr></table></figure><p><code>注意：在运行chromeless前，需要先安装headless chrome，并且需要在本地开启--remote-debugging-port=9222，监听本地9222端口；chromeless也支持使用远程的headless chrome</code></p><h4 id="pychrome工具"><a href="#pychrome工具" class="headerlink" title="pychrome工具"></a><a href="#pychrome工具" title="pychrome工具"></a>pychrome工具</h4><p><code>暂没有研究，尽情期待！</code></p><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a><a href="#常见问题" title="常见问题"></a>常见问题</h3><h4 id="Linux截图中文字体变方块如何解决？"><a href="#Linux截图中文字体变方块如何解决？" class="headerlink" title="Linux截图中文字体变方块如何解决？"></a><a href="#Linux截图中文字体变方块如何解决？" title="Linux截图中文字体变方块如何解决？"></a>Linux截图中文字体变方块如何解决？</h4><p>出现这类问题主要是因为linux服务器字体缺失的问题，解决方案是将字体文件copy到linux服务器/usr/share/fonts/zh_CN目录下。</p><p>第一步：从windows或者mac上获取字体文件，mac上的字体文件地址为：/Library/Fonts，windows字体地址为：c盘下的Windows/Fonts。将Fonts目录打包上传到linux服务器/usr/share/fonts/zh_CN目录下，然后解压。</p><p>第二步：设置权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chmod -R 755 /usr/share/fonts/zh_CN</div></pre></td></tr></table></figure><p>第三步：生成fonts.scale</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum -y install ttmkfdir</div><div class="line">ttmkfdir -e /usr/share/X11/fonts/encodings/encodings.dir</div></pre></td></tr></table></figure><p>第四步：修改字体配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vim /etc/fonts/fonts.conf</div><div class="line"></div><div class="line"></div><div class="line">在&lt;dir&gt;….&lt;/dir&gt;列表中添加字体</div><div class="line"></div><div class="line">如：&lt;dir&gt;/usr/share/fonts/zh_CN/Fonts&lt;/dir&gt;</div></pre></td></tr></table></figure><p>第五步：刷新字体缓存</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">fc</span>-cache</div></pre></td></tr></table></figure><h4 id="命令行运行headless-chrome需要使用–disable-gpu参数吗？"><a href="#命令行运行headless-chrome需要使用–disable-gpu参数吗？" class="headerlink" title="命令行运行headless chrome需要使用–disable-gpu参数吗？"></a><a href="#命令行运行headless-chrome需要使用–disable-gpu参数吗？" title="命令行运行headless chrome需要使用–disable-gpu参数吗？"></a>命令行运行headless chrome需要使用–disable-gpu参数吗？</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">目前–<span class="built_in">disable</span>-gpu 标志在处理一些bug时是需要的，在未来版本的 Chrome 中就不需要了。</div></pre></td></tr></table></figure><h4 id="系统仍然需要安装Xvfb吗？"><a href="#系统仍然需要安装Xvfb吗？" class="headerlink" title="系统仍然需要安装Xvfb吗？"></a><a href="#系统仍然需要安装Xvfb吗？" title="系统仍然需要安装Xvfb吗？"></a>系统仍然需要安装Xvfb吗？</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">不需要，Headless Chrome 不使用窗口，所以不需要像 Xvfb 这样的显示服务器。</div><div class="line"></div><div class="line">你问什么是 Xvfb？</div><div class="line">Xvfb 是一个用于类 Unix 系统的运行于内存之内的显示服务器，可以让你运行图形应用程序（如 Chrome），而无需附加的物理显示器。许多人使用 Xvfb 运行早期版本的 Chrome 进行 “headless” 测试。</div></pre></td></tr></table></figure><h4 id="如何创建一个运行-Headless-Chrome-的-Docker-容器？"><a href="#如何创建一个运行-Headless-Chrome-的-Docker-容器？" class="headerlink" title="如何创建一个运行 Headless Chrome 的 Docker 容器？"></a><a href="#如何创建一个运行-Headless-Chrome-的-Docker-容器？" title="如何创建一个运行 Headless Chrome 的 Docker 容器？"></a>如何创建一个运行 Headless Chrome 的 Docker 容器？</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">查看 lighthouse-ci。它有一个使用 Ubuntu 作为基础镜像的 Dockerfile 示例，并且在 App Engine Flexible 容器中安装和运行了 Lighthouse。</div></pre></td></tr></table></figure><h4 id="headless-chrome和-PhantomJS-有什么关系？"><a href="#headless-chrome和-PhantomJS-有什么关系？" class="headerlink" title="headless chrome和 PhantomJS 有什么关系？"></a><a href="#headless-chrome和-PhantomJS-有什么关系？" title="headless chrome和 PhantomJS 有什么关系？"></a>headless chrome和 PhantomJS 有什么关系？</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Headless Chrome 和 PhantomJS 是类似的工具。它们都可以用来在无需显示的环境中进行自动化测试。两者的主要不同在于 Phantom 使用了一个较老版本的 WebKit 作为它的渲染引擎，而 Headless Chrome 使用了最新版本的 Blink。</div></pre></td></tr></table></figure><p><code>下篇将介绍分布式漏扫爬虫框架的设计与实现，以及写爬虫过程中需要注意的点</code></p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a><a href="#参考文章" title="参考文章"></a>参考文章</h3><p><a href="https://zhuanlan.zhihu.com/p/29207391" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/29207391</a><br><a href="https://developers.google.com/web/updates/2017/04/headless-chrome" target="_blank" rel="noopener">https://developers.google.com/web/updates/2017/04/headless-chrome</a><br><a href="https://juejin.im/entry/58fd5e645c497d005803b6a4" target="_blank" rel="noopener">https://juejin.im/entry/58fd5e645c497d005803b6a4</a><br><a href="http://csbun.github.io/blog/2017/09/puppeteer/" target="_blank" rel="noopener">http://csbun.github.io/blog/2017/09/puppeteer/</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.chucz.club/2018/06/24/Supervisord管理进程实践/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="褚成志"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="褚成志的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/06/24/Supervisord管理进程实践/" itemprop="url">Supervisord管理进程实践</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-25T02:59:38+08:00">2018-06-25</time></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>小孩在门前唱着歌<br>阳光它照暖了溪河<br>今天凑空研究了下Supervisord，这是一款linux进程管理工具，使用python开发，主要用于在后台维护进程（类似master守护进程），可以实现监控进程的状态、自动重启进程等操作，便于一些服务的维护与监控。<br><a id="more"></a></p></blockquote><h3 id="安装Supervisord"><a href="#安装Supervisord" class="headerlink" title="安装Supervisord"></a><a href="#安装Supervisord" title="安装Supervisord"></a>安装Supervisord</h3><p>由于是用python开发的，因此使用pip安装最为方便。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pip install supervisor</div></pre></td></tr></table></figure><p>说明：安装完成之后多了3个工具：echo_supervisord_conf、supervisorctl和supervisord。</p><h3 id="Supervisord配置文件"><a href="#Supervisord配置文件" class="headerlink" title="Supervisord配置文件"></a><a href="#Supervisord配置文件" title="Supervisord配置文件"></a>Supervisord配置文件</h3><p>首先可以使用echo_supervisord_conf命令获取supervisor配置模板：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo_supervisord_conf &gt; supervisord.conf</div></pre></td></tr></table></figure><p>说明：该命令在当前目录下创建了一个文件名为supervisord.conf的配置文件，编辑配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim supervisord.conf</div></pre></td></tr></table></figure><p>来看看默认配置文件中的主要配置项：（还有一些配置不常用，可以忽略）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[unix_http_server]</div><div class="line">file=/tmp/supervisor.sock   ; UNIX socket 文件，supervisorctl 会使用</div><div class="line">;chmod=0700                 ; socket 文件的 mode，默认是 0700</div><div class="line">;chown=nobody:nogroup       ; socket 文件的 owner，格式： uid:gid</div><div class="line"></div><div class="line">;[inet_http_server]         ; HTTP 服务器，提供 web 管理界面</div><div class="line">;port=127.0.0.1:9001        ; Web 管理后台运行的 IP 和端口，如果开放到公网，需要注意安全性</div><div class="line">;username=user              ; 登录管理后台的用户名</div><div class="line">;password=123               ; 登录管理后台的密码</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">logfile=/tmp/supervisord.log ; 日志文件，默认是 <span class="variable">$CWD</span>/supervisord.log</div><div class="line">logfile_maxbytes=50MB        ; 日志文件大小，超出会 rotate，默认 50MB</div><div class="line">logfile_backups=10           ; 日志文件保留备份数量默认 10</div><div class="line">loglevel=info                ; 日志级别，默认 info，其它: debug,warn,trace</div><div class="line">pidfile=/tmp/supervisord.pid ; pid 文件</div><div class="line">nodaemon=<span class="literal">false</span>               ; 是否在前台启动，默认是 <span class="literal">false</span>，即以 daemon 的方式启动</div><div class="line">minfds=1024                  ; 可以打开的文件描述符的最小值，默认 1024</div><div class="line">minprocs=200                 ; 可以打开的进程数的最小值，默认 200</div><div class="line"></div><div class="line">; the below section must remain <span class="keyword">in</span> the config file <span class="keyword">for</span> RPC</div><div class="line">; (supervisorctl/web interface) to work, additional interfaces may be</div><div class="line">; added by defining them <span class="keyword">in</span> separate rpcinterface: sections</div><div class="line">[rpcinterface:supervisor]</div><div class="line">supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface</div><div class="line"></div><div class="line">[supervisorctl]</div><div class="line">serverurl=unix:///tmp/supervisor.sock ; 通过 UNIX socket 连接 supervisord，路径与 unix_http_server 部分的 file 一致</div><div class="line">;serverurl=<a href="http://127.0.0.1:9001" target="_blank" rel="noopener">http://127.0.0.1:9001</a> ; 通过 HTTP 的方式连接 supervisord</div><div class="line"></div><div class="line">; 包含其他的配置文件</div><div class="line">[include]</div><div class="line">files = relative/directory/<em>.ini    ; 可以是 </em>.conf 或 *.ini</div></pre></td></tr></table></figure><p>运行以下命令启动supervisord进程，可测试supervisord是否安装成功并执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisord -c supervisord.conf</div></pre></td></tr></table></figure><p>查看系统进程中是否多了一个supervisord：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps -aux | grep supervisord</div></pre></td></tr></table></figure><h3 id="配置Program"><a href="#配置Program" class="headerlink" title="配置Program"></a><a href="#配置Program" title="配置Program"></a>配置Program</h3><p>program就是用来配置监控不同的应用程序进程的，推荐每个应用程序单独写一个program配置文件，然后在supervisord.conf中通过include加载所有应用程序的配置。<br>这里拿创建一个celery进程为例，首先在supervisord.conf最后一行写入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">;加载/etc/supervisor/目录下所有的配置文件</div><div class="line">[include]</div><div class="line">files = /etc/supervisor/*.conf</div></pre></td></tr></table></figure><p>然后创建/etc/supervisor目录，并到目录下创建/etc/supervisor/celery_touchscan.conf文件，写入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">;program名称，随便写，但不要重复，是program的唯一标识</div><div class="line">[program:celery_touchscan]</div><div class="line">;指定运行目录</div><div class="line">directory=/root/TouchScanV2/ </div><div class="line">;运行目录下执行命令</div><div class="line"><span class="built_in">command</span>=celery -A scan worker –queue=touchscan –pidfile=<span class="string">“./log/pid.txt”</span> –logfile=<span class="string">“./log/scan.log”</span> -c 10</div><div class="line">;进程名称</div><div class="line">process_name=%(program_name)s_%(process_num)02d</div><div class="line"></div><div class="line">;启动设置</div><div class="line">numprocs=1         ;进程数，注意：（celery进程数量,不是work数量，相当于执行了10个<span class="built_in">command</span>命令，而不是在celery中指定-c 为10）</div><div class="line">autostart=<span class="literal">true</span>      ;当supervisor启动时,程序将会自动启动</div><div class="line">autorestart=<span class="literal">true</span>    ;自动重启（当work被<span class="built_in">kill</span>了之后会重新启动）</div><div class="line">;运行程序的用户</div><div class="line">;user=root</div><div class="line">;startsecs=1 ;程序重启时候停留在runing状态的秒数</div><div class="line">;startretries=10 ;启动失败时的最多重试次数</div><div class="line"></div><div class="line">;停止信号,默认TERM</div><div class="line">;中断:INT (类似于Ctrl+C)(<span class="built_in">kill</span> -INT pid)，退出后会将写文件或日志(推荐)</div><div class="line">;终止:TERM (<span class="built_in">kill</span> -TERM pid)</div><div class="line">;挂起:HUP (<span class="built_in">kill</span> -HUP pid),注意与Ctrl+Z/<span class="built_in">kill</span> -stop pid不同</div><div class="line">;从容停止:QUIT (<span class="built_in">kill</span> -QUIT pid)</div><div class="line">stopsignal=INT</div></pre></td></tr></table></figure><p>重启supervisord进程：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisorctl -c supervisord.conf reload</div></pre></td></tr></table></figure><p>此时查看系统上的进程，发现创建了一个supervisord守护进程，10个celery的work进程（celery的work进程数量取决于command命令中的-c参数以及配置文件中的numprocs参数，numprocs参数是指运行几次command命令，而在celery命令行中指定了需要运行的work数量）</p><p><img src="/upload_image/20180601/1.png" alt=""><br><img src="/upload_image/20180601/2.png" alt=""></p><p>说明：此时如果手动kill掉celery的work进程，会发现celery的work进程会被supervisord自动重启，只有当supervisord守护进程被kill以后，才能真正kill掉celery的work进程。</p><h3 id="supervisord命令行操作"><a href="#supervisord命令行操作" class="headerlink" title="supervisord命令行操作"></a><a href="#supervisord命令行操作" title="supervisord命令行操作"></a>supervisord命令行操作</h3><h4 id="启动supervisord进程"><a href="#启动supervisord进程" class="headerlink" title="启动supervisord进程"></a><a href="#启动supervisord进程" title="启动supervisord进程"></a>启动supervisord进程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisord -c supervisord.conf</div></pre></td></tr></table></figure><h4 id="关闭supervisord进程"><a href="#关闭supervisord进程" class="headerlink" title="关闭supervisord进程"></a><a href="#关闭supervisord进程" title="关闭supervisord进程"></a>关闭supervisord进程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisorctl -c supervisord.conf shutdown <span class="comment">#注意这里将supervisord进程关闭，但通过supervisord启动的进程没有关闭</span></div></pre></td></tr></table></figure><h4 id="重启supervisord进程"><a href="#重启supervisord进程" class="headerlink" title="重启supervisord进程"></a><a href="#重启supervisord进程" title="重启supervisord进程"></a>重启supervisord进程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisorctl -c supervisord.conf reload</div></pre></td></tr></table></figure><h4 id="查看进程状态"><a href="#查看进程状态" class="headerlink" title="查看进程状态"></a><a href="#查看进程状态" title="查看进程状态"></a>查看进程状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisorctl</div></pre></td></tr></table></figure><p>效果如下：<br><img src="/upload_image/20180601/3.png" alt=""><br>每列分别代表：programe名称、进程名称，进程状态、进程id，运行时间</p><h4 id="更多supervisorctl命令"><a href="#更多supervisorctl命令" class="headerlink" title="更多supervisorctl命令"></a><a href="#更多supervisorctl命令" title="更多supervisorctl命令"></a>更多supervisorctl命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ supervisorctl status</div><div class="line">$ supervisorctl stop celery_touchscan <span class="comment"># celery_touchscan是一个program的名称</span></div><div class="line">$ supervisorctl start celery_touchscan</div><div class="line">$ supervisorctl restart celery_touchscan</div><div class="line">$ supervisorctl reread</div><div class="line">$ supervisorctl update</div></pre></td></tr></table></figure><p>说明：可以直接在系统shell中执行，也可以先执行supervisorctl，进入supervisorctl_shell中执行相应的命令。</p><h4 id="针对Python环境"><a href="#针对Python环境" class="headerlink" title="针对Python环境"></a><a href="#针对Python环境" title="针对Python环境"></a>针对Python环境</h4><p>如果项目使用了python的pyenv模块来设置环境，则supervisord配置文件中需要指定python环境的路径。其中有两种方式指定程序使用的Python环境：</p><ul><li>command使用绝对路径。</li><li>通过environment配置PYTHONPATH。</li></ul><h3 id="使用supervisord注意点"><a href="#使用supervisord注意点" class="headerlink" title="使用supervisord注意点"></a><a href="#使用supervisord注意点" title="使用supervisord注意点"></a>使用supervisord注意点</h3><h4 id="子进程问题"><a href="#子进程问题" class="headerlink" title="子进程问题"></a><a href="#子进程问题" title="子进程问题"></a>子进程问题</h4><p>有时候用Supervisor托管的程序还会有子进程，如果只杀死主进程，子进程就可能变成孤儿进程。通过以下这两项配置来确保所有子进程都能正确停止：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">stopasgroup=<span class="literal">true</span></div><div class="line">killasgroup=<span class="literal">true</span></div></pre></td></tr></table></figure><h4 id="配置更新"><a href="#配置更新" class="headerlink" title="配置更新"></a><a href="#配置更新" title="配置更新"></a>配置更新</h4><p>每次修改supervisord配置文件后，需要重启supervisord进程。</p><h4 id="后台程序问题"><a href="#后台程序问题" class="headerlink" title="后台程序问题"></a><a href="#后台程序问题" title="后台程序问题"></a>后台程序问题</h4><p>Supervisor只能管理在前台运行的程序，所以如果应用程序有后台运行的选项，需要关闭。</p><h3 id="supervisord与定时任务"><a href="#supervisord与定时任务" class="headerlink" title="supervisord与定时任务"></a><a href="#supervisord与定时任务" title="supervisord与定时任务"></a>supervisord与定时任务</h3><p>supervisord主要用来管理进程，而不是调度任务，因此如果有定时任务的需求，跟结合crontab一起使用。当然如果是管理celery服务，可以结合celery自身的定时任务功能，具体可移步：<a href="https://thief.one/2017/08/25/1/" target="_blank" rel="noopener">https://thief.one/2017/08/25/1/</a></p><h3 id="supervisord-xml-rpc"><a href="#supervisord-xml-rpc" class="headerlink" title="supervisord xml-rpc"></a><a href="#supervisord-xml-rpc" title="supervisord xml-rpc"></a>supervisord xml-rpc</h3><p>前面介绍的都是在本地利用supervisord管理进程，那么如何实现在远处管理服务器上的进程呢？supervisord工具提供了相关的api。首先需要在配置文件中打开相关配置信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[inet_http_server]         ; HTTP 服务器，提供 web 管理界面</div><div class="line">port=127.0.0.1:9001        ; Web 管理后台运行的 IP 和端口，如果开放到公网，需要注意安全性</div><div class="line">username=user              ; 登录管理后台的用户名</div><div class="line">password=123               ; 登录管理后台的密码</div></pre></td></tr></table></figure><p>然后启动supervisord后，可以用web界面管理进程，打开<em><a href="http://127.0.0.1:9001" target="_blank" rel="noopener">http://127.0.0.1:9001</a></em>。当然也提供了rpc接口，可供远程调用，代码样例如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">import xmlrpclib</div><div class="line">server = xmlrpclib.Server(<span class="string">‘<a href="http://user:123@127.0.0.1:9111/RPC2&#39;" target="_blank" rel="noopener">http://user:123@127.0.0.1:9111/RPC2&#39;</a></span>) <span class="comment">#连接rpc服务</span></div><div class="line"><span class="comment"># print server.system.listMethods() # 查询api支持的方法</span></div><div class="line"><span class="comment"># print server.supervisor.getState() # 获取supervisord进程状态</span></div><div class="line"><span class="comment"># print server.supervisor.shutdown() # 关闭supervisor,慎用</span></div><div class="line"><span class="comment"># print server.supervisor.restart() # 重启supervisor</span></div><div class="line"><span class="built_in">print</span> server.supervisor.getProcessInfo(process_name) <span class="comment"># 获取指定进程信息</span></div><div class="line"><span class="built_in">print</span> server.supervisor.startProcess(process_name) <span class="comment"># 启动指定进程</span></div><div class="line"><span class="built_in">print</span> server.supervisor.stopProcess(process_name) <span class="comment"># 暂停指定进程</span></div></pre></td></tr></table></figure><p>api操作比较简单，具体的方法使用文档可以参考：<a href="http://supervisord.org/api.html#xml-rpc" target="_blank" rel="noopener">http://supervisord.org/api.html#xml-rpc</a></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a><a href="#参考" title="参考"></a>参考</h3><p><a href="https://pypi.org/project/supervisor/" target="_blank" rel="noopener">https://pypi.org/project/supervisor/</a><br><a href="https://www.jianshu.com/p/9559ab642d88" target="_blank" rel="noopener">https://www.jianshu.com/p/9559ab642d88</a><br><a href="http://liyangliang.me/posts/2015/06/using-supervisor/" target="_blank" rel="noopener">http://liyangliang.me/posts/2015/06/using-supervisor/</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.chucz.club/2018/06/20/Python3-5协程学习研究/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="褚成志"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="褚成志的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/06/20/Python3-5协程学习研究/" itemprop="url">Python3.5协程学习研究</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-21T07:18:04+08:00">2018-06-21</time></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>今夕何夕故人不来迟暮连山黛</p></blockquote><p>之前有研究过python协程相关的知识，但一直没有进行深入探究。平常工作中使用的也还是以python2为主，然而最近的项目需要使用python3协程相关的内容，因此凑出时间学习了一番python3的协程语法。<br>本篇主要以介绍python3.5的async/await协程语法为主，因为这种语法看上去很别扭，不容易理解。如果对python协程基础不是很了解，建议可以先看此篇：<a href="https://thief.one/2017/02/20/Python%E5%8D%8F%E7%A8%8B/" target="_blank" rel="noopener">Python协程</a>。<br><a id="more"></a></p><h3 id="协程函数（异步函数）"><a href="#协程函数（异步函数）" class="headerlink" title="协程函数（异步函数）"></a><a href="#协程函数（异步函数）" title="协程函数（异步函数）"></a>协程函数（异步函数）</h3><p>我们平常使用最多的函数都是同步函数，即不同函数执行是按顺序执行的。那么什么是异步函数呢？怎么创建异步函数？怎么在异步函数之间来回切换执行？不急，请往下看。</p><h4 id="创建协程函数"><a href="#创建协程函数" class="headerlink" title="创建协程函数"></a><a href="#创建协程函数" title="创建协程函数"></a>创建协程函数</h4><p>先来看下普通函数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">def test1():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line"></div><div class="line">def test2():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“3”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“4”</span>)</div><div class="line"></div><div class="line">a = test1()</div><div class="line">b = test2()</div><div class="line"><span class="built_in">print</span>(a,<span class="built_in">type</span>(a))</div><div class="line"><span class="built_in">print</span>(b,<span class="built_in">type</span>(b))</div></pre></td></tr></table></figure><p>运行以上代码得到结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">None &lt;class <span class="string">‘NoneType’</span>&gt;</div><div class="line">None &lt;class <span class="string">‘NoneType’</span>&gt;</div></pre></td></tr></table></figure><p>说明：程序顺序执行了test1、test2函数，在调用函数的时候就自动进入了函数体，并执行了函数的内容。</p><p>然后使用async关键词将普通函数变成协程函数，即异步函数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">async def test1():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line"></div><div class="line">async def test2():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“3”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“4”</span>)</div><div class="line"></div><div class="line"><span class="built_in">print</span>(test1())</div><div class="line"><span class="built_in">print</span>(test2())</div></pre></td></tr></table></figure><p>运行以上代码得到结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;coroutine object test1 at 0x109f4c620&gt;</div><div class="line">asyncio_python3_test.py:16: RuntimeWarning: coroutine <span class="string">‘test1’</span> was never awaited</div><div class="line">  <span class="built_in">print</span>(test1())</div><div class="line">&lt;coroutine object test2 at 0x109f4c620&gt;</div><div class="line">asyncio_python3_test.py:17: RuntimeWarning: coroutine <span class="string">‘test2’</span> was never awaited</div><div class="line">  <span class="built_in">print</span>(test2())</div></pre></td></tr></table></figure><p>说明：忽略结果中的告警，可以看到调用函数test1、test2的时候，并没有进入函数体且执行函数内容，而是返回了一个coroutine（协程对象）。</p><p>除了函数外，类的方法也可以使用async关键词将其变成协程方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">class <span class="built_in">test</span>:</div><div class="line">    async def run(self):</div><div class="line">        <span class="built_in">print</span>(<span class="string">“1”</span>)</div></pre></td></tr></table></figure><h4 id="执行协程函数"><a href="#执行协程函数" class="headerlink" title="执行协程函数"></a><a href="#执行协程函数" title="执行协程函数"></a>执行协程函数</h4><p>前面我们成功创建了协程函数，并且在调用函数的时候返回了一个协程对象，那么怎么进入函数体并执行函数内容呢？类似于生成器，可以使用send方法执行函数，修改下前面的代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">async def test1():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line"></div><div class="line">async def test2():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“3”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“4”</span>)</div><div class="line"></div><div class="line">a = test1()</div><div class="line">b = test2()</div><div class="line"></div><div class="line">a.send(None)</div><div class="line">b.send(None)</div></pre></td></tr></table></figure><p>运行以上代码得到以下结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">“asyncio_python3_test.py”</span>, line 19, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    a.send(None)</div><div class="line">StopIteration</div><div class="line">sys:1: RuntimeWarning: coroutine <span class="string">‘test2’</span> was never awaited</div></pre></td></tr></table></figure><p>说明：程序先执行了test1协程函数，当test1执行完时报了StopIteration异常，这是协程函数执行完饭回的一个异常，我们可以用try except捕捉，来用判断协程函数是否执行完毕。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">async def test1():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line"></div><div class="line">async def test2():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“3”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“4”</span>)</div><div class="line"></div><div class="line">a = test1()</div><div class="line">b = test2()</div><div class="line"></div><div class="line">try:</div><div class="line">    a.send(None) <span class="comment"># 可以通过调用 send 方法，执行协程函数</span></div><div class="line">except StopIteration as e:</div><div class="line">    <span class="built_in">print</span>(e.value)</div><div class="line">    <span class="comment"># 协程函数执行结束时会抛出一个StopIteration 异常，标志着协程函数执行结束，返回值在value中</span></div><div class="line">    pass</div><div class="line">try:</div><div class="line">    b.send(None) <span class="comment"># 可以通过调用 send 方法，执行协程函数</span></div><div class="line">except StopIteration:</div><div class="line">    <span class="built_in">print</span>(e.value)</div><div class="line">    <span class="comment"># 协程函数执行结束时会抛出一个StopIteration 异常，标志着协程函数执行结束，返回值在value中</span></div><div class="line">    pass</div></pre></td></tr></table></figure><p>运行以上代码得到以下结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td></tr></table></figure><p>说明：程序先执行了test1函数，等到test1函数执行完后再执行test2函数。从执行过程上来看目前协程函数与普通函数没有区别，并没有实现异步函数，那么如何交叉运行协程函数呢？</p><h4 id="交叉执行协程函数（await）"><a href="#交叉执行协程函数（await）" class="headerlink" title="交叉执行协程函数（await）"></a><a href="#交叉执行协程函数（await）" title="交叉执行协程函数（await）"></a>交叉执行协程函数（await）</h4><p>通过以上例子，我们发现定义协程函数可以使用async关键词，执行函数可以使用send方法，那么如何实现在两个协程函数间来回切换执行呢？这里需要使用await关键词，修改一下代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line"></div><div class="line">async def test1():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    await asyncio.sleep(1) <span class="comment"># asyncio.sleep(1)返回的也是一个协程对象</span></div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line"></div><div class="line">async def test2():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“3”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“4”</span>)</div><div class="line"></div><div class="line">a = test1()</div><div class="line">b = test2()</div><div class="line"></div><div class="line">try:</div><div class="line">    a.send(None) <span class="comment"># 可以通过调用 send 方法，执行协程函数</span></div><div class="line">except StopIteration:</div><div class="line">    <span class="comment"># 协程函数执行结束时会抛出一个StopIteration 异常，标志着协程函数执行结束</span></div><div class="line">    pass</div><div class="line"></div><div class="line">try:</div><div class="line">    b.send(None) <span class="comment"># 可以通过调用 send 方法，执行协程函数</span></div><div class="line">except StopIteration:</div><div class="line">    pas</div></pre></td></tr></table></figure><p>运行以上函数得到以下结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">3</div><div class="line">4</div></pre></td></tr></table></figure><p>说明：程序先执行test1协程函数，在执行到await时，test1函数停止了执行（阻塞）；接着开始执行test2协程函数，直到test2执行完毕。从结果中，我们可以看到，直到程序运行完毕，test1函数也没有执行完（没有执行print(“2”)），那么如何使test1函数执行完毕呢？可以使用asyncio自带的方法循环执行协程函数。</p><h4 id="await与阻塞"><a href="#await与阻塞" class="headerlink" title="await与阻塞"></a><a href="#await与阻塞" title="await与阻塞"></a>await与阻塞</h4><p>使用async可以定义协程对象，使用await可以针对耗时的操作进行挂起，就像生成器里的yield一样，函数让出控制权。协程遇到await，事件循环将会挂起该协程，执行别的协程，直到其他的协程也挂起或者执行完毕，再进行下一个协程的执行，协程的目的也是让一些耗时的操作异步化。</p><p>注意点：await后面跟的必须是一个Awaitable对象，或者实现了相应协议的对象，查看Awaitable抽象类的代码，表明了只要一个类实现了<strong>await</strong>方法，那么通过它构造出来的实例就是一个Awaitable，并且Coroutine类也继承了Awaitable。</p><h4 id="自动循环执行协程函数"><a href="#自动循环执行协程函数" class="headerlink" title="自动循环执行协程函数"></a><a href="#自动循环执行协程函数" title="自动循环执行协程函数"></a>自动循环执行协程函数</h4><p>通过前面介绍我们知道执行协程函数需要使用send方法，但一旦协程函数执行过程中切换到其他函数了，那么这个函数就不在被继续运行了，并且使用sned方法不是很高效。那么如何在执行整个程序过程中，自动得执行所有的协程函数呢，就如同多线程、多进程那样，隐式得执行而不是显示的通过send方法去执行函数。</p><h5 id="事件循环方法"><a href="#事件循环方法" class="headerlink" title="事件循环方法"></a><a href="#事件循环方法" title="事件循环方法"></a>事件循环方法</h5><p>前面提到的问题就需要用到事件循环方法去解决，即asyncio.get_event_loop方法，修改以上代码如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line"></div><div class="line">async def test1():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    await test2()</div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line"></div><div class="line">async def test2():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“3”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“4”</span>)</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">loop.run_until_complete(test1())</div></pre></td></tr></table></figure><p>运行以上代码得到以下结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">3</div><div class="line">4</div><div class="line">2</div></pre></td></tr></table></figure><p>说明：asyncio.get_event_loop方法可以创建一个事件循环，然后使用run_until_complete将协程注册到事件循环，并启动事件循环。</p><h5 id="task任务"><a href="#task任务" class="headerlink" title="task任务"></a><a href="#task任务" title="task任务"></a>task任务</h5><p>由于协程对象不能直接运行，在注册事件循环的时候，其实是run_until_complete方法将协程包装成为了一个任务（task）对象。所谓task对象是Future类的子类，保存了协程运行后的状态，用于未来获取协程的结果。我们也可以手动将协程对象定义成task，修改以上代码如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line"></div><div class="line">async def test1():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    await test2()</div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line"></div><div class="line">async def test2():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“3”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“4”</span>)</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">task = loop.create_task(test1())</div><div class="line">loop.run_until_complete(task)</div></pre></td></tr></table></figure><p>说明：前面说到task对象保存了协程运行的状态，并且可以获取协程函数运行的返回值，那么具体该如何获取呢？这里可以分两种方式，一种需要绑定回调函数，另外一种则直接在运行完task任务后输出。值得一提的是，如果使用send方法执行函数，则返回值可以通过捕捉StopIteration异常，利用StopIteration.value获取。</p><h5 id="直接输出task结果"><a href="#直接输出task结果" class="headerlink" title="直接输出task结果"></a><a href="#直接输出task结果" title="直接输出task结果"></a>直接输出task结果</h5><p>当协程函数运行结束后，我们需要得到其返回值，第一种方式就是等到task状态为finish时，调用task的result方法获取返回值。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line"></div><div class="line">async def test1():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    await test2()</div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line">    <span class="built_in">return</span> <span class="string">“stop”</span></div><div class="line"></div><div class="line">async def test2():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“3”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“4”</span>)</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">task = asyncio.ensure_future(test1())</div><div class="line">loop.run_until_complete(task)</div><div class="line"><span class="built_in">print</span>(task.result())</div></pre></td></tr></table></figure><p>运行以上代码得到以下结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">3</div><div class="line">4</div><div class="line">2</div><div class="line">stop</div></pre></td></tr></table></figure><h5 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a><a href="#回调函数" title="回调函数"></a>回调函数</h5><p>获取返回值的第二种方法是可以通过绑定回调函数，在task执行完毕的时候可以获取执行的结果，回调的最后一个参数是future对象，通过该对象可以获取协程返回值。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line"></div><div class="line">async def test1():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    await test2()</div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line">    <span class="built_in">return</span> <span class="string">“stop”</span></div><div class="line"></div><div class="line">async def test2():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“3”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“4”</span>)</div><div class="line"></div><div class="line">def callback(future):</div><div class="line">    <span class="built_in">print</span>(<span class="string">‘Callback:’</span>,future.result()) <span class="comment"># 通过future对象的result方法可以获取协程函数的返回值</span></div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">task = asyncio.ensure_future(test1()) <span class="comment"># 创建task，test1()是一个协程对象</span></div><div class="line">task.add_done_callback(callback) <span class="comment"># 绑定回调函数</span></div><div class="line">loop.run_until_complete(task)</div></pre></td></tr></table></figure><p>运行以上代码得到以下结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">3</div><div class="line">4</div><div class="line">2</div><div class="line">Callback: stop</div></pre></td></tr></table></figure><p>如果回调函数需要接受多个参数，可以通过偏函数导入，修改代码如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line">import functools</div><div class="line"></div><div class="line">async def test1():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    await test2()</div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line">    <span class="built_in">return</span> <span class="string">“stop”</span></div><div class="line"></div><div class="line">async def test2():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“3”</span>)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“4”</span>)</div><div class="line"></div><div class="line">def callback(param1,param2,future):</div><div class="line">    <span class="built_in">print</span>(param1,param2)</div><div class="line">    <span class="built_in">print</span>(<span class="string">‘Callback:’</span>,future.result())</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">task = asyncio.ensure_future(test1())</div><div class="line">task.add_done_callback(functools.partial(callback,<span class="string">“param1”</span>,<span class="string">“param2”</span>))</div><div class="line">loop.run_until_complete(task)</div></pre></td></tr></table></figure><p>说明：回调函数中的future对象就是创建的task对象。</p><h5 id="future对象"><a href="#future对象" class="headerlink" title="future对象"></a><a href="#future对象" title="future对象"></a>future对象</h5><p>future对象有几个状态：Pending、Running、Done、Cancelled。创建future的时候，task为pending，事件循环调用执行的时候当然就是running，调用完毕自然就是done，如果需要停止事件循环，就需要先把task取消，可以使用asyncio.Task获取事件循环的task。</p><h5 id="协程停止"><a href="#协程停止" class="headerlink" title="协程停止"></a><a href="#协程停止" title="协程停止"></a>协程停止</h5><p>前面介绍了使用事件循环执行协程函数，那么怎么停止执行呢？在停止执行协程前，需要先取消task，然后再停止loop事件循环。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line"></div><div class="line">async def test1():</div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    await asyncio.sleep(3)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line">    <span class="built_in">return</span> <span class="string">“stop”</span></div><div class="line"></div><div class="line">tasks = [</div><div class="line">    asyncio.ensure_future(test1()),</div><div class="line">    asyncio.ensure_future(test1()),</div><div class="line">    asyncio.ensure_future(test1()),</div><div class="line">]</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">try:</div><div class="line">    loop.run_until_complete(asyncio.wait(tasks))</div><div class="line">except KeyboardInterrupt as e:</div><div class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> asyncio.Task.all_tasks():</div><div class="line">        task.cancel()</div><div class="line">    loop.stop()</div><div class="line">    loop.run_forever()</div><div class="line">finally:</div><div class="line">    loop.close()</div></pre></td></tr></table></figure><p>运行以上代码，按ctrl+c可以结束执行。</p><h3 id="本文中用到的一些概念及方法"><a href="#本文中用到的一些概念及方法" class="headerlink" title="本文中用到的一些概念及方法"></a><a href="#本文中用到的一些概念及方法" title="本文中用到的一些概念及方法"></a>本文中用到的一些概念及方法</h3><ul><li>event_loop事件循环：程序开启一个无限的循环，当把一些函数注册到事件循环上时，满足事件发生条件即调用相应的函数。</li><li>coroutine协程对象：指一个使用async关键字定义的函数，它的调用不会立即执行函数，而是会返回一个协程对象，协程对象需要注册到事件循环，由事件循环调用。</li><li>task任务：一个协程对象就是一个原生可以挂起的函数，任务则是对协程进一步封装，其中包含任务的各种状态。</li><li>future：代表将来执行或没有执行的任务的结果，它和task上没有本质的区别</li><li>async/await关键字：python3.5用于定义协程的关键字，async定义一个协程，await用于挂起阻塞的异步调用接口。</li></ul><h3 id="并发与并行"><a href="#并发与并行" class="headerlink" title="并发与并行"></a><a href="#并发与并行" title="并发与并行"></a>并发与并行</h3><p>并发通常指有多个任务需要同时进行，并行则是同一时刻有多个任务执行。用多线程、多进程、协程来说，协程实现并发，多线程与多进程实现并行。</p><h4 id="asyncio协程如何实现并发"><a href="#asyncio协程如何实现并发" class="headerlink" title="asyncio协程如何实现并发"></a><a href="#asyncio协程如何实现并发" title="asyncio协程如何实现并发"></a>asyncio协程如何实现并发</h4><p>asyncio想要实现并发，就需要多个协程来完成任务，每当有任务阻塞的时候就await，然后其他协程继续工作，这需要创建多个协程的列表，然后将这些协程注册到事件循环中。这里指的多个协程，可以是多个协程函数，也可以是一个协程函数的多个协程对象。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line"></div><div class="line">async def test1():</div><div class="line"></div><div class="line">    <span class="built_in">print</span>(<span class="string">“1”</span>)</div><div class="line">    await asyncio.sleep(1)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“2”</span>)</div><div class="line">    <span class="built_in">return</span> <span class="string">“stop”</span></div><div class="line"></div><div class="line">a = test1()</div><div class="line">b = test1()</div><div class="line">c = test1()</div><div class="line"></div><div class="line">tasks = [</div><div class="line">    asyncio.ensure_future(a),</div><div class="line">    asyncio.ensure_future(b),</div><div class="line">    asyncio.ensure_future(c),</div><div class="line">]</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">loop.run_until_complete(asyncio.wait(tasks)) <span class="comment"># 注意asyncio.wait方法</span></div><div class="line"><span class="keyword">for</span> task <span class="keyword">in</span> tasks:</div><div class="line">    <span class="built_in">print</span>(<span class="string">“task result is “</span>,task.result())</div></pre></td></tr></table></figure><p>运行以上代码得到以下结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">1</div><div class="line">1</div><div class="line">2</div><div class="line">2</div><div class="line">2</div><div class="line">task result is  stop</div><div class="line">task result is  stop</div><div class="line">task result is  stop</div></pre></td></tr></table></figure><p>说明：代码先是定义了三个协程对象，然后通过asyncio.ensure_future方法创建了三个task，并且将所有的task加入到了task列表，最终使用loop.run_until_complete将task列表添加到事件循环中。</p><h3 id="协程爬虫"><a href="#协程爬虫" class="headerlink" title="协程爬虫"></a><a href="#协程爬虫" title="协程爬虫"></a>协程爬虫</h3><p>前面介绍了如何使用async与await创建协程函数，使用asyncio.get_event_loop创建事件循环并执行协程函数。例子很好地展示了协程并发的高效，但在实际应用场景中该如何开发协程程序？比如说异步爬虫。我尝试用requests模块、urllib模块写异步爬虫，但实际操作发现并不支持asyncio异步，因此可以使用aiohttp模块编写异步爬虫。</p><h4 id="aiohttp实现"><a href="#aiohttp实现" class="headerlink" title="aiohttp实现"></a><a href="#aiohttp实现" title="aiohttp实现"></a>aiohttp实现</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line">import aiohttp</div><div class="line"></div><div class="line">async def run(url):</div><div class="line">    <span class="built_in">print</span>(<span class="string">“start spider “</span>,url)</div><div class="line">    async with aiohttp.ClientSession() as session:</div><div class="line">        async with session.get(url) as resp:</div><div class="line">            <span class="built_in">print</span>(resp.url)</div><div class="line"></div><div class="line">url_list = [<span class="string">“<a href="https://thief.one&quot;" target="_blank" rel="noopener">https://thief.one&quot;</a></span>,<span class="string">“<a href="https://home.nmask.cn&quot;" target="_blank" rel="noopener">https://home.nmask.cn&quot;</a></span>,<span class="string">“<a href="https://movie.nmask.cn&quot;" target="_blank" rel="noopener">https://movie.nmask.cn&quot;</a></span>,<span class="string">“<a href="https://tool.nmask.cn&quot;" target="_blank" rel="noopener">https://tool.nmask.cn&quot;</a></span>]</div><div class="line"></div><div class="line">tasks = [asyncio.ensure_future(run(url)) <span class="keyword">for</span> url <span class="keyword">in</span> url_list]</div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">loop.run_until_complete(asyncio.wait(tasks))</div></pre></td></tr></table></figure><p>运行以上代码得到以下结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">start spider  <a href="https://thief.one" target="_blank" rel="noopener">https://thief.one</a></div><div class="line">start spider  <a href="https://home.nmask.cn" target="_blank" rel="noopener">https://home.nmask.cn</a></div><div class="line">start spider  <a href="https://movie.nmask.cn" target="_blank" rel="noopener">https://movie.nmask.cn</a></div><div class="line">start spider  <a href="https://tool.nmask.cn" target="_blank" rel="noopener">https://tool.nmask.cn</a></div><div class="line"><a href="https://movie.nmask.cn" target="_blank" rel="noopener">https://movie.nmask.cn</a></div><div class="line"><a href="https://home.nmask.cn" target="_blank" rel="noopener">https://home.nmask.cn</a></div><div class="line"><a href="https://tool.nmask.cn" target="_blank" rel="noopener">https://tool.nmask.cn</a></div><div class="line"><a href="https://thief.one" target="_blank" rel="noopener">https://thief.one</a></div></pre></td></tr></table></figure><p>说明：aiohttp基于asyncio实现，既可以用来写webserver，也可以当爬虫使用。</p><h4 id="requests实现"><a href="#requests实现" class="headerlink" title="requests实现"></a><a href="#requests实现" title="requests实现"></a>requests实现</h4><p>由于requests模块阻塞了客户代码与asycio事件循环的唯一线程，因此在执行调用时，整个应用程序都会冻结，但如果一定要用requests模块，可以使用事件循环对象的run_in_executor方法，通过run_in_executor方法来新建一个线程来执行耗时函数，因此可以这样修改代码实现：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line">import requests</div><div class="line"></div><div class="line">async def run(url):</div><div class="line">    <span class="built_in">print</span>(<span class="string">“start “</span>,url)</div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    response = await loop.run_in_executor(None, requests.get, url)</div><div class="line">    <span class="built_in">print</span>(response.url)</div><div class="line">    </div><div class="line">url_list = [<span class="string">“<a href="https://thief.one&quot;" target="_blank" rel="noopener">https://thief.one&quot;</a></span>,<span class="string">“<a href="https://home.nmask.cn&quot;" target="_blank" rel="noopener">https://home.nmask.cn&quot;</a></span>,<span class="string">“<a href="https://movie.nmask.cn&quot;" target="_blank" rel="noopener">https://movie.nmask.cn&quot;</a></span>,<span class="string">“<a href="https://tool.nmask.cn&quot;" target="_blank" rel="noopener">https://tool.nmask.cn&quot;</a></span>]</div><div class="line"></div><div class="line">tasks = [asyncio.ensure_future(run(url)) <span class="keyword">for</span> url <span class="keyword">in</span> url_list]</div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">loop.run_until_complete(asyncio.wait(tasks))</div></pre></td></tr></table></figure><p>如果要给requests带上参数，可以使用functools：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line">import requests</div><div class="line">import functools</div><div class="line"></div><div class="line">async def run(url):</div><div class="line">    <span class="built_in">print</span>(<span class="string">“start “</span>,url)</div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    try:</div><div class="line">        response = await loop.run_in_executor(None,functools.partial(requests.get,url=url,params=<span class="string">“”</span>,timeout=1))</div><div class="line">    except Exception as e:</div><div class="line">        <span class="built_in">print</span>(e)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="built_in">print</span>(response.url)</div><div class="line"></div><div class="line">url_list = [<span class="string">“<a href="https://thief.one&quot;" target="_blank" rel="noopener">https://thief.one&quot;</a></span>,<span class="string">“<a href="https://home.nmask.cn&quot;" target="_blank" rel="noopener">https://home.nmask.cn&quot;</a></span>,<span class="string">“<a href="https://movie.nmask.cn&quot;" target="_blank" rel="noopener">https://movie.nmask.cn&quot;</a></span>,<span class="string">“<a href="https://tool.nmask.cn&quot;" target="_blank" rel="noopener">https://tool.nmask.cn&quot;</a></span>]</div><div class="line"></div><div class="line">tasks = [asyncio.ensure_future(run(url)) <span class="keyword">for</span> url <span class="keyword">in</span> url_list]</div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">loop.run_until_complete(asyncio.wait(tasks))</div></pre></td></tr></table></figure><h3 id="asyncio中使用阻塞函数"><a href="#asyncio中使用阻塞函数" class="headerlink" title="asyncio中使用阻塞函数"></a><a href="#asyncio中使用阻塞函数" title="asyncio中使用阻塞函数"></a>asyncio中使用阻塞函数</h3><p>如同前面介绍如何在asyncio中使用requests模块一样，如果想在asyncio中使用其他阻塞函数，该怎么实现呢？虽然目前有异步函数支持asyncio，但实际问题是大部分IO模块还不支持asyncio。</p><h4 id="阻塞函数在asyncio中使用的问题"><a href="#阻塞函数在asyncio中使用的问题" class="headerlink" title="阻塞函数在asyncio中使用的问题"></a><a href="#阻塞函数在asyncio中使用的问题" title="阻塞函数在asyncio中使用的问题"></a>阻塞函数在asyncio中使用的问题</h4><p>阻塞函数(例如io读写，requests网络请求)阻塞了客户代码与asycio事件循环的唯一线程，因此在执行调用时，整个应用程序都会冻结。</p><h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a><a href="#解决方案" title="解决方案"></a>解决方案</h4><p>这个问题的解决方法是使用事件循环对象的run_in_executor方法。asyncio的事件循环在背后维护着一个ThreadPoolExecutor对象，我们可以调用run_in_executor方法，把可调用对象发给它执行，即可以通过run_in_executor方法来新建一个线程来执行耗时函数。</p><h4 id="run-in-executor方法"><a href="#run-in-executor方法" class="headerlink" title="run_in_executor方法"></a><a href="#run-in-executor方法" title="run_in_executor方法"></a>run_in_executor方法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AbstractEventLoop.run_in_executor(executor, func, *args)</div></pre></td></tr></table></figure><ul><li>executor 参数应该是一个 Executor 实例。如果为 None，则使用默认 executor。</li><li>func 就是要执行的函数</li><li>args 就是传递给 func 的参数</li></ul><p>实际例子（使用time.sleep()）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">import asyncio</div><div class="line">import time</div><div class="line"></div><div class="line">async def run(url):</div><div class="line">    <span class="built_in">print</span>(<span class="string">“start “</span>,url)</div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    try:</div><div class="line">        await loop.run_in_executor(None,time.sleep,1)</div><div class="line">    except Exception as e:</div><div class="line">        <span class="built_in">print</span>(e)</div><div class="line">    <span class="built_in">print</span>(<span class="string">“stop “</span>,url)</div><div class="line"></div><div class="line">url_list = [<span class="string">“<a href="https://thief.one&quot;" target="_blank" rel="noopener">https://thief.one&quot;</a></span>,<span class="string">“<a href="https://home.nmask.cn&quot;" target="_blank" rel="noopener">https://home.nmask.cn&quot;</a></span>,<span class="string">“<a href="https://movie.nmask.cn&quot;" target="_blank" rel="noopener">https://movie.nmask.cn&quot;</a></span>,<span class="string">“<a href="https://tool.nmask.cn&quot;" target="_blank" rel="noopener">https://tool.nmask.cn&quot;</a></span>]</div><div class="line"></div><div class="line">tasks = [asyncio.ensure_future(run(url)) <span class="keyword">for</span> url <span class="keyword">in</span> url_list]</div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">loop.run_until_complete(asyncio.wait(tasks))</div></pre></td></tr></table></figure><p>运行以上代码得到以下函数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">start  <a href="https://thief.one" target="_blank" rel="noopener">https://thief.one</a></div><div class="line">start  <a href="https://home.nmask.cn" target="_blank" rel="noopener">https://home.nmask.cn</a></div><div class="line">start  <a href="https://movie.nmask.cn" target="_blank" rel="noopener">https://movie.nmask.cn</a></div><div class="line">start  <a href="https://tool.nmask.cn" target="_blank" rel="noopener">https://tool.nmask.cn</a></div><div class="line">stop  <a href="https://thief.one" target="_blank" rel="noopener">https://thief.one</a></div><div class="line">stop  <a href="https://movie.nmask.cn" target="_blank" rel="noopener">https://movie.nmask.cn</a></div><div class="line">stop  <a href="https://home.nmask.cn" target="_blank" rel="noopener">https://home.nmask.cn</a></div><div class="line">stop  <a href="https://tool.nmask.cn" target="_blank" rel="noopener">https://tool.nmask.cn</a></div></pre></td></tr></table></figure><p>说明：有了run_in_executor方法，我们就可以使用之前熟悉的模块创建协程并发了，而不需要使用特定的模块进行IO异步开发。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a><a href="#参考" title="参考"></a>参考</h3><p><a href="https://www.oschina.net/translate/playing-around-with-await-async-in-python-3-5" target="_blank" rel="noopener">https://www.oschina.net/translate/playing-around-with-await-async-in-python-3-5</a><br><a href="https://www.jianshu.com/p/b5e347b3a17c" target="_blank" rel="noopener">https://www.jianshu.com/p/b5e347b3a17c</a><br><a href="https://zhuanlan.zhihu.com/p/27258289" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/27258289</a><br><a href="https://juejin.im/entry/5aabb949f265da23a04951df" target="_blank" rel="noopener">https://juejin.im/entry/5aabb949f265da23a04951df</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.chucz.club/2018/06/07/利用chrome-remote-interface实现程序化、自动化Web安全测试/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="褚成志"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="褚成志的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/06/07/利用chrome-remote-interface实现程序化、自动化Web安全测试/" itemprop="url">利用chrome_remote_interface实现程序化、自动化Web安全测试</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-07T09:00:27+08:00">2018-06-07</time></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>高考加油！</p></blockquote><p>如果要问有哪些抓包神器或者流量分析工具？以下几款工具是必须要提的，burpsuite（跨平台）、<a href="https://thief.one/2017/04/27/1/" target="_blank" rel="noopener">fiddler</a>（windows下抓包神器）、<a href="https://thief.one/2017/02/09/WireShark%E8%BF%87%E6%BB%A4%E8%A7%84%E5%88%99/" target="_blank" rel="noopener">wireshark</a>（经典网络抓包工具）、<a href="https://thief.one/2017/09/27/1/" target="_blank" rel="noopener">justniffer</a>（与前面几个使用代理获取流量不一样的是，justniffer是基于网卡获取流量）等。以上这几款工具之前我有单独成文介绍过，如有需要可点击蓝色链接移步。<br>那么如果问有哪些程序化的抓包工具？（注明一下这里的程序化指的是可编程）首先burpsuite算一个，因为我们可以开发扩展工具（<a href="https://thief.one/2018/05/04/1/" target="_blank" rel="noopener">burpsuite插件开发之检测越权访问漏洞</a>）；另外fiddle也算一个，可以编辑配置文件，达到扩展功能，之前也介绍过。<br>那么如果问有哪些即可以实现程序化又可以实现自动化的抓包工具？（注明一下这里的自动化是指自动产生流量）这个问题有点拗口，你可能会想为什么一个抓包工具要负责产生流量，流量交给爬虫岂不是更好？这个问题暂且放一放，继续往下看。<br><a id="more"></a></p><h3 id="自动化安全测试"><a href="#自动化安全测试" class="headerlink" title="自动化安全测试"></a><a href="#自动化安全测试" title="自动化安全测试"></a>自动化安全测试</h3><p>平常我们经常会使用burpsuite等工具检测一个网站的安全性，检测方法不外乎使用浏览器访问网站且把流量代理到burpsuite上，然后在burpsuite上通过拦截、修改、重放流量等方式测试网站安全性。然而当要测试的网站非常多时，有没有一个更自动化、更省力的方式去测试呢？方案肯定是有的，简单来说要实现自动化web安全测试无非要解决几个问题，首先是流量怎么产生？然后是怎么从流量中分析出漏洞？</p><h4 id="自动化测试方案：主动扫描器"><a href="#自动化测试方案：主动扫描器" class="headerlink" title="自动化测试方案：主动扫描器"></a><a href="#自动化测试方案：主动扫描器" title="自动化测试方案：主动扫描器"></a>自动化测试方案：主动扫描器</h4><p>市面上基于爬虫的主动扫描器就是一种自动化安全测试工具，首先它的流量是通过爬虫爬取url主动产生的，然后利用一些漏洞插件去构造不同的访问请求。短板：目前市面上扫描器爬虫大多基于web1.0，无法加载js渲染网页，而现在越来越多的网站使用web2.0技术实现前后端数据交互。</p><h4 id="自动化测试方案：被动扫描器"><a href="#自动化测试方案：被动扫描器" class="headerlink" title="自动化测试方案：被动扫描器"></a><a href="#自动化测试方案：被动扫描器" title="自动化测试方案：被动扫描器"></a>自动化测试方案：被动扫描器</h4><p>一些大厂内部自研的被动扫描器，首先它的流量不是通过爬虫主动获取的，而是通过监听交换机等网络设备的网卡流量，然后利用一些漏洞插件去分析流量中存在漏洞的点。短板：适合大厂各业务线安全检查不适合测试某个特定的网站，因为需要人为访问网站产生流量。</p><h4 id="自动化测试方案：selenium-流量获取工具-漏洞插件"><a href="#自动化测试方案：selenium-流量获取工具-漏洞插件" class="headerlink" title="自动化测试方案：selenium+流量获取工具+漏洞插件"></a><a href="#自动化测试方案：selenium-流量获取工具-漏洞插件" title="自动化测试方案：selenium+流量获取工具+漏洞插件"></a>自动化测试方案：selenium+流量获取工具+漏洞插件</h4><p>selenium是一款网站自动化测试工具，可以程序化的操作浏览器，实现自动化产生流量。再结合抓包工具以及漏洞检测插件，应该就可以解决流量获取以及漏洞检测的问题。短板：用selenium只能实现一些简单的浏览器操作，对于检测复杂的网站系统，似乎不够用，而且速度很慢，性能很差。</p><h4 id="自动化测试方案：chrome-remote-interface-漏洞插件"><a href="#自动化测试方案：chrome-remote-interface-漏洞插件" class="headerlink" title="自动化测试方案：chrome_remote_interface+漏洞插件"></a><a href="#自动化测试方案：chrome-remote-interface-漏洞插件" title="自动化测试方案：chrome_remote_interface+漏洞插件"></a>自动化测试方案：chrome_remote_interface+漏洞插件</h4><p>之前我介绍过<a href="https://thief.one/2018/03/06/1/" target="_blank" rel="noopener">headless chrome</a>，也介绍过<a href="https://thief.one/2017/03/31/Phantomjs%E6%AD%A3%E7%A1%AE%E6%89%93%E5%BC%80%E6%96%B9%E5%BC%8F/" target="_blank" rel="noopener">phantomjs</a>等web2.0爬虫工具，目前推荐去学习使用headless-chrome。headless chrome工具是用来自动加载js，获取渲染后的页面源码，解决web2.0爬虫之困。而chrome_remote_interface是一个更底层的工具，可以用来分析协议，简单说就是可以分析整个渲染过程，以及截取分析过程中的流量。就类似您打开了chrome浏览器的审查元素功能，然后刷新一下页面，查看一下network信息。<br><img src="/upload_image/20180607/1.png" alt=""></p><h3 id="chrome-remote-interface介绍"><a href="#chrome-remote-interface介绍" class="headerlink" title="chrome_remote_interface介绍"></a><a href="#chrome-remote-interface介绍" title="chrome_remote_interface介绍"></a>chrome_remote_interface介绍</h3><p>chrome_remote_interface是一个开源项目，<a href="https://github.com/cyrus-and/chrome-remote-interface" target="_blank" rel="noopener">项目地址</a>，并且支持命令行、编码两种方式，且使用node.js开发。</p><h4 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a><a href="#安装使用" title="安装使用"></a>安装使用</h4><p>因为chrome_remote_interface是基于nodejs的，因此需要安装npm包管理工具。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install npm -y</div></pre></td></tr></table></figure><p>然后创建一个目录，初始化一个项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm init</div></pre></td></tr></table></figure><p>在目录下安装chrome_remote_interface</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install chrome-remote-interface</div></pre></td></tr></table></figure><p>创建一个简单的nodejs程序(nmask.js)：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">const CDP = require(<span class="string">‘chrome-remote-interface’</span>);</div><div class="line"></div><div class="line">// node nmask.js <a href="https://nmask.cn" target="_blank" rel="noopener">https://nmask.cn</a></div><div class="line"></div><div class="line">var options = process.argv;</div><div class="line">var target_url = options[2];</div><div class="line"></div><div class="line">CDP((client) =&gt; &#123;</div><div class="line">    // extract domains</div><div class="line">    const &#123;Network, Page&#125; = client;</div><div class="line">    </div><div class="line">    // setup handlers</div><div class="line">    Network.requestWillBeSent((params) =&gt; &#123;</div><div class="line">        console.log(params.request.url);</div><div class="line">    &#125;);</div><div class="line">    Page.loadEventFired(() =&gt; &#123;</div><div class="line">        client.close();</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    // <span class="built_in">enable</span> events <span class="keyword">then</span> start!</div><div class="line">    Promise.all([</div><div class="line">        Network.enable(),</div><div class="line">        Page.enable()</div><div class="line">    ]).<span class="keyword">then</span>(() =&gt; &#123;</div><div class="line">        <span class="built_in">return</span> Page.navigate(&#123;url: target_url&#125;);//输出请求的url</div><div class="line">    &#125;).catch((err) =&gt; &#123;</div><div class="line">        console.error(err);</div><div class="line">        client.close();</div><div class="line">    &#125;);</div><div class="line">&#125;).on(<span class="string">‘error’</span>, (err) =&gt; &#123;</div><div class="line">    console.error(err);</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>说明：在运行这段程序前，必须要在系统上安装chrome以及启动chrome headless监听模式，具体怎么安装chrome headless可以移步：<a href="https://thief.one/2018/03/06/1/" target="_blank" rel="noopener">headless chrome and api</a><br>启动chrome headless监听模式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">chrome –headless –remote-debugging-port=9222</div><div class="line">或者</div><div class="line">google-chrome –headless –remote-debugging-port=9222</div></pre></td></tr></table></figure><p>然后另外开启一个窗口，运行nodejs：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node nmask.js <a href="https://thief.one" target="_blank" rel="noopener">https://thief.one</a></div></pre></td></tr></table></figure><p>运行结果如下：(输出渲染过程中请求的所有url)<br><img src="/upload_image/20180607/2.png" alt=""></p><h3 id="chrome-remote-interface-for-python"><a href="#chrome-remote-interface-for-python" class="headerlink" title="chrome_remote_interface for python"></a><a href="#chrome-remote-interface-for-python" title="chrome_remote_interface for python"></a>chrome_remote_interface for python</h3><p>由于chrome_remote_interface是nodejs实现的，因此对于不熟悉nodejs的朋友来说coding成本比较高。然而好在已经有外国友人用python封装了一个工具，<a href="https://github.com/wasiher/chrome_remote_interface_python" target="_blank" rel="noopener">项目地址</a>，虽然目前此项目尚处于初级阶段，但实实在在地解决了我的问题。</p><h4 id="安装使用-1"><a href="#安装使用-1" class="headerlink" title="安装使用"></a><a href="#安装使用-1" title="安装使用"></a>安装使用</h4><p>基于是用python3.5开发的，那么就clone一下项目，直接安装吧：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> <a href="https://github.com/wasiher/chrome-remote-interface-python.git" target="_blank" rel="noopener">https://github.com/wasiher/chrome-remote-interface-python.git</a></div><div class="line">python3 setup.py install</div></pre></td></tr></table></figure><p>编写一个python版的程序(nmask.py)：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line"><span class="string">‘’</span><span class="string">‘</span></div><div class="line"><strong>author</strong>=”nMask”</div><div class="line"><strong>Date</strong>=”7 Jun 2018”</div><div class="line"><strong>Blog</strong>=”<a href="https://thief.one&quot;" target="_blank" rel="noopener">https://thief.one&quot;</a></div><div class="line"><strong>version</strong>=”1.0”</div><div class="line"><strong>py_version</strong>=”3.5”</div><div class="line"></div><div class="line">‘<span class="string">‘’</span></div><div class="line"></div><div class="line">import asyncio</div><div class="line">import chrome_remote_interface</div><div class="line"></div><div class="line"></div><div class="line">class callbacks(object):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ callback class ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    target_url = <span class="string">‘’</span></div><div class="line">    result = []</div><div class="line"></div><div class="line">    async def start(tabs):</div><div class="line">        await tabs.add()</div><div class="line"></div><div class="line">    async def tab_start(tabs, tab):</div><div class="line">        await tab.Page.enable()</div><div class="line">        await tab.Network.enable()</div><div class="line">        await tab.Page.navigate(url=callbacks.target_url)</div><div class="line"></div><div class="line">    async def network__response_received(tabs, tab, requestId, loaderId, timestamp, <span class="built_in">type</span>, response, <strong>kwargs):</strong></div><div class="line">        <span class="string">‘’</span><span class="string">‘</span></div><div class="line">        print(response.requestHeaders)</div><div class="line">        print(dir(response))</div><div class="line">        more response attribute <a href="https://chromedevtools.github.io/devtools-protocol/tot/Network#type-Response" target="_blank" rel="noopener">https://chromedevtools.github.io/devtools-protocol/tot/Network#type-Response</a></div><div class="line">        ‘<span class="string">‘’</span></div><div class="line">        try:</div><div class="line">            body = tabs.helpers.old_helpers.unpack_response_body(await tab.Network.get_response_body(requestId=requestId))</div><div class="line">        except tabs.FailResponse as e:</div><div class="line">            <span class="built_in">print</span>(<span class="string">‘[Error]’</span>, e)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="built_in">print</span>(response.url,response.status,len(body))</div><div class="line">            callbacks.result.append((response.url,response.status,len(body)))</div><div class="line"></div><div class="line">    async def page__frame_stopped_loading(tabs, tab, kwargs):</div><div class="line">        <span class="built_in">print</span>(<span class="string">“[Info]Finish”</span>)</div><div class="line">        tabs.terminate()</div><div class="line"></div><div class="line">    async def any(tabs, tab, callback_name, parameters):</div><div class="line">        pass</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong>==<span class="string">“<strong>main</strong>“</span>:</div><div class="line">    callbacks.target_url = <span class="string">“<a href="http://www.baidu.com&quot;" target="_blank" rel="noopener">http://www.baidu.com&quot;</a></span></div><div class="line">    asyncio.get_event_loop().run_until_complete(chrome_remote_interface.Tabs.run(<span class="string">‘localhost’</span>, 9222, callbacks))</div><div class="line">    <span class="built_in">print</span>(callbacks.result)</div></pre></td></tr></table></figure><p>说明：同样的在运行这段代码前，先运行chrome headless监听程序。</p><p>然后运行该程序：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python nmask.py</div></pre></td></tr></table></figure><p><img src="/upload_image/20180607/3.png" alt=""></p><p>说明：运行程序，最终得到渲染过程中请求的url、响应码、响应内容长度。</p><h3 id="Chrome-Debugging-Protocol"><a href="#Chrome-Debugging-Protocol" class="headerlink" title="Chrome Debugging Protocol"></a><a href="#Chrome-Debugging-Protocol" title="Chrome Debugging Protocol"></a>Chrome Debugging Protocol</h3><p>无论是nodejs版本的chrome-remote-interface还是python版本的，实现的底层都是基于Chrome Debugging Protocol接口，<a href="https://chromedevtools.github.io/devtools-protocol/" target="_blank" rel="noopener">官方文档</a>，因此在使用chrome-remote-interface过程中，可以查询一下这个文档。比如python版本中network__response_received函数，是封装了Chrome Debugging Protocol接口Network.ResponseReceived函数，而此函数接受的参数，以及一些属性方法等都可以在该文档中查询。</p><h3 id="解决文章开头的问题"><a href="#解决文章开头的问题" class="headerlink" title="解决文章开头的问题"></a><a href="#解决文章开头的问题" title="解决文章开头的问题"></a>解决文章开头的问题</h3><p>文章开头还留了一个问题，有哪些即可以实现程序化又可以实现自动化的抓包工具？想想chrome-remote-interface能干啥？其一可以使用nodejs、python（可能还有其他语言封装的项目）编程，底层接口文档比较完善；其二用它来写web2.0爬虫，访问页面产生流量，当然区别web1.0爬虫，这里的流量是完整的流量，相当于人工打开浏览器访问网页；其三可以获取流量，并且进行分析。第一点功能实现了程序化，第二三点功能实现了自动化。<br>最后让我们回过头看一下前文提到的自动化测试方案–主动扫描器，其短板就是没法解决web2.0爬虫的困境，而chrome-remote-interface恰恰可以解决，发挥下想象力，其前途应该无限！</p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.chucz.club/2018/05/25/区块链系列·python实现的区块链/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="褚成志"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="褚成志的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/05/25/区块链系列·python实现的区块链/" itemprop="url">区块链系列·python实现的区块链</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-25T08:16:48+08:00">2018-05-25</time></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>地是床 天是被 流星是眼泪<br>有时醒 有时醉 大雁飞一个来回<br>听说现在会点区块链技术的工资都高破天了，抱着对高工资的幻想，我决定也开始学一学区块链吧。那么我想接触区块链的第一步必须得是去交易平台注册个帐号，然后充点钱买0.00001个BTC了。（2333，~!~现在我穷得只剩下币了）<br><a id="more"></a></p></blockquote><p>老实说区块链技术还是有点难理解的，为此我搜了搜区块链的实现代码，想着结合代码看获许会简单一点，于是我发现有人用python实现了简单的区块链，于是再原作者基础上，我稍微修改了点内容，在此粘贴一下，以供学习。原项目地址：<a href="https://github.com/xilibi2003/blockchain" target="_blank" rel="noopener">https://github.com/xilibi2003/blockchain</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line"></div><div class="line">import hashlib</div><div class="line">import json</div><div class="line">from time import time</div><div class="line"></div><div class="line"></div><div class="line">class Blockchain(object):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ 区块链 </span></div><div class="line">    </div><div class="line">    一个区块结构（每个区块的字典顺序必须一致）：</div><div class="line"></div><div class="line">    block = &#123;</div><div class="line">        ‘index<span class="string">‘: 1, # 区块索引</span></div><div class="line">        ‘timestamp<span class="string">‘: 1506057125.900785, # 时间戳</span></div><div class="line">        ‘transactions<span class="string">‘: [ # 交易列表</span></div><div class="line">            &#123;</div><div class="line">                ‘sender<span class="string">‘: “8527147fe1f5426f9dd545de4b27ee00”,</span></div><div class="line">                ‘recipient<span class="string">‘: “a77f5cdfa2934df3954a5c7c7da5df1f”,</span></div><div class="line">                ‘amount<span class="string">‘: 5,</span></div><div class="line">            &#125;</div><div class="line">        ],</div><div class="line">        ‘proof<span class="string">‘: 324984774000, # 工作量证明</span></div><div class="line">        ‘previous_hash<span class="string">‘: “2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824”</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ‘<span class="string">‘’</span></div><div class="line"></div><div class="line">    def <strong>init</strong>(self):</div><div class="line"></div><div class="line">        self.chain = [] <span class="comment"># 区块列表</span></div><div class="line">        self.current_transactions = [] <span class="comment"># 交易列表</span></div><div class="line">        self.nodes = <span class="built_in">set</span>() <span class="comment"># 节点列表(避免重复)</span></div><div class="line"></div><div class="line">        self.new_block(previous_hash=1, proof=100) <span class="comment"># 创造创世区块</span></div><div class="line"></div><div class="line"></div><div class="line">    def register_node(self,address):</div><div class="line">        <span class="string">‘’</span><span class="string">‘ 注册节点 </span></div><div class="line"></div><div class="line">        Add a new node to the list of nodes</div><div class="line">        :param address: &lt;str&gt; 节点地址 ‘192.168.0.1:5000<span class="string">‘</span></div><div class="line">        :return: None</div><div class="line"></div><div class="line">        ‘<span class="string">‘’</span></div><div class="line"></div><div class="line">        self.nodes.add(address)</div><div class="line"></div><div class="line">    def valid_chain(self,chain):</div><div class="line">        <span class="string">‘’</span><span class="string">‘ 验证区块链的有效性 </span></div><div class="line"></div><div class="line">        :param chain: &lt;list&gt; 一个完整的区块链</div><div class="line">        :return: &lt;bool&gt; True if valid, False if not</div><div class="line"></div><div class="line">        ‘<span class="string">‘’</span></div><div class="line"></div><div class="line">        previous_block = chain[0] <span class="comment"># 前一个区块</span></div><div class="line">        current_index = 1 <span class="comment"># 当前区块索引</span></div><div class="line"></div><div class="line">        <span class="keyword">while</span> current_index &lt; len(chain):</div><div class="line">            block = chain[current_index] <span class="comment"># 当前区块</span></div><div class="line"></div><div class="line">            <span class="keyword">if</span> block[<span class="string">‘previous_hash’</span>] != self.hash(previous_block):</div><div class="line">                <span class="string">‘’</span><span class="string">‘ hash值验证 ‘</span><span class="string">‘’</span></div><div class="line">                <span class="built_in">return</span> False</div><div class="line"></div><div class="line">            <span class="keyword">if</span> not self.valid_proof(previous_block[<span class="string">‘proof’</span>],block[<span class="string">‘proof’</span>]):</div><div class="line">                <span class="string">‘’</span><span class="string">‘ 工作量证明验证 ‘</span><span class="string">‘’</span></div><div class="line">                <span class="built_in">return</span> False</div><div class="line"></div><div class="line">            previous_block = block</div><div class="line">            current_index += 1</div><div class="line"></div><div class="line">        <span class="built_in">return</span> True</div><div class="line"></div><div class="line">    def resolve_conflicts(self):</div><div class="line">        <span class="string">‘’</span><span class="string">‘ 共识算法解决不同节点账本不相同的冲突 </span></div><div class="line"></div><div class="line">        使用网络中最长的有效区块链</div><div class="line">        :return: &lt;bool&gt; True 如果链被取代, 否则为False</div><div class="line">        ‘<span class="string">‘’</span></div><div class="line"></div><div class="line">        neighbours = self.nodes <span class="comment"># 网络中所有节点列表</span></div><div class="line">        new_chain = None</div><div class="line"></div><div class="line">        max_length = len(self.chain) <span class="comment"># 当前节点的区块链长度</span></div><div class="line"></div><div class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> neighbours: <span class="comment"># 遍历所有网络节点，若有比本节点有效区块链长的，则替换掉本地区块链</span></div><div class="line">            </div><div class="line">            <span class="comment"># 通过api获取</span></div><div class="line">            length = 100 <span class="comment"># 某节点区块链长度</span></div><div class="line">            chain = [] <span class="comment"># 某节点区块链列表</span></div><div class="line"></div><div class="line">            <span class="keyword">if</span> length &gt; max_length and self.valid_chain(chain):</div><div class="line">                max_length = length</div><div class="line">                new_chain = chain</div><div class="line"></div><div class="line">        <span class="keyword">if</span> new_chain:</div><div class="line">            self.chain = new_chain</div><div class="line">            <span class="built_in">return</span> True</div><div class="line"></div><div class="line">        <span class="built_in">return</span> False</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    def new_block(self,proof,previous_hash=None):</div><div class="line">        <span class="string">‘’</span><span class="string">‘ 创建新的区块，添加到区块链中 </span></div><div class="line">        </div><div class="line">        生成新块</div><div class="line">        :param proof: &lt;int&gt; 工作量证明</div><div class="line">        :param previous_hash: 前一个区块的hash值</div><div class="line">        :return: &lt;dict&gt; 新区块</div><div class="line"></div><div class="line">        ‘<span class="string">‘’</span></div><div class="line"></div><div class="line">        block = &#123;</div><div class="line"></div><div class="line">            <span class="string">‘index’</span>: len(self.chain) + 1, <span class="comment"># 确保索引在区块链尾部</span></div><div class="line">            <span class="string">‘timestamp’</span>: time(),</div><div class="line">            <span class="string">‘transactions’</span>: self.current_transactions, <span class="comment"># 交易列表</span></div><div class="line">            <span class="string">‘proof’</span>: proof, <span class="comment"># 工作量证明</span></div><div class="line">            <span class="string">‘previous_hash’</span>: previous_hash or self.hash(self.chain[-1]), <span class="comment"># 此区块前一个区块的hash</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment"># 对交易的详细内容可以进行操作，比如说增加金币，或者减少金币等等。</span></div><div class="line"></div><div class="line">        self.current_transactions = [] <span class="comment"># 重置交易列表</span></div><div class="line"></div><div class="line">        self.chain.append(block) <span class="comment"># 将新的区块添加到区块链中</span></div><div class="line"></div><div class="line">        <span class="built_in">return</span> block</div><div class="line"></div><div class="line"></div><div class="line">    def new_transactions(self,sender,recipient,amount):</div><div class="line">        <span class="string">‘’</span><span class="string">‘ 添加新的交易到交易列表中 </span></div><div class="line"></div><div class="line">        生成新交易信息，信息将加入到下一个待挖的区块中</div><div class="line">        :param sender: &lt;str&gt; 发送者地址</div><div class="line">        :param recipient: &lt;str&gt; 接收着地址</div><div class="line">        :param amount: &lt;int&gt; 金额或者数量</div><div class="line">        :return: &lt;int&gt; 返回这笔交易的区块链索引（将这笔交易添加到区块链最后面）</div><div class="line"></div><div class="line">        ‘<span class="string">‘’</span></div><div class="line"></div><div class="line">        self.current_transactions.append(&#123;</div><div class="line"></div><div class="line">            <span class="string">“sender”</span>:sender,</div><div class="line">            <span class="string">‘recipient’</span>:recipient,</div><div class="line">            <span class="string">‘amount’</span>:amount,</div><div class="line"></div><div class="line">            &#125;)</div><div class="line"></div><div class="line">        <span class="built_in">return</span> self.last_block[<span class="string">‘index’</span>] + 1</div><div class="line">        </div><div class="line">    @staticmethod</div><div class="line">    def <span class="built_in">hash</span>(block):</div><div class="line">        <span class="string">‘’</span><span class="string">‘ 计算一个区块的hash值 </span></div><div class="line">        </div><div class="line">        生成块的 SHA-256 hash值</div><div class="line">        :param block: &lt;dict&gt; Block</div><div class="line">        :return: &lt;str&gt;</div><div class="line"></div><div class="line">        ‘<span class="string">‘’</span></div><div class="line">        </div><div class="line">        block_string = json.dumps(block, sort_keys=True).encode()</div><div class="line">        <span class="built_in">return</span> hashlib.sha256(block_string).hexdigest()</div><div class="line"></div><div class="line">    @property</div><div class="line">    def last_block(self):</div><div class="line">        <span class="string">‘’</span><span class="string">‘ 区块链中最后一个区块 ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">        <span class="built_in">return</span> self.chain[-1] <span class="comment"># 返回区块链中最后一个区块</span></div><div class="line"></div><div class="line"></div><div class="line">    def proof_of_work(self, last_proof):</div><div class="line">        <span class="string">‘’</span><span class="string">‘</span></div><div class="line">        简单的工作量证明:</div><div class="line">         - 查找一个 p’ 使得 <span class="built_in">hash</span>(pp<span class="string">‘) 以4个0开头</span></div><div class="line">         - p 是上一个块的证明,  p’ 是当前的证明</div><div class="line">        :param last_proof: &lt;int&gt;</div><div class="line">        :<span class="built_in">return</span>: &lt;int&gt;</div><div class="line">        <span class="string">‘’</span><span class="string">‘</span></div><div class="line"></div><div class="line">        proof = 0</div><div class="line">        while self.valid_proof(last_proof, proof) is False:</div><div class="line">            proof += 1</div><div class="line"></div><div class="line">        return proof</div><div class="line"></div><div class="line"></div><div class="line">    @staticmethod</div><div class="line">    def valid_proof(last_proof,proof):</div><div class="line">        ‘<span class="string">‘’</span></div><div class="line">        验证证明: 是否<span class="built_in">hash</span>(last_proof, proof)以4个0开头?</div><div class="line">        :param last_proof: &lt;int&gt; 前一个区块的<span class="built_in">hash</span></div><div class="line">        :param proof: &lt;int&gt; 当前区块的<span class="built_in">hash</span></div><div class="line">        :<span class="built_in">return</span>: &lt;bool&gt; True or False</div><div class="line">        <span class="string">‘’</span><span class="string">‘</span></div><div class="line"></div><div class="line">        guess = (str(last_proof)+str(proof)).encode()</div><div class="line">        guess_hash = hashlib.sha256(guess).hexdigest()</div><div class="line"></div><div class="line">        return guess_hash[:4] == “0000”</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">if <strong>name</strong>==”<strong>main</strong>“:</div><div class="line"></div><div class="line">    # 运行这一段脚本就是一个区块链节点，而节点之间可以通过api的方式互相传递信息</div><div class="line"></div><div class="line">    # 每个节点都每隔10分钟运行一次</div><div class="line"></div><div class="line">    blockchain = Blockchain()</div><div class="line"></div><div class="line">    for i in range(2):</div><div class="line"></div><div class="line">        # 同步一下区块</div><div class="line"></div><div class="line">        # 开始挖矿</div><div class="line">        last_block = blockchain.last_block</div><div class="line">        last_proof = last_block[‘proof<span class="string">‘]</span></div><div class="line">        proof = blockchain.proof_of_work(last_proof) </div><div class="line"></div><div class="line">        # 挖矿成功后，生成新的交易（奖励交易）</div><div class="line">        blockchain.new_transactions(sender=”0”,recipient=”000002”,amount=1)</div><div class="line"></div><div class="line">        # 添加新的交易(不是奖励交易，而是普通交易)</div><div class="line">        blockchain.new_transactions(sender=”0000001”,recipient=”000002”,amount=1)</div><div class="line"></div><div class="line">        # 输出当前交易列表</div><div class="line">        print “current_transactions lists is: \n”,blockchain.current_transactions</div><div class="line"></div><div class="line">        # 挖矿成功后，生成新的区块（包含奖励交易信息、新增的交易信息），只有挖矿成功后，才能创造出新的区块。</div><div class="line">        block = blockchain.new_block(proof)</div><div class="line"></div><div class="line">        # 输出当前区块链</div><div class="line">        print “current chain lists is: \n”,blockchain.chain</div></pre></td></tr></table></figure><p><code>从本篇开始，我将继续学习一些区块链的技术以及区块链安全相关的技术，并会总结成系列文章在博客发布，技术有限请多包涵！</code></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.chucz.club/2018/05/20/ELK-Sentinl/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="褚成志"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="褚成志的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/05/20/ELK-Sentinl/" itemprop="url">ELK Sentinl</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-21T02:14:12+08:00">2018-05-21</time></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="Sentinl简介"><a href="#Sentinl简介" class="headerlink" title="Sentinl简介"></a><a href="#Sentinl简介" title="Sentinl简介"></a>Sentinl简介</h3><p>Sentinl 5扩展自Kibi / Kibana 5，具有警报和报告功能，可使用标准查询，可编程验证器和各种可配置操作来监控，通知和报告数据系列更改 - 将其视为一个独立的“观察者” “报告”功能（PNG / PDFs快照）。</p><p>SENTINEL还旨在通过直接在Kibana UI中整合来简化在Kibi / Kibana中创建和管理警报和报告的过程。</p><h3 id="功能模块"><a href="#功能模块" class="headerlink" title="功能模块"></a><a href="#功能模块" title="功能模块"></a>功能模块</h3><p>Watchers<br>Alarms<br>Reports<br>Watchers是Sentinl核心，主要由 input,Condition,Transform,Actions几大块组成，可以和X-Pack一一对应，部分文档可参考X-Pack，但需要注意的是它和X-Pack还有一些区别，主要体现在input只实现了search，其他并未实现，Actions也并未都实现</p><h3 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a><a href="#安装与配置" title="安装与配置"></a>安装与配置</h3><ul><li>安装</li></ul><p>/usr/share/kibana/bin/kibana-plugin install <a href="https://github.com/sirensolutions/sentinl/releases/download/tag-5.5/sentinl-v5.6.5.zip" target="_blank" rel="noopener">https://github.com/sirensolutions/sentinl/releases/download/tag-5.5/sentinl-v5.6.5.zip</a></p><ul><li>config</li></ul><p>kibana.yml config:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sentinl:</span></span><br><span class="line"><span class="attr">  es:</span></span><br><span class="line"><span class="attr">    timefield:</span> <span class="string">‘@timestamp’</span></span><br><span class="line"><span class="attr">    default_index:</span> <span class="string">watcher</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">watch</span></span><br><span class="line"><span class="attr">    alarm_index:</span> <span class="string">watcher_alarms</span></span><br><span class="line"><span class="attr">  sentinl:</span></span><br><span class="line"><span class="attr">    history:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">    results:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">  settings:</span></span><br><span class="line"><span class="attr">    email:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">username</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">password</span></span><br><span class="line"><span class="attr">      host:</span> <span class="string">smtp.server.com</span></span><br><span class="line"><span class="attr">      ssl:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">10000</span>  <span class="comment"># mail server connection timeout</span></span><br><span class="line"><span class="attr">    slack:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">username</span></span><br><span class="line"><span class="attr">      hook:</span> <span class="string">‘<a href="https://hooks.slack.com/services/&lt;token&gt;&#39;" target="_blank" rel="noopener">https://hooks.slack.com/services/&lt;token&gt;&#39;</a></span></span><br><span class="line"><span class="attr">      channel:</span> <span class="string">‘#channel’</span></span><br><span class="line"><span class="attr">    report:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      tmp_path:</span> <span class="string">/tmp/</span></span><br><span class="line"><span class="attr">    pushapps:</span></span><br><span class="line"><span class="attr">      active:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      api_key:</span> <span class="string">‘&lt;pushapps API Key&gt;’</span></span><br></pre></td></tr></table></figure><ul><li>raw<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">“input”</span>: &#123;</span><br><span class="line">      <span class="string">“search”</span>: &#123;</span><br><span class="line">        <span class="string">“request”</span>: &#123;</span><br><span class="line">          <span class="string">“index”</span>: [</span><br><span class="line">            <span class="string">“&lt;xxx-&#123;now/d&#125;&gt;”</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">“body”</span>: &#123;</span><br><span class="line">            <span class="string">“query”</span>: &#123;</span><br><span class="line">              <span class="string">“bool”</span>: &#123;</span><br><span class="line">                <span class="string">“should”</span>: [</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="string">“match”</span>: &#123;</span><br><span class="line">                      <span class="string">“status”</span>: <span class="string">“502”</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="string">“match”</span>: &#123;</span><br><span class="line">                      <span class="string">“status”</span>: <span class="string">“404”</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">“minimum_should_match”</span>: <span class="number">1</span>,  #must setup</span><br><span class="line">                <span class="string">“filter”</span>: &#123;</span><br><span class="line">                  <span class="string">“range”</span>: &#123;</span><br><span class="line">                    <span class="string">“@timestamp”</span>: &#123;</span><br><span class="line">                      <span class="string">“gte”</span>: <span class="string">“now-60s”</span>,</span><br><span class="line">                      <span class="string">“lte”</span>: <span class="string">“now”</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">“condition”</span>: &#123;</span><br><span class="line">      <span class="string">“script”</span>: &#123;</span><br><span class="line">        <span class="string">“script”</span>: <span class="string">“payload.hits.total &gt; 30”</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure></li></ul></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.chucz.club/2018/05/20/端口扫描器的几种代码实现方案/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="褚成志"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="褚成志的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/05/20/端口扫描器的几种代码实现方案/" itemprop="url">端口扫描器的几种代码实现方案</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-21T02:13:36+08:00">2018-05-21</time></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>这雨夜太漫长 失眠的我 在谁梦里 歌唱<br>搞安全的应该都知道端口扫描在渗透测试、漏洞扫描过程中的重要性，其与URL爬虫等技术构成了漏洞扫描的第一阶段，即目标信息收集。因此能否开发出一款高效稳定的端口扫描器，往往决定了漏洞扫描器的好坏。那么说到端口扫描器，我们往往会先想到nmap、masscan等神器，它们是这个领域的标杆。但本篇并不是为了介绍这几款工具，而是谈谈如何自研一款高效稳定的端口扫描器。<br><a id="more"></a><br>端口扫描器，顾名思义就是为了探测服务器上的某个端口是否开放，究其原理可以分为很多种探测方式，比如tcp三次握手扫描，syn扫描等等，本篇并不打算详细介绍这些扫描方式的区别，有兴趣的可以看下nmap的文档，对这几种扫描方式有详细的介绍。<br>那么说下本文重点，基于这几天我研究并尝试利用python、go开发tcp扫描器、tcp-syn扫描器，以及对比它们之间的速度性能、稳定性差异情况，将测试结果在此做个记录，并分享一下代码以及方案。</p></blockquote><p>说明：文章结尾将给出本篇所使用代码的Github地址，可供大家测试，代码测试环境为centos7。</p><h3 id="scan-for-Python-Socket"><a href="#scan-for-Python-Socket" class="headerlink" title="scan for Python Socket"></a><a href="#scan-for-Python-Socket" title="scan for Python Socket"></a>scan for Python Socket</h3><p>Python的Socket模块可以创建套接字，创建tcp三次握手连接，以此探测目标端口是否存活。本篇将使用socket模块编写tcp扫描以及syn扫描，并对比两者的差异。</p><h4 id="tcp-scan"><a href="#tcp-scan" class="headerlink" title="tcp scan"></a><a href="#tcp-scan" title="tcp scan"></a>tcp scan</h4><p>快来看代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line">import time</div><div class="line">import socket</div><div class="line"></div><div class="line">socket_timeout = 0.1</div><div class="line"></div><div class="line">def tcp_scan(ip,port):</div><div class="line">    try:</div><div class="line">        s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</div><div class="line">        s.settimeout(socket_timeout)</div><div class="line">        c=s.connect_ex((ip,port))</div><div class="line">        <span class="keyword">if</span> c==0:</div><div class="line">            <span class="built_in">print</span> <span class="string">“%s:%s is open”</span> % (ip,port)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="comment"># print “%s:%s is not open” % (ip,port)</span></div><div class="line">            pass</div><div class="line">    except Exception,e:</div><div class="line">        <span class="built_in">print</span> e</div><div class="line">    </div><div class="line">    s.close()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong>==<span class="string">“<strong>main</strong>“</span>:</div><div class="line">    s_time = time.time()</div><div class="line">    ip = <span class="string">“14.215.177.38”</span></div><div class="line">    <span class="keyword">for</span> port <span class="keyword">in</span> range(0,1024):</div><div class="line">        <span class="string">‘’</span><span class="string">‘ 此处可用协作 ‘</span><span class="string">‘’</span></div><div class="line">        tcp_scan(ip,port)   </div><div class="line">    e_time = time.time()</div><div class="line">    <span class="built_in">print</span> <span class="string">“scan time is “</span>,e_time-s_time</div></pre></td></tr></table></figure><p>运行结果：<br><img src="/upload_image/20180517/socket_tcp.png" alt=""></p><p>说明一下：可以看到此代码扫描1024个端口用了102s，当然代码并没有用多线程、协程等方式提高扫描效率（使用协程测试过扫65535个端口用时400s左右），因为python在这方面的能力比较弱；由于扫描过程中会建立tcp三次握手，因此比较消耗资源。</p><h4 id="tcp-syn-scan"><a href="#tcp-syn-scan" class="headerlink" title="tcp syn scan"></a><a href="#tcp-syn-scan" title="tcp syn scan"></a>tcp syn scan</h4><p>相对tcp扫描，tcp syn扫描方式更为隐蔽，也更节省资源，那么如何利用socket模块实现tcp syn扫描呢？这里需要用到SOCK_RAW，这个在socket编程中相对少用，资料也不多。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -<em>- coding: UTF-8 -</em>- </span></div><div class="line"></div><div class="line">import time</div><div class="line">import random</div><div class="line">import socket</div><div class="line">import sys</div><div class="line">from struct import <em></em></div><div class="line"></div><div class="line"><span class="string">‘’</span><span class="string">‘</span></div><div class="line">Warning:must run it as root</div><div class="line"></div><div class="line">yum install python-devel libpcap-devel</div><div class="line">pip install pcap</div><div class="line"></div><div class="line">‘<span class="string">‘’</span></div><div class="line"></div><div class="line">def checksum(msg):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ Check Summing ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    s = 0</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(0,len(msg),2):</div><div class="line">        w = (ord(msg[i]) &lt;&lt; 8) + (ord(msg[i+1]))</div><div class="line">        s = s+w</div><div class="line"></div><div class="line">    s = (s&gt;&gt;16) + (s &amp; 0xffff)</div><div class="line">    s = ~s &amp; 0xffff</div><div class="line"></div><div class="line">    <span class="built_in">return</span> s</div><div class="line"></div><div class="line"></div><div class="line">def CreateSocket(source_ip,dest_ip):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ create socket connection ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    try:</div><div class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_TCP)</div><div class="line">    except socket.error, msg:</div><div class="line">        <span class="built_in">print</span> <span class="string">‘Socket create error: ‘</span>,str(msg[0]),<span class="string">‘message: ‘</span>,msg[1]</div><div class="line">        sys.exit()</div><div class="line"></div><div class="line">    <span class="string">‘’</span><span class="string">‘ Set the IP header manually ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    s.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, 1)</div><div class="line">    </div><div class="line">    <span class="built_in">return</span> s</div><div class="line"></div><div class="line"></div><div class="line">def CreateIpHeader(source_ip, dest_ip):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ create ip header ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    <span class="comment"># packet = ‘’</span></div><div class="line"></div><div class="line">    <span class="comment"># ip header option</span></div><div class="line"></div><div class="line">    headerlen = 5</div><div class="line">    version = 4</div><div class="line">    tos = 0</div><div class="line">    tot_len = 20 + 20</div><div class="line">    id = random.randrange(18000,65535,1)</div><div class="line">    frag_off = 0</div><div class="line">    ttl = 255</div><div class="line">    protocol = socket.IPPROTO_TCP</div><div class="line">    check = 10</div><div class="line">    saddr = socket.inet_aton ( source_ip )</div><div class="line">    daddr = socket.inet_aton ( dest_ip )</div><div class="line">    hl_version = (version &lt;&lt; 4) + headerlen</div><div class="line">    ip_header = pack(<span class="string">‘!BBHHHBBH4s4s’</span>, hl_version, tos, tot_len, id, frag_off, ttl, protocol, check, saddr, daddr)</div><div class="line"></div><div class="line">    <span class="built_in">return</span> ip_header</div><div class="line"></div><div class="line"></div><div class="line">def create_tcp_syn_header(source_ip, dest_ip, dest_port):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ create tcp syn header function ‘</span><span class="string">‘’</span></div><div class="line"></div><div class="line">    <span class="built_in">source</span> = random.randrange(32000,62000,1) <span class="comment"># randon select one source_port </span></div><div class="line">    seq = 0</div><div class="line">    ack_seq = 0</div><div class="line">    doff = 5</div><div class="line">    </div><div class="line">    <span class="string">‘’</span><span class="string">‘ tcp flags ‘</span><span class="string">‘’</span></div><div class="line">    fin = 0</div><div class="line">    syn = 1</div><div class="line">    rst = 0</div><div class="line">    psh = 0</div><div class="line">    ack = 0</div><div class="line">    urg = 0</div><div class="line">    window = socket.htons (8192)    <span class="comment"># max windows size</span></div><div class="line">    check = 0</div><div class="line">    urg_ptr = 0</div><div class="line">    offset_res = (doff &lt;&lt; 4) + 0</div><div class="line">    tcp_flags = fin + (syn&lt;&lt;1) + (rst&lt;&lt;2) + (psh&lt;&lt;3) + (ack&lt;&lt;4) + (urg&lt;&lt;5)</div><div class="line">    tcp_header = pack(<span class="string">‘!HHLLBBHHH’</span>, <span class="built_in">source</span>, dest_port, seq, ack_seq, offset_res, tcp_flags, window, check, urg_ptr)</div><div class="line">    </div><div class="line">    <span class="string">‘’</span><span class="string">‘ headers option ‘</span><span class="string">‘’</span></div><div class="line">    source_address = socket.inet_aton( source_ip )</div><div class="line">    dest_address = socket.inet_aton( dest_ip )</div><div class="line">    placeholder = 0</div><div class="line">    protocol = socket.IPPROTO_TCP</div><div class="line">    tcp_length = len(tcp_header)</div><div class="line">    psh = pack(<span class="string">‘!4s4sBBH’</span>, source_address, dest_address, placeholder, protocol, tcp_length);</div><div class="line">    psh = psh + tcp_header;</div><div class="line">    tcp_checksum = checksum(psh)</div><div class="line"></div><div class="line">    <span class="string">‘’</span><span class="string">‘ Repack the TCP header and fill in the correct checksum ‘</span><span class="string">‘’</span></div><div class="line">    tcp_header = pack(<span class="string">‘!HHLLBBHHH’</span>, <span class="built_in">source</span>, dest_port, seq, ack_seq, offset_res, tcp_flags, window, tcp_checksum, urg_ptr)</div><div class="line">    </div><div class="line">    <span class="built_in">return</span> tcp_header</div><div class="line"></div><div class="line"></div><div class="line">def syn_scan(source_ip, dest_ip, des_port) :</div><div class="line"></div><div class="line">    s = CreateSocket(source_ip, dest_ip)</div><div class="line">    ip_header = CreateIpHeader(source_ip, dest_ip)</div><div class="line">    tcp_header = create_tcp_syn_header(source_ip, dest_ip, des_port)</div><div class="line">    packet = ip_header + tcp_header</div><div class="line"></div><div class="line">    s.sendto(packet, (dest_ip, 0))</div><div class="line">    data = s.recvfrom(1024) [0][0:]</div><div class="line"></div><div class="line">    ip_header_len = (ord(data[0]) &amp; 0x0f)  4</div><div class="line">    <span class="comment"># ip_header_ret = data[0: ip_header_len - 1]</span></div><div class="line">    tcp_header_len = (ord(data[32]) &amp; 0xf0)&gt;&gt;2</div><div class="line"></div><div class="line">    tcp_header_ret = data[ip_header_len:ip_header_len+tcp_header_len - 1]</div><div class="line"></div><div class="line">    <span class="string">‘’</span><span class="string">‘ SYN/ACK flags ‘</span><span class="string">‘’</span></div><div class="line">    <span class="keyword">if</span> ord(tcp_header_ret[13]) == 0x12:</div><div class="line">        <span class="built_in">print</span>  <span class="string">“%s:%s is open”</span> % (dest_ip,des_port)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="built_in">print</span> <span class="string">“%s:%s is not open”</span> % (dest_ip,des_port)</div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong>==<span class="string">“<strong>main</strong>“</span>:</div><div class="line"></div><div class="line">    t_s = time.time()</div><div class="line">    source_ip = <span class="string">‘’</span> <span class="comment"># 填写本机ip</span></div><div class="line">    dest_ip = <span class="string">‘14.215.177.38’</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> des_port <span class="keyword">in</span> range(1024):</div><div class="line">        syn_scan(source_ip, dest_ip, des_port)</div><div class="line"></div><div class="line">    t_e = time.time()</div><div class="line">    <span class="built_in">print</span> <span class="string">“time is “</span>,(t_e-t_s)</div></pre></td></tr></table></figure><p>有一点需要注意的，运行这段代码前，需要在系统上安装依赖:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install python-devel libpcap-devel</div><div class="line">pip install pcap</div></pre></td></tr></table></figure><p>运行结果：<br><img src="/upload_image/20180517/socket_syn.png" alt=""></p><p>说明：从运行结果上来看，并没有很准确，而且速度也不快，不清楚是不是代码上有问题。</p><h3 id="scan-for-Python-scapy"><a href="#scan-for-Python-scapy" class="headerlink" title="scan for Python scapy"></a><a href="#scan-for-Python-scapy" title="scan for Python scapy"></a>scan for Python scapy</h3><p>除了socket模块外，python还有一个scapy模块，可以用来模拟发包，但只能在linux下使用，其他操作系统不建议使用此模块。</p><h4 id="tcp-syn-csan"><a href="#tcp-syn-csan" class="headerlink" title="tcp syn csan"></a><a href="#tcp-syn-csan" title="tcp syn csan"></a>tcp syn csan</h4><p>代码在这里：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line">import time</div><div class="line">from scapy.all import *</div><div class="line"></div><div class="line"></div><div class="line">ip = <span class="string">“14.215.177.38”</span></div><div class="line">TIMEOUT = 0.5</div><div class="line">threads = 500</div><div class="line">port_range = 1024</div><div class="line">retry = 1</div><div class="line"></div><div class="line"></div><div class="line">def is_up(ip):</div><div class="line">    <span class="string">“”</span><span class="string">“ Tests if host is up “</span><span class="string">“”</span></div><div class="line"></div><div class="line">    icmp = IP(dst=ip)/ICMP()</div><div class="line">    resp = sr1(icmp, timeout=TIMEOUT)</div><div class="line">    <span class="keyword">if</span> resp == None:</div><div class="line">        <span class="built_in">return</span> False</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="built_in">return</span> True</div><div class="line"></div><div class="line">def reset_half_open(ip, ports):</div><div class="line">    <span class="comment"># Reset the connection to stop half-open connections from pooling up</span></div><div class="line"></div><div class="line">    sr(IP(dst=ip)/TCP(dport=ports, flags=<span class="string">‘AR’</span>), timeout=TIMEOUT)</div><div class="line"></div><div class="line"></div><div class="line">def is_open(ip, ports):</div><div class="line"></div><div class="line">    to_reset = []</div><div class="line">    results = []</div><div class="line"></div><div class="line">    p = IP(dst=ip)/TCP(dport=ports, flags=<span class="string">‘S’</span>)  <span class="comment"># Forging SYN packet</span></div><div class="line">    answers, un_answered = sr(p, verbose=False, retry=retry ,timeout=TIMEOUT) <span class="comment"># Send the packets</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> req, resp <span class="keyword">in</span> answers:</div><div class="line">        <span class="keyword">if</span> not resp.haslayer(TCP):</div><div class="line">            <span class="built_in">continue</span></div><div class="line">        tcp_layer = resp.getlayer(TCP)</div><div class="line">        <span class="keyword">if</span> tcp_layer.flags == 0x12:</div><div class="line">            <span class="comment"># port is open</span></div><div class="line">            to_reset.append(tcp_layer.sport)</div><div class="line">            results.append(tcp_layer.sport)</div><div class="line"></div><div class="line">        <span class="keyword">elif</span> tcp_layer.flags == 0x14:</div><div class="line">            <span class="comment"># port is open</span></div><div class="line">            pass</div><div class="line"></div><div class="line">    reset_half_open(ip, to_reset)</div><div class="line">    </div><div class="line">    <span class="built_in">return</span> results</div><div class="line"></div><div class="line"></div><div class="line">def chunks(l, n):</div><div class="line">    <span class="string">“”</span><span class="string">“Yield successive n-sized chunks from l.”</span><span class="string">“”</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(0, len(l), n):</div><div class="line">        yield l[i:i + n]</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong> == <span class="string">‘<strong>main</strong>‘</span>:</div><div class="line"></div><div class="line">    start_time = time.time()</div><div class="line">    open_port_list = []</div><div class="line"></div><div class="line">    <span class="keyword">for</span> ports <span class="keyword">in</span> chunks(list(range(port_range)), threads):</div><div class="line">        results = is_open(ip, ports)</div><div class="line">        <span class="keyword">if</span> results:</div><div class="line">           open_port_list += results</div><div class="line">                </div><div class="line">    end_time = time.time()</div><div class="line">    <span class="built_in">print</span> <span class="string">“%s %s”</span> % (ip,open_port_list)</div><div class="line">    <span class="built_in">print</span> <span class="string">“%s Scan Completed in %fs”</span> % (ip, end_time-start_time)</div></pre></td></tr></table></figure><p>运行结果：<br><img src="/upload_image/20180517/scapy_syn.png" alt=""></p><p>说明：由于scapy可以一次性发多个syn包，因此速度相对socket更快一些，但稳定性没有很好。</p><h3 id="scan-for-python-nmap"><a href="#scan-for-python-nmap" class="headerlink" title="scan for python+nmap"></a><a href="#scan-for-python-nmap" title="scan for python+nmap"></a>scan for python+nmap</h3><p>文章开头提到了nmap，其实在python中也可以直接调用nmap，看代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line"><span class="string">‘’</span><span class="string">‘</span></div><div class="line">pip install python-nmap</div><div class="line">‘<span class="string">‘’</span></div><div class="line"></div><div class="line">import nmap</div><div class="line">nm =nmap.PortScanner()</div><div class="line"></div><div class="line">def scan(ip,port,arg):</div><div class="line">    try:</div><div class="line">        nm.scan(ip, arguments=arg+str(port))</div><div class="line">    except nmap.nmap.PortScannerError:</div><div class="line">        <span class="built_in">print</span> <span class="string">“Please run -O method for root privileges”</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">for</span> host <span class="keyword">in</span> nm.all_hosts():</div><div class="line">            <span class="keyword">for</span> proto <span class="keyword">in</span> nm[host].all_protocols():</div><div class="line">                lport = nm[host][proto].keys()</div><div class="line">                lport.sort()</div><div class="line">                <span class="keyword">for</span> port <span class="keyword">in</span> lport:</div><div class="line">                    <span class="built_in">print</span> (<span class="string">‘port : %s\tstate : %s’</span> % (port, nm[host][proto][port][<span class="string">‘state’</span>]))</div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong>==<span class="string">“<strong>main</strong>“</span>:</div><div class="line">    port=<span class="string">“80,443,22,21”</span></div><div class="line">    scan(ip=<span class="string">“14.215.177.38”</span>,port=port,arg=<span class="string">“-sS -Pn -p”</span>)</div><div class="line">    <span class="comment"># tcp scan -sT</span></div><div class="line">    <span class="comment"># tcp syn scan -sS</span></div></pre></td></tr></table></figure><p>运行结果：<br><img src="/upload_image/20180517/nmap_scan.png" alt=""><br>由于nmap扫描速度相对比较慢，因此这里只演示扫描4个端口，不做速度的对比，当然其稳定性还是可以的。</p><h3 id="scan-for-go"><a href="#scan-for-go" class="headerlink" title="scan for go"></a><a href="#scan-for-go" title="scan for go"></a>scan for go</h3><p>前文一直在介绍使用python语言开发端口扫描器，然而由于python在多线程方面的弱势，扫描器的性能可想而知，因此我又利用go语言的高并发性优势，尝试开发端口扫描器。（题外话：为此我花了半天时间看了下go语言的基础，勉强看懂了扫描代码，并做了一些修改）</p><h4 id="tcp-scan-1"><a href="#tcp-scan-1" class="headerlink" title="tcp scan"></a><a href="#tcp-scan-1" title="tcp scan"></a>tcp scan</h4><p>直接看代码吧：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line">package main</div><div class="line"></div><div class="line">// port tcp scan</div><div class="line"></div><div class="line">import (</div><div class="line">    <span class="string">“fmt”</span></div><div class="line">    <span class="string">“net”</span></div><div class="line">    <span class="string">“os”</span></div><div class="line">    <span class="string">“runtime”</span></div><div class="line">    <span class="string">“strconv”</span></div><div class="line">    <span class="string">“sync”</span></div><div class="line">    <span class="string">“time”</span></div><div class="line">)</div><div class="line"></div><div class="line">func loop(inport chan int, startport, endport int) &#123;</div><div class="line">    <span class="keyword">for</span> i := startport; i &lt;= endport; i++ &#123;</div><div class="line">        inport &lt;- i</div><div class="line">    &#125;</div><div class="line">    close(inport)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">type</span> ScanSafeCount struct &#123;</div><div class="line">    // 结构体</div><div class="line">    count int</div><div class="line">    mux   sync.Mutex</div><div class="line">&#125;</div><div class="line"></div><div class="line">var scanCount ScanSafeCount</div><div class="line"></div><div class="line"></div><div class="line">func scanner(inport int, outport chan int, ip string, endport int) &#123;</div><div class="line">    // 扫描函数</div><div class="line"></div><div class="line">    <span class="keyword">in</span> := inport // 定义要扫描的端口号</div><div class="line">    // fmt.Printf(<span class="string">“ %d “</span>, <span class="keyword">in</span>) // 输出扫描的端口</div><div class="line"></div><div class="line">    host := fmt.Sprintf(<span class="string">“%s:%d”</span>, ip, <span class="keyword">in</span>) // 类似（ip,port）</div><div class="line"></div><div class="line">    tcpAddr, err := net.ResolveTCPAddr(<span class="string">“tcp4”</span>, host) // 根据域名查找ip</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        // 域名解析ip失败</div><div class="line">        outport &lt;- 0</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        conn, err := net.DialTimeout(<span class="string">“tcp”</span>, tcpAddr.String(), 10<em>time.Second) //建立tcp连接</em></div><div class="line">        <span class="keyword">if</span> err != nil &#123;</div><div class="line">            // tcp连接失败</div><div class="line">            outport &lt;- 0</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            // tcp连接成功</div><div class="line">            outport &lt;- <span class="keyword">in</span> // 将端口写入outport信号</div><div class="line">            fmt.Printf(<span class="string">“\n <strong><strong><em>**</em></strong></strong>( %d 可以 )<strong><strong><strong><strong>*</strong></strong></strong></strong>\n”</span>, <span class="keyword">in</span>)</div><div class="line">            conn.Close()</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 线程锁</div><div class="line">    scanCount.mux.Lock()</div><div class="line">    scanCount.count = scanCount.count - 1</div><div class="line">    <span class="keyword">if</span> scanCount.count &lt;= 0 &#123;</div><div class="line">        close(outport)</div><div class="line">    &#125;</div><div class="line">    scanCount.mux.Unlock()</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">func <span class="function"><span class="title">main</span></span>() &#123;</div><div class="line">    runtime.GOMAXPROCS(runtime.NumCPU()) // 设置最大可使用的cpu核数</div><div class="line"></div><div class="line">    // 定义变量</div><div class="line">    inport := make(chan int) // 信号变量，类似python中的queue</div><div class="line">    outport := make(chan int)</div><div class="line">    collect := []int&#123;&#125; // 定义一个切片变量，类似python中的list</div><div class="line"></div><div class="line">    // fmt.Println(os.Args, len(os.Args)) // 获取命令行参数并输出</div><div class="line"></div><div class="line">    <span class="keyword">if</span> len(os.Args) != 4 &#123;</div><div class="line">        // 命令行参数个数有误</div><div class="line">        fmt.Println(<span class="string">“使用方式： port_scanner IP startport endport”</span>)</div><div class="line">        os.Exit(0)</div><div class="line">    &#125;</div><div class="line">    s_time := time.Now().Unix()</div><div class="line"></div><div class="line">    // fmt.Println(<span class="string">“扫描开始：”</span>) // 获取当前时间</div><div class="line"></div><div class="line">    ip := string(os.Args[1]) // 获取参数中的ip</div><div class="line">    startport, _ := strconv.Atoi(os.Args[2]) // 获取参数中的启始端口</div><div class="line">    endport, _ := strconv.Atoi(os.Args[3]) // 获取参数中的结束端口</div><div class="line"></div><div class="line">    <span class="keyword">if</span> startport &gt; endport &#123;</div><div class="line">        fmt.Println(<span class="string">“Usage: scanner IP startport endport”</span>)</div><div class="line">        fmt.Println(<span class="string">“Endport must be larger than startport”</span>)</div><div class="line">        os.Exit(0)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        // 定义scanCount变量为ScanSafeCount结构体，即计算扫描的端口数量</div><div class="line">        scanCount = ScanSafeCount&#123;count: (endport - startport + 1)&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">“扫描 %s：%d———-%d\n”</span>, ip, startport, endport)</div><div class="line"></div><div class="line">    go loop(inport, startport, endport)  // 执行loop函数将端口写入input信号</div><div class="line"></div><div class="line">    <span class="keyword">for</span> v := range inport &#123;</div><div class="line">        // 开始循环input</div><div class="line">        go scanner(v, outport, ip, endport)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 输出结果</div><div class="line">    <span class="keyword">for</span> port := range outport &#123;</div><div class="line">        <span class="keyword">if</span> port != 0 &#123;</div><div class="line">            collect = append(collect, port)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">“–”</span>)</div><div class="line">    fmt.Println(collect)</div><div class="line">    e_time := time.Now().Unix()</div><div class="line">    fmt.Println(<span class="string">“扫描时间:”</span>, e_time-s_time)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>代码我就不解释了（我在代码中加了些注释，应该大致可以看懂），本文也不打算介绍go的用法，毕竟自己也是刚开始学习go，有兴趣的可以看看go的文档，然后再回过头来看看这段代码。</p><p>代码运行结果：<br><img src="/upload_image/20180517/go_tcp.png" alt=""></p><p>说明：由于是tcp扫描，所以多少还是占资源的，而且测试发现稳定性不是很好。</p><h4 id="tcp-syn-scan-1"><a href="#tcp-syn-scan-1" class="headerlink" title="tcp syn scan"></a><a href="#tcp-syn-scan-1" title="tcp syn scan"></a>tcp syn scan</h4><p>看代码看代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div></pre></td><td class="code"><pre><div class="line">package main</div><div class="line"></div><div class="line">// port tcp syn scan</div><div class="line"></div><div class="line">import (</div><div class="line">    <span class="string">“bytes”</span></div><div class="line">    <span class="string">“encoding/binary”</span></div><div class="line">    <span class="string">“flag”</span></div><div class="line">    <span class="string">“fmt”</span></div><div class="line">    <span class="string">“log”</span></div><div class="line">    <span class="string">“math/rand”</span></div><div class="line">    <span class="string">“net”</span></div><div class="line">    <span class="string">“os”</span></div><div class="line">    <span class="string">“strconv”</span></div><div class="line">    <span class="string">“strings”</span></div><div class="line">    <span class="string">“time”</span></div><div class="line">    <span class="string">“errors”</span></div><div class="line">)</div><div class="line"></div><div class="line">//TCPHeader <span class="built_in">test</span></div><div class="line"><span class="built_in">type</span> TCPHeader struct &#123;</div><div class="line">    SrcPort       uint16</div><div class="line">    DstPort       uint16</div><div class="line">    SeqNum        uint32</div><div class="line">    AckNum        uint32</div><div class="line">    Flags         uint16</div><div class="line">    Window        uint16</div><div class="line">    ChkSum        uint16</div><div class="line">    UrgentPointer uint16</div><div class="line">&#125;</div><div class="line"></div><div class="line">//TCPOption <span class="built_in">test</span></div><div class="line"><span class="built_in">type</span> TCPOption struct &#123;</div><div class="line">    Kind   uint8</div><div class="line">    Length uint8</div><div class="line">    Data   []byte</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">type</span> scanResult struct &#123;</div><div class="line">    Port   uint16</div><div class="line">    Opened bool</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">type</span> scanJob struct &#123;</div><div class="line">    Laddr string</div><div class="line">    Raddr string</div><div class="line">    SPort uint16</div><div class="line">    DPort uint16</div><div class="line">    Stop  uint8</div><div class="line">&#125;</div><div class="line"></div><div class="line">var stopFlag = make(chan uint8, 1)</div><div class="line"></div><div class="line">func <span class="function"><span class="title">main</span></span>() &#123;</div><div class="line"></div><div class="line">    rate := time.Second / 400</div><div class="line">    throttle := time.Tick(rate)</div><div class="line">    <span class="built_in">jobs</span> := make(chan <em>scanJob, 65536)</em></div><div class="line">    results := make(chan scanResult, 1000)</div><div class="line">    <span class="keyword">for</span> w := 0; w &lt; 10; w++ &#123;</div><div class="line">        go worker(w, <span class="built_in">jobs</span>, throttle, results)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 获取命令行参数</div><div class="line"></div><div class="line">    ifaceName := flag.String(<span class="string">“i”</span>, <span class="string">“eth0”</span>, <span class="string">“Specify network”</span>)</div><div class="line">    remote := flag.String(<span class="string">“r”</span>, <span class="string">“”</span>, <span class="string">“remote address”</span>)</div><div class="line">    portRange := flag.String(<span class="string">“p”</span>, <span class="string">“1-1024”</span>, <span class="string">“port range: -p 1-1024”</span>)</div><div class="line">    flag.Parse()</div><div class="line"></div><div class="line">    // ifaceName := &amp;interfaceName_</div><div class="line">    // remote := &amp;remote_</div><div class="line">    // portRange := &amp;portRange_</div><div class="line"></div><div class="line">    s_time := time.Now().Unix()</div><div class="line"></div><div class="line">    laddr := interfaceAddress(<em>ifaceName) //</em></div><div class="line">    raddr := remote</div><div class="line">    minPort , maxPort := portSplit(portRange)</div><div class="line"></div><div class="line">    // fmt.Println(laddr, raddr) // 输出源ip地址，目标ip地址</div><div class="line"></div><div class="line">    go func(num int)&#123;</div><div class="line">        <span class="keyword">for</span> i := 0; i &lt; num; i++ &#123;</div><div class="line">            recvSynAck(laddr, raddr, results)</div><div class="line">        &#125;</div><div class="line">    &#125;(10)</div><div class="line"></div><div class="line">    go func(jobLength int) &#123;</div><div class="line">        <span class="keyword">for</span> j := minPort; j &lt; maxPort + 1; j++ &#123;</div><div class="line">            s := scanJob&#123;</div><div class="line">                Laddr: laddr,</div><div class="line">                Raddr: raddr,</div><div class="line">                SPort: uint16(random(10000, 65535)),</div><div class="line">                DPort: uint16(j + 1),</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">jobs</span> &lt;- &amp;s</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">jobs</span> &lt;- &amp;scanJob&#123;Stop: 1&#125;</div><div class="line">    &#125;(1024)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        select &#123;</div><div class="line">        <span class="keyword">case</span> res := &lt;-results:</div><div class="line">            fmt.Println(<span class="string">“扫描到开放的端口:”</span>,res.Port)</div><div class="line">        <span class="keyword">case</span> &lt;-stopFlag:</div><div class="line">            e_time := time.Now().Unix()</div><div class="line">            fmt.Println(<span class="string">“总共用了多少时间(s):”</span>,e_time-s_time)</div><div class="line">            os.Exit(0)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func worker(id int, <span class="built_in">jobs</span> &lt;-chan <em>scanJob, th &lt;-chan time.Time, results chan&lt;- </em>scanResult) &#123;</div><div class="line">    <span class="keyword">for</span> j := range <span class="built_in">jobs</span> &#123;</div><div class="line">        <span class="keyword">if</span> j.Stop != 1 &#123;</div><div class="line">            sendSyn(j.Laddr, j.Raddr, j.SPort, j.DPort)</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            stopFlag &lt;- j.Stop</div><div class="line">        &#125;</div><div class="line">        &lt;-th</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func checkError(err error) &#123;</div><div class="line">    // 错误check</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        log.Println(err)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//CheckSum <span class="built_in">test</span></div><div class="line">func CheckSum(data []byte, src, dst [4]byte) uint16 &#123;</div><div class="line">    pseudoHeader := []byte&#123;</div><div class="line">        src[0], src[1], src[2], src[3],</div><div class="line">        dst[0], dst[1], dst[2], dst[3],</div><div class="line">        0,</div><div class="line">        6,</div><div class="line">        0,</div><div class="line">        byte(len(data)),</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    totalLength := len(pseudoHeader) + len(data)</div><div class="line">    <span class="keyword">if</span> totalLength%2 != 0 &#123;</div><div class="line">        totalLength++</div><div class="line">    &#125;</div><div class="line">    d := make([]byte, 0, totalLength)</div><div class="line">    d = append(d, pseudoHeader…)</div><div class="line">    d = append(d, data…)</div><div class="line"></div><div class="line">    <span class="built_in">return</span> ^mySum(d)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func mySum(data []byte) uint16 &#123;</div><div class="line">    var sum uint32</div><div class="line">    <span class="keyword">for</span> i := 0; i &lt; len(data)-1; i += 2 &#123;</div><div class="line">        sum += uint32(uint16(data[i])&lt;&lt;8 | uint16(data[i+1]))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sum = (sum &gt;&gt; 16) + (sum &amp; 0xffff)</div><div class="line">    sum = sum + (sum &gt;&gt; 16)</div><div class="line">    <span class="built_in">return</span> uint16(sum)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func sendSyn(laddr, raddr string, sport, dport uint16) &#123;</div><div class="line">    conn, err := net.Dial(<span class="string">“ip4:tcp”</span>, raddr)</div><div class="line">    checkError(err)</div><div class="line">    defer conn.Close()</div><div class="line">    op := []TCPOption&#123;</div><div class="line">        TCPOption&#123;</div><div class="line">            Kind:   2,</div><div class="line">            Length: 4,</div><div class="line">            Data:   []byte&#123;0x05, 0xb4&#125;,</div><div class="line">        &#125;,</div><div class="line">        TCPOption&#123;</div><div class="line">            Kind: 0,</div><div class="line">        &#125;,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    tcpH := TCPHeader&#123;</div><div class="line">        SrcPort:       sport,</div><div class="line">        DstPort:       dport,</div><div class="line">        SeqNum:        rand.Uint32(),</div><div class="line">        AckNum:        0,</div><div class="line">        Flags:         0x8002,</div><div class="line">        Window:        8192,</div><div class="line">        ChkSum:        0,</div><div class="line">        UrgentPointer: 0,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    buff := new(bytes.Buffer)</div><div class="line"></div><div class="line">    err = binary.Write(buff, binary.BigEndian, tcpH)</div><div class="line">    checkError(err)</div><div class="line">    <span class="keyword">for</span> i := range op &#123;</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Kind)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Length)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Data)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    binary.Write(buff, binary.BigEndian, [6]byte&#123;&#125;)</div><div class="line"></div><div class="line">    data := buff.Bytes()</div><div class="line">    checkSum := CheckSum(data, ipstr2Bytes(laddr), ipstr2Bytes(raddr))</div><div class="line">    //fmt.Printf(<span class="string">“CheckSum 0x%X\n”</span>, checkSum)</div><div class="line">    tcpH.ChkSum = checkSum</div><div class="line"></div><div class="line">    buff = new(bytes.Buffer)</div><div class="line">    binary.Write(buff, binary.BigEndian, tcpH)</div><div class="line">    <span class="keyword">for</span> i := range op &#123;</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Kind)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Length)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Data)</div><div class="line">    &#125;</div><div class="line">    binary.Write(buff, binary.BigEndian, [6]byte&#123;&#125;)</div><div class="line">    data = buff.Bytes()</div><div class="line"></div><div class="line">    //fmt.Printf(<span class="string">“% X\n”</span>, data)</div><div class="line">    _, err = conn.Write(data)</div><div class="line">    checkError(err)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func recvSynAck(laddr, raddr string, res chan&lt;- <em>scanResult) error &#123;</em></div><div class="line">    listenAddr, err := net.ResolveIPAddr(<span class="string">“ip4”</span>, laddr) // 解析域名为ip</div><div class="line">    checkError(err)</div><div class="line">    conn, err := net.ListenIP(<span class="string">“ip4:tcp”</span>, listenAddr)</div><div class="line">    defer conn.Close()</div><div class="line">    checkError(err)</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        buff := make([]byte, 1024)</div><div class="line">        _, addr, err := conn.ReadFrom(buff)</div><div class="line">        <span class="keyword">if</span> err != nil &#123;</div><div class="line">            <span class="built_in">continue</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> addr.String() != raddr || buff[13] != 0x12 &#123;</div><div class="line">            <span class="built_in">continue</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        var port uint16</div><div class="line">        binary.Read(bytes.NewReader(buff), binary.BigEndian, &amp;port)</div><div class="line">        res &lt;- &amp;scanResult&#123;</div><div class="line">            Port:   port,</div><div class="line">            Opened: <span class="literal">true</span>,</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func ipstr2Bytes(addr string) [4]byte &#123;</div><div class="line">    s := strings.Split(addr, <span class="string">“.”</span>)</div><div class="line">    b0, _ := strconv.Atoi(s[0])</div><div class="line">    b1, _ := strconv.Atoi(s[1])</div><div class="line">    b2, _ := strconv.Atoi(s[2])</div><div class="line">    b3, _ := strconv.Atoi(s[3])</div><div class="line">    <span class="built_in">return</span> [4]byte&#123;byte(b0), byte(b1), byte(b2), byte(b3)&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func random(min, max int) int &#123;</div><div class="line">    <span class="built_in">return</span> rand.Intn(max-min) + min</div><div class="line">&#125;</div><div class="line"></div><div class="line">func interfaceAddress(ifaceName string ) string &#123;</div><div class="line">    iface, err:= net.InterfaceByName(ifaceName)</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    addr, err := iface.Addrs()</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    addrStr := strings.Split(addr[0].String(), <span class="string">“/“</span>)[0]</div><div class="line">    <span class="built_in">return</span> addrStr</div><div class="line">&#125;</div><div class="line"></div><div class="line">func portSplit(portRange string) (uint16, uint16) &#123;</div><div class="line">    ports := strings.Split(*portRange, <span class="string">“-“</span>)</div><div class="line">    minPort, err := strconv.ParseUint(ports[0], 10, 16)</div><div class="line">    <span class="keyword">if</span> err !=nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    maxPort, err := strconv.ParseUint(ports[1], 10, 16)</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> minPort &gt; maxPort &#123;</div><div class="line">        panic(errors.New(<span class="string">“minPort must greater than maxPort”</span>))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">return</span> uint16(minPort), uint16(maxPort)</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>代码运行结果：<br><img src="/upload_image/20180517/go_syn.png" alt=""><br>没错，就是2s！我测试了扫描全端口（0-65535），大概120s左右，而且稳定性不错。</p><h3 id="scan-for-go-python"><a href="#scan-for-go-python" class="headerlink" title="scan for go+python"></a><a href="#scan-for-go-python" title="scan for go+python"></a>scan for go+python</h3><p>经过前面的测试我们不难发现，在并发的性能上，go完胜python，但go不适合做复杂的逻辑处理，以及web开发之类的。因此如何整合python跟go呢？这里我想了两种方案，第一种将go语言打包成.so动态连接库，利用python的ctypes模块可以调用；第二种是go写成接口，提供python调用。写成接口的方式相对简单一些，因此这里不介绍了，说说如何打包go，即如何利用python调用go的方法或者说函数。</p><p>先看下修改过后的tcp_syn_scan.go代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div></pre></td><td class="code"><pre><div class="line">package main</div><div class="line"></div><div class="line">// port tcp syn scan</div><div class="line"></div><div class="line">import (</div><div class="line">    <span class="string">“C”</span></div><div class="line">    <span class="string">“os”</span></div><div class="line">    <span class="string">“bytes”</span></div><div class="line">    <span class="string">“encoding/binary”</span></div><div class="line">    <span class="string">“fmt”</span></div><div class="line">    <span class="string">“log”</span></div><div class="line">    <span class="string">“math/rand”</span></div><div class="line">    <span class="string">“net”</span></div><div class="line">    <span class="string">“strconv”</span></div><div class="line">    <span class="string">“strings”</span></div><div class="line">    <span class="string">“time”</span></div><div class="line">    <span class="string">“errors”</span></div><div class="line">)</div><div class="line"></div><div class="line">//TCPHeader <span class="built_in">test</span></div><div class="line"><span class="built_in">type</span> TCPHeader struct &#123;</div><div class="line">    SrcPort       uint16</div><div class="line">    DstPort       uint16</div><div class="line">    SeqNum        uint32</div><div class="line">    AckNum        uint32</div><div class="line">    Flags         uint16</div><div class="line">    Window        uint16</div><div class="line">    ChkSum        uint16</div><div class="line">    UrgentPointer uint16</div><div class="line">&#125;</div><div class="line"></div><div class="line">//TCPOption <span class="built_in">test</span></div><div class="line"><span class="built_in">type</span> TCPOption struct &#123;</div><div class="line">    Kind   uint8</div><div class="line">    Length uint8</div><div class="line">    Data   []byte</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">type</span> scanResult struct &#123;</div><div class="line">    Port   uint16</div><div class="line">    Opened bool</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">type</span> scanJob struct &#123;</div><div class="line">    Laddr string</div><div class="line">    Raddr string</div><div class="line">    SPort uint16</div><div class="line">    DPort uint16</div><div class="line">    Stop  uint8</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">var stopFlag = make(chan uint8, 1)</div><div class="line"></div><div class="line">//<span class="built_in">export</span> Scan</div><div class="line">func Scan(remote_ <em>C.char, portRange_ </em>C.char, interfaceName_ <em>C.char) &#123;</em></div><div class="line">    </div><div class="line">    rate := time.Second / 400</div><div class="line">    throttle := time.Tick(rate)</div><div class="line">    <span class="built_in">jobs</span> := make(chan scanJob, 65536)</div><div class="line">    results := make(chan <em>scanResult, 1000)</em></div><div class="line">    <span class="keyword">for</span> w := 0; w &lt; 10; w++ &#123;</div><div class="line">        go worker(w, <span class="built_in">jobs</span>, throttle, results)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 获取命令行参数</div><div class="line"></div><div class="line">    // ifaceName := flag.String(<span class="string">“i”</span>, <span class="string">“eth0”</span>, <span class="string">“Specify network”</span>)</div><div class="line">    // remote := flag.String(<span class="string">“r”</span>, <span class="string">“”</span>, <span class="string">“remote address”</span>)</div><div class="line">    // portRange := flag.String(<span class="string">“p”</span>, <span class="string">“1-1024”</span>, <span class="string">“port range: -p 1-1024”</span>)</div><div class="line">    // flag.Parse()</div><div class="line">    </div><div class="line">    interfaceName_1 := C.GoString(interfaceName_)</div><div class="line">    remote_1 := C.GoString(remote_)</div><div class="line">    portRange_1 := C.GoString(portRange_) </div><div class="line"></div><div class="line">    ifaceName := &amp;interfaceName_1</div><div class="line">    remote := &amp;remote_1</div><div class="line">    portRange := &amp;portRange_1</div><div class="line"></div><div class="line">    s_time := time.Now().Unix()</div><div class="line">    </div><div class="line">    laddr := interfaceAddress(ifaceName) //</div><div class="line">    raddr := <em>remote</em></div><div class="line">    minPort , maxPort := portSplit(portRange)</div><div class="line"></div><div class="line">    fmt.Println(laddr, raddr) // 输出源ip地址，目标ip地址</div><div class="line"></div><div class="line">    go func(num int)&#123;</div><div class="line">        <span class="keyword">for</span> i := 0; i &lt; num; i++ &#123;</div><div class="line">            recvSynAck(laddr, raddr, results)</div><div class="line">        &#125;</div><div class="line">    &#125;(10)</div><div class="line"></div><div class="line">    go func(jobLength int) &#123;</div><div class="line">        <span class="keyword">for</span> j := minPort; j &lt; maxPort + 1; j++ &#123;</div><div class="line">            s := scanJob&#123;</div><div class="line">                Laddr: laddr,</div><div class="line">                Raddr: raddr,</div><div class="line">                SPort: uint16(random(10000, 65535)),</div><div class="line">                DPort: uint16(j + 1),</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">jobs</span> &lt;- &amp;s</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">jobs</span> &lt;- &amp;scanJob&#123;Stop: 1&#125;</div><div class="line">    &#125;(1024)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        select &#123;</div><div class="line">        <span class="keyword">case</span> res := &lt;-results:</div><div class="line">            fmt.Println(<span class="string">“扫描到开放的端口：”</span>,res.Port) //输出开放的端口号</div><div class="line">        <span class="keyword">case</span> &lt;-stopFlag:</div><div class="line">            e_time := time.Now().Unix()</div><div class="line">            fmt.Println(<span class="string">“本次扫描总共耗时(s):”</span>,e_time-s_time)</div><div class="line">            os.Exit(0)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func worker(id int, <span class="built_in">jobs</span> &lt;-chan scanJob, th &lt;-chan time.Time, results chan&lt;- <em>scanResult) &#123;</em></div><div class="line">    <span class="keyword">for</span> j := range <span class="built_in">jobs</span> &#123;</div><div class="line">        <span class="keyword">if</span> j.Stop != 1 &#123;</div><div class="line">            sendSyn(j.Laddr, j.Raddr, j.SPort, j.DPort)</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            stopFlag &lt;- j.Stop</div><div class="line">        &#125;</div><div class="line">        &lt;-th</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func checkError(err error) &#123;</div><div class="line">    // 错误check</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        log.Println(err)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//CheckSum <span class="built_in">test</span></div><div class="line">func CheckSum(data []byte, src, dst [4]byte) uint16 &#123;</div><div class="line">    pseudoHeader := []byte&#123;</div><div class="line">        src[0], src[1], src[2], src[3],</div><div class="line">        dst[0], dst[1], dst[2], dst[3],</div><div class="line">        0,</div><div class="line">        6,</div><div class="line">        0,</div><div class="line">        byte(len(data)),</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    totalLength := len(pseudoHeader) + len(data)</div><div class="line">    <span class="keyword">if</span> totalLength%2 != 0 &#123;</div><div class="line">        totalLength++</div><div class="line">    &#125;</div><div class="line">    d := make([]byte, 0, totalLength)</div><div class="line">    d = append(d, pseudoHeader…)</div><div class="line">    d = append(d, data…)</div><div class="line"></div><div class="line">    <span class="built_in">return</span> ^mySum(d)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func mySum(data []byte) uint16 &#123;</div><div class="line">    var sum uint32</div><div class="line">    <span class="keyword">for</span> i := 0; i &lt; len(data)-1; i += 2 &#123;</div><div class="line">        sum += uint32(uint16(data[i])&lt;&lt;8 | uint16(data[i+1]))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sum = (sum &gt;&gt; 16) + (sum &amp; 0xffff)</div><div class="line">    sum = sum + (sum &gt;&gt; 16)</div><div class="line">    <span class="built_in">return</span> uint16(sum)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func sendSyn(laddr, raddr string, sport, dport uint16) &#123;</div><div class="line">    conn, err := net.Dial(<span class="string">“ip4:tcp”</span>, raddr)</div><div class="line">    checkError(err)</div><div class="line">    defer conn.Close()</div><div class="line">    op := []TCPOption&#123;</div><div class="line">        TCPOption&#123;</div><div class="line">            Kind:   2,</div><div class="line">            Length: 4,</div><div class="line">            Data:   []byte&#123;0x05, 0xb4&#125;,</div><div class="line">        &#125;,</div><div class="line">        TCPOption&#123;</div><div class="line">            Kind: 0,</div><div class="line">        &#125;,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    tcpH := TCPHeader&#123;</div><div class="line">        SrcPort:       sport,</div><div class="line">        DstPort:       dport,</div><div class="line">        SeqNum:        rand.Uint32(),</div><div class="line">        AckNum:        0,</div><div class="line">        Flags:         0x8002,</div><div class="line">        Window:        8192,</div><div class="line">        ChkSum:        0,</div><div class="line">        UrgentPointer: 0,</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    buff := new(bytes.Buffer)</div><div class="line"></div><div class="line">    err = binary.Write(buff, binary.BigEndian, tcpH)</div><div class="line">    checkError(err)</div><div class="line">    <span class="keyword">for</span> i := range op &#123;</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Kind)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Length)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Data)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    binary.Write(buff, binary.BigEndian, [6]byte&#123;&#125;)</div><div class="line"></div><div class="line">    data := buff.Bytes()</div><div class="line">    checkSum := CheckSum(data, ipstr2Bytes(laddr), ipstr2Bytes(raddr))</div><div class="line">    //fmt.Printf(<span class="string">“CheckSum 0x%X\n”</span>, checkSum)</div><div class="line">    tcpH.ChkSum = checkSum</div><div class="line"></div><div class="line">    buff = new(bytes.Buffer)</div><div class="line">    binary.Write(buff, binary.BigEndian, tcpH)</div><div class="line">    <span class="keyword">for</span> i := range op &#123;</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Kind)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Length)</div><div class="line">        binary.Write(buff, binary.BigEndian, op[i].Data)</div><div class="line">    &#125;</div><div class="line">    binary.Write(buff, binary.BigEndian, [6]byte&#123;&#125;)</div><div class="line">    data = buff.Bytes()</div><div class="line"></div><div class="line">    //fmt.Printf(<span class="string">“% X\n”</span>, data)</div><div class="line">    _, err = conn.Write(data)</div><div class="line">    checkError(err)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func recvSynAck(laddr, raddr string, res chan&lt;- scanResult) error &#123;</div><div class="line">    listenAddr, err := net.ResolveIPAddr(<span class="string">“ip4”</span>, laddr) // 解析域名为ip</div><div class="line">    checkError(err)</div><div class="line">    conn, err := net.ListenIP(<span class="string">“ip4:tcp”</span>, listenAddr)</div><div class="line">    defer conn.Close()</div><div class="line">    checkError(err)</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        buff := make([]byte, 1024)</div><div class="line">        _, addr, err := conn.ReadFrom(buff)</div><div class="line">        <span class="keyword">if</span> err != nil &#123;</div><div class="line">            <span class="built_in">continue</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> addr.String() != raddr || buff[13] != 0x12 &#123;</div><div class="line">            <span class="built_in">continue</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        var port uint16</div><div class="line">        binary.Read(bytes.NewReader(buff), binary.BigEndian, &amp;port)</div><div class="line">        res &lt;- &amp;scanResult&#123;</div><div class="line">            Port:   port,</div><div class="line">            Opened: <span class="literal">true</span>,</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func ipstr2Bytes(addr string) [4]byte &#123;</div><div class="line">    s := strings.Split(addr, <span class="string">“.”</span>)</div><div class="line">    b0, _ := strconv.Atoi(s[0])</div><div class="line">    b1, _ := strconv.Atoi(s[1])</div><div class="line">    b2, _ := strconv.Atoi(s[2])</div><div class="line">    b3, _ := strconv.Atoi(s[3])</div><div class="line">    <span class="built_in">return</span> [4]byte&#123;byte(b0), byte(b1), byte(b2), byte(b3)&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">func random(min, max int) int &#123;</div><div class="line">    <span class="built_in">return</span> rand.Intn(max-min) + min</div><div class="line">&#125;</div><div class="line"></div><div class="line">func interfaceAddress(ifaceName string ) string &#123;</div><div class="line">    iface, err:= net.InterfaceByName(ifaceName)</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    addr, err := iface.Addrs()</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    addrStr := strings.Split(addr[0].String(), <span class="string">“/“</span>)[0]</div><div class="line">    <span class="built_in">return</span> addrStr</div><div class="line">&#125;</div><div class="line"></div><div class="line">func portSplit(portRange <em>string) (uint16, uint16) &#123;</em></div><div class="line">    ports := strings.Split(portRange, <span class="string">“-“</span>)</div><div class="line">    minPort, err := strconv.ParseUint(ports[0], 10, 16)</div><div class="line">    <span class="keyword">if</span> err !=nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line">    maxPort, err := strconv.ParseUint(ports[1], 10, 16)</div><div class="line">    <span class="keyword">if</span> err != nil &#123;</div><div class="line">        panic(err)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> minPort &gt; maxPort &#123;</div><div class="line">        panic(errors.New(<span class="string">“minPort must greater than maxPort”</span>))</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">return</span> uint16(minPort), uint16(maxPort)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func <span class="function"><span class="title">main</span></span>() &#123; &#125;</div></pre></td></tr></table></figure><p>然后利用go自身的build命令，将其打包成.so库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">go build -buildmode=c-shared -o tcp_syn_scan.so tcp_syn_scan.go</div></pre></td></tr></table></figure><p>打包后会得到一个tcp_syn_scan.so和一个tcp_syn_scan.h。然后利用下面的python代码就可以调用Go代码中的Scan()函数了，创建一个tcp_syn_scan.py文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line">from ctypes import *</div><div class="line">lib = cdll.LoadLibrary(u<span class="string">‘./scan.so’</span>)</div><div class="line">lib.Scan(<span class="string">“14.215.177.38”</span>,<span class="string">“1-1024”</span>,<span class="string">“eth0”</span>) <span class="comment"># ip,端口范围，网卡</span></div></pre></td></tr></table></figure><p>代码运行结果：<br><img src="/upload_image/20180517/python_go_syn_scan.png" alt=""></p><p>说明：相当原生的go，利用python去调用go会损耗一些性能，但总体上还可以。</p><h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a><a href="#后记" title="后记"></a>后记</h3><p>本文结论就是可以利用go开发扫描模块（性能更佳），并结合python调用。<br>本文代码项目地址：<a href="https://github.com/tengzhangchao/PortScan" target="_blank" rel="noopener">https://github.com/tengzhangchao/PortScan</a></p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a><a href="#参考文章" title="参考文章"></a>参考文章</h3><p><a href="https://blog.csdn.net/pwc1996/article/details/73469850" target="_blank" rel="noopener">https://blog.csdn.net/pwc1996/article/details/73469850</a></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.chucz.club/2018/05/07/利用python开发app实战/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="褚成志"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="褚成志的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"><a class="post-title-link" href="/2018/05/07/利用python开发app实战/" itemprop="url">利用python开发app实战</a></h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-08T05:35:25+08:00">2018-05-08</time></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>你说，我们的未来<br>被装进棺材，染不上尘埃</p></blockquote><p>我很早之前就想开发一款app玩玩，无奈对java不够熟悉，之前也没有开发app的经验，因此一直耽搁了。最近想到尝试用python开发一款app，google搜索了一番后，发现确实有路可寻，目前也有了一些相对成熟的模块，于是便开始了动手实战，过程中发现这其中有很多坑，好在最终依靠google解决了，因此小记一番。<br><a id="more"></a></p><h3 id="说在前面的话"><a href="#说在前面的话" class="headerlink" title="说在前面的话"></a><a href="#说在前面的话" title="说在前面的话"></a>说在前面的话</h3><p>python语言虽然很万能，但用它来开发app还是显得有点不对路，因此用python开发的app应当是作为编码练习、或者自娱自乐所用，加上目前这方面的模块还不是特别成熟，bug比较多，总而言之，劝君莫轻入。</p><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a><a href="#准备工作" title="准备工作"></a>准备工作</h3><p>利用python开发app需要用到python的一个模块–<a href="https://github.com/kivy/kivy" target="_blank" rel="noopener">kivy</a>，kivy是一个开源的，跨平台的Python开发框架，用于开发使用创新的应用程序。简而言之，这是一个python桌面程序开发框架（类似wxpython等模块），强大的是kivy支持linux、mac、windows、android、ios平台，这也是为什么开发app需要用到这个模块。<br>虽然kivy是跨平台的，但是想要在不同的平台使用python代码，还需要将python代码打包成对应平台的可执行程序，好在kivy项目下有个打包工具项目–<a href="https://github.com/kivy/buildozer" target="_blank" rel="noopener">buildozer</a>，这是官方推荐的打包工具，因为相对比较简单，自动化程度高，其他项目比如：<a href="https://github.com/kivy/python-for-android" target="_blank" rel="noopener">python-for-android</a>也能起到类似的作用，这里不展开介绍。</p><h3 id="搭建kivy开发环境"><a href="#搭建kivy开发环境" class="headerlink" title="搭建kivy开发环境"></a><a href="#搭建kivy开发环境" title="搭建kivy开发环境"></a>搭建kivy开发环境</h3><p>需要在pc上安装kivy开发环境，这里演示下mac与linux下的安装过程。</p><h4 id="install-kivy-for-mac"><a href="#install-kivy-for-mac" class="headerlink" title="install kivy for mac"></a><a href="#install-kivy-for-mac" title="install kivy for mac"></a>install kivy for mac</h4><p>安装一些依赖包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install pkg-config sdl2 sdl2_image sdl2_ttf sdl2_mixer gstreamer</div></pre></td></tr></table></figure><p>安装cython以及kivy：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pip install cython==0.25</div><div class="line">pip install kivy</div></pre></td></tr></table></figure><p>如果安装kivy报错，则使用下面的方式安装kivy：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> <a href="https://github.com/kivy/kivy" target="_blank" rel="noopener">https://github.com/kivy/kivy</a></div><div class="line">python setup.py install</div></pre></td></tr></table></figure><p>安装后测试：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$python</span></div><div class="line">Python 2.7.10 (default, Jul 15 2017, 17:16:57)</div><div class="line">[GCC 4.2.1 Compatible Apple LLVM 9.0.0 (clang-900.0.31)] on darwin</div><div class="line">Type <span class="string">“help”</span>, <span class="string">“copyright”</span>, <span class="string">“credits”</span> or <span class="string">“license”</span> <span class="keyword">for</span> more information.</div><div class="line">&gt;&gt;&gt;</div><div class="line">&gt;&gt;&gt; import kivy</div><div class="line">[INFO   ] [Logger      ] Record <span class="built_in">log</span> <span class="keyword">in</span> /Users/didi/.kivy/logs/kivy_18-05-08_4.txt</div><div class="line">[INFO   ] [Kivy        ] v1.10.1.dev0, git-5f6c66e, 20180507</div><div class="line">[INFO   ] [Python      ] v2.7.10 (default, Jul 15 2017, 17:16:57)</div><div class="line">[GCC 4.2.1 Compatible Apple LLVM 9.0.0 (clang-900.0.31)]</div></pre></td></tr></table></figure><p>说明：导入kivy模块没有报错则说明安装成功。</p><h4 id="install-kivy-for-centos7"><a href="#install-kivy-for-centos7" class="headerlink" title="install kivy for centos7"></a><a href="#install-kivy-for-centos7" title="install kivy for centos7"></a>install kivy for centos7</h4><p>先安装依赖：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">yum install \</div><div class="line">    make \</div><div class="line">    mercurial \</div><div class="line">    automake \</div><div class="line">    gcc \</div><div class="line">    gcc-c++ \</div><div class="line">    SDL_ttf-devel \</div><div class="line">    SDL_mixer-devel \</div><div class="line">    khrplatform-devel \</div><div class="line">    mesa-libGLES \</div><div class="line">    mesa-libGLES-devel \</div><div class="line">    gstreamer-plugins-good \</div><div class="line">    gstreamer \</div><div class="line">    gstreamer-python \</div><div class="line">    mtdev-devel \</div><div class="line">    python-devel \</div><div class="line">    python-pip \</div><div class="line">    java-devel</div></pre></td></tr></table></figure><p>安装cython以及kivy:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pip install Cython==0.20</div><div class="line">pip install kivy</div></pre></td></tr></table></figure><p>centos安装kivy参考：<a href="https://kivy.org/docs/installation/installation-linux.html#using-software-packages" target="_blank" rel="noopener">https://kivy.org/docs/installation/installation-linux.html#using-software-packages</a></p><p>说明：其他安装kivy方式可移步：<a href="https://kivy.org/#download（需要翻墙）" target="_blank" rel="noopener">https://kivy.org/#download（需要翻墙）</a></p><h3 id="用kivy开发第一个python-app"><a href="#用kivy开发第一个python-app" class="headerlink" title="用kivy开发第一个python app"></a><a href="#用kivy开发第一个python-app" title="用kivy开发第一个python app"></a>用kivy开发第一个python app</h3><p>安装完kivy就可以开发app程序了，这里演示下hello-world程序，关于kivy更复杂的用法不是本文重点，后面再成文介绍。<br>1) 创建一个main.py文件，写入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#! -<em>- coding:utf-8 -</em>-</span></div><div class="line"></div><div class="line">from kivy.app import App</div><div class="line"></div><div class="line">class HelloApp(App):</div><div class="line">    pass</div><div class="line"></div><div class="line"><span class="keyword">if</span> <strong>name</strong> == <span class="string">‘<strong>main</strong>‘</span>:</div><div class="line">    HelloApp().run()</div></pre></td></tr></table></figure><p>2)创建一个hello.kv文件，写入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Label:</div><div class="line">    text: <span class="string">‘Hello, World! I am nMask’</span></div></pre></td></tr></table></figure><p>简单说明：main.py是入口函数，定义了一个HelloApp类，该类继承kivy.app；hello.kv文件是kivy程序，相当于定义界面风格等，该文件命名规则为类名小写且去除app。</p><h3 id="运行第一个python-app"><a href="#运行第一个python-app" class="headerlink" title="运行第一个python app"></a><a href="#运行第一个python-app" title="运行第一个python app"></a>运行第一个python app</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python main.py</div></pre></td></tr></table></figure><p>运行结果：<br><img src="/upload_image/20180508/1.png" alt=""></p><h3 id="安装buildozer工具"><a href="#安装buildozer工具" class="headerlink" title="安装buildozer工具"></a><a href="#安装buildozer工具" title="安装buildozer工具"></a>安装buildozer工具</h3><p>通过以上的编码，我创建了自己的第一个python app程序，该程序可以直接在mac、linux、windows平台下运行，那么如何让它在安卓或者苹果手机上运行呢？我们知道在安卓上运行，需要将其打包成apk安装程序，因此就需要用到前面提到过的buildozer工具，（buildozer工具可以打包kivy程序，支持android、ios等），buildozer的安装过程比较简单：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install buildozer</div></pre></td></tr></table></figure><h3 id="使用buildozer工具将kivy程序打包成apk"><a href="#使用buildozer工具将kivy程序打包成apk" class="headerlink" title="使用buildozer工具将kivy程序打包成apk"></a><a href="#使用buildozer工具将kivy程序打包成apk" title="使用buildozer工具将kivy程序打包成apk"></a>使用buildozer工具将kivy程序打包成apk</h3><p>在python项目目录下运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">buildozer init</div></pre></td></tr></table></figure><p>运行成功将会创建一个配置文件buildozer.spec，可以通过修改配置文件更改app的名称等，然后运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">buildozer android debug deploy run</div></pre></td></tr></table></figure><p>运行以上命令将会生成跨平台的安装包，可适用安卓、ios等，如果用于安卓，则是利用<a href="https://github.com/kivy/python-for-android" target="_blank" rel="noopener">python-for-android</a>项目。</p><p>在第一次运行以上命令的时候，会自动在系统中下载安卓sdk等必要文件，如下图。（过程需要翻墙，而且有很多依赖需要下载）<br><img src="/upload_image/20180508/2.png" alt=""></p><p>说明：这里只演示打包成apk文件，iso平台的可自行研究，参考文档：<a href="https://github.com/kivy/buildozer。" target="_blank" rel="noopener">https://github.com/kivy/buildozer。</a></p><h3 id="python-apk程序测试"><a href="#python-apk程序测试" class="headerlink" title="python apk程序测试"></a><a href="#python-apk程序测试" title="python apk程序测试"></a>python apk程序测试</h3><p>如果以上步骤都运行成功的话，应该会在项目目录下的bin目录下生成一个apk文件，类似如下：<br><img src="/upload_image/20180508/3.png" alt=""></p><p>然后将apk下载到安卓系统的手机上，安装即可，测试效果如下：<br><img src="/upload_image/20180508/4.png" alt=""><br>打开app：<br><img src="/upload_image/20180508/5.png" alt=""></p><h3 id="buildozer使用说明"><a href="#buildozer使用说明" class="headerlink" title="buildozer使用说明"></a><a href="#buildozer使用说明" title="buildozer使用说明"></a>buildozer使用说明</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">Usage:</div><div class="line">    buildozer [–profile &lt;name&gt;] [–verbose] [target] &lt;<span class="built_in">command</span>&gt;…</div><div class="line">    buildozer –version</div><div class="line"></div><div class="line">Available targets:</div><div class="line">  android        Android target, based on python-for-android project</div><div class="line">  ios            iOS target, based on kivy-ios project</div><div class="line">  android_old    Android target, based on python-for-android project (old toolchain)</div><div class="line"></div><div class="line">Global commands (without target):</div><div class="line">  distclean          Clean the whole Buildozer environment.</div><div class="line">  <span class="built_in">help</span>               Show the Buildozer <span class="built_in">help</span>.</div><div class="line">  init               Create a initial buildozer.spec <span class="keyword">in</span> the current directory</div><div class="line">  serve              Serve the bin directory via SimpleHTTPServer</div><div class="line">  setdefault         Set the default <span class="built_in">command</span> to run when no arguments are given</div><div class="line">  version            Show the Buildozer version</div><div class="line"></div><div class="line">Target commands:</div><div class="line">  clean      Clean the target environment</div><div class="line">  update     Update the target dependencies</div><div class="line">  debug      Build the application <span class="keyword">in</span> debug mode</div><div class="line">  release    Build the application <span class="keyword">in</span> release mode</div><div class="line">  deploy     Deploy the application on the device</div><div class="line">  run        Run the application on the device</div><div class="line">  serve      Serve the bin directory via SimpleHTTPServer</div><div class="line"></div><div class="line">Target <span class="string">“android_old”</span> commands:</div><div class="line">  adb                Run adb from the Android SDK. Args must come after –, or</div><div class="line">                     use –<span class="built_in">alias</span> to make an <span class="built_in">alias</span></div><div class="line">  logcat             Show the <span class="built_in">log</span> from the device</div><div class="line"></div><div class="line">Target <span class="string">“ios”</span> commands:</div><div class="line">  list_identities    List the available identities to use <span class="keyword">for</span> signing.</div><div class="line">  xcode              Open the xcode project.</div><div class="line"></div><div class="line">Target <span class="string">“android”</span> commands:</div><div class="line">  adb                Run adb from the Android SDK. Args must come after –, or</div><div class="line">                     use –<span class="built_in">alias</span> to make an <span class="built_in">alias</span></div><div class="line">  logcat             Show the <span class="built_in">log</span> from the device</div><div class="line">  p4a                Run p4a commands. Args must come after –, or use –<span class="built_in">alias</span></div><div class="line">                     to make an <span class="built_in">alias</span></div></pre></td></tr></table></figure><h3 id="buildozer打包过程中的坑点"><a href="#buildozer打包过程中的坑点" class="headerlink" title="buildozer打包过程中的坑点"></a><a href="#buildozer打包过程中的坑点" title="buildozer打包过程中的坑点"></a>buildozer打包过程中的坑点</h3><p>如果在打包过程中遇到报错，可以修改buildozer.spec配置文件中的log_level为2，然后重新运行，可以看具体的错误信息。</p><h4 id="报错：You-might-have-missed-to-install-32bits-libs"><a href="#报错：You-might-have-missed-to-install-32bits-libs" class="headerlink" title="报错：You might have missed to install 32bits libs"></a><a href="#报错：You-might-have-missed-to-install-32bits-libs" title="报错：You might have missed to install 32bits libs"></a>报错：You might have missed to install 32bits libs</h4><p>这个错是我在centos7上运行时报的错，大意是系统缺少了某些32位的依赖文件。<br>解决方案：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install –skip-broken glibc.i686 arts.i686 audiofile.i686 bzip2-libs.i686 cairo.i686 cyrus-sasl-lib.i686 dbus-libs.i686 directfb.i686 esound-libs.i686 fltk.i686 freeglut.i686 gtk2.i686 hal-libs.i686 imlib.i686 lcms-libs.i686 lesstif.i686 libacl.i686 libao.i686 libattr.i686 libcap.i686 libdrm.i686 libexif.i686 libgnomecanvas.i686 libICE.i686 libieee1284.i686 libsigc++20.i686 libSM.i686 libtool-ltdl.i686 libusb.i686 libwmf.i686 libwmf-lite.i686 libX11.i686 libXau.i686 libXaw.i686 libXcomposite.i686 libXdamage.i686 libXdmcp.i686 libXext.i686 libXfixes.i686 libxkbfile.i686 libxml2.i686 libXmu.i686 libXp.i686 libXpm.i686 libXScrnSaver.i686 libxslt.i686 libXt.i686 libXtst.i686 libXv.i686 libXxf86vm.i686 lzo.i686 mesa-libGL.i686 mesa-libGLU.i686 nas-libs.i686 nss_ldap.i686 cdk.i686 openldap.i686 pam.i686 popt.i686 pulseaudio-libs.i686 sane-backends-libs-gphoto2.i686 sane-backends-libs.i686 SDL.i686 svgalib.i686 unixODBC.i686 zlib.i686 compat-expat1.i686 compat-libstdc++-33.i686 openal-soft.i686 alsa-oss-libs.i686 redhat-lsb.i686 alsa-plugins-pulseaudio.i686 alsa-plugins-oss.i686 alsa-lib.i686 nspluginwrapper.i686 libXv.i686 libXScrnSaver.i686 qt.i686 qt-x11.i686 pulseaudio-libs.i686 pulseaudio-libs-glib2.i686 alsa-plugins-pulseaudio.i686 python-matplotli</div></pre></td></tr></table></figure><p>参考：<a href="https://ask.fedoraproject.org/en/question/9556/how-do-i-install-32bit-libraries-on-a-64-bit-fedora/" target="_blank" rel="noopener">https://ask.fedoraproject.org/en/question/9556/how-do-i-install-32bit-libraries-on-a-64-bit-fedora/</a></p><h4 id="报错：Error-compiling-Cython-file"><a href="#报错：Error-compiling-Cython-file" class="headerlink" title="报错：Error compiling Cython file"></a><a href="#报错：Error-compiling-Cython-file" title="报错：Error compiling Cython file"></a>报错：Error compiling Cython file</h4><p>错误大意为cython文件出错，可能是cython模块没有安装，或者版本有问题。<br>解决方案：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install cython==0.25</div></pre></td></tr></table></figure><h4 id="报错：IOError-Errno-2-No-such-file-or-directory…"><a href="#报错：IOError-Errno-2-No-such-file-or-directory…" class="headerlink" title="报错：IOError: [Errno 2] No such file or directory….."></a><a href="#报错：IOError-Errno-2-No-such-file-or-directory…" title="报错：IOError: [Errno 2] No such file or directory….."></a>报错：IOError: [Errno 2] No such file or directory…..</h4><p>这是在打包的最后一步，将apk文件copy到项目bin目录下时报的错，是buildozer的一个bug。<br>解决方案：<br>修改/usr/local/lib/python2.7/dist-packages/buildozer/tagets/android.py文件：<br>(1)在文件开头导入:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">from distutils.version import LooseVersion</div></pre></td></tr></table></figure><p>(2) 将786行:XXX found how the apk name is really built from the title这一行以下的代码替换为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><strong>sdk_dir = self.android_sdk_dir</strong></div><div class="line">build_tools_versions = os.listdir(join(sdk_dir, <span class="string">‘build-tools’</span>))</div><div class="line">build_tools_versions = sorted(build_tools_versions, key=LooseVersion)</div><div class="line">build_tools_version = build_tools_versions[-1]</div><div class="line">gradle_files = [<span class="string">“build.gradle”</span>, <span class="string">“gradle”</span>, <span class="string">“gradlew”</span>]</div><div class="line">is_gradle_build = any((exists(join(dist_dir, x)) <span class="keyword">for</span> x <span class="keyword">in</span> gradle_files)) and build_tools_version &gt;= ’25.0<span class="string">‘</span></div></pre></td></tr></table></figure><h3 id="buildozer虚拟机"><a href="#buildozer虚拟机" class="headerlink" title="buildozer虚拟机"></a><a href="#buildozer虚拟机" title="buildozer虚拟机"></a>buildozer虚拟机</h3><p>kivy官方推出了一个buildozer虚拟机镜像，已经安装好了buildozer以及一些依赖文件，为buildozer打包测试提供平台。由于之前我在mac上利用buildozer打包一直报错，后来换成centos也依然没有成功，因此便下载了此虚拟机，测试效果如下：<br><img src="/upload_image/20180508/6.png" alt=""></p><p>虚拟机下载地址：<a href="http://txzone.net/files/torrents/kivy-buildozer-vm-2.0.zip" target="_blank" rel="noopener">http://txzone.net/files/torrents/kivy-buildozer-vm-2.0.zip</a></p><p>说明：对于无法解决依赖问题的朋友，可以使用此虚拟机进行程序打包，开发环境还是推荐用自己的本机。</p><h3 id="kivy开发实例"><a href="#kivy开发实例" class="headerlink" title="kivy开发实例"></a><a href="#kivy开发实例" title="kivy开发实例"></a>kivy开发实例</h3><p>因为本文重点在于介绍如何利用kivy+buildozer开发一款python app，因此对于kivy的开发过程，以及app功能进行了最简化。想要学习如何开发更复杂的app，可参考：<a href="https://muxuezi.github.io/posts/kivy-perface.html#" target="_blank" rel="noopener">https://muxuezi.github.io/posts/kivy-perface.html#</a></p><p><em>～！～ 折腾python使我快乐，……，想想还是滚回去学java吧 ～！～</em></p></div><footer class="post-footer"><div class="post-eof"></div></footer></div></article></section><nav class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a></nav></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">褚成志</p><p class="site-description motion-element" itemprop="description">关注互联网的科技博客</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">67</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><span class="site-state-item-count">1</span> <span class="site-state-item-name">分类</span></div><div class="site-state-item site-state-tags"><span class="site-state-item-count">38</span> <span class="site-state-item-name">标签</span></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">褚成志</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div><span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script></body></html><!-- rebuild by neat -->