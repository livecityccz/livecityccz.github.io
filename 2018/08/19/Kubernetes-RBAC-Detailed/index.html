<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta name="baidu-site-verification" content="2WtclSxlwa" />
<meta name="google-site-verification" content="-v1R6yxahUz-_HLWFSGNlUtQ5JburbSV6Ma_eU9eOXo" />
<meta name="msvalidate.01" content="B593F889E6A9B7CAEB29758AD324E36B" />
<meta name="360-site-verification" content="7347f8994b75a4f74367571b5d5b45a8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="K8s," />





  <link rel="alternate" href="/atom.xml" title="褚成志的博客" type="application/atom+xml" />






<meta name="description" content="RBAC - 基于角色的访问控制RBAC使用：rbac.authorization.k8s.io API Group 来实现授权决策，允许管理员通过 Kubernetes API 动态配置策略，要启用RBAC，需要在 apiserver 中添加参数–authorization-mode=RBAC，如果使用的kubeadm安装的集群，1.6 版本以上的都默认开启了RBAC，可以通过查看 Master">
<meta name="keywords" content="K8s">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes RBAC  Detailed">
<meta property="og:url" content="http://chucz.club/2018/08/19/Kubernetes-RBAC-Detailed/index.html">
<meta property="og:site_name" content="褚成志的博客">
<meta property="og:description" content="RBAC - 基于角色的访问控制RBAC使用：rbac.authorization.k8s.io API Group 来实现授权决策，允许管理员通过 Kubernetes API 动态配置策略，要启用RBAC，需要在 apiserver 中添加参数–authorization-mode=RBAC，如果使用的kubeadm安装的集群，1.6 版本以上的都默认开启了RBAC，可以通过查看 Master">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-09-28T08:25:28.616Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubernetes RBAC  Detailed">
<meta name="twitter:description" content="RBAC - 基于角色的访问控制RBAC使用：rbac.authorization.k8s.io API Group 来实现授权决策，允许管理员通过 Kubernetes API 动态配置策略，要启用RBAC，需要在 apiserver 中添加参数–authorization-mode=RBAC，如果使用的kubeadm安装的集群，1.6 版本以上的都默认开启了RBAC，可以通过查看 Master">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://chucz.club/2018/08/19/Kubernetes-RBAC-Detailed/"/>





  <title>Kubernetes RBAC  Detailed | 褚成志的博客</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'livecityccz@gmail.com', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">褚成志的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">青青子衿, 悠悠我心</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/08/19/Kubernetes-RBAC-Detailed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="褚成志">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="褚成志的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Kubernetes RBAC  Detailed</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T01:51:37+00:00">
                2018-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2018/08/19/Kubernetes-RBAC-Detailed/" class="leancloud_visitors" data-flag-title="Kubernetes RBAC  Detailed">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6.6k
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>RBAC - 基于角色的访问控制<br>RBAC使用：rbac.authorization.k8s.io API Group 来实现授权决策，允许管理员通过 Kubernetes API 动态配置策略，要启用RBAC，需要在 apiserver 中添加参数–authorization-mode=RBAC，如果使用的kubeadm安装的集群，1.6 版本以上的都默认开启了RBAC，可以通过查看 Master 节点上 apiserver 的静态Pod定义文件：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">kube</span>-<span class="title">apiserver</span>.<span class="title">service</span></span></span><br><span class="line">或者是：</span><br><span class="line">$ cat /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">…</span><br><span class="line">    - –authorization-mode=Node,RBAC</span><br><span class="line">…</span><br></pre></td></tr></table></figure>

<p>如果是二进制的方式搭建的集群，添加这个参数过后，记得要重启 apiserver 服务。</p>
<hr>
<h3 id="RBAC-API-对象"><a href="#RBAC-API-对象" class="headerlink" title="RBAC API 对象"></a><a href="#RBAC-API-对象" title="RBAC API 对象"></a>RBAC API 对象</h3><p>Kubernetes有一个很基本的特性就是它的所有资源对象都是模型化的 API 对象，允许执行 CRUD(Create、Read、Update、Delete)操作(也就是我们常说的增、删、改、查操作)，比如下面的这下资源：</p>
<ul>
<li>Pods</li>
<li>ConfigMaps</li>
<li>Deployments</li>
<li>Nodes</li>
<li>Secrets</li>
<li>Namespaces</li>
</ul>
<p>上面这些资源对象的可能存在的操作有：</p>
<ul>
<li>create</li>
<li>get</li>
<li>delete</li>
<li>list</li>
<li>update</li>
<li>edit</li>
<li>watch</li>
<li>exec</li>
</ul>
<p>在更上层，这些资源和API Group 进行关联，比如Pods属于Core API Group，而Deployements属于 apps API Group，要在Kubernetes中进行RBAC的管理，除了上面的这些资源和操作以外，我们还需要另外的一些对象：</p>
<ol>
<li>Rule：规则，规则是一组属于不同API Group 资源上的一组操作的集合</li>
<li>Role 和 ClusterRole：角色和集群角色，这两个对象都包含上面的Rules 元素，二者的区别在于，在Role 中，定义的规则只适用于单个命名空间，也就是和namespace 关联的，而ClusterRole 是集群范围内的，因此定义的规则不受命名空间的约束。另外Role和 ClusterRole在Kubernetes中都被定义为集群内部的API 资源，和Pod、ConfigMap 这些类似，都是集群的资源对象，所以同样的可以使用kubectl相关的命令来进行操作</li>
<li><p>Subject：主题，对应在集群中尝试操作的对象，集群中定义了3种类型的主题资源：</p>
<pre><code>*   User Account：用户，这是有外部独立服务进行管理的，管理员进行私钥的分配，用户可以使用KeyStone或者Goolge 帐号，甚至一个用户名和密码的文件列表也可以。对于用户的管理集群内部没有一个关联的资源对象，所以用户不能通过集群内部的API 来进行管理
</code></pre><ul>
<li>Group：组，这是用来关联多个账户的，集群中有一些默认创建的组，比如cluster-admin</li>
<li>Service Account：服务帐号，通过Kubernetes API 来管理的一些用户帐号，和namespace 进行关联的，适用于集群内部运行的应用程序，需要通过API 来完成权限认证，所以在集群内部进行权限操作，都需要使用到 ServiceAccount</li>
</ul>
</li>
<li>RoleBinding和 ClusterRoleBinding：角色绑定和集群角色绑定，简单来说就是把声明的Subject和Role 进行绑定的过程(给某个用户绑定上操作的权限)，二者的区别也是作用范围的区别：RoleBinding只会影响到当前namespace 下面的资源操作权限，而ClusterRoleBinding会影响到所有的 namespace。<a id="more"></a></li>
</ol>
<hr>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a><a href="#示例" title="示例"></a>示例</h3><p>通过如下示例来演示RBAC的配置方法：</p>
<h4 id="创建一个只能访问某个-namespace-的用户"><a href="#创建一个只能访问某个-namespace-的用户" class="headerlink" title="创建一个只能访问某个 namespace 的用户"></a><a href="#创建一个只能访问某个-namespace-的用户" title="创建一个只能访问某个 namespace 的用户"></a>创建一个只能访问某个 namespace 的用户</h4><p>创建一个 User Account，只能访问 kube-system这个命名空间：</p>
<ul>
<li>username: martin</li>
<li>group: op</li>
</ul>
<h5 id="第一步：创建用户凭证"><a href="#第一步：创建用户凭证" class="headerlink" title="第一步：创建用户凭证"></a><a href="#第一步：创建用户凭证" title="第一步：创建用户凭证"></a>第一步：创建用户凭证</h5><p>Kubernetes没有User Account的API 对象，不过要创建一个用户帐号的话也是挺简单的，利用管理员分配的一个私钥就可以创建了。<br>创建方法有两种:</p>
<h6 id="1-使用OpenSSL证书来创建User；"><a href="#1-使用OpenSSL证书来创建User；" class="headerlink" title="1. 使用OpenSSL证书来创建User；"></a><a href="#1-使用OpenSSL证书来创建User；" title="1\. 使用OpenSSL证书来创建User；"></a>1. 使用OpenSSL证书来创建User；</h6><ul>
<li><p>给用户martin创建一个私钥，命名成：martin.key：<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -out martin.<span class="type">key</span> <span class="number">2048</span></span><br></pre></td></tr></table></figure></p>
</li>
<li><p>使用刚刚创建的私钥创建一个证书签名请求文件：martin.csr，要注意需要确保在-subj参数中指定用户名和组(CN表示用户名，O表示组)：<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -new -key martin<span class="selector-class">.key</span> -out martin<span class="selector-class">.csr</span> -subj <span class="string">“/CN=martin/O=op”</span></span><br></pre></td></tr></table></figure></p>
</li>
<li><p>然后找到Kubernetes集群的CA，我们使用的是kubeadm安装的集群，CA相关证书位于/etc/kubernetes/pki/目录下面，如果是二进制方式搭建的，应该在最开始搭建集群的时候就已经指定好了CA的目录(/data/kubernetes/ssl)，然后利用该目录下面的ca.crt和ca.key两个文件来批准上面的证书请求</p>
</li>
<li><p>生成最终的证书文件，这里设置证书的有效期为500天<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -req -<span class="keyword">in</span> martin<span class="selector-class">.csr</span> -CA /data/kubernetes/ssl/ca<span class="selector-class">.crt</span> -CAkey /data/kubernetes/ssl/ca<span class="selector-class">.key</span> -CAcreateserial -out martin<span class="selector-class">.crt</span> -days <span class="number">500</span></span><br><span class="line">现在查看当前文件夹下面是否生成了一个证书文件：</span><br><span class="line">$ ls</span><br><span class="line">martin<span class="selector-class">.csr</span> martin<span class="selector-class">.key</span> martin.crt</span><br></pre></td></tr></table></figure></p>
</li>
<li><p>现在可以使用刚刚创建的证书文件和私钥文件在集群中创建新的凭证和上下文(Context):<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl<span class="built_in"> config </span>set-credentials martin <span class="attribute">–client-certificate</span>=martin.crt  <span class="attribute">–client-key</span>=martin.key</span><br></pre></td></tr></table></figure></p>
</li>
<li><p>可以看到一个用户martin创建了，然后为这个用户设置新的 Context:<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl<span class="built_in"> config </span>set-context martin-context <span class="attribute">–cluster</span>=kubernetes <span class="attribute">–namespace</span>=kube-system <span class="attribute">–user</span>=martin</span><br></pre></td></tr></table></figure></p>
</li>
</ul>
<p>到这里，用户martin就已经创建成功了，现在使用当前的这个配置文件来操作kubectl命令的时候，应该会出现错误，因为还没有为该用户定义任何操作的权限：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> pods <span class="attribute">–context</span>=martin-context</span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Forbidden): pods is forbidden:<span class="built_in"> User </span><span class="string">“martin”</span> cannot list pods <span class="keyword">in</span> the namespace <span class="string">“default”</span></span><br></pre></td></tr></table></figure>

<h6 id="2-使用cfssl工具来创建，也是参考官方文档中的方法。"><a href="#2-使用cfssl工具来创建，也是参考官方文档中的方法。" class="headerlink" title="2. 使用cfssl工具来创建，也是参考官方文档中的方法。"></a><a href="#2-使用cfssl工具来创建，也是参考官方文档中的方法。" title="2\. 使用cfssl工具来创建，也是参考官方文档中的方法。"></a>2. 使用cfssl工具来创建，也是参考官方文档中的方法。</h6><ul>
<li><p>CFSSL是CloudFlare开源的一款PKI/TLS工具。 CFSSL 包含一个命令行工具和一个用于签名，验证并且捆绑TLS证书的HTTP API服务。使用Go语言编写。</p>
</li>
<li><p>CFSSL包括：</p>
<ul>
<li>一组用于生成自定义TLS PKI的工具</li>
<li>cfssl程序，是CFSSL的命令行工具</li>
<li>multirootca程序是可以使用多个签名密钥的证书颁发机构服务器</li>
<li>mkbundle程序用于构建证书池</li>
<li>cfssljson程序，从cfssl和multirootca程序获取JSON输出，并将证书，密钥，CSR和bundle写入磁盘</li>
</ul>
</li>
<li><p>PKI借助数字证书和公钥加密技术提供可信任的网络身份。通常，证书就是一个包含如下身份信息的文件：</p>
<ul>
<li>证书所有组织的信息</li>
<li>公钥</li>
<li>证书颁发组织的信息</li>
<li>证书颁发组织授予的权限，如证书有效期、适用的主机名、用途等</li>
<li>使用证书颁发组织私钥创建的数字签名</li>
</ul>
</li>
<li><p>cfssl工具，子命令介绍：</p>
<ul>
<li>bundle: 创建包含客户端证书的证书包</li>
<li>genkey: 生成一个key(私钥)和CSR(证书签名请求)</li>
<li>scan: 扫描主机问题</li>
<li>revoke: 吊销证书</li>
<li>certinfo: 输出给定证书的证书信息，跟cfssl-certinfo 工具作用一样</li>
<li>gencrl: 生成新的证书吊销列表</li>
<li>selfsign: 生成一个新的自签名密钥和签名证书</li>
<li>print-defaults: 打印默认配置，这个默认配置可以用作模板</li>
<li>serve: 启动一个HTTP API服务</li>
<li>gencert: 生成新的key(密钥)和签名证书</li>
<li>-ca：指明ca的证书</li>
<li>-ca-key：指明ca的私钥文件</li>
<li>-config：指明请求证书的json文件</li>
<li>-profile：与-config中的profile对应，是指根据config中的prof  ile段来生成证书的相关信息</li>
<li>ocspdump</li>
<li>ocspsign</li>
<li>info: 获取有关远程签名者的信息</li>
<li>sign: 签名一个客户端证书，通过给定的CA和CA密钥，和主机名</li>
<li>ocsprefresh</li>
<li>ocspserve</li>
</ul>
</li>
<li><p>创建认证中心(CA)，也就是Kubernetes集群的CA，上面用openssl时已经将其省略了，现cfssl操作说明下详细方法：</p>
<ol>
<li><p>CFSSL可以创建一个获取和操作证书的内部认证中心。运行认证中心需要一个CA证书和相应的CA私钥。任何知道私钥的人都可以充当CA颁发证书。因此，私钥的保护至关重要。</p>
<ol start="2">
<li>创建用来生成CA文件的JSON配置文件,配置证书生成策略，让CA软件知道颁发什么样的证书。<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ssl]# vim ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“signing”</span>: &#123;</span><br><span class="line">    <span class="string">“default”</span>: &#123;</span><br><span class="line">      <span class="string">“expiry”</span>: <span class="string">“8760h”</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">“profiles”</span>: &#123;</span><br><span class="line">      <span class="string">“kubernetes”</span>: &#123;</span><br><span class="line">        <span class="string">“usages”</span>: [</span><br><span class="line">            <span class="string">“signing”</span>,</span><br><span class="line">            <span class="string">“key encipherment”</span>,</span><br><span class="line">            <span class="string">“server auth”</span>,</span><br><span class="line">            <span class="string">“client auth”</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">“expiry”</span>: <span class="string">“8760h”</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">这个策略，有一个默认的配置，和一个profile，可以设置多个profile，这里的profile   是kubernetes。</span><br><span class="line">默认策略，指定了证书的有效期是一年(8760h)</span><br><span class="line">kubernetes策略，指定了证书的用途</span><br><span class="line">signing, 表示该证书可用于签名其它证书；生成的ca.pem 证书中   <span class="attribute">CA</span>=<span class="literal">TRUE</span></span><br><span class="line">server auth：表示client可以用该CA对server提供的证书进行验证</span><br><span class="line">client auth：表示server可以用该CA对client提供的证书进行验证</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>创建用来生成CA证书签名请求（CSR）的JSON配置文件<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ssl]<span class="comment"># vim ca-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“CN”</span>: <span class="string">“kubernetes”</span>,</span><br><span class="line">  <span class="string">“key”</span>: &#123;</span><br><span class="line">    <span class="string">“algo”</span>: <span class="string">“rsa”</span>,</span><br><span class="line">    <span class="string">“size”</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“names”</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">“C”</span>: <span class="string">“CN”</span>,</span><br><span class="line">      <span class="string">“ST”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“L”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“O”</span>: <span class="string">“k8s”</span>,</span><br><span class="line">      <span class="string">“OU”</span>: <span class="string">“System”</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">术语介绍:</span></span><br><span class="line"><span class="section">CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。浏览器使用该字段验证网站是否合法</span></span><br><span class="line"><span class="section">C: Country， 国家</span></span><br><span class="line"><span class="section">L: Locality，地区，城市</span></span><br><span class="line"><span class="section">O: Organization Name，组织名称，公司名称</span></span><br><span class="line"><span class="section">OU: Organization Unit Name，组织单位名称，公司部门</span></span><br><span class="line"><span class="section">ST: State，州，省</span></span><br></pre></td></tr></table></figure></li>
<li>生成CA证书（ca.pem）和私钥（ca-key.pem）<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ linux-node1 ssl]<span class="comment"># cfssl gencert -initca ca-csr.json |   cfssljson -bare ca  </span></span><br><span class="line"><span class="comment">#初始化ca</span></span><br><span class="line">[root@ linux-node1 ssl]<span class="comment"># ls -l ca*</span></span><br><span class="line">-rw-r–r–<span class="number"> 1 </span>root root <span class="number"> 290 </span>Mar <span class="number"> 4 </span>13:45 ca-config.json</span><br><span class="line">-rw-r–r–<span class="number"> 1 </span>root root<span class="number"> 1001 </span>Mar <span class="number"> 4 </span>14:09 ca.csr</span><br><span class="line">-rw-r–r–<span class="number"> 1 </span>root root <span class="number"> 208 </span>Mar <span class="number"> 4 </span>13:51 ca-csr.json</span><br><span class="line">-rw——-<span class="number"> 1 </span>root root<span class="number"> 1679 </span>Mar <span class="number"> 4 </span>14:09 ca-key.pem</span><br><span class="line">-rw-r–r–<span class="number"> 1 </span>root root<span class="number"> 1359 </span>Mar <span class="number"> 4 </span>14:09 ca.pem</span><br><span class="line">该命令会生成运行CA所必需的文件ca-key.pem（私钥）和ca.pem（证书），还会生成ca.csr（证书签名请求），用于交叉签名或重新签名。</span><br></pre></td></tr></table></figure></li>
</ol>
<p>小提示：</p>
<ul>
<li>使用现有的CA私钥，重新生成：<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca -<span class="keyword">ca</span>-key key.pem <span class="keyword">ca</span>-csr.json |     cfssljson -bare <span class="keyword">ca</span></span><br></pre></td></tr></table></figure></li>
<li>使用现有的CA私钥和CA证书，重新生成：<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">cfssl</span> <span class="selector-tag">gencert</span> <span class="selector-tag">-renewca</span> <span class="selector-tag">-ca</span> <span class="selector-tag">cert</span><span class="selector-class">.pem</span> <span class="selector-tag">-ca-key</span> <span class="selector-tag">key</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure></li>
<li><p>查看cert(证书信息)：cfssl certinfo -cert ca.pem</p>
<ul>
<li>查看CSR(证书签名请求)信息：cfssl certinfo -csr ca.csr</li>
</ul>
</li>
</ul>
</li>
<li>创建martin证书签名请求(Kubernetes集群的CA创建好了，再根据该CA证书来创建一个只能访问某个namespace的用户)<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  martin cat martin-csr.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“CN”</span>: <span class="string">“martin”</span>,</span><br><span class="line">  <span class="string">“hosts”</span>: [],</span><br><span class="line">  <span class="string">“key”</span>: &#123;</span><br><span class="line">    <span class="string">“algo”</span>: <span class="string">“rsa”</span>,</span><br><span class="line">    <span class="string">“size”</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“names”</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">“C”</span>: <span class="string">“CN”</span>,</span><br><span class="line">      <span class="string">“ST”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“L”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“O”</span>: <span class="string">“op”</span>, <span class="comment">#system:masters</span></span><br><span class="line">      <span class="string">“OU”</span>: <span class="string">“System”</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">➜  martin </span><br><span class="line">后续kube-apiserver使用RBAC对客户端(如kubelet、kube-proxy、Pod)请求进行授权；</span><br><span class="line">kube-apiserver预定义了一些RBAC使用的RoleBindings，如cluster-admin将<span class="keyword">Group</span> <span class="title">op</span>(system:masters)与 <span class="keyword">Role</span> <span class="title">cluster-admin</span> 绑定，该Role授予了调用kube-apiserver的所有API的权限；</span><br><span class="line">OU指定该证书的Group为<span class="keyword">op</span>(system:masters)，kubelet使用该证书访问 kube-apiserver时,由于证书被CA签名，所以认证通过，同时由于证书用户组为经过预授权的<span class="keyword">op</span>(system:masters)，所以被授予访问所有 API 的权限；</span><br></pre></td></tr></table></figure></li>
<li>生成martin证书和私钥<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="keyword">martin </span>ls -lth</span><br><span class="line"><span class="symbol">total</span> <span class="number">4</span>.<span class="number">0</span>K</span><br><span class="line">-rw-r–r– <span class="number">1</span> root root <span class="number">218</span> Jun <span class="number">26</span> <span class="number">11</span>:<span class="number">59</span> <span class="keyword">martin-csr.json</span></span><br><span class="line"><span class="keyword">➜ </span> <span class="keyword">martin </span>cfssl gencert -ca=/<span class="meta">data</span>/kubernetes/ssl/ca.pem -ca-key=/<span class="meta">data</span>/kubernetes/ssl/ca-key.pem -config=/<span class="meta">data</span>/kubernetes/ssl/ca-config.json -profile<span class="symbol">=kubernetes</span> <span class="keyword">martin-csr.json|cfssljson </span>-<span class="keyword">bare </span><span class="keyword">martin</span></span><br><span class="line"><span class="keyword">2018/06/26 </span><span class="number">16</span>:<span class="number">20</span>:<span class="number">37</span> [<span class="meta">INFO</span>] generate received request</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">37</span> [<span class="meta">INFO</span>] received CSR</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">37</span> [<span class="meta">INFO</span>] generating key: rsa-<span class="number">2048</span></span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">38</span> [<span class="meta">INFO</span>] encoded CSR</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">38</span> [<span class="meta">INFO</span>] signed certificate with serial number <span class="number">451530418945753741698899402739082416074910829402</span></span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">38</span> [WARNING] This certificate lacks a <span class="string">“hosts”</span> <span class="meta">field</span>. This makes <span class="keyword">it </span>unsuitable for</span><br><span class="line"><span class="symbol">websites.</span> For more information see the <span class="keyword">Baseline </span>Requirements for the Issuance <span class="keyword">and </span>Management</span><br><span class="line"><span class="symbol">of</span> Publicly-Trusted Certificates, v.<span class="number">1</span>.<span class="number">1</span>.<span class="number">6</span>, from the CA/<span class="keyword">Browser </span>Forum (<a href="https://cabforum.org" target="_blank" rel="noopener">https://cabforum.org</a>)<span class="comment">;</span></span><br><span class="line"><span class="symbol">specifically</span>, section <span class="number">10</span>.<span class="number">2</span>.<span class="number">3</span> (<span class="string">“Information Requirements”</span>).</span><br><span class="line">➜  <span class="keyword">martin </span>ls -lth</span><br><span class="line"><span class="symbol">total</span> <span class="number">16</span>K</span><br><span class="line">-rw-r–r– <span class="number">1</span> root root  <span class="number">993</span> Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> <span class="keyword">martin.csr</span></span><br><span class="line"><span class="keyword">-rw——- </span><span class="number">1</span> root root <span class="number">1</span>.<span class="number">7</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> <span class="keyword">martin-key.pem</span></span><br><span class="line"><span class="keyword">-rw-r–r– </span><span class="number">1</span> root root <span class="number">1</span>.<span class="number">4</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> <span class="keyword">martin.pem</span></span><br><span class="line"><span class="keyword">-rw-r–r– </span><span class="number">1</span> root root  <span class="number">218</span> Jun <span class="number">26</span> <span class="number">11</span>:<span class="number">59</span> <span class="keyword">martin-csr.json</span></span><br><span class="line"><span class="keyword">➜ </span> <span class="keyword">martin</span></span><br></pre></td></tr></table></figure></li>
<li>设置集群参数</li>
</ul>
<p>本段主要设置了需要访问的集群的信息。使用set-cluster设置了需要访问的集群，如下为kubernetes，这只是个名称，实际为–server指向的apiserver；–certificate-authority设置了该集群的公钥；–embed-certs为true表示将–certificate-authority证书写入到kubeconfig中；–server则表示该集群的kube-apiserver地址</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl config set-cluster kubernetes –certificate-authority=/data/kubernetes/ssl/ca<span class="selector-class">.pem</span> –embed-certs=true –server=https:<span class="comment">//192.168.0.14:6443 –kubeconfig=martin.kubeconfig</span></span><br><span class="line">Cluster <span class="string">“kubernetes”</span> set.</span><br><span class="line">➜  martin ls -lth</span><br><span class="line">total <span class="number">20</span>K</span><br><span class="line">-rw——- <span class="number">1</span> root root <span class="number">2.0</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">29</span> martin.kubeconfig</span><br><span class="line">-rw-r–r– <span class="number">1</span> root root  <span class="number">993</span> Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> martin.csr</span><br><span class="line">-rw——- <span class="number">1</span> root root <span class="number">1.7</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> martin-key.pem</span><br><span class="line">-rw-r–r– <span class="number">1</span> root root <span class="number">1.4</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> martin.pem</span><br><span class="line">-rw-r–r– <span class="number">1</span> root root  <span class="number">218</span> Jun <span class="number">26</span> <span class="number">11</span>:<span class="number">59</span> martin-csr.json</span><br><span class="line">生成了新的文件：martin.kubeconfig</span><br><span class="line">➜  martin cat martin<span class="selector-class">.kubeconfig</span> </span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: xxx</span><br><span class="line">    server: https:<span class="comment">//192.168.0.14:6443</span></span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts: []</span><br><span class="line">current-context: <span class="string">“”</span></span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users: []</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>注意：–kubeconfig=martin.kubeconfig是将生成的相关信息全部写入martin.kubeconfig文件,如果不指定的话，默认是写入到“~/.kube/config ”</p>
<ul>
<li>设置客户端认证参数</li>
</ul>
<p>本段主要设置用户的相关信息，主要是用户证书。如下用户名为martin，证书为：/martin.pem，私钥为：./martin-key.pem。客户端的证书首先要经过集群CA的签署，否则不会被集群认可。此处使用的是ca认证方式，也可以使用token认证，如kubelet的TLS Boostrap机制下的bootstrapping使用的就是token认证方式。如下kubectl使用的是ca认证，不需要token字段</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl<span class="built_in"> config </span>set-credentials martin <span class="attribute">–client-certificate</span>=./martin.pem <span class="attribute">–client-key</span>=./martin-key.pem <span class="attribute">–embed-certs</span>=<span class="literal">true</span> <span class="attribute">–kubeconfig</span>=martin.kubeconfig                                      </span><br><span class="line">User <span class="string">“martin”</span> set.</span><br><span class="line">➜  martin </span><br><span class="line">可以看到martin.kubeconfig新增了如下内容：</span><br><span class="line">users:</span><br><span class="line">- name: martin</span><br><span class="line">  user:</span><br><span class="line">    xxx</span><br></pre></td></tr></table></figure>

<ul>
<li>设置上下文参数,指定命名空间为：kube-system</li>
</ul>
<p>集群参数和用户参数可以同时设置多对，在上下文参数中将集群参数和用户参数关联起来。下面的上下文名称为martin-context，集群为kubenetes，用户为martin，表示使用martin的用户凭证来访问kubenetes集群的kube-system命名空间(增加–namspace来指定访问的命名空间)。</p>
<p>执行之前先看下:martin.kubeconfig文件内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">martin</span> <span class="string">cat</span> <span class="string">martin.kubeconfig</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="attr">- cluster:</span></span><br><span class="line"><span class="attr">    certificate-authority-data:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">    server:</span> <span class="attr"><a href="https://192.168.0.14:6443" target="_blank" rel="noopener">https://192.168.0.14:6443</a></span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">“”</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">martin</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line"><span class="attr">    client-certificate-data:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">    client-key-data:</span> <span class="string">xxx</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">martin</span></span><br></pre></td></tr></table></figure>

<p>执行：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl<span class="built_in"> config </span>set-context martin-context <span class="attribute">–cluster</span>=kubernetes <span class="attribute">–namespace</span>=kube-system <span class="attribute">–user</span>=martin <span class="attribute">–kubeconfig</span>=martin.kubeconfig   </span><br><span class="line">Context <span class="string">“martin-context”</span> created.</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>再次查看martin.kubeconfig文件,发现内容做了如下改变：<br>之前：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contexts: <span class="string">[]</span></span><br></pre></td></tr></table></figure>

<p>现在：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">contexts</span>:</span><br><span class="line">- <span class="attribute">context</span>:</span><br><span class="line">    <span class="attribute">cluster</span>: kubernetes</span><br><span class="line">    <span class="attribute">namespace</span>: kube-system</span><br><span class="line">    <span class="attribute">user</span>: martin</span><br><span class="line">  <span class="attribute">name</span>: martin-context</span><br></pre></td></tr></table></figure>

<p>增加了上下文的相关信息。</p>
<ul>
<li>设置默认上下文<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl<span class="built_in"> config </span>use-context martin-context <span class="attribute">–kubeconfig</span>=martin.kubeconfig</span><br><span class="line">Switched <span class="keyword">to</span> context <span class="string">“martin-context”</span>.</span><br></pre></td></tr></table></figure></li>
</ul>
<p>如果配置了多个环境项，可以通过切换不同的环境项名字或指定kubeconfig文件来访问到不同的集群环境。</p>
<ul>
<li>现在martin用户通过cfssl创建成功,可以看到所有关于martin用户的信息都写入了配置文件：martin.kubeconfig,不指定”-kubeconfig=”的话，默认是写入到”~/.kube/config”，如果之前有admin的相关信息，会追加到后面。martin.kubeconfig配置文件描述了集群、用户和上下文</li>
</ul>
<p>kubectl只是个go编写的可执行程序，只要为kubectl配置合适的kubeconfig，就可以在集群中的任意节点使用。kubectl默认会从$HOME/.kube目录下查找文件名为config的文件，也可以通过设置环境变量KUBECONFIG或者通过设置–kubeconfig去指定其它kubeconfig文件,总之kubeconfig就是为访问集群所作的配置。</p>
<p>如果之前”~/.kube/config”下配置的是admin账号信息，要用martin账号，则指定kubeconfig文件即可：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="string">martin </span><span class="string">kubectl </span><span class="string">config </span><span class="built_in">get-contexts</span>                               </span><br><span class="line"><span class="string">CURRENT </span>  <span class="string">NAME </span>        <span class="string">CLUSTER </span>     <span class="string">AUTHINFO </span>  <span class="string">NAMESPACE</span></span><br><span class="line"><span class="string"><em></em></span>         <span class="string">kubernetes </span>  <span class="string">kubernetes </span>  <span class="string">admin </span>     </span><br><span class="line">➜  <span class="string">martin </span></span><br><span class="line">➜  <span class="string">martin </span><span class="string">kubectl </span><span class="string">config </span><span class="built_in">get-contexts</span> <span class="built_in">–kubeconfig</span> <span class="string">martin.</span><span class="string">kubeconfig</span></span><br><span class="line"><span class="string">CURRENT </span>  <span class="string">NAME </span>            <span class="string">CLUSTER </span>     <span class="string">AUTHINFO </span>  <span class="string">NAMESPACE</span></span><br><span class="line"><span class="string"></span>         <span class="string">martin-context </span>  <span class="string">kubernetes </span>  <span class="string">martin </span>    <span class="string">kube-system</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">martin</span></span><br></pre></td></tr></table></figure>

<p>现在使用当前的这个配置文件来操作kubectl命令的时候，应该会出现错误，因为还没有为该用户定义任何操作的权限呢：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl <span class="builtin-name">get</span> pods –kubeconfig martin.kubeconfig</span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Forbidden): pods is forbidden:<span class="built_in"> User </span><span class="string">“martin”</span> cannot list pods <span class="keyword">in</span> the namespace <span class="string">“default”</span></span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>如果提示：“kubectl error: You must be logged in to the server (Unauthorized)”<br>则是没有指定martin.kubeconfig文件或者默认的”~/.kube/config”里面没有martin用户的相关证书信息，因为前面设置客户端认证的时候没有指定password，而是用了证书。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-credentials kubeuser/foo.kubernetes.com <span class="attribute">–username</span>=kubeuser <span class="attribute">–password</span>=kubepassword (用户名密码认证方式)</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials martin <span class="attribute">–client-certificate</span>=./martin.pem <span class="attribute">–client-key</span>=./martin-key.pem <span class="attribute">–embed-certs</span>=<span class="literal">true</span> <span class="attribute">–kubeconfig</span>=martin.kubeconfig</span><br><span class="line">(证书认证方式)</span><br></pre></td></tr></table></figure>

<p>另外可以通过：”Cfssl-Certinfo“命令来查看martin证书信息</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="keyword">martin </span>cfssl-certinfo -cert <span class="keyword">martin.pem</span></span><br><span class="line"><span class="keyword">&#123;</span></span><br><span class="line"><span class="keyword"> </span> <span class="string">“subject”</span>: &#123;</span><br><span class="line">    <span class="string">“common_name”</span>: <span class="string">“martin”</span>,</span><br><span class="line">    <span class="string">“country”</span>: <span class="string">“CN”</span>,</span><br><span class="line">    <span class="string">“organization”</span>: <span class="string">“op”</span>,</span><br><span class="line">    <span class="string">“organizational_unit”</span>: <span class="string">“System”</span>,</span><br><span class="line">    <span class="string">“locality”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">    <span class="string">“province”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">    <span class="string">“names”</span>: [</span><br><span class="line">      <span class="string">“CN”</span>,</span><br><span class="line">      <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“op”</span>,</span><br><span class="line">      <span class="string">“System”</span>,</span><br><span class="line">      <span class="string">“martin”</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“issuer”</span>: &#123;</span><br><span class="line">    <span class="string">“common_name”</span>: <span class="string">“kubernetes”</span>,</span><br><span class="line">    <span class="string">“country”</span>: <span class="string">“CN”</span>,</span><br><span class="line">    <span class="string">“organization”</span>: <span class="string">“k8s”</span>,</span><br><span class="line">    <span class="string">“organizational_unit”</span>: <span class="string">“System”</span>,</span><br><span class="line">    <span class="string">“locality”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">    <span class="string">“province”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">    <span class="string">“names”</span>: [</span><br><span class="line">      <span class="string">“CN”</span>,</span><br><span class="line">      <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“k8s”</span>,</span><br><span class="line">      <span class="string">“System”</span>,</span><br><span class="line">      <span class="string">“kubernetes”</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<h5 id="第二步：创建角色"><a href="#第二步：创建角色" class="headerlink" title="第二步：创建角色"></a><a href="#第二步：创建角色" title="第二步：创建角色"></a>第二步：创建角色</h5><p>用户创建完成后，接下来就需要给该用户添加操作权限，定义一个YAML文件，创建一个允许用户操作Deployment、Pod、ReplicaSets 的角色，如下定义：(martin-role.yaml)</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  martin cat martin-role.yaml </span><br><span class="line"><span class="symbol">apiVersion:</span> rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="symbol">kind:</span> Role</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> martin-role</span><br><span class="line"><span class="symbol">  namespace:</span> kube-system</span><br><span class="line"><span class="symbol">rules:</span></span><br><span class="line">- apiGroups: [<span class="string">“”</span>, <span class="string">“extensions”</span>, <span class="string">“apps”</span>]</span><br><span class="line"><span class="symbol">  resources:</span> [<span class="string">“deployments”</span>, <span class="string">“replicasets”</span>, <span class="string">“pods”</span>]</span><br><span class="line"><span class="symbol">  verbs:</span> [<span class="string">“get”</span>, <span class="string">“list”</span>, <span class="string">“watch”</span>, <span class="string">“create”</span>, <span class="string">“update”</span>, <span class="string">“patch”</span>, <span class="string">“delete”</span>] <span class="meta"># 也可以使用[<span class="string">‘*’</span>]</span></span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>其中Pod属于core这个API Group，在YAML中用空字符就可以，而Deployment属于apps 这个API Group，ReplicaSets属于extensions这个API Group(<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/" target="_blank" rel="noopener">点这里查文档</a>)，所以 rules下面的apiGroups 就综合了这几个资源的 API Group：[“”, “extensions”, “apps”]，其中verbs就是上面提到的可以对这些资源对象执行的操作，这里需要所有的操作方法，所以也可以使用[‘*’]来代替。</p>
<p>然后创建这个Role:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl create -f martin-role<span class="selector-class">.yaml</span> </span><br><span class="line">role<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">“martin-role”</span> created</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>注意这里没有使用上面的martin-context这个上下文，因为木有权限</p>
<h5 id="第三步：创建角色权限绑定"><a href="#第三步：创建角色权限绑定" class="headerlink" title="第三步：创建角色权限绑定"></a><a href="#第三步：创建角色权限绑定" title="第三步：创建角色权限绑定"></a>第三步：创建角色权限绑定</h5><p>Role创建完成了，但是很明显现在这个Role和我们的用户martin 还没有任何关系，这里就需要创建一个RoleBinding对象，在 kube-system这个命名空间下面将上面的martin-role角色和用户 martin进行绑定:(martin-rolebinding.yaml)</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  martin cat martin-rolebinding<span class="selector-class">.yaml</span> </span><br><span class="line">apiVersion: rbac<span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span>/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: martin-rolebinding</span><br><span class="line">  namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  <span class="selector-id">#apiGroup</span>: rbac<span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span></span><br><span class="line">  <span class="selector-id">#kind</span>: ClusterRole</span><br><span class="line">  kind: Role</span><br><span class="line">  name: martin-role</span><br><span class="line">  apiGroup: <span class="string">“”</span></span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: <span class="string">“”</span></span><br><span class="line">  kind: User</span><br><span class="line">  name: martin</span><br><span class="line">  <span class="selector-id">#apiGroup</span>: <span class="string">“”</span>  #会提示语法错误</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>上面的YAML文件中看到了subjects关键字，这里就是上面提到的用来尝试操作集群的对象，这里对应上面的 User帐号martin，使用kubectl创建上面的资源对象：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl create -f martin-rolebinding.yaml</span><br><span class="line">rolebinding<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">“martin-rolebinding”</span> created</span><br></pre></td></tr></table></figure>

<p>使用admin账号(martin账号无权限查看)查看role和rolebinding相关信息：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl <span class="built_in">get</span> rolebinding <span class="comment">–all-namespaces</span></span><br><span class="line">NAMESPACE     NAME                                             AGE</span><br><span class="line">kube-public   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   martin-rolebinding                               <span class="number">18</span>h</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-controller-manager   <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-scheduler            <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:cloud-provider                 <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:<span class="keyword">token</span>-cleaner                  <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   ui-admin-binding                                 <span class="number">11</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   ui-<span class="built_in">read</span>-binding                                  <span class="number">11</span>d</span><br><span class="line">➜  martin </span><br><span class="line">➜  martin kubectl <span class="built_in">get</span> role <span class="comment">–all-namespaces            </span></span><br><span class="line">NAMESPACE     NAME                                             AGE</span><br><span class="line">kube-public   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   extension-apiserver-authentication-reader        <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   martin-role                                      <span class="number">18</span>h</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-controller-manager   <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-scheduler            <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:cloud-provider                 <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:<span class="keyword">token</span>-cleaner                  <span class="number">19</span>d</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<h5 id="第四步：测试"><a href="#第四步：测试" class="headerlink" title="第四步：测试"></a><a href="#第四步：测试" title="第四步：测试"></a>第四步：测试</h5><p>现在应该可以用上面的martin-context上下文来操作集群了：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl get pods                                          </span><br><span class="line">NAME                              READY     STATUS    RESTARTS   AGE</span><br><span class="line">nexus3<span class="number">-68</span>f55d9746-vfnf8           <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">5</span>d</span><br><span class="line">rbd-rest-api-registrykey-m262<span class="number">-1</span>   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">4</span>d</span><br><span class="line">➜  martin </span><br><span class="line">➜  martin kubectl get pods -n <span class="section">default</span></span><br><span class="line">NAME                              READY     STATUS    RESTARTS   AGE</span><br><span class="line">nexus3<span class="number">-68</span>f55d9746-vfnf8           <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">5</span>d</span><br><span class="line">rbd-rest-api-registrykey-m262<span class="number">-1</span>   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">4</span>d</span><br><span class="line">➜  martin </span><br><span class="line">➜  martin kubectl get pods –kubeconfig martin.kubeconfig</span><br><span class="line">NAME                                    READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns<span class="number">-77</span>c989547b-lcbfw                <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">1</span>          <span class="number">15</span>d</span><br><span class="line">coredns<span class="number">-77</span>c989547b-xq4dr                <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">1</span>          <span class="number">15</span>d</span><br><span class="line">heapster<span class="number">-77</span>b9c5bd7b-l5ms6               <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br><span class="line">kubernetes-dashboard<span class="number">-66</span>c9d98865-g8l6l   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br><span class="line">monitoring-grafana<span class="number">-7</span>c674cb7f6-nqvlw     <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br><span class="line">monitoring-influxdb<span class="number">-644</span>db5c5b6-llnp9    <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br></pre></td></tr></table></figure>

<p>使用kubectl时并没有指定namespace，这是因为之前已经为该用户分配了权限，并且指定了kube-system命名空间写入到martin.kubeconfig文件中，如果使用default命名空间，在后面加上一个-n default，则会提示forbidden,如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl <span class="builtin-name">get</span> pods -n<span class="built_in"> default </span>–kubeconfig martin.kubeconfig </span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Forbidden): pods is forbidden:<span class="built_in"> User </span><span class="string">“martin”</span> cannot list pods <span class="keyword">in</span> the namespace <span class="string">“default”</span></span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>这是因为该用户并没有default这个命名空间的操作权限。</p>
<hr>
<h4 id="创建一个只能访问某个namespace的ServiceAccount"><a href="#创建一个只能访问某个namespace的ServiceAccount" class="headerlink" title="创建一个只能访问某个namespace的ServiceAccount"></a><a href="#创建一个只能访问某个namespace的ServiceAccount" title="创建一个只能访问某个namespace的ServiceAccount"></a>创建一个只能访问某个namespace的ServiceAccount</h4><p>上面创建了一个只能访问某个命名空间下面的普通用户，前面也提到过subjects,下面还有一种类型的主题资源：ServiceAccount。</p>
<h5 id="第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments"><a href="#第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments" class="headerlink" title="第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments"></a><a href="#第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments" title="第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments"></a>第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments</h5><p>首先来创建一个ServiceAccount对象：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl create sa martin-sa -n kube-system</span><br><span class="line">serviceaccount <span class="string">“martin-sa”</span> created</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa </span><br><span class="line">NAME      SECRETS   AGE</span><br><span class="line">default   1         20d</span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa -n kube-system</span><br><span class="line">NAME                   SECRETS   AGE</span><br><span class="line">admin-user             1         11d</span><br><span class="line">coredns                1         15d</span><br><span class="line">default                1         20d</span><br><span class="line">heapster               1         11d</span><br><span class="line">kubernetes-dashboard   1         11d</span><br><span class="line">martin-sa              1         13s</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>当然也可以定义成YAML文件的形式来创建:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> ServiceAccount</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> martin-sa</span><br><span class="line"><span class="symbol">  namespace:</span> kube-system</span><br></pre></td></tr></table></figure>

<h5 id="第二步：创建一个Role对象：-martin-sa-role-yaml"><a href="#第二步：创建一个Role对象：-martin-sa-role-yaml" class="headerlink" title="第二步：创建一个Role对象：(martin-sa-role.yaml)"></a><a href="#第二步：创建一个Role对象：-martin-sa-role-yaml" title="第二步：创建一个Role对象：(martin-sa-role.yaml)"></a>第二步：创建一个Role对象：(martin-sa-role.yaml)</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount <span class="keyword">cat</span> martin-<span class="keyword">sa</span>-role.yaml </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadat<span class="variable">a:</span></span><br><span class="line">  name: martin-<span class="keyword">sa</span>-role</span><br><span class="line">  namespace: kube-<span class="built_in">system</span></span><br><span class="line">rule<span class="variable">s:</span></span><br><span class="line">- apiGroup<span class="variable">s:</span> [<span class="string">“”</span>]</span><br><span class="line">  resource<span class="variable">s:</span> [<span class="string">“pods”</span>]</span><br><span class="line">  <span class="keyword">verb</span><span class="variable">s:</span> [<span class="string">“get”</span>, <span class="string">“list”</span>, <span class="string">“watch”</span>] # 也可以使用[<span class="string">‘*’</span>]</span><br><span class="line">- apiGroup<span class="variable">s:</span> [<span class="string">“apps”</span>]</span><br><span class="line">  resource<span class="variable">s:</span> [<span class="string">“deployments”</span>]</span><br><span class="line">  <span class="keyword">verb</span><span class="variable">s:</span> [<span class="string">“get”</span>, <span class="string">“list”</span>, <span class="string">“watch”</span>, <span class="string">“create”</span>, <span class="string">“update”</span>, <span class="string">“patch”</span>, <span class="string">“delete”</span>]</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>可以看到这里定义的角色没有创建、删除、更新Pod的权限，等会可以重点测试一下。</p>
<p>创建该Role对象：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl create -f martin-sa-role<span class="selector-class">.yaml</span> </span><br><span class="line">role<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">“martin-sa-role”</span> created</span><br></pre></td></tr></table></figure>

<h5 id="第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：-martin-sa-rolebinding-yaml"><a href="#第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：-martin-sa-rolebinding-yaml" class="headerlink" title="第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：(martin-sa-rolebinding.yaml)"></a><a href="#第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：-martin-sa-rolebinding-yaml" title="第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：(martin-sa-rolebinding.yaml)"></a>第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：(martin-sa-rolebinding.yaml)</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span> <span class="string">cat</span> <span class="string">martin-sa-rolebinding.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-rolebinding</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-role</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<p>创建这个资源对象：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="built_in">get</span> rolebinding -n kube-<span class="built_in">system</span></span><br><span class="line">NAME                                             AGE</span><br><span class="line">kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">martin-rolebinding                               <span class="number">22</span>h</span><br><span class="line">➜  serviceaccount </span><br><span class="line"></span><br><span class="line">➜  serviceaccount kubectl create -<span class="keyword">f</span> martin-<span class="keyword">sa</span>-rolebinding.yaml </span><br><span class="line">rolebinding.rbac.authorization.k8s.io <span class="string">“martin-sa-rolebinding”</span> created</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl <span class="built_in">get</span> rolebinding               </span><br><span class="line">No resources found.</span><br><span class="line">➜  serviceaccount kubectl <span class="built_in">get</span> rolebinding -n kube-<span class="built_in">system</span></span><br><span class="line">NAME                                             AGE</span><br><span class="line">kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">martin-rolebinding                               <span class="number">23</span>h</span><br><span class="line">martin-<span class="keyword">sa</span>-rolebinding                            <span class="number">26</span>s</span><br><span class="line">可以看到martin-<span class="keyword">sa</span>-rolebinding已经添加</span><br></pre></td></tr></table></figure>

<h5 id="第四步，验证这个ServiceAccount"><a href="#第四步，验证这个ServiceAccount" class="headerlink" title="第四步，验证这个ServiceAccount"></a><a href="#第四步，验证这个ServiceAccount" title="第四步，验证这个ServiceAccount"></a>第四步，验证这个ServiceAccount</h5><p>一个ServiceAccount会生成一个Secret对象和它进行映射，这个Secret里面包含一个token：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>-n kube-system</span><br><span class="line">NAME                              <span class="built_in"> TYPE </span>                                 DATA      AGE</span><br><span class="line">admin-user-token-xszp7             kubernetes.io/service-account-token   3         11d</span><br><span class="line">coredns-token-9ppnq                kubernetes.io/service-account-token   3         15d</span><br><span class="line">default-token-fs7zj                kubernetes.io/service-account-token   3         20d</span><br><span class="line">heapster-token-gn8g5               kubernetes.io/service-account-token   3         11d</span><br><span class="line">kubernetes-dashboard-certs         Opaque                                0         11d</span><br><span class="line">kubernetes-dashboard-key-holder    Opaque                                2         15d</span><br><span class="line">kubernetes-dashboard-token-tg782   kubernetes.io/service-account-token   3         11d</span><br><span class="line">martin-sa-token-78s5j              kubernetes.io/service-account-token   3         41m  #新增</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl describe<span class="built_in"> secret </span>martin-sa-token-78s5j -n kube-system</span><br><span class="line">Name:         martin-sa-token-78s5j</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.<span class="attribute">name</span>=martin-sa</span><br><span class="line">              kubernetes.io/service-account.<span class="attribute">uid</span>=576ef41d-79e2-11e8-bede-5254004f2222</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1359 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      xxx</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>==注意：查看时需要-n指定kube-system命名空间！==</p>
<p>然后可以利用这个token去登录Dashboard，就可以在Dashboard中来验证功能是否符合预期：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>martin-sa-token-78s5j -o jsonpath=&#123;.data.token&#125; -n kube-system |base64 -d #会生成一串很长的base64后的字符串</span><br><span class="line">xxxxxxxxxxxxxxxx</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>使用这里的xxx token去Dashboard页面进行登录：<br>会出现如下提示信息：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">configmaps is forbidden:<span class="built_in"> User </span><span class="string">“system:serviceaccount:kube-system:martin-sa”</span> cannot list configmaps <span class="keyword">in</span> the namespace <span class="string">“default”</span></span><br><span class="line">close</span><br><span class="line">warning</span><br><span class="line">persistentvolumeclaims is forbidden:<span class="built_in"> User </span><span class="string">“system:serviceaccount:kube-system:martin-sa”</span> cannot list persistentvolumeclaims <span class="keyword">in</span> the namespace <span class="string">“default”</span></span><br></pre></td></tr></table></figure>

<p>这是因为登录进来后默认跳转到default命名空间，但是却没有改空间的权限，因此需要切换到kube-system命名空间下面:</p>
<p>原来url:<br><a href="https://xxx/#!/deployment?namespace=default" target="_blank" rel="noopener">https://xxx/#!/deployment?namespace=default</a></p>
<p>修改为新url:<br><a href="https://xxx/#!/deployment?namespace=kube-system" target="_blank" rel="noopener">https://xxx/#!/deployment?namespace=kube-system</a></p>
<p>可以看到能访问pod列表了，但是也会有一些其他额外的提示：events is forbidden: User “system:serviceaccount:kube-system:martin-sa” cannot list events in the namespace “kube-system”，这是因为当前登录用只被授权了访问pod和deployment的权限，同样的，访问下deployment看看可以了吗？</p>
<p>同样的，可以根据自己的需求来对访问用户的权限进行限制，可以自己通过Role定义更加细粒度的权限，也可以使用系统内置的一些权限……</p>
<hr>
<h4 id="创建一个可以访问所有-namespace-的ServiceAccount"><a href="#创建一个可以访问所有-namespace-的ServiceAccount" class="headerlink" title="创建一个可以访问所有 namespace 的ServiceAccount"></a><a href="#创建一个可以访问所有-namespace-的ServiceAccount" title="创建一个可以访问所有 namespace 的ServiceAccount"></a>创建一个可以访问所有 namespace 的ServiceAccount</h4><p>刚刚创建的martin-sa这个ServiceAccount和一个Role角色进行绑定的，如果现在创建一个新的ServiceAccount，需要他操作的权限作用于所有的namespace，这个时候就需要使用到ClusterRole 和 ClusterRoleBinding 这两种资源对象了。</p>
<h5 id="第一步，同样，首先新建一个ServiceAcount对象：-martin-sa2-yaml"><a href="#第一步，同样，首先新建一个ServiceAcount对象：-martin-sa2-yaml" class="headerlink" title="第一步，同样，首先新建一个ServiceAcount对象：(martin-sa2.yaml)"></a><a href="#第一步，同样，首先新建一个ServiceAcount对象：-martin-sa2-yaml" title="第一步，同样，首先新建一个ServiceAcount对象：(martin-sa2.yaml)"></a>第一步，同样，首先新建一个ServiceAcount对象：(martin-sa2.yaml)</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount cat martin-sa2.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: martin-sa2</span><br><span class="line">  namespace: kube-system</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl create -f martin-sa2.yaml </span><br><span class="line">serviceaccount <span class="string">“martin-sa2”</span> created</span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa   </span><br><span class="line">NAME      SECRETS   AGE</span><br><span class="line">default   1         20d</span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa -n kube-system</span><br><span class="line">NAME                   SECRETS   AGE</span><br><span class="line">admin-user             1         12d</span><br><span class="line">coredns                1         15d</span><br><span class="line">default                1         20d</span><br><span class="line">heapster               1         12d</span><br><span class="line">kubernetes-dashboard   1         12d</span><br><span class="line">martin-sa              1         1h</span><br><span class="line">martin-sa2             1         12s</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<h5 id="第二步，创建一个ClusterRoleBinding-对象-martin-clusterolebinding-yaml"><a href="#第二步，创建一个ClusterRoleBinding-对象-martin-clusterolebinding-yaml" class="headerlink" title="第二步，创建一个ClusterRoleBinding 对象(martin-clusterolebinding.yaml):"></a><a href="#第二步，创建一个ClusterRoleBinding-对象-martin-clusterolebinding-yaml" title="第二步，创建一个ClusterRoleBinding 对象(martin-clusterolebinding.yaml):"></a>第二步，创建一个ClusterRoleBinding 对象(martin-clusterolebinding.yaml):</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span> <span class="string">cat</span> <span class="string">martin-clusterolebinding.yaml</span>   </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa2-clusterrolebinding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span></span><br></pre></td></tr></table></figure>

<p>对比下之前的”martin-sa-rolebinding.yaml”</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span> <span class="string">cat</span> <span class="string">martin-sa-rolebinding.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-rolebinding</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-role</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span></span><br></pre></td></tr></table></figure>

<p>从上面可以看到没有为这个资源对象声明namespace，因为这是一个ClusterRoleBinding 资源对象，是作用于整个集群的，也没有单独新建一个ClusterRole对象，而是使用的 cluster-admin这个对象，这是Kubernetes集群内置的ClusterRole对象，可以使用kubectl get clusterrole 和kubectl get clusterrolebinding查看系统内置的一些集群角色和集群角色绑定，这里使用的 cluster-admin这个集群角色是拥有最高权限的集群角色，所以一般需要谨慎使用该集群角色。</p>
<p>创建上面集群角色绑定资源对象：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl create -f martin-clusterolebinding<span class="selector-class">.yaml</span> </span><br><span class="line">clusterrolebinding<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">“martin-sa2-clusterrolebinding”</span> created</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>通过ubectl get clusterrolebinding可以看到”martin-sa2-clusterrolebinding”已经加入其中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl get clusterrolebinding </span><br><span class="line">NAME                                                   AGE</span><br><span class="line">admin-user                                             <span class="number">12d</span></span><br><span class="line">cluster-admin                                          <span class="number">20d</span></span><br><span class="line">heapster                                               <span class="number">12d</span></span><br><span class="line">kubelet-bootstrap                                      <span class="number">19d</span></span><br><span class="line">martin-sa2-clusterrolebinding                          <span class="number">22s</span></span><br></pre></td></tr></table></figure>

<h5 id="第三步，使用-ServiceAccount对应的token去登录Dashboard验证："><a href="#第三步，使用-ServiceAccount对应的token去登录Dashboard验证：" class="headerlink" title="第三步，使用 ServiceAccount对应的token去登录Dashboard验证："></a><a href="#第三步，使用-ServiceAccount对应的token去登录Dashboard验证：" title="第三步，使用 ServiceAccount对应的token去登录Dashboard验证："></a>第三步，使用 ServiceAccount对应的token去登录Dashboard验证：</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>-n kube-system|grep martin-sa2-token-q7bhr</span><br><span class="line">martin-sa2-token-q7bhr             kubernetes.io/service-account-token   3         34m</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>martin-sa2-token-q7bhr -o jsonpath=&#123;.data.token&#125; -n kube-system |base64 -d</span><br><span class="line">xxxxxxx</span><br><span class="line"><span class="comment">#会生成一串很长的base64后的字符串</span></span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>在最开始接触到RBAC认证的时候，可能不太熟悉，特别是不知道应该怎么去编写rules规则，可以去分析系统自带的clusterrole、clusterrolebinding这些资源对象的编写方法，利用 kubectl的get、describe、-o yaml这些操作，所以kubectl最基本的操作一定要掌握好。</p>
<p>RBAC只是Kubernetes中安全认证的一种方式，当然也是现在最重要的一种方式。</p>
<hr>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/K8s/" rel="tag"><i class="fa fa-tag"></i> K8s</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/19/只在移动端网页内显示”Fork-me-on-Github”/" rel="next" title="只在移动端网页内显示”Fork me on Github”">
                <i class="fa fa-chevron-left"></i> 只在移动端网页内显示”Fork me on Github”
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/19/基于k8s-动态配置及扩容maven-nexus私服/" rel="prev" title="基于k8s 动态配置及扩容maven nexus私服">
                基于k8s 动态配置及扩容maven nexus私服 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">褚成志</p>
              <p class="site-description motion-element" itemprop="description">关注互联网的科技博客</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">57</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">38</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/livecityccz" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:livecityccz@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/livecityccz" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/livecityccz" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/livecityccz" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i>FB Page</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://youtube.com/livecityccz" target="_blank" title="YouTube">
                      
                        <i class="fa fa-fw fa-youtube"></i>YouTube</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#RBAC-API-对象"><span class="nav-number">1.</span> <span class="nav-text">RBAC API 对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例"><span class="nav-number">2.</span> <span class="nav-text">示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建一个只能访问某个-namespace-的用户"><span class="nav-number">2.1.</span> <span class="nav-text">创建一个只能访问某个 namespace 的用户</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#第一步：创建用户凭证"><span class="nav-number">2.1.1.</span> <span class="nav-text">第一步：创建用户凭证</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-使用OpenSSL证书来创建User；"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">1. 使用OpenSSL证书来创建User；</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-使用cfssl工具来创建，也是参考官方文档中的方法。"><span class="nav-number">2.1.1.2.</span> <span class="nav-text">2. 使用cfssl工具来创建，也是参考官方文档中的方法。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#第二步：创建角色"><span class="nav-number">2.1.2.</span> <span class="nav-text">第二步：创建角色</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#第三步：创建角色权限绑定"><span class="nav-number">2.1.3.</span> <span class="nav-text">第三步：创建角色权限绑定</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#第四步：测试"><span class="nav-number">2.1.4.</span> <span class="nav-text">第四步：测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建一个只能访问某个namespace的ServiceAccount"><span class="nav-number">2.2.</span> <span class="nav-text">创建一个只能访问某个namespace的ServiceAccount</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments"><span class="nav-number">2.2.1.</span> <span class="nav-text">第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#第二步：创建一个Role对象：-martin-sa-role-yaml"><span class="nav-number">2.2.2.</span> <span class="nav-text">第二步：创建一个Role对象：(martin-sa-role.yaml)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：-martin-sa-rolebinding-yaml"><span class="nav-number">2.2.3.</span> <span class="nav-text">第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：(martin-sa-rolebinding.yaml)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#第四步，验证这个ServiceAccount"><span class="nav-number">2.2.4.</span> <span class="nav-text">第四步，验证这个ServiceAccount</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建一个可以访问所有-namespace-的ServiceAccount"><span class="nav-number">2.3.</span> <span class="nav-text">创建一个可以访问所有 namespace 的ServiceAccount</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#第一步，同样，首先新建一个ServiceAcount对象：-martin-sa2-yaml"><span class="nav-number">2.3.1.</span> <span class="nav-text">第一步，同样，首先新建一个ServiceAcount对象：(martin-sa2.yaml)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#第二步，创建一个ClusterRoleBinding-对象-martin-clusterolebinding-yaml"><span class="nav-number">2.3.2.</span> <span class="nav-text">第二步，创建一个ClusterRoleBinding 对象(martin-clusterolebinding.yaml):</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#第三步，使用-ServiceAccount对应的token去登录Dashboard验证："><span class="nav-number">2.3.3.</span> <span class="nav-text">第三步，使用 ServiceAccount对应的token去登录Dashboard验证：</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="heart">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">褚成志</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">77.9k</span>
  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 你是第
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      个小伙伴
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      人次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  







  
  





  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_sphere.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("", "");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  


  <script type="text/javascript" src="/js/src/love.js"></script>

</body>
</html>
