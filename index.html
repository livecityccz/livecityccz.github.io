<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="诗和田野" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="诗和田野">
<meta property="og:url" content="http://chucz.club/index.html">
<meta property="og:site_name" content="诗和田野">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="诗和田野">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://chucz.club/"/>





  <title>诗和田野</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">诗和田野</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">生活不苟且</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/首页" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/标签/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/分类/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/归档/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/09/28/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/28/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-28T11:15:31+08:00">
                2018-09-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/08/27/记Django开发中的一些常用代码段/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/27/记Django开发中的一些常用代码段/" itemprop="url">记Django开发中的一些常用代码段</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-28T06:46:20+08:00">
                2018-08-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>2018年的第一场雪，比2002年来得更晚一些<br>　　记得之前有分享过Django开发相关的系列文章（可在博客右上方自行搜索），内容包括模版、视图、路由等。那么本篇再补充一些Django开发过程中常用到的一些功能代码块，内容涉及前端、后端相关功能代码。这些代码块都是平常开发中常用的，因此在此做个备份，方便查询。<br><a id="more"></a></p>
</blockquote>
<h3 id="前端功能"><a href="#前端功能" class="headerlink" title="前端功能"></a><a href="#前端功能" title="前端功能"></a>前端功能</h3><p>搞安全的还需要会前端？当然啊，搞安全的也需要出产品，出产品了没前端不就显得很low吗？不过自己写前端太累了，因此还得用框架，这里推荐<a href="http://v3.bootcss.com/" target="_blank" rel="noopener">Bootstrap</a>。在尝试使用文章下方介绍的前端代码前，先在代码中添加上Bootstrap框架提供给的css、js连接。</p>
<h4 id="面板折叠"><a href="#面板折叠" class="headerlink" title="面板折叠"></a><a href="#面板折叠" title="面板折叠"></a>面板折叠</h4><p><img src="/upload_image/20180126/6.png" alt=""><br><img src="/upload_image/20180126/1.png" alt=""><br>这个功能经常在侧边菜单栏中用到，面板折叠可有效的保持界面整洁。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;div class=<span class="string">“panel panel-success”</span>&gt;</div><div class="line">&lt;div class=<span class="string">“panel-heading”</span> data-toggle=<span class="string">“collapse”</span> data-parent=<span class="string">“#accordion”</span> href=<span class="string">“#collapse”</span>&gt;</div><div class="line">  &lt;h1 class=<span class="string">“panel-title”</span>&gt;&lt;span class=<span class="string">“glyphicon glyphicon-tag”</span> aria-hidden=<span class="string">“true”</span>&gt;&lt;/span&gt;Index&lt;/h1&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;div id=<span class="string">“collapse”</span> class=<span class="string">“panel-collapse collapse out”</span>&gt; <span class="comment"># out or in 控制折叠状态</span></div><div class="line">  &lt;div class=<span class="string">“panel-body”</span>&gt;</div><div class="line">    &lt;a href=<span class="string">“”</span>&gt;index1&lt;/a&gt;&lt;br&gt;&lt;br&gt;</div><div class="line">    &lt;a href=<span class="string">“”</span>&gt;index2&lt;/a&gt;&lt;br&gt;&lt;br&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>

<h4 id="表格分页"><a href="#表格分页" class="headerlink" title="表格分页"></a><a href="#表格分页" title="表格分页"></a>表格分页</h4><p><img src="/upload_image/20180126/7.png" alt=""><br>表格分页前端比较简单，想要实现真正的分页显示数据，需要结合后端代码，文章后面会介绍。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;!– 分页 –&gt;</div><div class="line">&lt;form action=<span class="string">“&#123;% url ‘asset_list’ %&#125;”</span> method=<span class="string">“POST”</span>&gt;</div><div class="line">&#123;% csrf_token %&#125;</div><div class="line">&lt;ul class=<span class="string">“pagination pagination”</span>&gt;</div><div class="line">    &lt;li&gt;&lt;a href=<span class="string">“&#123;% url ‘asset_list’ %&#125;?page=0&amp;search_key=&#123;&#123;search_key&#125;&#125;”</span>&gt;首页&lt;/a&gt;&lt;/li&gt;</div><div class="line">    &lt;li&gt;&lt;a href=<span class="string">“&#123;% url ‘asset_list’ %&#125;?page=&#123;&#123;pre_page&#125;&#125;&amp;search_key=&#123;&#123;search_key&#125;&#125;”</span>&gt;上一页&lt;/a&gt;&lt;/li&gt;</div><div class="line">    &#123;% <span class="keyword">for</span> i <span class="keyword">in</span> page_list %&#125;</div><div class="line">        &lt;li&gt;&lt;a href=<span class="string">“&#123;% url ‘asset_list’ %&#125;?page=&#123;&#123; i &#125;&#125;&amp;search_key=&#123;&#123;search_key&#125;&#125;”</span> class=<span class="string">“active”</span>&gt;&#123;&#123; i &#125;&#125;&lt;/a&gt;&lt;/li&gt;</div><div class="line">    &#123;% endfor %&#125;</div><div class="line">    &lt;li&gt;&lt;a href=<span class="string">“&#123;% url ‘asset_list’ %&#125;?page=&#123;&#123; next_page &#125;&#125;&amp;search_key=&#123;&#123;search_key&#125;&#125;”</span>&gt;下一页&lt;/a&gt;&lt;/li&gt;</div><div class="line">    &lt;li&gt;&lt;a href=<span class="string">“&#123;% url ‘asset_list’ %&#125;?page=&#123;&#123; last_page &#125;&#125;&amp;search_key=&#123;&#123;search_key&#125;&#125;”</span>&gt;尾页&lt;/a&gt;&lt;/li&gt;</div><div class="line">    &amp;nbsp;</div><div class="line">     &lt;li&gt;</div><div class="line">        &lt;input <span class="built_in">type</span>=<span class="string">“text”</span> placeholder=<span class="string">“输入页码”</span> ng-model=<span class="string">“gotoPage”</span> class=<span class="string">“”</span> style=<span class="string">“width: 80px”</span> name=<span class="string">“page”</span>&gt;</div><div class="line">        &amp;nbsp;</div><div class="line">        &lt;input <span class="built_in">type</span>=<span class="string">“submit”</span> class=<span class="string">“btn btn-default”</span> name=<span class="string">“”</span> value=<span class="string">“跳转到”</span> style=<span class="string">“width:70px;height: 34px”</span>&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line"> &lt;/ul&gt;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure>

<h4 id="控制表格单元格内容自动换行"><a href="#控制表格单元格内容自动换行" class="headerlink" title="控制表格单元格内容自动换行"></a><a href="#控制表格单元格内容自动换行" title="控制表格单元格内容自动换行"></a>控制表格单元格内容自动换行</h4><p>有些时候表格中单元格内容太长，会导致表格整体很不好看，因此对于内容会很长的表格列需要添加如下style</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;td style=<span class="string">“word-wrap:break-word;word-break:break-all;”</span>&gt;<span class="built_in">test</span>&lt;/td&gt;</div></pre></td></tr></table></figure>

<h4 id="弹出框（可编辑）"><a href="#弹出框（可编辑）" class="headerlink" title="弹出框（可编辑）"></a><a href="#弹出框（可编辑）" title="弹出框（可编辑）"></a>弹出框（可编辑）</h4><p><img src="/upload_image/20180126/2.png" alt=""><br>有些时候需要修改一些表格数据，之前的做法是点击一个按钮，跳转到一个修改的页面，但这种做法不够优雅，因此可以选择点击按钮弹出一个可编辑的对话框。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&lt;form action=<span class="string">“/index/“</span> method=<span class="string">“POST”</span>&gt;</div><div class="line">&lt;div class=<span class="string">“modal fade”</span> id=<span class="string">“update”</span> tabindex=<span class="string">“-1”</span> role=<span class="string">“dialog”</span> aria-labelledby=<span class="string">“myModalLabel”</span> aria-hidden=<span class="string">“true”</span>&gt;</div><div class="line">  &lt;div class=<span class="string">“modal-dialog”</span>&gt;</div><div class="line">    &lt;div class=<span class="string">“modal-content”</span>&gt;</div><div class="line">      &lt;div class=<span class="string">“modal-header”</span>&gt;</div><div class="line">        &lt;button <span class="built_in">type</span>=<span class="string">“button”</span> class=<span class="string">“close”</span> data-dismiss=<span class="string">“modal”</span> aria-hidden=<span class="string">“true”</span>&gt;</div><div class="line">          &amp;<span class="built_in">times</span>;</div><div class="line">        &lt;/button&gt;</div><div class="line">        &lt;h4 class=<span class="string">“modal-title”</span> id=<span class="string">“myModalLabel”</span>&gt;</div><div class="line">          提醒框</div><div class="line">        &lt;/h4&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">      &lt;div class=<span class="string">“modal-body”</span>&gt;</div><div class="line">        &lt;label&gt;KEY&lt;/label&gt;</div><div class="line">        &lt;input <span class="built_in">type</span>=<span class="string">“text”</span> class=<span class="string">“form-control”</span> name=<span class="string">“new_key”</span> value=<span class="string">“&#123;&#123;i.key_&#125;&#125;”</span>&gt;</div><div class="line">        &lt;label&gt;VALUES&lt;/label&gt;</div><div class="line">        &lt;input <span class="built_in">type</span>=<span class="string">“text”</span> class=<span class="string">“form-control”</span> name=<span class="string">“new_value”</span> value=<span class="string">“&#123;&#123;i.value_&#125;&#125;”</span>&gt;</div><div class="line"></div><div class="line">      &lt;/div&gt;</div><div class="line">      &lt;div class=<span class="string">“modal-footer”</span>&gt;</div><div class="line">        &lt;button <span class="built_in">type</span>=<span class="string">“button”</span> class=<span class="string">“btn btn-default”</span> data-dismiss=<span class="string">“modal”</span>&gt;关闭</div><div class="line">        &lt;/button&gt;</div><div class="line">        &lt;button <span class="built_in">type</span>=<span class="string">“submit”</span> name=<span class="string">“update_id”</span> value=<span class="string">“&#123;&#123;i.id&#125;&#125;”</span> class=<span class="string">“btn btn-primary”</span>&gt;</div><div class="line">          确定修改</div><div class="line">        &lt;/button&gt;</div><div class="line">      &lt;/div&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;input <span class="built_in">type</span>=<span class="string">“button”</span> data-toggle=<span class="string">“modal”</span> data-target=<span class="string">“#update”</span> class=<span class="string">“btn btn-info”</span> value=<span class="string">“修改”</span>&gt;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure>

<h4 id="弹出提醒框（不可编辑）"><a href="#弹出提醒框（不可编辑）" class="headerlink" title="弹出提醒框（不可编辑）"></a><a href="#弹出提醒框（不可编辑）" title="弹出提醒框（不可编辑）"></a>弹出提醒框（不可编辑）</h4><p><img src="/upload_image/20180126/3.png" alt=""><br>这个功能主要作用删除数据、修改数据时的提醒。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;form action=<span class="string">“/index/“</span> method=<span class="string">“POST”</span>&gt;</div><div class="line">&lt;div class=<span class="string">“modal fade”</span> id=<span class="string">“del”</span> tabindex=<span class="string">“-1”</span> role=<span class="string">“dialog”</span> aria-labelledby=<span class="string">“myModalLabel”</span> aria-hidden=<span class="string">“true”</span>&gt;</div><div class="line">&lt;div class=<span class="string">“modal-dialog”</span>&gt;</div><div class="line">&lt;div class=<span class="string">“modal-content”</span>&gt;</div><div class="line">  &lt;div class=<span class="string">“modal-header”</span>&gt;</div><div class="line">    &lt;button <span class="built_in">type</span>=<span class="string">“button”</span> class=<span class="string">“close”</span> data-dismiss=<span class="string">“modal”</span> aria-hidden=<span class="string">“true”</span>&gt;</div><div class="line">      &amp;<span class="built_in">times</span>;</div><div class="line">    &lt;/button&gt;</div><div class="line">    &lt;h4 class=<span class="string">“modal-title”</span> id=<span class="string">“myModalLabel”</span>&gt;</div><div class="line">      提醒框</div><div class="line">    &lt;/h4&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;div class=<span class="string">“modal-body”</span>&gt;</div><div class="line">    您确定要删除记录吗？</div><div class="line">  &lt;/div&gt;</div><div class="line">  &lt;div class=<span class="string">“modal-footer”</span>&gt;</div><div class="line">    &lt;button <span class="built_in">type</span>=<span class="string">“button”</span> class=<span class="string">“btn btn-default”</span> data-dismiss=<span class="string">“modal”</span>&gt;关闭</div><div class="line">    &lt;/button&gt;</div><div class="line">    &lt;button <span class="built_in">type</span>=<span class="string">“submit”</span> name=<span class="string">“del_id”</span> value=<span class="string">“&#123;&#123;i.id&#125;&#125;”</span> class=<span class="string">“btn btn-primary”</span>&gt;</div><div class="line">      确定删除</div><div class="line">    &lt;/button&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;input <span class="built_in">type</span>=<span class="string">“button”</span> data-toggle=<span class="string">“modal”</span> data-target=<span class="string">“#del”</span> class=<span class="string">“btn btn-danger”</span> value=<span class="string">“删除”</span>&gt;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure>

<h4 id="搜索框自动补全"><a href="#搜索框自动补全" class="headerlink" title="搜索框自动补全"></a><a href="#搜索框自动补全" title="搜索框自动补全"></a>搜索框自动补全</h4><p><img src="/upload_image/20180126/4.png" alt=""><br>这个就厉害啦，当搜索一些资源的时候，如果能自动补全是不是会方便很多呢？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;label <span class="keyword">for</span>=<span class="string">“autocomplete”</span>&gt;选择扫描插件（必选）&lt;/label&gt;&lt;br&gt;</div><div class="line">&lt;input  class=<span class="string">“form-control”</span> id=<span class="string">“autocomplete”</span> name=<span class="string">“vul_name”</span> placeholder=<span class="string">“输入漏洞名称”</span>&gt;&lt;br&gt;&lt;br&gt;</div><div class="line"></div><div class="line"></div><div class="line">&lt;script <span class="built_in">type</span>=<span class="string">“text/javascript”</span>&gt;</div><div class="line">var tags = &#123;&#123; plugin_list|safe &#125;&#125;; <span class="comment"># 注plugin_list</span></div><div class="line">$( <span class="string">“#autocomplete”</span> ).autocomplete(&#123;</div><div class="line">  <span class="built_in">source</span>: tags</div><div class="line">&#125;);</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>

<h4 id="ajax请求"><a href="#ajax请求" class="headerlink" title="ajax请求"></a><a href="#ajax请求" title="ajax请求"></a>ajax请求</h4><p>用ajax发送请求有好有坏，具体用法可参考：<a href="https://thief.one/2017/09/14/3/" target="_blank" rel="noopener">https://thief.one/2017/09/14/3/</a></p>
<h4 id="界面面板布局"><a href="#界面面板布局" class="headerlink" title="界面面板布局"></a><a href="#界面面板布局" title="界面面板布局"></a>界面面板布局</h4><p><img src="/upload_image/20180126/5.png" alt=""><br>这个纯粹为了装逼。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;div class=<span class="string">“container”</span>&gt;</div><div class="line">  &lt;div class=<span class="string">“row”</span>&gt;</div><div class="line">        <span class="comment">####### 面板 ##########</span></div><div class="line">        &lt;div class=<span class="string">“col-md-3”</span>&gt;</div><div class="line">            &lt;div class=<span class="string">“list-group”</span>&gt;</div><div class="line">                &lt;form class=<span class="string">“list-group-item”</span>&gt; </div><div class="line">                    &lt;a href=<span class="string">“”</span>&gt;<span class="built_in">test</span>&lt;/a&gt;</div><div class="line">                &lt;/form&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line"></div><div class="line">       <span class="comment">####### 面板 ##########</span></div><div class="line">        &lt;div class=<span class="string">“col-md-3”</span>&gt;</div><div class="line">            &lt;div class=<span class="string">“list-group”</span>&gt;</div><div class="line">                &lt;form class=<span class="string">“list-group-item”</span>&gt; </div><div class="line">                    &lt;a href=<span class="string">“”</span>&gt;test2&lt;/a&gt;</div><div class="line">                &lt;/form&gt;</div><div class="line">            &lt;/div&gt;</div><div class="line">        &lt;/div&gt;</div><div class="line">  </div><div class="line">  &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div></pre></td></tr></table></figure>

<h4 id="表格单选框"><a href="#表格单选框" class="headerlink" title="表格单选框"></a><a href="#表格单选框" title="表格单选框"></a>表格单选框</h4><p>表格显示数据是常见的功能，一般情况下需要多表格数据进行删改，因此批量选中就很重要。一般表格中的批量选择，可以使用单选框实现。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">&lt;!– 导入js –&gt;</div><div class="line">&lt;script src=<span class="string">“<a href="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js&quot;" target="_blank" rel="noopener">https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js&quot;</a></span>&gt;&lt;/script&gt;</div><div class="line">&lt;!– 表格数据 –&gt;</div><div class="line">&lt;div id=<span class="string">“list”</span>&gt;</div><div class="line">    &lt;table class=<span class="string">“table table-hover table-bordered table-striped”</span>&gt;</div><div class="line">        &lt;thead&gt;</div><div class="line">            &lt;tr&gt;</div><div class="line">                &lt;th&gt;&lt;input <span class="built_in">type</span>=<span class="string">“checkbox”</span> id=<span class="string">“all”</span> name=<span class="string">“task_check_”</span> value=<span class="string">“”</span>&gt;&lt;/th&gt;</div><div class="line">                &lt;th&gt;ID&lt;/th&gt;</div><div class="line">                &lt;th&gt;User&lt;/th&gt;</div><div class="line">            &lt;/tr&gt;</div><div class="line">        &lt;/thead&gt;</div><div class="line">        &lt;tbody&gt;</div><div class="line">            &lt;tr&gt;</div><div class="line">                &lt;th&gt;&lt;input <span class="built_in">type</span>=<span class="string">“checkbox”</span> id=<span class="string">“”</span> name=<span class="string">“task_check”</span> value=<span class="string">“”</span>&gt;&lt;/th&gt;</div><div class="line">                &lt;td&gt;01&lt;/td&gt;</div><div class="line">                &lt;td&gt;nmask&lt;/td&gt;</div><div class="line">                &lt;td&gt;</div><div class="line">                    &lt;a href=<span class="string">“”</span> class=<span class="string">“link”</span>&gt;修改&lt;/a&gt;&amp;nbsp;&amp;nbsp;</div><div class="line">                &lt;/td&gt;</div><div class="line">            &lt;/tr&gt;</div><div class="line">        &lt;/tbody&gt;</div><div class="line">    &lt;/table&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;!– js –&gt;</div><div class="line">&lt;script&gt;</div><div class="line">$(document).ready(<span class="function"><span class="title">function</span></span> () &#123;</div><div class="line">    //全选或全不选</div><div class="line">    $(<span class="string">“#all”</span>).click(<span class="function"><span class="title">function</span></span> () &#123;</div><div class="line">        <span class="keyword">if</span> (this.checked) &#123;</div><div class="line">            $(<span class="string">“#list :checkbox”</span>).prop(<span class="string">“checked”</span>, <span class="literal">true</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            $(<span class="string">“#list :checkbox”</span>).attr(<span class="string">“checked”</span>, <span class="literal">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    //设置全选复选框</div><div class="line">    $(<span class="string">“#list :checkbox”</span>).click(<span class="function"><span class="title">function</span></span> () &#123;</div><div class="line">        allchk();</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">function</span> selectAll(check)&#123;</div><div class="line">        $(check).click(<span class="function"><span class="title">function</span></span>()&#123;</div><div class="line">            <span class="keyword">if</span> ($(check).is(<span class="string">‘:checked’</span>)) &#123;</div><div class="line">                $(<span class="string">“.list input”</span>).prop(<span class="string">“checked”</span>,<span class="literal">true</span>);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                $(<span class="string">“.list input”</span>).prop(<span class="string">“checked”</span>,<span class="literal">false</span>);</div><div class="line">            &#125;;</div><div class="line">        &#125;);</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    //显示时执行一次</div><div class="line">    selectAll();</div><div class="line">&#125;);</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>

<h3 id="后端功能"><a href="#后端功能" class="headerlink" title="后端功能"></a><a href="#后端功能" title="后端功能"></a>后端功能</h3><h4 id="表格分页-1"><a href="#表格分页-1" class="headerlink" title="表格分页"></a><a href="#表格分页-1" title="表格分页"></a>表格分页</h4><p>前面介绍了前端的分页，那么后端怎么写分页的功能呢？django框架有内置的分页模块Paginator，其他框架也有，比如flask等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">from django.core.paginator import Paginator</div><div class="line"></div><div class="line">def page_fenye(objects,page,num=10):</div><div class="line">    <span class="string">‘’</span><span class="string">‘分页函数</span></div><div class="line">    @num:每页显示多少条数据</div><div class="line">    @page:当前页码</div><div class="line">    @fenye_num:分页栏显示的数字数量</div><div class="line"></div><div class="line">    return：</div><div class="line">    @object_list:该页显示的数据对象</div><div class="line">    @page_range:分页栏显示的数字范围</div><div class="line">    @last_page:最后一页的数字</div><div class="line">    ‘<span class="string">‘’</span></div><div class="line">    fenye_num=6</div><div class="line">    fenye_num_av=fenye_num/2</div><div class="line"></div><div class="line">    try:</div><div class="line">        page=int(page)</div><div class="line">    except:</div><div class="line">        page=1</div><div class="line"></div><div class="line">    <span class="keyword">if</span> page&lt;1:</div><div class="line">        page=1</div><div class="line"></div><div class="line">    range_first_page=page-fenye_num_av</div><div class="line">    range_last_page=page+fenye_num_av</div><div class="line"></div><div class="line">    <span class="keyword">if</span> range_first_page&lt;0:</div><div class="line">        range_first_page=0</div><div class="line">        range_last_page=fenye_num</div><div class="line"></div><div class="line">    p = Paginator(objects, num)</div><div class="line"></div><div class="line">    page_range=list(p.page_range)[range_first_page:range_last_page]</div><div class="line"></div><div class="line">    last_page=len(p.page_range)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> page&gt;last_page:</div><div class="line">        page=1</div><div class="line"></div><div class="line">    page1 = p.page(page)</div><div class="line"></div><div class="line">    object_list=page1.object_list</div><div class="line"></div><div class="line">    <span class="built_in">return</span> object_list,page_range,last_page</div></pre></td></tr></table></figure>

<p>但个人使用以后发现性能不好，因为每次请求页面需要先获取所有的数据，再通过此模块计算出此页面需要展示的数据，当所有的数据量比较大时，返回就比较慢了(也可能是我没用对这个模块)。因此，我自己写了一个分页的模块。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">def fenye(all_num,page,num,page_list_num):</div><div class="line">    <span class="string">‘’</span><span class="string">‘分页计算</span></div><div class="line">    @all_num:数据库记录总量</div><div class="line">    @page:当前页码</div><div class="line">    @num:每一页显示的记录条数</div><div class="line">    @page_list_num:分页导航显示多少个数字，要为偶数</div><div class="line">    @page_list_aver:page_list_num除以2</div><div class="line"></div><div class="line">    return：</div><div class="line">    @page:显示第几页</div><div class="line">    @last_page:最后一页的数字</div><div class="line">    @page_list:分页栏显示的数字范围</div><div class="line">    ‘<span class="string">‘’</span></div><div class="line"></div><div class="line">    page=int(page)</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> all_num!=0:</div><div class="line">        last_page = all_num/num-1 <span class="keyword">if</span> all_num%num == 0 <span class="keyword">else</span> all_num/num <span class="comment">#计算最后一页数字</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        last_page=0</div><div class="line"></div><div class="line">    page_list_aver=page_list_num/2</div><div class="line"> </div><div class="line">    page=last_page <span class="keyword">if</span> page &gt; last_page <span class="keyword">else</span> page <span class="comment">#判断请求的页数是否超过范围</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> page &gt; page_list_aver:</div><div class="line">        <span class="keyword">if</span> last_page &gt; page+page_list_aver:</div><div class="line"></div><div class="line">            page_list=range(page - page_list_aver , page + page_list_aver)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line"></div><div class="line">            page_list=range(last_page - (page_list_num-1), last_page + 1)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">if</span> last_page &gt; page_list_num:</div><div class="line"></div><div class="line">            page_list = range(page_list_num)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line"></div><div class="line">            page_list = range(last_page + 1)</div><div class="line"></div><div class="line">    <span class="built_in">return</span> page,last_page,page_list</div></pre></td></tr></table></figure>

<p>这样不需要提前先查询出所有的数据存入内存，而只需要查询出总共存在多少条数据（注意，这里的查询语句由select <code>*</code> 改为select count(<code>*</code>)会快很多）。获取到分页函数返回的page后，可以结合sql语句中的limit功能，查询分页要展示的数据内容。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select <em> from <span class="built_in">test</span> <span class="built_in">limit</span> page</em>num,num <span class="comment"># page为分页返回的显示页码，num是一页显示的数据数量</span></div></pre></td></tr></table></figure>

<h4 id="session做身份认证"><a href="#session做身份认证" class="headerlink" title="session做身份认证"></a><a href="#session做身份认证" title="session做身份认证"></a>session做身份认证</h4><p>这个功能就是用来验证用户身份的，可配合登录功能，写一个装饰器函数，检查全局是否存在session值。（session值是一个字典格式，在用户登录时生成）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">def session_check(level=2,return_=False):</div><div class="line">    <span class="string">‘’</span><span class="string">‘session_check装饰器函数 针对函数</span></div><div class="line">    @level：可以给用户区分权限</div><div class="line">    @return_:检测到不存在session后跳转到不同的页面</div><div class="line">    ‘<span class="string">‘’</span></div><div class="line">    def dec(func):</div><div class="line">        def warp(request,<em>args,**kwargs):</em></div><div class="line">            <span class="keyword">if</span> request.session.get(<span class="string">‘user_id’</span>,False) and int(request.session.get(<span class="string">‘level’</span>))&lt;=level:</div><div class="line">                <span class="built_in">return</span> func(request,args,**kwargs)</div><div class="line">            <span class="keyword">elif</span> return_:</div><div class="line">                <span class="built_in">return</span> HttpResponse(<span class="string">‘&lt;head&gt;&lt;meta http-equiv=”refresh” content=”0.0001;url=/login/“&gt;&lt;/head&gt;’</span>)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="built_in">return</span> HttpResponse(<span class="string">‘&lt;head&gt;&lt;meta http-equiv=”refresh” content=”0.0001;url=/error/“&gt;&lt;/head&gt;’</span>)</div><div class="line">        <span class="built_in">return</span> warp</div><div class="line"></div><div class="line">    <span class="built_in">return</span> dec</div></pre></td></tr></table></figure>

<p>使用的话，直接在需要权限控制的函数上添加：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@session_check(return_=True)</div><div class="line">def vul_index(request):</div><div class="line">    <span class="string">‘’</span><span class="string">‘ 漏洞扫描 ‘</span><span class="string">‘’</span></div><div class="line">    pass</div></pre></td></tr></table></figure>

<p><code>暂时就想到了这些，先记这么多吧，等以后遇上了再补充一些，o了</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/08/21/生成k8s证书的三种方式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/21/生成k8s证书的三种方式/" itemprop="url">生成k8s证书的三种方式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-21T13:51:16+08:00">
                2018-08-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>根据官方文档，生成k8s秘钥证书及相关管理证书有三种方式，其本质都是通过openssl:</p>
<ul>
<li>cfssl</li>
<li>easyrsa</li>
<li>openssl</li>
</ul>
<p>官方文档：<a href="https://kubernetes.io/docs/concepts/cluster-administration/certificates/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/cluster-administration/certificates/</a></p>
<h5 id="cfssl方式"><a href="#cfssl方式" class="headerlink" title="cfssl方式"></a><a href="#cfssl方式" title="cfssl方式"></a>cfssl方式</h5><h6 id="1-cfssl下载地址"><a href="#1-cfssl下载地址" class="headerlink" title="1.cfssl下载地址:"></a><a href="#1-cfssl下载地址" title="1.cfssl下载地址:"></a>1.cfssl下载地址:</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VERSION=R1.<span class="number">2</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;cfssl,cfssljson,cfssl-certinfo&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">wget https:<span class="regexp">//</span>pkg.cfssl.org<span class="regexp">/$&#123;VERSION&#125;/</span><span class="variable">$&#123;i&#125;</span>_linux-amd64 -O <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span><span class="variable">$&#123;i&#125;</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h6 id="2-生成CA配置文件"><a href="#2-生成CA配置文件" class="headerlink" title="2.生成CA配置文件"></a><a href="#2-生成CA配置文件" title="2.生成CA配置文件"></a>2.生成CA配置文件</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mkdir ssl &amp;&amp; cd ssl</span><br><span class="line">cfssl print-defaults<span class="built_in"> config </span>&gt; config.json</span><br><span class="line">cfssl print-defaults csr &gt; csr.json</span><br><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“signing”</span>: &#123;</span><br><span class="line">    <span class="string">“default”</span>: &#123;</span><br><span class="line">      <span class="string">“expiry”</span>: <span class="string">“87600h”</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">“profiles”</span>: &#123;</span><br><span class="line">      <span class="string">“kubernetes”</span>: &#123;</span><br><span class="line">        <span class="string">“usages”</span>: [</span><br><span class="line">            <span class="string">“signing”</span>,</span><br><span class="line">            <span class="string">“key encipherment”</span>,</span><br><span class="line">            <span class="string">“server auth”</span>,</span><br><span class="line">            <span class="string">“client auth”</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">“expiry”</span>: <span class="string">“87600h”</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h6 id="3-生成CA签名配置文件"><a href="#3-生成CA签名配置文件" class="headerlink" title="3.生成CA签名配置文件"></a><a href="#3-生成CA签名配置文件" title="3.生成CA签名配置文件"></a>3.生成CA签名配置文件</h6><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“CN”</span>: <span class="string">“kubernetes”</span>,</span><br><span class="line">  <span class="string">“key”</span>: &#123;</span><br><span class="line">    <span class="string">“algo”</span>: <span class="string">“rsa”</span>,</span><br><span class="line">    <span class="string">“size”</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“names”</span>:[&#123;</span><br><span class="line">    <span class="string">“C”</span>: <span class="string">“CN”</span>,</span><br><span class="line">    <span class="string">“ST”</span>: <span class="string">“Beijing”</span>,</span><br><span class="line">    <span class="string">“L”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">    <span class="string">“O”</span>: <span class="string">“k8s”</span>,</span><br><span class="line">    <span class="string">“OU”</span>: <span class="string">“System”</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><a id="more"></a><br><br>###### <a href="#4-生成私钥和证书" title="4.生成私钥和证书"></a>4.生成私钥和证书<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca <span class="keyword">ca</span>-csr.json | cfssljson -bare <span class="keyword">ca</span></span><br></pre></td></tr></table></figure>

<h6 id="5-创建一个用于生成API-Server的密钥和证书的JSON配置文件"><a href="#5-创建一个用于生成API-Server的密钥和证书的JSON配置文件" class="headerlink" title="5.创建一个用于生成API Server的密钥和证书的JSON配置文件"></a><a href="#5-创建一个用于生成API-Server的密钥和证书的JSON配置文件" title="5.创建一个用于生成API Server的密钥和证书的JSON配置文件"></a>5.创建一个用于生成API Server的密钥和证书的JSON配置文件</h6><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubernetes-csr.json &lt;&lt;<span class="built_in">EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“CN”</span>: <span class="string">“kubernetes”</span>,</span><br><span class="line">  <span class="string">“hosts”</span>: [</span><br><span class="line">    <span class="string">“127.0.0.1”</span>,</span><br><span class="line">    <span class="string">“&lt;MASTER_IP&gt;”</span>,</span><br><span class="line">    <span class="string">“&lt;MASTER_CLUSTER_IP&gt;”</span>,</span><br><span class="line">    <span class="string">“kubernetes”</span>,</span><br><span class="line">    <span class="string">“kubernetes.default”</span>,</span><br><span class="line">    <span class="string">“kubernetes.default.svc”</span>,</span><br><span class="line">    <span class="string">“kubernetes.default.svc.cluster”</span>,</span><br><span class="line">    <span class="string">“kubernetes.default.svc.cluster.local”</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">“key”</span>: &#123;</span><br><span class="line">    <span class="string">“algo”</span>: <span class="string">“rsa”</span>,</span><br><span class="line">    <span class="string">“size”</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“names”</span>: [&#123;</span><br><span class="line">    <span class="string">“C”</span>: <span class="string">“CN”</span>,</span><br><span class="line">    <span class="string">“ST”</span>: <span class="string">“Beijing”</span>,</span><br><span class="line">    <span class="string">“L”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">    <span class="string">“O”</span>: <span class="string">“k8s”</span>,</span><br><span class="line">    <span class="string">“OU”</span>: <span class="string">“System”</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125; </span><br><span class="line"><span class="built_in">EOF</span></span><br><span class="line"><span class="meta">#该文件需要包含所有使用该证书的ip和域名列表，包括etcd集群、kubernetes master集群、以及apiserver 集群内部cluster ip。</span></span><br></pre></td></tr></table></figure>

<h6 id="6-生成-kubernetes-证书和私钥"><a href="#6-生成-kubernetes-证书和私钥" class="headerlink" title="6.生成 kubernetes 证书和私钥"></a><a href="#6-生成-kubernetes-证书和私钥" title="6.生成 kubernetes 证书和私钥"></a>6.生成 kubernetes 证书和私钥</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert <span class="attribute">-ca</span>=ca.pem <span class="attribute">-ca-key</span>=ca-key.pem <span class="attribute">-config</span>=ca-config.json <span class="attribute">-profile</span>=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span><br></pre></td></tr></table></figure>

<h6 id="7-创建admin证书"><a href="#7-创建admin证书" class="headerlink" title="7.创建admin证书"></a><a href="#7-创建admin证书" title="7.创建admin证书"></a>7.创建admin证书</h6><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; admin-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“CN”</span>: <span class="string">“admin”</span>,</span><br><span class="line">  <span class="string">“hosts”</span>: [],</span><br><span class="line">  <span class="string">“key”</span>: &#123;</span><br><span class="line">    <span class="string">“algo”</span>: <span class="string">“rsa”</span>,</span><br><span class="line">    <span class="string">“size”</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“names”</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">“C”</span>: <span class="string">“CN”</span>,</span><br><span class="line">      <span class="string">“ST”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“L”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“O”</span>: <span class="string">“system:masters”</span>,</span><br><span class="line">      <span class="string">“OU”</span>: <span class="string">“System”</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert <span class="attribute">-ca</span>=ca.pem <span class="attribute">-ca-key</span>=ca-key.pem <span class="attribute">-config</span>=ca-config.json <span class="attribute">-profile</span>=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line"><span class="comment"># 证书O配置为system:masters 在集群内部cluster-admin的clusterrolebinding将system:masters组和cluster-admin clusterrole绑定在一起</span></span><br></pre></td></tr></table></figure>

<h6 id="8-创建kube-proxy证书"><a href="#8-创建kube-proxy证书" class="headerlink" title="8.创建kube-proxy证书"></a><a href="#8-创建kube-proxy证书" title="8.创建kube-proxy证书"></a>8.创建kube-proxy证书</h6><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cat</span> &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“CN”</span>: <span class="string">“system:kube-proxy”</span>,</span><br><span class="line">  <span class="string">“hosts”</span>: [],</span><br><span class="line">  <span class="string">“key”</span>: &#123;</span><br><span class="line">    <span class="string">“algo”</span>: <span class="string">“rsa”</span>,</span><br><span class="line">    <span class="string">“size”</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“names”</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">“C”</span>: <span class="string">“CN”</span>,</span><br><span class="line">      <span class="string">“ST”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“L”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“O”</span>: <span class="string">“k8s”</span>,</span><br><span class="line">      <span class="string">“OU”</span>: <span class="string">“System”</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">cfssl gencert -<span class="keyword">ca</span>=<span class="keyword">ca</span>.pem -<span class="keyword">ca</span>-key=<span class="keyword">ca</span>-key.pem -config=<span class="keyword">ca</span>-config.json -<span class="keyword">profile</span>=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line"># 该证书用户名为<span class="built_in">system</span>:kube-proxy，预定义的<span class="built_in">system</span>:node-proxier clusterrolebindings将 <span class="built_in">system</span>:kube-proxy用户和<span class="built_in">system</span>:node-proxier角色绑定在一起</span><br></pre></td></tr></table></figure>

<h6 id="9-校验证书信息"><a href="#9-校验证书信息" class="headerlink" title="9.校验证书信息"></a><a href="#9-校验证书信息" title="9.校验证书信息"></a>9.校验证书信息</h6><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cfssl-certinfo -cert kubernetes.pem</span><br><span class="line">openssl x509  -noout -text -<span class="keyword">in</span>  kubernetes.pem</span><br></pre></td></tr></table></figure>

<h6 id="10-拷贝证书"><a href="#10-拷贝证书" class="headerlink" title="10.拷贝证书"></a><a href="#10-拷贝证书" title="10.拷贝证书"></a>10.拷贝证书</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span> &amp;&amp; cp *.pem <span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span></span><br></pre></td></tr></table></figure>

<h5 id="easyrsa方式"><a href="#easyrsa方式" class="headerlink" title="easyrsa方式"></a><a href="#easyrsa方式" title="easyrsa方式"></a>easyrsa方式</h5><h6 id="1-下载："><a href="#1-下载：" class="headerlink" title="1.下载："></a><a href="#1-下载：" title="1.下载："></a>1.下载：</h6><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -L -O https:<span class="string">//storage.googleapis.com/kubernetes-release/easy-rsa/easy-rsa.tar.gz</span></span><br><span class="line">tar xzf easy-rsa.tar.gz</span><br><span class="line"><span class="keyword">cd</span> easy-rsa-master/easyrsa3</span><br><span class="line"><span class="string">./easyrsa</span> init-pki</span><br><span class="line"><span class="string">./easyrsa</span> <span class="params">–batch</span> <span class="string">“--req-cn=172.26.6.1@<code>date +%s</code>“</span> build-ca nopass</span><br></pre></td></tr></table></figure>

<h6 id="2-生成-kubernetes-证书和私钥"><a href="#2-生成-kubernetes-证书和私钥" class="headerlink" title="2.生成 kubernetes 证书和私钥"></a><a href="#2-生成-kubernetes-证书和私钥" title="2.生成 kubernetes 证书和私钥"></a>2.生成 kubernetes 证书和私钥</h6><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./easyrsa –<span class="attr">subject-alt-name=</span><span class="string">“IP:172.26.6.1,IP:10.254.0.1,DNS:kubernetes.default”</span> build-server-full kubernetes-<span class="keyword">master</span> <span class="title">nopass</span></span><br></pre></td></tr></table></figure>

<h6 id="3-签发admin证书"><a href="#3-签发admin证书" class="headerlink" title="3.签发admin证书"></a><a href="#3-签发admin证书" title="3.签发admin证书"></a>3.签发admin证书</h6><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">./easyrsa</span> <span class="params">–dn-mode=org</span> <span class="params">–req-cn=admin</span> <span class="params">–req-org=system</span><span class="function">:masters</span> <span class="params">–req-c=</span> <span class="params">–req-st=</span> <span class="params">–req-city=</span> <span class="params">–req-email=</span> <span class="params">–req-ou=</span> build-client-full admin nopass</span><br></pre></td></tr></table></figure>

<h5 id="openssl方式"><a href="#openssl方式" class="headerlink" title="openssl方式"></a><a href="#openssl方式" title="openssl方式"></a>openssl方式</h5><h6 id="1-生成ca"><a href="#1-生成ca" class="headerlink" title="1.生成ca"></a><a href="#1-生成ca" title="1.生成ca"></a>1.生成ca</h6><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out ca.<span class="type">key</span> <span class="number">2048</span></span><br><span class="line">openssl req -x509 -new -nodes -<span class="type">key</span> ca.<span class="type">key</span> -subj <span class="string">“/CN=172.26.6.1”</span> -days <span class="number">10000</span> -out ca.crt</span><br></pre></td></tr></table></figure>

<h6 id="2-kubernetes证书和私钥"><a href="#2-kubernetes证书和私钥" class="headerlink" title="2.kubernetes证书和私钥"></a><a href="#2-kubernetes证书和私钥" title="2.kubernetes证书和私钥"></a>2.kubernetes证书和私钥</h6><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out server<span class="selector-class">.key</span> <span class="number">2048</span></span><br><span class="line">cat &gt;csr<span class="selector-class">.conf</span> &lt;&lt;EOF</span><br><span class="line">[ req ]</span><br><span class="line">default_bits = <span class="number">2048</span></span><br><span class="line">prompt = no</span><br><span class="line">default_md = sha256</span><br><span class="line">req_extensions = req_ext</span><br><span class="line">distinguished_name = dn</span><br><span class="line">    </span><br><span class="line">[ dn ]</span><br><span class="line">C = &lt;country&gt;</span><br><span class="line">ST = &lt;state&gt;</span><br><span class="line">L = &lt;city&gt;</span><br><span class="line">O = &lt;organization&gt;</span><br><span class="line">OU = &lt;organization unit&gt;</span><br><span class="line">CN = <span class="number">172.26</span>.<span class="number">6.1</span></span><br><span class="line">    </span><br><span class="line">[ req_ext ]</span><br><span class="line">subjectAltName = @alt_names</span><br><span class="line">    </span><br><span class="line">[ alt_names ]</span><br><span class="line">DNS.<span class="number">1</span> = kubernetes</span><br><span class="line">DNS.<span class="number">2</span> = kubernetes.default</span><br><span class="line">DNS.<span class="number">3</span> = kubernetes<span class="selector-class">.default</span><span class="selector-class">.svc</span></span><br><span class="line">DNS.<span class="number">4</span> = kubernetes<span class="selector-class">.default</span><span class="selector-class">.svc</span><span class="selector-class">.cluster</span></span><br><span class="line">DNS.<span class="number">5</span> = kubernetes<span class="selector-class">.default</span><span class="selector-class">.svc</span><span class="selector-class">.cluster</span><span class="selector-class">.local</span></span><br><span class="line">IP.<span class="number">1</span> = <span class="number">172.26</span>.<span class="number">6.1</span></span><br><span class="line">IP.<span class="number">2</span> = <span class="number">10.254</span>.<span class="number">0.1</span></span><br><span class="line">    </span><br><span class="line">[ v3_ext ]</span><br><span class="line">authorityKeyIdentifier=keyid,issuer:always</span><br><span class="line">basicConstraints=CA:FALSE</span><br><span class="line">keyUsage=keyEncipherment,dataEncipherment</span><br><span class="line">extendedKeyUsage=serverAuth,clientAuth</span><br><span class="line">subjectAltName=@alt_names</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">openssl req -new -key server<span class="selector-class">.key</span> -out server<span class="selector-class">.csr</span> -config csr.conf</span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> server<span class="selector-class">.csr</span> -CA ca<span class="selector-class">.crt</span> -CAkey ca<span class="selector-class">.key</span> -CAcreateserial -out server<span class="selector-class">.crt</span> -days <span class="number">10000</span> -extensions v3_ext -extfile csr.conf</span><br><span class="line">openssl x509  -noout -text -<span class="keyword">in</span> ./server.crt</span><br></pre></td></tr></table></figure>

<h6 id="3-admin证书"><a href="#3-admin证书" class="headerlink" title="3.admin证书"></a><a href="#3-admin证书" title="3.admin证书"></a>3.admin证书</h6><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -<span class="keyword">out</span> admin.key 2048</span><br><span class="line">openssl req -new -key admin.key -<span class="keyword">out</span> admin.csr -subj <span class="string">“/O=system:masters/CN=dmin”</span></span><br><span class="line">openssl x509 -req -set_serial $(date +%s%<span class="keyword">N</span>) -<span class="keyword">in</span> admin.csr -<span class="keyword">CA</span> <span class="keyword">ca</span>.crt -CAkey <span class="keyword">ca</span>.key -<span class="keyword">out</span> admin.crt -days 365 -extensions v3_req -extfile req.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/08/19/23种非常有用的ElasticSearch查询例子/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/19/23种非常有用的ElasticSearch查询例子/" itemprop="url">23种非常有用的ElasticSearch查询例子</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T09:57:30+08:00">
                2018-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、新建索引"><a href="#一、新建索引" class="headerlink" title="一、新建索引"></a><a href="#一、新建索引" title="一、新建索引"></a>一、新建索引</h2><p>为了展示Elasticsearch中不同查询的用法，先在Elasticsearch里面创建了book相关的documents，每本书主要涉及以下字段： title, authors, summary, publish_date(发行日期),publisher以及评论条数。</p>
<p>操作如下：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">‘<a href="https://www.iteblog.com:9200/iteblog_book_index&#39;" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index&#39;</a></span> -d <span class="string">‘&#123; “</span>settings<span class="string">“: &#123; “</span>number_of_shards<span class="string">“: 1 &#125;&#125;’</span></span><br><span class="line"></span><br><span class="line">curl -XPOST <span class="string">‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_bulk&#39;" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_bulk&#39;</a></span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123; “</span>index<span class="string">“: &#123; “</span>_id<span class="string">“: 1 &#125;&#125;</span></span><br><span class="line"><span class="string">&#123; “</span>title<span class="string">“: “</span>Elasticsearch: The Definitive Guide<span class="string">“, “</span>authors<span class="string">“: [“</span>clinton gormley<span class="string">“, “</span>zachary tong<span class="string">“], “</span>summary<span class="string">“ : “</span>A distibuted <span class="built_in">real</span>-time search <span class="built_in">and</span> analytics engine<span class="string">“, “</span>publish_date<span class="string">“ : “</span><span class="number">2015</span><span class="number">-02</span><span class="number">-07</span><span class="string">“, “</span>num_reviews<span class="string">“: 20, “</span>publisher<span class="string">“: “</span>oreilly<span class="string">“ &#125;</span></span><br><span class="line"><span class="string">&#123; “</span>index<span class="string">“: &#123; “</span>_id<span class="string">“: 2 &#125;&#125;</span></span><br><span class="line"><span class="string">&#123; “</span>title<span class="string">“: “</span>Taming Text: How to Find, Organize, <span class="built_in">and</span> Manipulate It<span class="string">“, “</span>authors<span class="string">“: [“</span>grant ingersoll<span class="string">“, “</span>thomas morton<span class="string">“, “</span>drew farris<span class="string">“], “</span>summary<span class="string">“ : “</span>organize text using approaches such as full-text search, proper name recognition, clustering, tagging, information extraction, <span class="built_in">and</span> summarization<span class="string">“, “</span>publish_date<span class="string">“ : “</span><span class="number">2013</span><span class="number">-01</span><span class="number">-24</span><span class="string">“, “</span>num_reviews<span class="string">“: 12, “</span>publisher<span class="string">“: “</span>manning<span class="string">“ &#125;</span></span><br><span class="line"><span class="string">&#123; “</span>index<span class="string">“: &#123; “</span>_id<span class="string">“: 3 &#125;&#125;</span></span><br><span class="line"><span class="string">&#123; “</span>title<span class="string">“: “</span>Elasticsearch in Action<span class="string">“, “</span>authors<span class="string">“: [“</span>radu gheorge<span class="string">“, “</span>matthew lee hinman<span class="string">“, “</span>roy russo<span class="string">“], “</span>summary<span class="string">“ : “</span>build scalable search applications using Elasticsearch without having to <span class="keyword">do</span> complex low-level programming <span class="built_in">or</span> understand advanced data science algorithms<span class="string">“, “</span>publish_date<span class="string">“ : “</span><span class="number">2015</span><span class="number">-12</span><span class="number">-03</span><span class="string">“, “</span>num_reviews<span class="string">“: 18, “</span>publisher<span class="string">“: “</span>manning<span class="string">“ &#125;</span></span><br><span class="line"><span class="string">&#123; “</span>index<span class="string">“: &#123; “</span>_id<span class="string">“: 4 &#125;&#125;</span></span><br><span class="line"><span class="string">&#123; “</span>title<span class="string">“: “</span>Solr in Action<span class="string">“, “</span>authors<span class="string">“: [“</span>trey grainger<span class="string">“, “</span>timothy potter<span class="string">“], “</span>summary<span class="string">“ : “</span>Comprehensive guide to implementing a scalable search engine using Apache Solr<span class="string">“, “</span>publish_date<span class="string">“ : “</span><span class="number">2014</span><span class="number">-04</span><span class="number">-05</span><span class="string">“, “</span>num_reviews<span class="string">“: 23, “</span>publisher<span class="string">“: “</span>manning<span class="string">“ &#125;</span></span><br><span class="line"><span class="string">‘</span></span><br></pre></td></tr></table></figure>

<p>通过dev tools来模拟则为：<br><a href="http://cos.leiyawu.com/img/elk_index_check_1.png" target="_blank" rel="noopener">http://cos.leiyawu.com/img/elk_index_check_1.png</a></p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /iteblog_book_index/book/_bulk</span><br><span class="line">&#123; <span class="string">“index”</span>: &#123; <span class="string">“_id”</span>: <span class="number">1</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">“title”</span>: <span class="string">“Elasticsearch: The Definitive Guide”</span>, <span class="string">“authors”</span>: [<span class="string">“clinton gormley”</span>, <span class="string">“zachary tong”</span>], <span class="string">“summary”</span> : <span class="string">“A distibuted real-time search and analytics engine”</span>, <span class="string">“publish_date”</span> : <span class="string">“2015-02-07”</span>, <span class="string">“num_reviews”</span>: <span class="number">20</span>, <span class="string">“publisher”</span>: <span class="string">“oreilly”</span> &#125;</span><br><span class="line">&#123; <span class="string">“index”</span>: &#123; <span class="string">“_id”</span>: <span class="number">2</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">“title”</span>: <span class="string">“Taming Text: How to Find, Organize, and Manipulate It”</span>, <span class="string">“authors”</span>: [<span class="string">“grant ingersoll”</span>, <span class="string">“thomas morton”</span>, <span class="string">“drew farris”</span>], <span class="string">“summary”</span> : <span class="string">“organize text using approaches such as full-text search, proper name recognition, clustering, tagging, information extraction, and summarization”</span>, <span class="string">“publish_date”</span> : <span class="string">“2013-01-24”</span>, <span class="string">“num_reviews”</span>: <span class="number">12</span>, <span class="string">“publisher”</span>: <span class="string">“manning”</span> &#125;</span><br><span class="line">&#123; <span class="string">“index”</span>: &#123; <span class="string">“_id”</span>: <span class="number">3</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">“title”</span>: <span class="string">“Elasticsearch in Action”</span>, <span class="string">“authors”</span>: [<span class="string">“radu gheorge”</span>, <span class="string">“matthew lee hinman”</span>, <span class="string">“roy russo”</span>], <span class="string">“summary”</span> : <span class="string">“build scalable search applications using Elasticsearch without having to do complex low-level programming or understand advanced data science algorithms”</span>, <span class="string">“publish_date”</span> : <span class="string">“2015-12-03”</span>, <span class="string">“num_reviews”</span>: <span class="number">18</span>, <span class="string">“publisher”</span>: <span class="string">“manning”</span> &#125;</span><br><span class="line">&#123; <span class="string">“index”</span>: &#123; <span class="string">“_id”</span>: <span class="number">4</span> &#125;&#125;</span><br><span class="line">&#123; <span class="string">“title”</span>: <span class="string">“Solr in Action”</span>, <span class="string">“authors”</span>: [<span class="string">“trey grainger”</span>, <span class="string">“timothy potter”</span>], <span class="string">“summary”</span> : <span class="string">“Comprehensive guide to implementing a scalable search engine using Apache Solr”</span>, <span class="string">“publish_date”</span> : <span class="string">“2014-04-05”</span>, <span class="string">“num_reviews”</span>: <span class="number">23</span>, <span class="string">“publisher”</span>: <span class="string">“manning”</span> &#125;</span><br></pre></td></tr></table></figure>

<p>ES中的查询请求有两种方式，一种是简易版的查询，另外一种是使用JSON完整的请求体，叫做结构化查询（DSL）。<br>由于DSL查询更为直观也更为简易，所以大都使用这种方式。<br>DSL查询是POST过去一个json，由于post的请求是json格式的，所以存在很多灵活性，也有很多形式。</p>
<p>基本匹配查询主要形式：<br>（1）、使用Search Lite API，并将所有的搜索参数都通过URL传递<br>（2）、使用Elasticsearch DSL，其可以通过传递一个JSON请求来获取结果。Curl方式与其类似，只是提交方式不是POST，而是XGET，提交参数与DSL提交一致</p>
<p>二、基本匹配查询(Basic Match Query)<br>1、在所有的字段中搜索带有”guide”的结果：<br>通过dev tools:<br>GET /iteblog_book_index/book/_search?q=guide</p>
<p>通过curl方式：<br>curl -u elastic “<a href="http://10.104.37.115:9281/iteblog_book_index/book/_search?pretty&quot;" target="_blank" rel="noopener">http://10.104.37.115:9281/iteblog_book_index/book/_search?pretty&quot;</a> -d ‘<br>{<br>    “query”: {<br>        “multi_match” : {<br>            “query” : “guide”,<br>            “fields” : [“_all”]<br>        }<br>    }<br>}’</p>
<p>通过DSL：(POST json方式)</p>
<p>其输出和上面使用/iteblog_book_index/book/_search?q=guide的输出一样。上面的multi_match关键字通常在查询多个fields的时候作为match关键字的简写方式。fields属性指定需要查询的字段，如果我们想查询所有的字段，这时候可以使用_all关键字，正如上面的一样。</p>
<p>如果只是查询summary字段，则为：</p>
<p>title的Guide则不会显示。</p>
<p>2、以上两种方式都允许我们指定查询哪些字段。比如，我们想查询title中出现in Action的图书，那么我们可以这么查询：</p>
<p>GET /iteblog_book_index/book/_search?q=title:in%20action</p>
<p>然而，DSL方式提供了更加灵活的方式来构建更加复杂的查询（我们将在后面看到），甚至指定你想要的返回结果。下面的例子中，我将指定需要返回结果的数量，开始的偏移量（这在分页的情况下非常有用），需要返回document中的哪些字段以及高亮关键字：</p>
<p>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “match” : {<br>            “title” : “in action”<br>        }<br>    },<br>    “size”: 2,   #返回结果的数量<br>    “from”: 0,  #开始的偏移量<br>    “_source”: [ “title”, “summary”, “publish_date” ],<br>    “highlight”: {<br>        “fields” : {<br>            “title” : {}<br>        }<br>    }<br>}’<br><a id="more"></a></p>
<p>三、Multi-field Search<br>正如我们之前所看到的，想在一个搜索中查询多个 document field （比如使用同一个查询关键字同时在title和summary中查询），你可以使用multi_match查询，使用如下：<br>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “multi_match” : {<br>            “query” : “elasticsearch guide”,<br>            “fields”: [“title”, “summary”]<br>        }<br>    }<br>}’</p>
<p>四、Boosting<br>上面使用同一个搜索请求在多个field中查询，你也许想提高某个field的查询权重。在下面的例子中，我们把summary field的权重调成3，这样就提高了其在结果中的权重，这样把_id=4的文档相关性大大提高了，如下：</p>
<p>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “multi_match” : {<br>            “query” : “elasticsearch guide”,<br>            “fields”: [“title”, “summary^3”]<br>        }<br>    },<br>    “_source”: [“title”, “summary”, “publish_date”]<br>}’</p>
<p>需要注意的是：Boosting不仅仅意味着计算出来的分数(calculated score)直接乘以boost factor，最终的boost value会经过归一化以及其他一些内部的优化</p>
<p>五、Bool Query<br>在查询条件中使用AND/OR/NOT操作符，这就是布尔查询(Bool Query)。布尔查询可以接受一个must参数(等价于AND)，一个must_not参数(等价于NOT)，以及一个should参数(等价于OR)。比如，我想查询title中出现Elasticsearch或者Solr关键字的图书，图书的作者是clinton gormley，但没有radu gheorge，可以这么来查询：</p>
<p>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “bool”: {<br>            “must”: {<br>                “bool” : { “should”: [<br>                      { “match”: { “title”: “Elasticsearch” }},<br>                      { “match”: { “title”: “Solr” }} ] }<br>            },<br>            “must”: { “match”: { “authors”: “clinton gormely” }},<br>            “must_not”: { “match”: {“authors”: “radu gheorge” }}<br>        }<br>    }<br>}’</p>
<p>六、Fuzzy Queries（模糊查询）<br>模糊查询可以在Match和 Multi-Match查询中使用以便解决拼写的错误，模糊度是基于Levenshtein distance计算与原单词的距离。使用如下：<br>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “multi_match” : {<br>            “query” : “comprihensiv guide”,<br>            “fields”: [“title”, “summary”],<br>            “fuzziness”: “AUTO”<br>        }<br>    },<br>    “_source”: [“title”, “summary”, “publish_date”],<br>    “size”: 1<br>}’</p>
<p>需要注意：上面我们将fuzziness的值指定为AUTO，其在term的长度大于5的时候相当于指定值为2。然而80%的人拼写错误的编辑距离(edit distance)为1，所有如果你将fuzziness设置为1可能会提高你的搜索性能。</p>
<p>七、Wildcard Query(通配符查询)<br>通配符查询允许我们指定一个模式来匹配，而不需要指定完整的term。?将会匹配一个字符；_将会匹配零个或者多个字符。比如我们想查找所有作者名字中以t字符开始的记录，我们可以如下使用：<br>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “wildcard” : {      #wildcard是通配符意思<br>            “authors” : “t_“<br>        }<br>    },<br>    “_source”: [“title”, “authors”],<br>    “highlight”: {<br>        “fields” : {<br>            “authors” : {}<br>        }<br>    }<br>}’</p>
<p>八、Regexp Query(正则表达式查询)<br>ElasticSearch还支持正则表达式查询，此方式提供了比通配符查询更加复杂的模式。比如我们先查找作者名字以t字符开头，中间是若干个a-z之间的字符，并且以字符y结束的记录，可以如下查询：</p>
<p>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “regexp” : {<br>            “authors” : “t[a-z]*y”<br>        }<br>    },<br>    “_source”: [“title”, “authors”],<br>    “highlight”: {<br>        “fields” : {<br>            “authors” : {}<br>        }<br>    }<br>}’</p>
<p>九、Match Phrase Query(匹配短语查询)<br>匹配短语查询要求查询字符串中的trems要么都出现Document中、要么trems按照输入顺序依次出现在结果中。在默认情况下，查询输入的trems必须在搜索字符串紧挨着出现，否则将查询不到。不过我们可以指定slop参数，来控制输入的trems之间有多少个单词仍然能够搜索到，如下所示：<br>curl -XGET ‘<a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search&#39;</a> -d ‘<br>{<br>    “query”: {<br>        “multi_match”: {<br>            “query”: “search engine”,<br>            “fields”: [<br>                “title”,<br>                “summary”<br>            ],<br>            “type”: “phrase”,<br>            “slop”: 3<br>        }<br>    },<br>    “_source”: [<br>        “title”,<br>        “summary”,<br>        “publish_date”<br>    ]<br>}’</p>
<p>从上面的例子可以看出，id为4的document被搜索（summary字段里面精确匹配到了search engine），并且分数比较高；而id为1的document也被搜索到了，虽然其summary中的search和engine单词并不是紧挨着的，但是我们指定了slop属性，所以被搜索到了。如果我们将”slop”: 3条件删除，那么id为1的文档将不会被搜索到，如下：</p>
<p>十、Simple Query String(简单查询字符串)<br>simple_query_string是query_string的另一种版本，其更适合为用户提供一个搜索框中，因为其使用+/|/- 分别替换AND/OR/NOT，如果用输入了错误的查询，其直接忽略这种情况而不是抛出异常。使用如下：(注意是POST)<br>curl POST <a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search</a><br>{<br>    “query”: {<br>        “simple_query_string” : {<br>            “query”: “(saerch~1 algorithm~1) + (grant ingersoll)  | (tom morton)”,<br>            “fields”: [“_all”, “summary^2”]<br>        }<br>    },<br>    “_source”: [ “title”, “summary”, “authors” ],<br>    “highlight”: {<br>        “fields” : {<br>            “summary” : {}<br>        }<br>    }<br>}</p>
<p>十一、Term/Terms Query<br>前面的例子中我们已经介绍了全文搜索(full-text search)，但有时候我们对结构化搜索中能够精确匹配并返回搜索结果更感兴趣。这种情况下我们可以使用term和terms查询。在下面例子中，我们想搜索所有曼宁出版社(Manning Publications)出版的图书：</p>
<p>curl POST <a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search</a> -d ‘<br>{<br>    “query”: {<br>        “term” : {<br>            “publisher”: “manning”<br>        }<br>    },<br>    “_source” : [“title”,”publish_date”,”publisher”]<br>}’</p>
<p>还可以使用terms关键字来指定多个terms，如下：</p>
<p>{<br>    “query”: {<br>        “terms” : {<br>            “publisher”: [“oreilly”, “packt”]<br>        }<br>    }<br>}</p>
<p>十二、Term Query - Sorted<br>词查询结果和其他查询结果一样可以很容易地对其进行排序，而且我们可以对输出结果按照多层进行排序：<br>curl POST <a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search</a><br>{<br>    “query”: {<br>        “term” : {<br>            “publisher”: “manning”<br>        }<br>    },<br>    “_source” : [“title”,”publish_date”,”publisher”],<br>    “sort”: [<br>        { “publish_date”: {“order”:”desc”}},<br>        { “title”: { “order”: “desc” }}<br>    ]<br>}</p>
<p>执行提示：<br>Fielddata is disabled on text fields by default. Set fielddata=true on [title] in order to load fielddata in memory by uninverting the inverted index</p>
<p>应该是5.x后对排序，聚合这些操作用单独的数据结构(fielddata)缓存到内存里了，需要单独开启</p>
<p>PUT /iteblog_book_index/_mapping/book<br>{<br>  “properties”: {<br>    “title”: {<br>      “type”: “text”,<br>      “fielddata”: true<br>    }<br>  }<br>}</p>
<p>再次执行：</p>
<p>十三、Range Query(范围查询)<br>另一种结构化查询就是范围查询。在下面例子中，我们搜索所有发行年份为2015的图书：<br>curl POST <a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search</a><br>{<br>    “query”: {<br>        “range” : {<br>            “publish_date”: {<br>                “gte”: “2015-01-01”,<br>                “lte”: “2015-12-31”<br>            }<br>        }<br>    },<br>    “_source” : [“title”,”publish_date”,”publisher”]<br>}</p>
<p>十四、Filtered Query(过滤查询)<br>过滤查询允许我们对查询结果进行筛选。比如：我们查询标题和摘要中包含Elasticsearch关键字的图书，但是我们想过滤出评论大于20的结果，可以如下使用：</p>
<p>curl POST <a href="https://www.iteblog.com:9200/iteblog_book_index/book/_search" target="_blank" rel="noopener">https://www.iteblog.com:9200/iteblog_book_index/book/_search</a><br>{<br>    “query”: {<br>        “filtered”: {<br>            “query” : {<br>                “multi_match”: {<br>                    “query”: “elasticsearch”,<br>                    “fields”: [“title”,”summary”]<br>                }<br>            },<br>            “filter”: {<br>                “range” : {<br>                    “num_reviews”: {<br>                        “gte”: 20<br>                    }<br>                }<br>            }<br>        }<br>    },<br>    “_source” : [“title”,”summary”,”publisher”, “num_reviews”]<br>}</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/08/19/ElasticSearch-索引查询使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/19/ElasticSearch-索引查询使用指南/" itemprop="url">ElasticSearch 索引查询使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T09:56:47+08:00">
                2018-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1.我们通常用用<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cat.html" target="_blank" rel="noopener">_cat API</a>检测集群是否健康。 确保9200端口号可用:<br>curl ‘localhost:9200/_cat/health?v’</p>
<p>绿色表示一切正常, 黄色表示所有的数据可用但是部分副本还没有分配,红色表示部分数据因为某些原因不可用.</p>
<p>2.通过如下语句，我们可以获取集群的节点列表：<br>curl ‘localhost:9200/_cat/nodes?v’</p>
<p>3.通过如下语句，列出所有索引：<br>curl ‘localhost:9200/_cat/indices?v’<br>返回结果：</p>
<p><img src="http://cos.leiyawu.com/img/elk_index_check_1.png" alt="图1"> 　　</p>
<p>4.创建索引<br>现在我们创建一个名为“customer”的索引，然后再查看所有的索引：<br> curl -XPUT ‘localhost:9200/customer?pretty’<br> curl ‘localhost:9200/_cat/indices?v’</p>
<p>结果如下：</p>
<p><img src="http://cos.leiyawu.com/img/elk_index_check_2.png" alt="图2"></p>
<p><img src="http://cos.leiyawu.com/img/elk_index_check_3.png" alt="图3"></p>
<p>上图中红框所表示的是：我们有一个叫customer的索引，它有五个私有的分片以及一个副本，在它里面有0个文档。<br><a id="more"></a></p>
<p>5.插入和获取<br>现在我么插入一些数据到集群索引。我们必须给ES指定所以的类型。如下语句：”external” type, ID：1:<br>主体为JSON格式的语句： { “name”: “John Doe” }</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">‘localhost:9200/customer/external/1?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">     　　  “</span>name<span class="string">“: “</span>John Doe<span class="string">“</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>返回结果为：create：true 表示插入成功。<br><img src="http://cos.leiyawu.com/img/elk_index_check_4.png" alt="图4"></p>
<p>获取GET，语句如下：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET ‘localhost:<span class="number">9200</span>/customer/external/1?pretty’</span><br></pre></td></tr></table></figure>

<p>其中含义为：获取customer索引下类型为external，id为1的数据，pretty参数表示返回结果格式美观。</p>
<p><img src="http://cos.leiyawu.com/img/elk_index_check_5.png" alt="图5"></p>
<p>6.删除索引 DELETE</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE ‘localhost:<span class="number">9200</span>/customer?pretty’</span><br><span class="line">curl ‘localhost:<span class="number">9200</span>/_cat/indices?v’</span><br></pre></td></tr></table></figure>

<p><img src="http://cos.leiyawu.com/img/elk_index_check_6.png" alt="图6"></p>
<p>表示索引删除成功。</p>
<p>7.通过以上命令语句的学习，我们发现索引的增删改查有一个类似的格式，总结如下：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -X&lt;REST Verb&gt; &lt;Node&gt;<span class="symbol">:&lt;Port&gt;/&lt;Index&gt;/&lt;Type&gt;/&lt;ID&gt;</span></span><br><span class="line">&lt;REST Verb&gt;：REST风格的语法谓词</span><br><span class="line">&lt;Node&gt;<span class="symbol">:</span>节点ip</span><br><span class="line">&lt;port&gt;<span class="symbol">:</span>节点端口号，默认<span class="number">9200</span></span><br><span class="line">&lt;Index&gt;<span class="symbol">:</span>索引名</span><br><span class="line">&lt;Type&gt;<span class="symbol">:</span>索引类型</span><br><span class="line">&lt;ID&gt;<span class="symbol">:</span>操作对象的ID号</span><br></pre></td></tr></table></figure>

<p>8 修改数据</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">‘localhost:9200/customer/external/1?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>name<span class="string">“: “</span>John Doe<span class="string">“</span></span><br><span class="line"><span class="string">&#125;’</span></span><br><span class="line">curl -XPUT <span class="string">‘localhost:9200/customer/external/1?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>name<span class="string">“: “</span>Jane Doe<span class="string">“</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>上述命令语句是：先新增id为1，name为John Doe的数据，然后将id为1的name修改为Jane Doe。</p>
<p>9.更新数据<br>9.1 这个例子展示如何将id为1文档的name字段更新为Jane Doe：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/customer/external/1/_update?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>doc<span class="string">“: &#123; “</span>name<span class="string">“: “</span>Jane Doe<span class="string">“ &#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>9.2 这个例子展示如何将id为1数据的name字段更新为Jane Doe同时增加字段age为20:</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/customer/external/1/_update?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>doc<span class="string">“: &#123; “</span>name<span class="string">“: “</span>Jane Doe<span class="string">“, “</span>age<span class="string">“: 20 &#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>9.3  也可以通过一些简单的scripts来执行更新。一下语句通过使用script将年龄增加5:</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/customer/external/1/_update?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>script<span class="string">“ : “</span>ctx._source.age += <span class="number">5</span><span class="string">“</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>10 删除数据<br>删除数据那是相当的直接. 下面的语句将执行删除Customer中ID为2的数据：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE ‘localhost:<span class="number">9200</span>/customer/external/2?pretty’</span><br></pre></td></tr></table></figure>

<p>11 批处理<br>举例:<br>下面语句将在一个批量操作中执行创建索引：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/customer/external/_bulk?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;”</span>index<span class="string">“:&#123;”</span>_id<span class="string">“:”</span><span class="number">1</span><span class="string">“&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;”</span>name<span class="string">“: “</span>John Doe<span class="string">“ &#125;</span></span><br><span class="line"><span class="string">&#123;”</span>index<span class="string">“:&#123;”</span>_id<span class="string">“:”</span><span class="number">2</span><span class="string">“&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;”</span>name<span class="string">“: “</span>Jane Doe<span class="string">“ &#125;</span></span><br><span class="line"><span class="string">‘</span></span><br></pre></td></tr></table></figure>

<p>下面语句批处理执行更新id为1的数据然后执行删除id为2的数据</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/customer/external/_bulk?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;”</span>update<span class="string">“:&#123;”</span>_id<span class="string">“:”</span><span class="number">1</span><span class="string">“&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;”</span>doc<span class="string">“: &#123; “</span>name<span class="string">“: “</span>John Doe becomes Jane Doe<span class="string">“ &#125; &#125;</span></span><br><span class="line"><span class="string">&#123;”</span>delete<span class="string">“:&#123;”</span>_id<span class="string">“:”</span><span class="number">2</span><span class="string">“&#125;&#125;</span></span><br><span class="line"><span class="string">‘</span></span><br></pre></td></tr></table></figure>

<p>12.导入数据集<br>你可以点击这里下载示例数据集:accounts.json<br>其中每个数据都是如下格式:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   　　  <span class="attr">“index”</span>:&#123;<span class="attr">“_id”</span>:<span class="string">“1”</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">“account_number”</span>: <span class="number">0</span>,</span><br><span class="line">  　 <span class="attr">“balance”</span>: <span class="number">16623</span>,</span><br><span class="line"> 　  <span class="attr">“firstname”</span>: <span class="string">“Bradshaw”</span>,</span><br><span class="line">  　 <span class="attr">“lastname”</span>: <span class="string">“Mckenzie”</span>,</span><br><span class="line">  　 <span class="attr">“age”</span>: <span class="number">29</span>,</span><br><span class="line">  　 <span class="attr">“gender”</span>: <span class="string">“F”</span>,</span><br><span class="line">    <span class="attr">“address”</span>: <span class="string">“244 Columbus Place”</span>,</span><br><span class="line"> 　  <span class="attr">“employer”</span>: <span class="string">“Euron”</span>,</span><br><span class="line">  　 <span class="attr">“email”</span>: <span class="string">“<a href="mailto:bradshawmckenzie@euron.com" target="_blank" rel="noopener">bradshawmckenzie@euron.com</a>“</span>,</span><br><span class="line">  　 <span class="attr">“city”</span>: <span class="string">“Hobucken”</span>,</span><br><span class="line">  　 <span class="attr">“state”</span>: <span class="string">“CO”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>导入示例数据集:</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST ‘localhost:<span class="number">9200</span>/bank/account/_bulk?pretty’ –data-binary <span class="string">“@accounts.json”</span></span><br><span class="line">curl ‘localhost:<span class="number">9200</span>/_cat/indices?v’</span><br></pre></td></tr></table></figure>

<p><img src="http://cos.leiyawu.com/img/elk_index_check_7.png" alt="图7"></p>
<p>上图红框表示我们已经成功批量导入1000条数据索引到bank索引中。</p>
<p>13.查询<br>Sample:</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="symbol">‘localhost</span>:<span class="number">9200</span>/bank/_search?q=*&amp;pretty’</span><br><span class="line">&#123;</span><br><span class="line">　　  <span class="string">“took”</span> : 63,</span><br><span class="line"> 　　 <span class="string">“timed_out”</span> : <span class="type">false</span>,</span><br><span class="line"> 　　 <span class="string">“_shards”</span> : &#123;</span><br><span class="line">    <span class="string">“total”</span> : 5,</span><br><span class="line">    <span class="string">“successful”</span> : 5,</span><br><span class="line">    <span class="string">“failed”</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“hits”</span> : &#123;</span><br><span class="line">  <span class="string">“total”</span> : 1000,</span><br><span class="line">  <span class="string">“max_score”</span> : 1.0,</span><br><span class="line">  <span class="string">“hits”</span> : [ &#123;</span><br><span class="line">    <span class="string">“_index”</span> : “<span class="type">bank</span><span class="string">“,</span></span><br><span class="line"><span class="string">    “</span>_type<span class="string">“ : “</span>account<span class="string">“,</span></span><br><span class="line"><span class="string">    “</span>_id<span class="string">“ : “</span><span class="number">1</span><span class="string">“,</span></span><br><span class="line"><span class="string">    “</span>_score<span class="string">“ : 1.0, “</span>_source<span class="string">“ : &#123;”</span>account_number<span class="string">“:1,”</span>balance<span class="string">“:39225,”</span>firstname<span class="string">“:”</span>Amber<span class="string">“,”</span>lastname<span class="string">“:”</span>Duke<span class="string">“,”</span>age<span class="string">“:32,”</span>gender<span class="string">“:”</span>M<span class="string">“,”</span>address<span class="string">“:”</span><span class="number">880</span> Holmes Lane<span class="string">“,”</span>employer<span class="string">“:”</span>Pyrami<span class="string">“,”</span>email<span class="string">“:”</span><a href="mailto:amberduke@pyrami.com" target="_blank" rel="noopener">amberduke@pyrami.com</a><span class="string">“,”</span>city<span class="string">“:”</span>Brogan<span class="string">“,”</span>state<span class="string">“:”</span>IL<span class="string">“&#125;</span></span><br><span class="line"><span class="string">  &#125;, &#123;</span></span><br><span class="line"><span class="string">    “</span>_index<span class="string">“ : “</span>bank<span class="string">“,</span></span><br><span class="line"><span class="string">    “</span>_type<span class="string">“ : “</span>account<span class="string">“,</span></span><br><span class="line"><span class="string">    “</span>_id<span class="string">“ : “</span><span class="number">6</span><span class="string">“,</span></span><br><span class="line"><span class="string">    “</span>_score<span class="string">“ : 1.0, “</span>_source<span class="string">“ : &#123;”</span>account_number<span class="string">“:6,”</span>balance<span class="string">“:5686,”</span>firstname<span class="string">“:”</span>Hattie<span class="string">“,”</span>lastname<span class="string">“:”</span>Bond<span class="string">“,”</span>age<span class="string">“:36,”</span>gender<span class="string">“:”</span>M<span class="string">“,”</span>address<span class="string">“:”</span><span class="number">671</span> Bristol Street<span class="string">“,”</span>employer<span class="string">“:”</span>Netagy<span class="string">“,”</span>email<span class="string">“:”</span><a href="mailto:hattiebond@netagy.com" target="_blank" rel="noopener">hattiebond@netagy.com</a><span class="string">“,”</span>city<span class="string">“:”</span>Dante<span class="string">“,”</span>state<span class="string">“:”</span>TN<span class="string">“&#125;</span></span><br><span class="line"><span class="string">  &#125;, &#123;</span></span><br><span class="line"><span class="string">    “</span>_index<span class="string">“ : “</span>bank<span class="string">“,</span></span><br><span class="line"><span class="string">    “</span>_type<span class="string">“ : “</span>account<span class="string">“,</span></span><br></pre></td></tr></table></figure>

<p>上面示例返回所有bank中的索引数据。其中 q=*  表示匹配索引中所有的数据。</p>
<p>等价于:</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>query<span class="string">“: &#123; “</span>match_all<span class="string">“: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>14 查询语言</p>
<p>匹配所有数据，但只返回1个:</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"> 　“</span>query<span class="string">“: &#123; “</span>match_all<span class="string">“: &#123;&#125; &#125;,</span></span><br><span class="line"><span class="string">  “</span><span class="built_in">size</span><span class="string">“: 1</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>注意：如果siez不指定，则默认返回10条数据。</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"> 　“</span>query<span class="string">“: &#123; “</span>match_all<span class="string">“: &#123;&#125; &#125;,</span></span><br><span class="line"><span class="string">  “</span>from<span class="string">“: 10,</span></span><br><span class="line"><span class="string">  “</span><span class="built_in">size</span><span class="string">“: 10</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>返回从11到20的数据。（索引下标从0开始）</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>query<span class="string">“: &#123; “</span>match_all<span class="string">“: &#123;&#125; &#125;,</span></span><br><span class="line"><span class="string"> 　“</span>sort<span class="string">“: &#123; “</span>balance<span class="string">“: &#123; “</span>order<span class="string">“: “</span>desc<span class="string">“ &#125; &#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>上述示例匹配所有的索引中的数据，按照balance字段降序排序，并且返回前10条（如果不指定size，默认最多返回10条）。</p>
<p>15.执行搜索</p>
<p>下面例子展示如何返回两个字段（account_number balance）</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>query<span class="string">“: &#123; “</span>match_all<span class="string">“: &#123;&#125; &#125;,</span></span><br><span class="line"><span class="string">  “</span>_source<span class="string">“: [“</span>account_number<span class="string">“, “</span>balance<span class="string">“]</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p><img src="http://cos.leiyawu.com/img/elk_index_check_8.png" alt="图8"></p>
<p>返回account_number 为20 的数据:</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>query<span class="string">“: &#123; “</span>match<span class="string">“: &#123; “</span>account_number<span class="string">“: 20 &#125; &#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>返回address中包含mill的所有数据：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>query<span class="string">“: &#123; “</span>match<span class="string">“: &#123; “</span>address<span class="string">“: “</span>mill<span class="string">“ &#125; &#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>返回地址中包含mill或者lane的所有数据：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"> 　“</span>query<span class="string">“: &#123; “</span>match<span class="string">“: &#123; “</span>address<span class="string">“: “</span>mill lane<span class="string">“ &#125; &#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>和上面匹配单个词语不同，下面这个例子是多匹配（match_phrase短语匹配），返回地址中包含短语 “mill lane”的所有数据：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>query<span class="string">“: &#123; “</span>match_phrase<span class="string">“: &#123; “</span>address<span class="string">“: “</span>mill lane<span class="string">“ &#125; &#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>以下是布尔查询，布尔查询允许我们将多个简单的查询组合成一个更复杂的布尔逻辑查询。<br>这个例子将两个查询组合，返回地址中含有mill和lane的所有记录数据：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>query<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">    “</span>bool<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">  　　  “</span>must<span class="string">“: [</span></span><br><span class="line"><span class="string">   　　   &#123; “</span>match<span class="string">“: &#123; “</span>address<span class="string">“: “</span>mill<span class="string">“ &#125; &#125;,</span></span><br><span class="line"><span class="string">   　　   &#123; “</span>match<span class="string">“: &#123; “</span>address<span class="string">“: “</span>lane<span class="string">“ &#125; &#125;</span></span><br><span class="line"><span class="string">  　　  ]</span></span><br><span class="line"><span class="string">  　　&#125;</span></span><br><span class="line"><span class="string"> 　&#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>上述例子中，must表示所有查询必须都为真才被认为匹配。</p>
<p>相反, 这个例子组合两个查询，返回地址中含有mill或者lane的所有记录数据：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"> 　“</span>query<span class="string">“: &#123;</span></span><br><span class="line"><span class="string"> 　  “</span>bool<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">  　　  “</span>should<span class="string">“: [</span></span><br><span class="line"><span class="string">   　　   &#123; “</span>match<span class="string">“: &#123; “</span>address<span class="string">“: “</span>mill<span class="string">“ &#125; &#125;,</span></span><br><span class="line"><span class="string">    　　  &#123; “</span>match<span class="string">“: &#123; “</span>address<span class="string">“: “</span>lane<span class="string">“ &#125; &#125;</span></span><br><span class="line"><span class="string">   　　 ]</span></span><br><span class="line"><span class="string">  　 &#125;</span></span><br><span class="line"><span class="string"> 　&#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>上述例子中，bool表示查询列表中只要有任何一个为真则认为匹配。</p>
<p>下面例子组合两个查询，返回地址中既没有mill也没有lane的所有数据：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>query<span class="string">“: &#123;</span></span><br><span class="line"><span class="string"> 　  “</span>bool<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">  　　  “</span>must_not<span class="string">“: [</span></span><br><span class="line"><span class="string">    　　  &#123; “</span>match<span class="string">“: &#123; “</span>address<span class="string">“: “</span>mill<span class="string">“ &#125; &#125;,</span></span><br><span class="line"><span class="string">     　　 &#123; “</span>match<span class="string">“: &#123; “</span>address<span class="string">“: “</span>lane<span class="string">“ &#125; &#125;</span></span><br><span class="line"><span class="string">    　　]</span></span><br><span class="line"><span class="string">  　　&#125;</span></span><br><span class="line"><span class="string"> 　&#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>上述例子中,must_not表示查询列表中没有为真的（也就是全为假）时则认为匹配。</p>
<p>我们可以组合must、should、must_not来实现更加复杂的多级逻辑查询。</p>
<p>下面这个例子返回年龄大于40岁、不居住在ID的所有数据：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  “</span>query<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">  　 “</span>bool<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">  　　  “</span>must<span class="string">“: [</span></span><br><span class="line"><span class="string">     　　 &#123; “</span>match<span class="string">“: &#123; “</span>age<span class="string">“: “</span><span class="number">40</span><span class="string">“ &#125; &#125;</span></span><br><span class="line"><span class="string">   　　 ],</span></span><br><span class="line"><span class="string">   　　 “</span>must_not<span class="string">“: [</span></span><br><span class="line"><span class="string">     　　 &#123; “</span>match<span class="string">“: &#123; “</span>state<span class="string">“: “</span>ID<span class="string">“ &#125; &#125;</span></span><br><span class="line"><span class="string">    　　]</span></span><br><span class="line"><span class="string">  　　&#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>16.过滤filter(查询条件设置)</p>
<p>下面这个例子使用了布尔查询返回balance在20000到30000之间的所有数据。</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">　　  “</span>query<span class="string">“: &#123;</span></span><br><span class="line"><span class="string"> 　　　  “</span>bool<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">  　　　　  “</span>must<span class="string">“: &#123; “</span>match_all<span class="string">“: &#123;&#125; &#125;,</span></span><br><span class="line"><span class="string">   　　　　 “</span>filter<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">      　　　　“</span>range<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">        　　“</span>balance<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">        　　  “</span>gte<span class="string">“: 20000,</span></span><br><span class="line"><span class="string">         　　 “</span>lte<span class="string">“: 30000</span></span><br><span class="line"><span class="string">       　　 &#125;</span></span><br><span class="line"><span class="string">     　　 &#125;</span></span><br><span class="line"><span class="string">   　　 &#125;</span></span><br><span class="line"><span class="string">  　 &#125;</span></span><br><span class="line"><span class="string"> 　&#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>17 聚合 Aggregations<br>下面这个例子： 将所有的数据按照state分组（group），然后按照分组记录数从大到小排序，返回前十条（默认）：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"> 　“</span><span class="built_in">size</span><span class="string">“: 0,</span></span><br><span class="line"><span class="string">  “</span>aggs<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">  　 “</span>group_by_state<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">  　　  “</span>terms<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">   　　　   “</span>field<span class="string">“: “</span>state<span class="string">“</span></span><br><span class="line"><span class="string">  　　  &#125;</span></span><br><span class="line"><span class="string">  　 &#125;</span></span><br><span class="line"><span class="string"> 　&#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p>注意：我们设置size=0，不显示查询hits，因为我们只想看返回的聚合结果。<br><img src="http://cos.leiyawu.com/img/elk_index_check_9.png" alt="图9"></p>
<p><img src="http://cos.leiyawu.com/img/elk_index_check_10.png" alt="图10"></p>
<p>上述语句类似于以下SQL语句：<br>SELECT state, COUNT(<em>) FROM bank GROUP BY state ORDER BY COUNT(</em>) DESC</p>
<p>下面这个实例按照state分组，降序排序，返回balance的平均值：</p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">‘localhost:9200/bank/_search?pretty’</span> -d <span class="string">‘</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"> 　“</span><span class="built_in">size</span><span class="string">“: 0,</span></span><br><span class="line"><span class="string"> 　“</span>aggs<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">  　 “</span>group_by_state<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">  　　  “</span>terms<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">     　　 “</span>field<span class="string">“: “</span>state<span class="string">“</span></span><br><span class="line"><span class="string">   　　 &#125;,</span></span><br><span class="line"><span class="string">  　　  “</span>aggs<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">     　　 “</span>average_balance<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">      　　  “</span>avg<span class="string">“: &#123;</span></span><br><span class="line"><span class="string">       　　   “</span>field<span class="string">“: “</span>balance<span class="string">“</span></span><br><span class="line"><span class="string">       　　 &#125;</span></span><br><span class="line"><span class="string">     　　 &#125;</span></span><br><span class="line"><span class="string">   　　 &#125;</span></span><br><span class="line"><span class="string">  　　&#125;</span></span><br><span class="line"><span class="string"> 　&#125;</span></span><br><span class="line"><span class="string">&#125;’</span></span><br></pre></td></tr></table></figure>

<p><img src="http://cos.leiyawu.com/img/elk_index_check_11.png" alt="图11"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/08/19/ES内置账号密码修改、自定义角色自定义账号、ldap及AD认证/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/19/ES内置账号密码修改、自定义角色自定义账号、ldap及AD认证/" itemprop="url">ES内置账号密码修改、自定义角色自定义账号、ldap及AD认证</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T09:55:58+08:00">
                2018-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="自定义内置账号"><a href="#自定义内置账号" class="headerlink" title="自定义内置账号"></a><a href="#自定义内置账号" title="自定义内置账号"></a>自定义内置账号</h2><ul>
<li>账户elastic为elasticsearch超级管理员，拥有所有权限</li>
<li>账户kibana用于kibana组件获取相关信息用于web展示</li>
<li>账户logstash_system用于logstash服务获取elasticsearch的监控数据</li>
<li>注意：此步骤需先启动elasticsearch服务</li>
</ul>
<p><img src="https://cos.leiyawu.com/img/elk/es_user.png" alt="es_user"></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-6.0.0]$ ./bin/x-pack/setup-passwords interactive</span><br><span class="line">Initiating the setup of reserved<span class="built_in"> user </span>elastic,kibana,logstash_system passwords.</span><br><span class="line">You will be prompted <span class="keyword">to</span> enter passwords as the process progresses.</span><br><span class="line">Please confirm that you would like <span class="keyword">to</span> continue [y/N]y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Enter password <span class="keyword">for</span> [elastic]: </span><br><span class="line">Reenter password <span class="keyword">for</span> [elastic]: </span><br><span class="line">Enter password <span class="keyword">for</span> [kibana]: </span><br><span class="line">Reenter password <span class="keyword">for</span> [kibana]: </span><br><span class="line">Enter password <span class="keyword">for</span> [logstash_system]: </span><br><span class="line">Reenter password <span class="keyword">for</span> [logstash_system]: </span><br><span class="line">Changed password <span class="keyword">for</span><span class="built_in"> user </span>[kibana]</span><br><span class="line">Changed password <span class="keyword">for</span><span class="built_in"> user </span>[logstash_system]</span><br><span class="line">Changed password <span class="keyword">for</span><span class="built_in"> user </span>[elastic]</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-6.0.0]$</span><br></pre></td></tr></table></figure>

<h2 id="验证内置账户访问"><a href="#验证内置账户访问" class="headerlink" title="验证内置账户访问"></a><a href="#验证内置账户访问" title="验证内置账户访问"></a>验证内置账户访问</h2><ul>
<li><p>若不提供用户名密码则返回401<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl <span class="string">‘<a href="http://10.59.30.96:9200/_cat/indices?pretty&#39;" target="_blank" rel="noopener">http://10.59.30.96:9200/_cat/indices?pretty&#39;</a></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“error”</span> : &#123;</span><br><span class="line">    <span class="string">“root_cause”</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">“type”</span> : <span class="string">“security_exception”</span>,</span><br><span class="line">        <span class="string">“reason”</span> : <span class="string">“missing authentication token for REST request [/_cat/indices?pretty]”</span>,</span><br><span class="line">        <span class="string">“header”</span> : &#123;</span><br><span class="line">          <span class="string">“WWW-Authenticate”</span> : <span class="string">“Basic realm=\”</span>security\<span class="string">“ charset=\”</span>UTF-<span class="number">8</span>\<span class="string">“”</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">“type”</span> : <span class="string">“security_exception”</span>,</span><br><span class="line">    <span class="string">“reason”</span> : <span class="string">“missing authentication token for REST request [/_cat/indices?pretty]”</span>,</span><br><span class="line">    <span class="string">“header”</span> : &#123;</span><br><span class="line">      <span class="string">“WWW-Authenticate”</span> : <span class="string">“Basic realm=\”</span>security\<span class="string">“ charset=\”</span>UTF-<span class="number">8</span>\<span class="string">“”</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“status”</span> : <span class="number">401</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</li>
<li><p>提供相应用户信息后可访问，若用户权限不足则返回403</p>
</li>
</ul>
<p>使用logstash_system用户访问<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl <span class="symbol">‘http</span>://<span class="number">10.59</span>.<span class="number">30.96</span>:<span class="number">9200</span>/_cat/indices?pretty’ -u logstash_system:logstash_system</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“error”</span> : &#123;</span><br><span class="line">    <span class="string">“root_cause”</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">“type”</span> : “<span class="type">security_exception</span><span class="string">“,</span></span><br><span class="line"><span class="string">        “</span>reason<span class="string">“ : “</span>action [indices:monitor/stats] <span class="keyword">is</span> unauthorized <span class="keyword">for</span> user [logstash_system]<span class="string">“</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    “</span><span class="keyword">type</span><span class="string">“ : “</span>security_exception<span class="string">“,</span></span><br><span class="line"><span class="string">    “</span>reason<span class="string">“ : “</span>action [indices:monitor/stats] <span class="keyword">is</span> unauthorized <span class="keyword">for</span> user [logstash_system]<span class="string">“</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  “</span>status<span class="string">“ : 403</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">[elasticsearch@elasticsearch elasticsearch-6.0.0]$</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>使用kibana用户访问<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl <span class="string">‘<a href="http://10.59.30.96:9200/_cat/indices?pretty&#39;" target="_blank" rel="noopener">http://10.59.30.96:9200/_cat/indices?pretty&#39;</a></span> -u kibana:kibana</span><br><span class="line">yellow open <span class="selector-class">.monitoring-es-6-2018</span>.<span class="number">01.10</span>   nND6-i_rR5iLEYVccBGj8w <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow open <span class="selector-class">.triggered_watches</span>            BtygGZisSDqiL3Y2TaQGqQ <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">green  open <span class="selector-class">.security-6</span>                   QVRL1mcFSAilryHGEhen7Q <span class="number">1</span> <span class="number">0</span>    </span><br><span class="line">yellow open <span class="selector-class">.watcher-history-6-2018</span>.<span class="number">01.10</span> SBGiHDAnTPiXFoHU65VY_g <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow open <span class="selector-class">.watches</span>                      kMzN4j5cQySZQQSDVPww8w <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow open <span class="selector-class">.monitoring-alerts-6</span>          VygY6VN9R3S0PR_jrGy50Q <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$</span><br></pre></td></tr></table></figure><a id="more"></a></li>
</ul>
<h2 id="添加自定义角色"><a href="#添加自定义角色" class="headerlink" title="添加自定义角色"></a><a href="#添加自定义角色" title="添加自定义角色"></a>添加自定义角色</h2><ul>
<li>添加角色接口为 POST /_xpack/security/role/<rolename></rolename></li>
</ul>
<p>下述示例为添加超级管理员角色的方法<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl -XPOST -H <span class="symbol">‘Content</span>-<span class="keyword">type</span>: application/json’ -u elastic:elastic <span class="symbol">‘http</span>://<span class="number">10.59</span>.<span class="number">30.96</span>:<span class="number">9200</span>/_xpack/security/role/admin?pretty’ -d ‘&#123;</span><br><span class="line">&gt;   <span class="string">“run_as”</span>: [ <span class="string">“elastic”</span> ],</span><br><span class="line">&gt;   <span class="string">“cluster”</span>: [ <span class="string">“all”</span> ],</span><br><span class="line">&gt;   <span class="string">“indices”</span>: [</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       <span class="string">“names”</span>: [ <span class="string">“<em>“</em></span> ],</span><br><span class="line">&gt;       <span class="string">“privileges”</span>: [ <span class="string">“all”</span> ]</span><br><span class="line">&gt;     &#125;</span><br><span class="line">&gt;   ]</span><br><span class="line">&gt; &#125;’</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“role”</span> : &#123;</span><br><span class="line">    <span class="string">“created”</span> : <span class="type">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl -XGET -H <span class="symbol">‘Content</span>-<span class="keyword">type</span>: application/json’ -u elastic:elastic <span class="symbol">‘http</span>://<span class="number">10.59</span>.<span class="number">30.96</span>:<span class="number">9200</span>/_xpack/security/role/admin?pretty’</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“admin”</span> : &#123;</span><br><span class="line">    <span class="string">“cluster”</span> : [</span><br><span class="line">      <span class="string">“all”</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">“indices”</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">“names”</span> : [</span><br><span class="line">          <span class="string">““</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">“privileges”</span> : [</span><br><span class="line">          <span class="string">“all”</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">“run_as”</span> : [</span><br><span class="line">      <span class="string">“elastic”</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">“metadata”</span> : &#123; &#125;,</span><br><span class="line">    <span class="string">“transient_metadata”</span> : &#123;</span><br><span class="line">      <span class="string">“enabled”</span> : <span class="type">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$</span><br></pre></td></tr></table></figure></p>
<h2 id="添加自定义账户"><a href="#添加自定义账户" class="headerlink" title="添加自定义账户"></a><a href="#添加自定义账户" title="添加自定义账户"></a>添加自定义账户</h2><ul>
<li>添加用户接口为 POST /_xpack/security/user/<username></username></li>
</ul>
<p>下述为添加martin账户并添加至admin角色操作方法<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XPOST</span> -<span class="type">H</span> <span class="symbol">‘Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json’ -u elastic:elastic <span class="symbol">‘http</span>:<span class="comment">//10.59.30.96:9200/_xpack/security/user/martin?pretty’ -d ‘&#123;</span></span><br><span class="line">&gt;   <span class="string">“password”</span> : <span class="string">“123456”</span>,</span><br><span class="line">&gt;   <span class="string">“full_name”</span> : <span class="string">“Martin Lei”</span>,</span><br><span class="line">&gt;   <span class="string">“roles”</span> : [<span class="string">“admin”</span>],</span><br><span class="line">&gt;   <span class="string">“email”</span> : <span class="string">“<a href="mailto:martin@martin.com" target="_blank" rel="noopener">martin@martin.com</a>“</span></span><br><span class="line">&gt; &#125;’</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“user”</span> : &#123;</span><br><span class="line">    <span class="string">“created”</span> : <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XGET</span> -<span class="type">H</span> <span class="symbol">‘Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json’ -u elastic:elastic <span class="symbol">‘http</span>:<span class="comment">//10.59.30.96:9200/_xpack/security/user/martin?pretty’</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“rocshen”</span> : &#123;</span><br><span class="line">    <span class="string">“username”</span> : <span class="string">“martin”</span>,</span><br><span class="line">    <span class="string">“roles”</span> : [</span><br><span class="line">      <span class="string">“admin”</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">“full_name”</span> : <span class="string">“Martin Lei”</span>,</span><br><span class="line">    <span class="string">“email”</span> : <span class="string">“<a href="mailto:martin@martin.com" target="_blank" rel="noopener">martin@martin.com</a>“</span>,</span><br><span class="line">    <span class="string">“metadata”</span> : &#123; &#125;,</span><br><span class="line">    <span class="string">“enabled”</span> : <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XGET</span> -<span class="type">H</span> <span class="symbol">‘Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json’ -u martin:<span class="number">123456</span> <span class="symbol">‘http</span>:<span class="comment">//10.59.30.96:9200/_cat/indices?pretty’</span></span><br><span class="line">yellow open .monitoring-es<span class="number">-6</span><span class="number">-2018.01</span><span class="number">.10</span>   nND6-i_rR5iLEYVccBGj8w <span class="number">1</span> <span class="number">1</span> <span class="number">4883</span> <span class="number">88</span>   <span class="number">2.5</span>mb   <span class="number">2.5</span>mb</span><br><span class="line">yellow open .triggered_watches            <span class="type">BtygGZisSDqiL3Y2TaQGqQ</span> <span class="number">1</span> <span class="number">1</span>    <span class="number">0</span>  <span class="number">0</span>  <span class="number">24.2</span>kb  <span class="number">24.2</span>kb</span><br><span class="line">green  open .security<span class="number">-6</span>                   <span class="type">QVRL1mcFSAilryHGEhen7Q</span> <span class="number">1</span> <span class="number">0</span>                        </span><br><span class="line">yellow open .watcher-history<span class="number">-6</span><span class="number">-2018.01</span><span class="number">.10</span> <span class="type">SBGiHDAnTPiXFoHU65VY_g</span> <span class="number">1</span> <span class="number">1</span>  <span class="number">630</span>  <span class="number">0</span> <span class="number">703.3</span>kb <span class="number">703.3</span>kb</span><br><span class="line">yellow open .watches                      kMzN4j5cQySZQQSDVPww8w <span class="number">1</span> <span class="number">1</span>    <span class="number">5</span>  <span class="number">0</span>  <span class="number">33.3</span>kb  <span class="number">33.3</span>kb</span><br><span class="line">yellow open .monitoring-alerts<span class="number">-6</span>          <span class="type">VygY6VN9R3S0PR_jrGy50Q</span> <span class="number">1</span> <span class="number">1</span>    <span class="number">1</span>  <span class="number">0</span>   <span class="number">6.5</span>kb   <span class="number">6.5</span>kb</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$</span><br></pre></td></tr></table></figure></p>
<h2 id="修改账户密码"><a href="#修改账户密码" class="headerlink" title="修改账户密码"></a><a href="#修改账户密码" title="修改账户密码"></a>修改账户密码</h2><ol>
<li>修改密码需使用超级管理员权限即elastic账户，接口为POST _xpack/security/user/<username>/_password</username></li>
</ol>
<p>curl参数含义如下</p>
<ul>
<li>-XPOST 使用post方法传递参数</li>
<li>-H 指定http协议的header信息</li>
<li>-u 指定用于认证的用户信息用户名与密码使用冒号分隔</li>
<li>-d 指定具体要传递的参数信息<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XPOST</span> -<span class="type">H</span> <span class="symbol">‘Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json’ -u elastic:elastic <span class="symbol">‘http</span>:<span class="comment">//10.59.30.96:9200/_xpack/security/user/kibana/_password?pretty’ -d ‘&#123;”password”: “123456”&#125;’</span></span><br><span class="line">&#123; &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol>
<li>密码修改后使用老密码访问则返回401，使用更新后的密码则正常<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.0]$ curl ‘http:<span class="comment">//10.59.30.96:9200/_cat/indices?pretty’ -u kibana:kibana</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“error”</span> : &#123;</span><br><span class="line">    <span class="string">“root_cause”</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">“type”</span> : <span class="string">“security_exception”</span>,</span><br><span class="line">        <span class="string">“reason”</span> : <span class="string">“failed to authenticate user [kibana]”</span>,</span><br><span class="line">        <span class="string">“header”</span> : &#123;</span><br><span class="line">          <span class="string">“WWW-Authenticate”</span> : <span class="string">“Basic realm=\”</span>security\<span class="string">“ charset=\”</span>UTF-<span class="number">8</span>\<span class="string">“”</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">“type”</span> : <span class="string">“security_exception”</span>,</span><br><span class="line">    <span class="string">“reason”</span> : <span class="string">“failed to authenticate user [kibana]”</span>,</span><br><span class="line">    <span class="string">“header”</span> : &#123;</span><br><span class="line">      <span class="string">“WWW-Authenticate”</span> : <span class="string">“Basic realm=\”</span>security\<span class="string">“ charset=\”</span>UTF-<span class="number">8</span>\<span class="string">“”</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“status”</span> : <span class="number">401</span></span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.0]$ curl ‘http:<span class="comment">//10.59.30.96:9200/_cat/indices?pretty’ -u kibana:123456</span></span><br><span class="line">yellow <span class="keyword">open</span> .monitoring-es-<span class="number">6</span>-<span class="number">2018.01</span>.10   nND6-i_rR5iLEYVccBGj8w <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow <span class="keyword">open</span> .triggered_watches            BtygGZisSDqiL3Y2TaQGqQ <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">green  <span class="keyword">open</span> .security-<span class="number">6</span>                   QVRL1mcFSAilryHGEhen7Q <span class="number">1</span> <span class="number">0</span>    </span><br><span class="line">yellow <span class="keyword">open</span> .watcher-history-<span class="number">6</span>-<span class="number">2018.01</span>.10 SBGiHDAnTPiXFoHU65VY_g <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow <span class="keyword">open</span> .watches                      kMzN4j5cQySZQQSDVPww8w <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">yellow <span class="keyword">open</span> .monitoring-alerts-<span class="number">6</span>          VygY6VN9R3S0PR_jrGy50Q <span class="number">1</span> <span class="number">1</span>    </span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.0]$</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="配置ldap帐号认证"><a href="#配置ldap帐号认证" class="headerlink" title="配置ldap帐号认证"></a><a href="#配置ldap帐号认证" title="配置ldap帐号认证"></a>配置ldap帐号认证</h2><p>ldap服务安装可参考：<a href="https://segmentfault.com/a/11.." target="_blank" rel="noopener">https://segmentfault.com/a/11..</a>.</p>
<p>添加下述ldap相关述配置 bind_dn为ldap的管理DN</p>
<ul>
<li>bind_password为管理dn的密码</li>
<li>user_search.base_dn为linux系统账户信息导入ldap的信息</li>
<li>user_search.attribute为账户在ldap中的标识信息</li>
<li>group_search.base_dn为linux系统组信息导入ldap的信息<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ vim config/elasticsearch<span class="selector-class">.yml</span> </span><br><span class="line"></span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">network<span class="selector-class">.host</span>: <span class="number">10.59</span>.<span class="number">30.96</span></span><br><span class="line">bootstrap<span class="selector-class">.system_call_filter</span>: false</span><br><span class="line"></span><br><span class="line">xpack<span class="selector-class">.ssl</span><span class="selector-class">.key</span>: elasticsearch/elasticsearch.key</span><br><span class="line">xpack<span class="selector-class">.ssl</span><span class="selector-class">.certificate</span>: elasticsearch/elasticsearch.crt</span><br><span class="line">xpack<span class="selector-class">.ssl</span><span class="selector-class">.certificate_authorities</span>: ca/ca.crt</span><br><span class="line">xpack<span class="selector-class">.security</span><span class="selector-class">.transport</span><span class="selector-class">.ssl</span><span class="selector-class">.enabled</span>: true</span><br><span class="line"></span><br><span class="line">xpack:</span><br><span class="line">  security:</span><br><span class="line">    authc:</span><br><span class="line">      realms:</span><br><span class="line">        ldap1:</span><br><span class="line">          type: ldap</span><br><span class="line">          <span class="attribute">order</span>: <span class="number">0</span></span><br><span class="line">          url: <span class="string">“ldap://10.59.30.95”</span></span><br><span class="line">          bind_dn: <span class="string">“cn=Manager, dc=martin, dc=com”</span></span><br><span class="line">          bind_password: <span class="number">123456</span></span><br><span class="line">          user_search:</span><br><span class="line">            base_dn: <span class="string">“ou=People,dc=martin,dc=com”</span></span><br><span class="line">            attribute: uid</span><br><span class="line">          group_search:</span><br><span class="line">            base_dn: <span class="string">“ou=Group,dc=martin,dc=com”</span></span><br><span class="line">          unmapped_groups_as_roles: false</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="配置AD域帐号认证"><a href="#配置AD域帐号认证" class="headerlink" title="配置AD域帐号认证"></a><a href="#配置AD域帐号认证" title="配置AD域帐号认证"></a>配置AD域帐号认证</h2><p>添加下ldap相关述配置至elasticsearch.yml，此处为接着上述LDAP配置添加，如果只需配置AD认证请将ldap相关配置删除即可；</p>
<ul>
<li>domain_name为AD域的域名</li>
<li>url为AD域的地址</li>
<li>bind_dnw为随意的域账户名称（格式为user@domain）</li>
<li>bind_password为上述账户的密码<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">xpack</span>:</span><br><span class="line">  <span class="attribute">security</span>:</span><br><span class="line">    <span class="attribute">authc</span>:</span><br><span class="line">      <span class="attribute">realms</span>:</span><br><span class="line">        <span class="attribute">ldap1</span>:</span><br><span class="line">          <span class="attribute">type</span>: ldap</span><br><span class="line">          <span class="attribute">order</span>: <span class="number">0</span></span><br><span class="line">          <span class="attribute">url</span>: <span class="string">“ldap://10.59.30.94”</span></span><br><span class="line">          <span class="attribute">bind_dn</span>: <span class="string">“cn=Manager, dc=martin, dc=com”</span></span><br><span class="line">          <span class="attribute">bind_password</span>: <span class="number">123456</span></span><br><span class="line">          <span class="attribute">user_search</span>:</span><br><span class="line">            <span class="attribute">base_dn</span>: <span class="string">“ou=People,dc=martin,dc=com”</span></span><br><span class="line">            <span class="attribute">attribute</span>: uid</span><br><span class="line">          <span class="attribute">group_search</span>:</span><br><span class="line">            <span class="attribute">base_dn</span>: <span class="string">“ou=Group,dc=martin,dc=com”</span></span><br><span class="line">          <span class="attribute">unmapped_groups_as_roles</span>: false</span><br><span class="line">        <span class="attribute">active_directory</span>:</span><br><span class="line">          <span class="attribute">type</span>: active_directory</span><br><span class="line">          <span class="attribute">order</span>: <span class="number">1</span></span><br><span class="line">          <span class="attribute">domain_name</span>: martin.com</span><br><span class="line">          <span class="attribute">url</span>: <span class="attribute">ldap</span>:<span class="comment">//ad.martin.com</span></span><br><span class="line">          <span class="attribute">bind_dn</span>: martin<span class="variable">@martin</span>.com</span><br><span class="line">          <span class="attribute">bind_password</span>: AD.<span class="number">123456</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>重启elasticsearch服务并使用ldap域账户user01登录</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ killall java</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ .<span class="regexp">/bin/</span>elasticsearch -d</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -XGET -u <span class="string">user01:</span>user01 <span class="string">‘<a href="http://10.59.30.96:9200/_cat?pretty&#39;" target="_blank" rel="noopener">http://10.59.30.96:9200/_cat?pretty&#39;</a></span></span><br><span class="line">=^.^=</span><br><span class="line"><span class="regexp">/_cat/</span>allocation</span><br><span class="line"><span class="regexp">/_cat/</span>shards</span><br><span class="line"><span class="regexp">/_cat/</span>shards/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>master</span><br><span class="line"><span class="regexp">/_cat/</span>nodes</span><br><span class="line"><span class="regexp">/_cat/</span>tasks</span><br><span class="line"><span class="regexp">/_cat/</span>indices</span><br><span class="line"><span class="regexp">/_cat/</span>indices/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>segments</span><br><span class="line"><span class="regexp">/_cat/</span>segments/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>count</span><br><span class="line"><span class="regexp">/_cat/</span>count/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>recovery</span><br><span class="line"><span class="regexp">/_cat/</span>recovery/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>health</span><br><span class="line"><span class="regexp">/_cat/</span>pending_tasks</span><br><span class="line"><span class="regexp">/_cat/</span>aliases</span><br><span class="line"><span class="regexp">/_cat/</span>aliases/&#123;alias&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>thread_pool</span><br><span class="line"><span class="regexp">/_cat/</span>thread_pool/&#123;thread_pools&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>plugins</span><br><span class="line"><span class="regexp">/_cat/</span>fielddata</span><br><span class="line"><span class="regexp">/_cat/</span>fielddata/&#123;fields&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>nodeattrs</span><br><span class="line"><span class="regexp">/_cat/</span>repositories</span><br><span class="line"><span class="regexp">/_cat/</span>snapshots/&#123;repository&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>templates</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$</span><br></pre></td></tr></table></figure>

<p>使用AD域账户martin登录</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl <span class="string">http:</span><span class="comment">//10.59.30.96:9200/_cat?pretty -u martin:AD.123456</span></span><br><span class="line">=^.^=</span><br><span class="line"><span class="regexp">/_cat/</span>allocation</span><br><span class="line"><span class="regexp">/_cat/</span>shards</span><br><span class="line"><span class="regexp">/_cat/</span>shards/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>master</span><br><span class="line"><span class="regexp">/_cat/</span>nodes</span><br><span class="line"><span class="regexp">/_cat/</span>tasks</span><br><span class="line"><span class="regexp">/_cat/</span>indices</span><br><span class="line"><span class="regexp">/_cat/</span>indices/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>segments</span><br><span class="line"><span class="regexp">/_cat/</span>segments/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>count</span><br><span class="line"><span class="regexp">/_cat/</span>count/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>recovery</span><br><span class="line"><span class="regexp">/_cat/</span>recovery/&#123;index&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>health</span><br><span class="line"><span class="regexp">/_cat/</span>pending_tasks</span><br><span class="line"><span class="regexp">/_cat/</span>aliases</span><br><span class="line"><span class="regexp">/_cat/</span>aliases/&#123;alias&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>thread_pool</span><br><span class="line"><span class="regexp">/_cat/</span>thread_pool/&#123;thread_pools&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>plugins</span><br><span class="line"><span class="regexp">/_cat/</span>fielddata</span><br><span class="line"><span class="regexp">/_cat/</span>fielddata/&#123;fields&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>nodeattrs</span><br><span class="line"><span class="regexp">/_cat/</span>repositories</span><br><span class="line"><span class="regexp">/_cat/</span>snapshots/&#123;repository&#125;</span><br><span class="line"><span class="regexp">/_cat/</span>templates</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$</span><br></pre></td></tr></table></figure>

<h2 id="为域账户信息映射角色"><a href="#为域账户信息映射角色" class="headerlink" title="为域账户信息映射角色"></a><a href="#为域账户信息映射角色" title="为域账户信息映射角色"></a>为域账户信息映射角色</h2><p>接口为：POST /_xpack/security/role_mapping/<name></name></p>
<p>下述为映射user1*账户为管理员角色的操作步骤</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XPOST</span> -<span class="type">H</span> <span class="symbol">‘Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json’ -u elastic:elastic <span class="symbol">‘http</span>:<span class="comment">//10.59.30.96:9200/_xpack/security/role_mapping/ldap_user_admin?pretty’ -d ‘&#123;</span></span><br><span class="line">&gt;   <span class="string">“roles”</span>: [ <span class="string">“admin”</span> ],</span><br><span class="line">&gt;   <span class="string">“enabled”</span>: <span class="literal">true</span>,</span><br><span class="line">&gt;   <span class="string">“rules”</span>: &#123;</span><br><span class="line">&gt;     <span class="string">“any”</span>: [</span><br><span class="line">&gt;       &#123;</span><br><span class="line">&gt;         <span class="string">“field”</span>: &#123;</span><br><span class="line">&gt;           <span class="string">“username”</span>: <span class="string">“/user1<em>/“</em></span></span><br><span class="line">&gt;         &#125;</span><br><span class="line">&gt;       &#125;</span><br><span class="line">&gt;     ]</span><br><span class="line">&gt;   &#125;</span><br><span class="line">&gt; &#125;’</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“role_mapping”</span> : &#123;</span><br><span class="line">    <span class="string">“created”</span> : <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$ curl -<span class="type">XGET</span> -<span class="type">H</span> <span class="symbol">‘Content</span>-<span class="class"><span class="keyword">type</span></span>: application/json’ -u elastic:elastic <span class="symbol">‘http</span>:<span class="comment">//10.59.30.96:9200/_xpack/security/role_mapping/ldap_user_admin?pretty’</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“ldap_user_admin”</span> : &#123;</span><br><span class="line">    <span class="string">“enabled”</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="string">“roles”</span> : [</span><br><span class="line">      <span class="string">“admin”</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">“rules”</span> : &#123;</span><br><span class="line">      <span class="string">“any”</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">“field”</span> : &#123;</span><br><span class="line">            <span class="string">“username”</span> : <span class="string">“/user1/“</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">“metadata”</span> : &#123; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch<span class="meta">@elasticsearch</span> elasticsearch<span class="number">-6.0</span><span class="number">.0</span>]$</span><br></pre></td></tr></table></figure>

<p>验证域账户权限，使用user01无权访问indices接口，使用user11可以访问；</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl -XGET -u user01:user01 <span class="string">‘<a href="http://10.59.30.96:9200/_cat/indices?pretty&#39;" target="_blank" rel="noopener">http://10.59.30.96:9200/_cat/indices?pretty&#39;</a></span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“error”</span> : &#123;</span><br><span class="line">    <span class="string">“root_cause”</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">“type”</span> : <span class="string">“security_exception”</span>,</span><br><span class="line">        <span class="string">“reason”</span> : <span class="string">“action [cluster:monitor/state] is unauthorized for user [user01]”</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">“type”</span> : <span class="string">“security_exception”</span>,</span><br><span class="line">    <span class="string">“reason”</span> : <span class="string">“action [cluster:monitor/state] is unauthorized for user [user01]”</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“status”</span> : <span class="number">403</span></span><br><span class="line">&#125;</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$ curl -XGET -u user11:user11 <span class="string">‘<a href="http://10.59.30.96:9200/_cat/indices?pretty&#39;" target="_blank" rel="noopener">http://10.59.30.96:9200/_cat/indices?pretty&#39;</a></span></span><br><span class="line">yellow open <span class="selector-class">.monitoring-es-6-2018</span>.<span class="number">01.10</span>   nND6-i_rR5iLEYVccBGj8w <span class="number">1</span> <span class="number">1</span> <span class="number">6178</span> <span class="number">44</span>  <span class="number">5.9</span>mb  <span class="number">5.9</span>mb</span><br><span class="line">yellow open <span class="selector-class">.triggered_watches</span>            BtygGZisSDqiL3Y2TaQGqQ <span class="number">1</span> <span class="number">1</span>    <span class="number">0</span>  <span class="number">0</span> <span class="number">11.7</span>kb <span class="number">11.7</span>kb</span><br><span class="line">green  open <span class="selector-class">.security-6</span>                   QVRL1mcFSAilryHGEhen7Q <span class="number">1</span> <span class="number">0</span>                      </span><br><span class="line">yellow open <span class="selector-class">.watcher-history-6-2018</span>.<span class="number">01.10</span> SBGiHDAnTPiXFoHU65VY_g <span class="number">1</span> <span class="number">1</span>  <span class="number">777</span>  <span class="number">0</span>  <span class="number">1.1</span>mb  <span class="number">1.1</span>mb</span><br><span class="line">yellow open <span class="selector-class">.watches</span>                      kMzN4j5cQySZQQSDVPww8w <span class="number">1</span> <span class="number">1</span>    <span class="number">5</span>  <span class="number">0</span> <span class="number">40.2</span>kb <span class="number">40.2</span>kb</span><br><span class="line">yellow open <span class="selector-class">.monitoring-alerts-6</span>          VygY6VN9R3S0PR_jrGy50Q <span class="number">1</span> <span class="number">1</span>    <span class="number">1</span>  <span class="number">0</span> <span class="number">12.8</span>kb <span class="number">12.8</span>kb</span><br><span class="line">[elasticsearch@elasticsearch elasticsearch-<span class="number">6.0</span>.<span class="number">0</span>]$</span><br></pre></td></tr></table></figure>

<h2 id="常见报错"><a href="#常见报错" class="headerlink" title="常见报错"></a><a href="#常见报错" title="常见报错"></a>常见报错</h2><p>No subject alternative names matching IP address</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[2018-01-10T19:19:35,483][WARN ][o.e.x.s.t.n.SecurityNetty4Transport] [fzP4t-4] exception caught on transport layer [[id: 0x5d97fe48, L:/0:0:0:0:0:0:0:1:49121 ! R:/0:0:0:0:0:0:0:1:9300]], closing connection</span><br><span class="line">    io.netty.handler.codec.DecoderException: javax.net.ssl.SSLHandshakeException: General SSLEngine problem</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line">Caused by: java.security.cert.CertificateException: <span class="literal">No</span> subject alternative names matching<span class="built_in"> IP address </span>0:0:0:0:0:0:0:1 found</span><br></pre></td></tr></table></figure>

<p>解决方案为一种是关闭IPv6地址，另一种是修改ES_HOME/config/elasticsearch.yml中的network.host值为本机eth0的IP</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a><a href="#参考文档" title="参考文档"></a>参考文档</h2><ul>
<li>官方安装步骤：<a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
<li>配置内置账户密码：<br><a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
<li>修改账户密码：<br><a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
<li>用户相关操作：<br><a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
<li>使用LDAP认证： <a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
<li>用户角色映射： <a href="https://www.elastic.co/guide/.." target="_blank" rel="noopener">https://www.elastic.co/guide/..</a>.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/08/19/crontab、anacron、logrotate-relationship/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/19/crontab、anacron、logrotate-relationship/" itemprop="url">crontab、anacron、logrotate relationship</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T09:55:15+08:00">
                2018-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>服务器上的nginx使用logrotate来分割日志，设置为每天分割。但是logrotate似乎没有工作，日志并没有分割。服务器是CentOS 6。</p>
<p>为了找到原因，分析可能出错的地方。<br>如果是logrotate未执行，可能是crond没有启动，因为logrotate被/etc/cron.daily/logrotate脚本所启动，可以查看其中代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> ~]<span class="comment"># cat /etc/cron.daily/logrotate</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/logrotate /etc/logrotate.conf</span><br><span class="line">EXITVALUE=$?</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$EXITVALUE</span> != 0 ]; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/logger -t logrotate <span class="string">“ALERT exited abnormally with [<span class="variable">$EXITVALUE</span>]”</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<p>可以看到logrotate运行时加载配置文件logrotate.conf，而这个配置文件除了设定一些分割日志相关的选项，还包含分割日志的配置文件目录/etc/logrotate.d。</p>
<p>nginx的日志分割配置文件就保存在logrotate.d目录：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]<span class="meta"># cat !$</span></span><br><span class="line">cat <span class="meta-keyword">/etc/</span>logrotate.d/nginx</span><br><span class="line"><span class="meta-keyword">/root/</span>*.<span class="class">log </span>&#123;</span><br><span class="line">    Daily</span><br><span class="line">    Missingok</span><br><span class="line">    rotate <span class="number">52</span></span><br><span class="line">    compress</span><br><span class="line">    delaycompress</span><br><span class="line">    notifempty</span><br><span class="line">    dateext</span><br><span class="line">    create <span class="number">644</span> nobody nobody</span><br><span class="line">    sharedscripts</span><br><span class="line">    postrotate</span><br><span class="line">    [ -f <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/nginx/</span>logs/nginx.pid ] &amp;&amp; kill -USR1 <code>cat &lt;span class=&quot;meta-keyword&quot;&gt;/usr/&lt;/span&gt;local&lt;span class=&quot;meta-keyword&quot;&gt;/nginx/&lt;/span&gt;logs/nginx.pid</code></span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>/root/<em>.log就是需要被分割的日志的目录，通配符</em>表示目录内的所有log文件都被分割，分割的规则就是{…}中的内容。这里把/root/*.log当做nginx日志只是为了测试。<br>在启动crond服务后，发现日志还是没有分割，于是想到会不会是/etc/logrotate.d/nginx配置文件的语法有问题，使用以下命令调试这个文件：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrotate -vfd <span class="meta-keyword">/etc/</span>logrotate.d/nginx  <span class="meta"># -vfd 三个选项分别表示显示详情，强制分割日志，只是调试配置文件而不是真的分割日志</span></span><br></pre></td></tr></table></figure>

<p>输出结果表明有语法错误，Daily，Missingok 都应该是小写。改成daily，missingok。再次调试配置文件，可以正确分割日志：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# ls <span class="number">-1</span> /root/</span><br><span class="line">install<span class="number">-2017</span><span class="number">-5</span><span class="number">-14.</span>log</span><br><span class="line">install<span class="number">-2017</span><span class="number">-5</span><span class="number">-14.</span>log<span class="number">-20170521</span>  #logrotate归档的日志</span><br></pre></td></tr></table></figure>

<p>上面猜测是crond执行/etc/cron.daily/内的脚本，实现定时执行计划任务，包括执行logrotate日志分割。<br>为了验证是否正确，网上搜索一番后找到了答案。如果没有crontab命令，先安装：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install crontabs  <span class="comment">#安装crond，crond实际上来自cronie包，这个包作为crontabs包的依赖被安装</span></span><br><span class="line">chkconfig –<span class="keyword">add</span><span class="bash"> crond <span class="comment">#添加到开机启动列表</span></span></span><br><span class="line"><span class="bash">chkconfig crond on    <span class="comment">#开机启动crond服务</span></span></span><br><span class="line"><span class="bash">/etc/init.d/crond     <span class="comment">#立即启动crond</span></span></span><br></pre></td></tr></table></figure><a id="more"></a><br><br>以下文件或目录的作用：<br>cron计划任务有两种类型：<br><br><em>   1）系统cron任务：由crond服务执行，/etc/crontab配置系统级别的任务
</em>   2）用户cron任务：由crond服务执行，用crontab命令编辑用户级别的任务<font color="#DC143C" size="3">属于系统cron任务的文件或目录：</font><br><br><em>   /etc/cron.d             #系统的任务脚本。执行 rpm -ql cronie 可以看到该目录被cronie包安装
</em>   /etc/cron.hourly     #每小时执行其内脚本。其中的0anacron文件调用anacron来执行任务，它被包cronie-anacron安装<br><em>   /etc/cron.daily        #每天执行其内脚本。也被anacron执行其内脚本，logrotate调用脚本就在该目录内
</em>   /etc/cron.weekly     #每周执行其内脚本。<br><em>   /etc/cron.monthly   #每月执行其内脚本。<br><br><font color="#DC143C" size="3">控制用户cron任务的执行：</font>

</em>   /etc/cron.allow   #默认不存在，如果这个文件存在，只有用户在这个文件中才能使用crontab命令<br><em>   /etc/cron.deny    #将不可以使用crontab命令的用户写入其中<br><br>注意：cron.allow和cron.deny就是用户名的列表，每行一个用户名。比如 cron.deny中有一行jason，效果是如果当前登录用户是jason，执行 crontab -e会提示不允许使用crontab命令。<br><br>以下三个目录的作用：<br><br>/var/spool/cron/USER_NAME<br><br>#这个文件才是跟crontab -e/-l 关联的，这个文件保存了crontab -e编辑的任务内容<br><br>#比如执行 crontab -u root -e，编辑保存后，就会有/var/spool/cron/root 这个文件<br><br>/var/spool/anacron/{cron.daily,cron.monthly,cron.weekly}<br><br>#这三个文件记录了anacron上一次执行的时间（上一天，上一周或上一月）<br><br>#anacron任务执行时，对照这里的时间，决定是否执行anacron任务<br><br>/var/lib/logrotate.status<br><br>#这个文件记录logrotate执行情况，logrotate参考这个文件来决定是否需要rotate日志<br><br>crontab和anacron和logrotate的关系：<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]<span class="comment"># cat /etc/cron.d/0hourly     #这个文件指定每小时的01分执行/etc/cron.hourly内的所有脚本</span></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line">HOME=/</span><br><span class="line">01 </span></pre></td></tr></table></figure></em> <em> </em> * root run-parts /etc/cron.hourly  <span class="comment">#这里的root指定执行任务的用户，run-parts其实是一个可执行脚本，在/usr/bin/run-parts，用来执行cron.hourly目录内的所有脚本</span><br>

<p>说明：用crontab -e命令每次编辑完某个用户的cron设置后，cron自动在/var/spool/cron下生成一个与此用户同名的文件，此用户的cron信息都记录在这个文件中。cron启动后每过一份钟读一次这个文件，检查是否要执行里面的命令。因此此文件修改后不需要重新启动cron服务。cron服务每分钟不仅要读一次/var/spool/cron内的所有文件，还需要读一次/etc/crontab，因此我们配置这个文件也能运用cron服务做一些事情。用crontab命令配置是针对某个用户的，而编辑/etc/crontab是针对系统的任务。此文件的文件格式是：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SHELL=<span class="regexp">/bin/bash</span></span><br><span class="line">PATH=<span class="regexp">/sbin:/bin</span><span class="symbol">:/usr/sbin</span><span class="symbol">:/usr/bin</span>     <span class="comment">#可执行文件查找路径</span></span><br><span class="line">MAILTO=root      <span class="comment">#如果出现错误，或者有数据输出，数据作为邮件发给这个帐号</span></span><br><span class="line">HOME=<span class="regexp">/           #使用者运行的路径，这里是根目录</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> ~]<span class="comment"># cat /etc/cron.hourly/0anacron   #cron.hourly目录下的脚本，根据条件执行anacron命令</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Skip excecution unless the date has changed from the previous run</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -r /var/spool/anacron/cron.daily; <span class="keyword">then</span></span><br><span class="line">    day=<code>cat /var/spool/anacron/cron.daily</code></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> [ <code>date +%Y%m%d</code> = <span class="string">“<span class="variable">$day</span>“</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Skip excecution unless AC powered</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> -x /usr/bin/on_ac_power; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/on_ac_power &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> $? -eq 1; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">/usr/sbin/anacron -s</span><br></pre></td></tr></table></figure><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@test</span> ~]<span class="comment"># cat /etc/anacrontab   #如果执行anacron命令，那么接着查看anacron的配置文件</span></span><br><span class="line"><span class="comment"># /etc/anacrontab: configuration file for anacron</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See anacron(8) and anacrontab(5) for details.</span></span><br><span class="line"></span><br><span class="line">SHELL=<span class="regexp">/bin/sh</span></span><br><span class="line">PATH=<span class="regexp">/sbin:/bin</span><span class="symbol">:/usr/sbin</span><span class="symbol">:/usr/bin</span></span><br><span class="line">MAILTO=root</span><br><span class="line"><span class="comment"># the maximal random delay added to the base delay of the jobs</span></span><br><span class="line">RANDOM_DELAY=<span class="number">45</span>     <span class="comment">#最大延迟时间</span></span><br><span class="line"><span class="comment"># the jobs will be started during the following hours only</span></span><br><span class="line">START_HOURS_RANGE=<span class="number">3</span>-<span class="number">22</span>     <span class="comment">#只有在3-22点之间执行任务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#period in days   delay in minutes   job-identifier   command</span></span><br><span class="line"><span class="number">1</span>    <span class="number">5</span>    cron.daily        nice run-parts /etc/cron.daily</span><br><span class="line"><span class="number">7</span>    <span class="number">25</span>    cron.weekly        nice run-parts /etc/cron.weekly</span><br><span class="line"><span class="variable">@monthly</span> <span class="number">45</span>    cron.monthly        nice run-parts /etc/cron.monthly</span><br></pre></td></tr></table></figure>

<p>以上anacrontab配置文件最重要的是最后一部分，以这行为例：</p>
<p>1    5    cron.daily        nice run-parts /etc/cron.daily</p>
<p>表示每天都执行/etc/cront.daily/目录下的脚本文件，真实的延迟是RANDOM_DELAY+delay。这里的延迟是5分钟，加上上面的RANDOM_DELAY，所以实际的延迟时间是5-50之间，开始时间为03-22点，如果机器没关，那么一般就是在03:05-03:50之间执行。<font color="#DC143C" size="3">nice命令将该进程设置为nice=10，默认为0，即低优先级进程。</font>如果RANDOM_DELAY=0，那么表示准确延迟5min，即03:05执行cron.daily内的脚本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="built_in">test</span> ~]<span class="comment"># cat /etc/cron.daily/logrotate  #最后在cron.daily内有logrotate的调用脚本</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/usr/sbin/logrotate /etc/logrotate.conf       <span class="comment">#logrotate将会读取配置文件，最终会读取到/etc/logrotate.d/nginx</span></span><br><span class="line">EXITVALUE=$?</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$EXITVALUE</span> != 0 ]; <span class="keyword">then</span></span><br><span class="line">    /usr/bin/logger -t logrotate <span class="string">“ALERT exited abnormally with [<span class="variable">$EXITVALUE</span>]”</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure>

<p>当logrotate命令加载了/etc/logrotate.d/nginx配置文件时，还要比较nginx日志的归档日期：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@test ~]# cat /var/lib/logrotate.status | grep /root</span><br><span class="line"><span class="string">“/root/install-2017-5-14.log”</span> <span class="number">2017</span><span class="number">-5</span><span class="number">-21</span>   #如果今天是<span class="number">2017</span><span class="number">-5</span><span class="number">-21</span>，这个文件里也是<span class="number">2017</span><span class="number">-5</span><span class="number">-21</span>，说明今天已经归档过了，否则就会归档（分割）nginx日志</span><br></pre></td></tr></table></figure>

<p>综上，整个逻辑流程为：</p>
<p>crond服务加载/etc/cron.d/0hourly —&gt;在每小时的01分执行/etc/cront.hourly/0anacron —&gt;执行anacron —&gt;根据/etc/anacrontab的配置执行/etc/cron.daily，/etc/cron.weekly，/etc/cron.monthly —&gt;执行/etc/cron.daily/下的logrotate脚本 —&gt;执行logrotate —&gt;根据/etc/logrotate.conf配置执行脚本/etc/logrotate.d/nginx —&gt;分割nginx日志成功</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/08/19/基于k8s-动态配置及扩容maven-nexus私服/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/19/基于k8s-动态配置及扩容maven-nexus私服/" itemprop="url">基于k8s 动态配置及扩容maven nexus私服</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T09:53:31+08:00">
                2018-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="配置nexus"><a href="#配置nexus" class="headerlink" title="配置nexus"></a><a href="#配置nexus" title="配置nexus"></a>配置nexus</h3><p>从官网下载了nexus之后还需要进行一些配置。<br>编辑bin/nexus.vmoptions 调整后的如下：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">Xms600M</span></span><br><span class="line"><span class="ruby">-Xmx600M</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>MaxDirectMemorySize=<span class="number">1</span>G</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>+UnlockDiagnosticVMOptions</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>+UnsyncloadClass</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>+LogVMOutput</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>LogFile=<span class="regexp">/data/docker</span><span class="regexp">/soft/nexus</span><span class="regexp">/log/jvm</span>.log</span></span><br><span class="line"><span class="ruby">-<span class="symbol">XX:</span>-OmitStackTraceInFastThrow</span></span><br><span class="line"><span class="ruby">-Djava.net.preferIPv4Stack=<span class="literal">true</span></span></span><br><span class="line"><span class="ruby">-Dkaraf.home=.</span></span><br><span class="line"><span class="ruby">-Dkaraf.base=.</span></span><br><span class="line"><span class="ruby">-Dkaraf.etc=etc/karaf</span></span><br><span class="line"><span class="ruby">-Djava.util.logging.config.file=etc/karaf/java.util.logging.properties</span></span><br><span class="line"><span class="ruby">-Dkaraf.data=<span class="regexp">/data/docker</span><span class="regexp">/soft/nexus</span><span class="regexp">/data</span></span></span><br><span class="line"><span class="ruby">-Djava.io.tmpdir=<span class="regexp">/data/docker</span><span class="regexp">/soft/nexus</span><span class="regexp">/tmp</span></span></span><br><span class="line"><span class="ruby">-Dkaraf.startLocalConsole=<span class="literal">false</span></span></span><br></pre></td></tr></table></figure>

<p>其中除了1，2行的jvm内存配置之外，最关键的就是，以下几个属性配置：</p>
<ul>
<li>-XX:LogFile=/data/docker/soft/nexus/log/jvm.log       # 日志文件生成位置</li>
<li>-Dkaraf.data=/data/docker/soft/nexus/data             # 仓库数据存放位置(上传的jar包)</li>
<li>-Djava.io.tmpdir=/data/docker/soft/nexus/tmp          # 临时文件存放位置</li>
</ul>
<h3 id="制作Docker镜像"><a href="#制作Docker镜像" class="headerlink" title="制作Docker镜像"></a><a href="#制作Docker镜像" title="制作Docker镜像"></a>制作Docker镜像</h3><p>配置好nexus之后，需要再制作自己的docker镜像，因为k8s就是调度镜像容器的。 </p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master nexus]<span class="comment"># pwd</span></span><br><span class="line">/data/docker/dockerfile/nexus</span><br><span class="line">[root@master nexus]<span class="comment"># ls -lth </span></span><br><span class="line">total 223M</span><br><span class="line">-rw-r–r–<span class="number"> 1 </span>root root <span class="number"> 146 </span>Jun<span class="number"> 21 </span>16:06 Dockerfile</span><br><span class="line">-rw-r–r–<span class="number"> 1 </span>root root 108M Jun<span class="number"> 21 </span>16:02 nexus3.tar.gz</span><br><span class="line">drwxr-xr-x<span class="number"> 3 </span>root root 4.0K Jun<span class="number"> 21 </span>15:53 sonatype-work</span><br><span class="line">drwxr-xr-x<span class="number"> 9 </span>root root 4.0K Jun<span class="number"> 21 </span>15:53 nexus-3.12.1-01</span><br><span class="line">-rw-r–r–<span class="number"> 1 </span>root root 115M Jun<span class="number"> 21 </span>15:36 nexus-3.12.1-01-unix.tar.gz.org</span><br></pre></td></tr></table></figure>

<p>docker镜像的制作很简单，新建一个Dockerfile文件：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master nexus]<span class="comment"># cat Dockerfile </span></span><br><span class="line"><span class="keyword">FROM</span> registry.cn-hangzhou.aliyuncs.com/luhaoyuan/oracle-jdk8:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> nexus3.tar.gz /opt</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">“/opt/nexus-3.12.1-01/bin/nexus”</span>, <span class="string">“run”</span>]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>第一行：nexus的运行是依赖JDK环境的，所以我们这里就使用jdk作为基础镜像；(镜像是基于centos7，比较大，后续可以考虑修改为alpine_3.6)</li>
<li>第二行：将我们配置过后的nexus(nexus-3.12.1-01)再重新打包一下，添加到容器中；*   第三行：启动容器时，执行的命令，nexus的启动命令有start和run，由于start默认是启动在后台进程的，这样容器一启动就退出了。所以这里必须要使用run命令启动了。</li>
</ul>
<p>最后构建Docker镜像：<br>docker build -t registry.martin.com:5000/tools/nexus:3.12.1 .<br>registry.martin.com:5000为我registry地址,构建之后将改image push到私库,当然也可以用harbor<br>如果有做ca校验，需要将证书拷贝到指定的:/etc/docker/certs.d/xxx/ca.crt,然后docker login校验<br>再docker push registry.martin.com:5000/tools/nexus:3.12.1，不然会提示x509认证失败<br><a id="more"></a></p>
<h3 id="配置k8s-PV-PVC"><a href="#配置k8s-PV-PVC" class="headerlink" title="配置k8s PV-PVC"></a><a href="#配置k8s-PV-PVC" title="配置k8s PV-PVC"></a>配置k8s PV-PVC</h3><p>为了避免容器重启数据丢失，需要挂载主机的卷空间。<br>在k8s中，pod挂载主机的存储卷，就需要使用到了PV（PersistentVolume）和PVC（PersistentVolumeClaim）。<br>新建nexus3-pv-pvc.yaml文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">nexus]#</span> <span class="string">pwd</span></span><br><span class="line"><span class="string">/data/k8s/nexus</span></span><br><span class="line"><span class="string">[root@master</span>  <span class="string">nexus]#</span> <span class="string">ls</span> <span class="bullet">-lth</span></span><br><span class="line"><span class="string">total</span> <span class="number">12</span><span class="string">K</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r–r–</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">777</span> <span class="string">Jun</span> <span class="number">21</span> <span class="number">18</span><span class="string">:49</span> <span class="string">nexus3-deployment.yaml</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r–r–</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">370</span> <span class="string">Jun</span> <span class="number">21</span> <span class="number">17</span><span class="string">:12</span> <span class="string">nexus3-service.yaml</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r–r–</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">525</span> <span class="string">Jun</span> <span class="number">21</span> <span class="number">16</span><span class="string">:49</span> <span class="string">nexus3-pv-pvc.yaml</span></span><br><span class="line"><span class="string">[root@master</span>  <span class="string">nexus]#</span> <span class="string">cat</span> <span class="string">nexus3-pv-pvc.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nexus3-data-pv</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nexus3-data-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">500</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line"><span class="attr">  hostPath:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/data/docker/soft/nexus</span></span><br><span class="line"></span><br><span class="line"><span class="meta">—</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nexus3-data-pvc</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nexus3-data-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">500</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      app:</span> <span class="string">nexus3-data-pv</span></span><br><span class="line"><span class="string">[root@master</span>  <span class="string">nexus]#</span></span><br></pre></td></tr></table></figure>

<p>==注意：PV中的hostPath，指定了宿主主机上的挂载路径(node节点最好全部先创建好)==</p>
<h3 id="配置k8s-Deployment"><a href="#配置k8s-Deployment" class="headerlink" title="配置k8s Deployment"></a><a href="#配置k8s-Deployment" title="配置k8s Deployment"></a>配置k8s Deployment</h3><p>在k8s早期更多的是使用ReplicationController (RC)来控制保障pod，不过后来又出现了Deployment。<br>Deployment不仅包含了RC的所有功能，还具有：版本记录、回滚、暂停和启动等多种额外的强大功能。<br>所以可以尽量都使用Deployment,新建nexus3-deployment.yaml文件：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@master nexus]<span class="meta"># cat nexus3-deployment.yaml </span></span><br><span class="line"><span class="symbol">kind:</span> Deployment</span><br><span class="line"><span class="symbol">apiVersion:</span> extensions/v1beta1</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  labels:</span></span><br><span class="line"><span class="symbol">    app:</span> nexus3</span><br><span class="line"><span class="symbol">  name:</span> nexus3</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    matchLabels:</span></span><br><span class="line"><span class="symbol">      app:</span> nexus3</span><br><span class="line"><span class="symbol">  template:</span></span><br><span class="line"><span class="symbol">    metadata:</span></span><br><span class="line"><span class="symbol">      labels:</span></span><br><span class="line"><span class="symbol">        app:</span> nexus3</span><br><span class="line"><span class="symbol">    spec:</span></span><br><span class="line"><span class="symbol">      containers:</span></span><br><span class="line">        - name: nexus3</span><br><span class="line"><span class="symbol">          image:</span> registry.martin.com:<span class="number">5000</span><span class="meta-keyword">/tools/</span>nexus:<span class="number">3.12</span><span class="number">.1</span></span><br><span class="line"><span class="symbol">          imagePullPolicy:</span> IfNotPresent</span><br><span class="line"><span class="symbol">          ports:</span></span><br><span class="line">          - containerPort: <span class="number">9193</span></span><br><span class="line"><span class="symbol">            protocol:</span> TCP</span><br><span class="line"><span class="symbol">          volumeMounts:</span></span><br><span class="line">          - name: nexus-data</span><br><span class="line"><span class="symbol">            mountPath:</span> <span class="meta-keyword">/data/</span>docker<span class="meta-keyword">/soft/</span>nexus</span><br><span class="line"><span class="symbol">      volumes:</span></span><br><span class="line">        - name: nexus-data</span><br><span class="line"><span class="symbol">          persistentVolumeClaim:</span></span><br><span class="line"><span class="symbol">            claimName:</span> nexus3-data-pvc</span><br><span class="line"><span class="symbol">      nodeSelector:</span></span><br><span class="line">        kubernetes.io/hostname: <span class="number">192.168</span><span class="number">.0</span><span class="number">.15</span></span><br></pre></td></tr></table></figure>

<p>需要在volumes结点上引用之前创建的PVC：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">volumes</span>:</span><br><span class="line">  - name: nexus-<span class="class"><span class="keyword">data</span></span></span><br><span class="line">    persistentVolumeClaim:</span><br><span class="line">      claimName: nexus3-<span class="class"><span class="keyword">data</span>-pvc</span></span><br></pre></td></tr></table></figure>

<p>在volumeMounts结点上，配置了挂载到容器中的路径：/data/docker/soft/nexus(node节点最好全部先创建好)</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">volumeMounts:</span></span><br><span class="line">  - name: nexus-data</span><br><span class="line"><span class="symbol">    mountPath:</span> <span class="meta-keyword">/data/</span>docker<span class="meta-keyword">/soft/</span>nexus</span><br></pre></td></tr></table></figure>

<p>最后的nodeSelector表示pod只在某个主机上运行,可以通过在k8s的master上使用:kubectl get nodes查看</p>
<h3 id="配置k8s-Service"><a href="#配置k8s-Service" class="headerlink" title="配置k8s Service"></a><a href="#配置k8s-Service" title="配置k8s Service"></a>配置k8s Service</h3><p>k8s中的pod的访问是不可靠的，随时可能发生pod停止-漂移-创建的过程。<br>所以要想能够稳定的访问，就必须要创建Service进行服务发现了，在Service中是根据selector来寻找pod的。<br>最后k8s上的Service只能在集群节点上访问，如果我们想要在集群外部进行访问的话，只有三种方式：</p>
<ul>
<li>NodePort、</li>
<li>LoadBalancer、</li>
<li>Ingress。</li>
</ul>
<p>这里使用NodePort，绑定宿主机的端口来进行暴露服务。跟docker run -p 看上去效果相似。<br>新建nexus3-service.yaml文件：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master nexus]<span class="meta"># cat nexus3-service.yaml </span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Service</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  labels:</span></span><br><span class="line"><span class="symbol">    app:</span> nexus3</span><br><span class="line"><span class="symbol">  name:</span> nexus3</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  type:</span> NodePort</span><br><span class="line"><span class="symbol">  ports:</span></span><br><span class="line">  - port: <span class="number">8081</span></span><br><span class="line"><span class="symbol">    targetPort:</span> <span class="number">8081</span></span><br><span class="line"><span class="symbol">    nodePort:</span> <span class="number">30031</span></span><br><span class="line"><span class="symbol">    name:</span> web-ui</span><br><span class="line"><span class="symbol">  selector:</span></span><br><span class="line"><span class="symbol">    app:</span> nexus3</span><br><span class="line">[root@master nexus]<span class="meta">#</span></span><br></pre></td></tr></table></figure>

<p>其中关键的地方就是spec.type节点配置NodePort类型了。<br>说明下的ports 端口的配置：</p>
<ul>
<li>port 属性定义了Service的虚端口；</li>
<li>targetPort 属性指定了后面pod上提供的端口，如果没有指定则默认与port相同(这里我们显视的指定了)；</li>
<li>nodePort 属性指定了绑定在宿主机(物理机)上的端口号，我们可以通过宿主机IP + 端口的形式访问到后方pod中的服。</li>
<li>name 如果有多个port配置的话，必须要为每个port指定一个名称。</li>
</ul>
<h3 id="k8s部署访问"><a href="#k8s部署访问" class="headerlink" title="k8s部署访问"></a><a href="#k8s部署访问" title="k8s部署访问"></a>k8s部署访问</h3><h4 id="创建-PV-PVC"><a href="#创建-PV-PVC" class="headerlink" title="创建 PV-PVC"></a><a href="#创建-PV-PVC" title="创建 PV-PVC"></a>创建 PV-PVC</h4><p>根据配置文件，创建PV-PVC：</p>
<p>kubectl create -f nexus3-pv-pvc.yaml</p>
<p>创建完成后，查看一下状态，是否正常： </p>
<p>kubectl get pv</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME             CAPACITY   ACCESS MODES   RECLAIM<span class="built_in"> POLICY </span>  STATUS    CLAIM                     STORAGECLASS   REASON    AGE</span><br><span class="line">nexus3-data-pv   500Gi      RWO            Recycle          Bound     default/nexus3-data-pvc                            17h</span><br></pre></td></tr></table></figure>

<h4 id="创建Deployment"><a href="#创建Deployment" class="headerlink" title="创建Deployment"></a><a href="#创建Deployment" title="创建Deployment"></a>创建Deployment</h4><p>继续创建Deployment，创建完后会自动创建pod的，并维护pod数量始终为1。 </p>
<p>kubectl create -f nexus3-deployment.yaml </p>
<p>稍等几秒钟，查看pod状态： </p>
<p>kubectl get pod -o wide</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME                      READY     STATUS    RESTARTS   AGE       IP           NODE</span><br><span class="line">nexus3<span class="number">-68</span>f55d9746-vfnf8   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">12</span>h       <span class="number">10.20</span><span class="number">.7</span><span class="number">.12</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.15</span></span><br></pre></td></tr></table></figure>

<p>==注意：默认不用-n指定namespace的都是用的default，-o wide可以看到详细的IP及node信息==</p>
<h4 id="创建Service"><a href="#创建Service" class="headerlink" title="创建Service"></a><a href="#创建Service" title="创建Service"></a>创建Service</h4><p>创建Service，暴露服务：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">kubectl</span> <span class="selector-tag">create</span> <span class="selector-tag">-f</span> <span class="selector-tag">nexus3-service</span><span class="selector-class">.yaml</span></span><br></pre></td></tr></table></figure>

<p>查看状态：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> kubectl <span class="builtin-name">get</span> svc</span><br><span class="line">NAME           <span class="built_in"> TYPE </span>       CLUSTER-IP      EXTERNAL-IP   PORT(S)                                        AGE</span><br><span class="line">kubernetes      ClusterIP   10.10.0.1       &lt;none&gt;        443/TCP                                        13d</span><br><span class="line">nexus3          NodePort    10.10.165.3     &lt;none&gt;        8081:30031/TCP,5000:30032/TCP,8889:30033/TCP   12h</span><br><span class="line">nginx-service   ClusterIP   10.10.147.216   &lt;none&gt;        80/TCP                                         10d</span><br></pre></td></tr></table></figure>

<p>==注意这里的访问，是访问宿主机的IP+端口，至于CLUSTER-IP这些都是虚拟的IP，无法在外部进行访问的==。</p>
<h3 id="访问Nexus"><a href="#访问Nexus" class="headerlink" title="访问Nexus"></a><a href="#访问Nexus" title="访问Nexus"></a>访问Nexus</h3><p><a href="http://192.168.1.2:30031" target="_blank" rel="noopener">http://192.168.1.2:30031</a> (pod内container端口为：8081)</p>
<h3 id="升级"><a href="#升级" class="headerlink" title="升级"></a><a href="#升级" title="升级"></a>升级</h3><p>借用k8s Deployment的升级方式:</p>
<ol>
<li>从官网下载最新的nexus安装包；</li>
<li>修改nexus配置文件，将上面旧版本的配置覆盖过来就行了；</li>
<li>修改Dockerfile文件，构建新的Docker镜像，将新打包的nexus放入镜像中。<br>如：docker build -t registry.martin.com:5000/tools/nexus:3.12.2 .<br>Ps: 不要忘记启动命令路径也要调整!</li>
<li>使用k8s命令升级Deployment：<br>如：kubectl set image deployment/nexus3 nexus3=registry.martin.com:5000/tools/nexus:3.12.2</li>
<li>回滚升级，如果发现升级了的不好用，或者出现问题，也可以回滚：<br>如：kubectl rollout undo deployment/nexus3</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><a href="#总结" title="总结"></a>总结</h3><p>其实这个过程中里复杂了一部分，也简化了一部分。<br>复杂了pv-pvc过程，pv-pvc不用创建直接在Deployment中挂载hostPath也是可以的。<br>简化了Deployment，其实应该还需要加上cpu、内存等资源限制的。<br>这里只是在nexus配置文件中做了限制，如果出现内存泄漏问题，还是没办法解决!</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/08/19/Kubernetes-RBAC-Detailed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/19/Kubernetes-RBAC-Detailed/" itemprop="url">Kubernetes RBAC  Detailed</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T09:51:37+08:00">
                2018-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>RBAC - 基于角色的访问控制<br>RBAC使用：rbac.authorization.k8s.io API Group 来实现授权决策，允许管理员通过 Kubernetes API 动态配置策略，要启用RBAC，需要在 apiserver 中添加参数–authorization-mode=RBAC，如果使用的kubeadm安装的集群，1.6 版本以上的都默认开启了RBAC，可以通过查看 Master 节点上 apiserver 的静态Pod定义文件：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">systemd</span>/<span class="title">system</span>/<span class="title">kube</span>-<span class="title">apiserver</span>.<span class="title">service</span></span></span><br><span class="line">或者是：</span><br><span class="line">$ cat /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">…</span><br><span class="line">    - –authorization-mode=Node,RBAC</span><br><span class="line">…</span><br></pre></td></tr></table></figure>

<p>如果是二进制的方式搭建的集群，添加这个参数过后，记得要重启 apiserver 服务。</p>
<hr>
<h3 id="RBAC-API-对象"><a href="#RBAC-API-对象" class="headerlink" title="RBAC API 对象"></a><a href="#RBAC-API-对象" title="RBAC API 对象"></a>RBAC API 对象</h3><p>Kubernetes有一个很基本的特性就是它的所有资源对象都是模型化的 API 对象，允许执行 CRUD(Create、Read、Update、Delete)操作(也就是我们常说的增、删、改、查操作)，比如下面的这下资源：</p>
<ul>
<li>Pods</li>
<li>ConfigMaps</li>
<li>Deployments</li>
<li>Nodes</li>
<li>Secrets</li>
<li>Namespaces</li>
</ul>
<p>上面这些资源对象的可能存在的操作有：</p>
<ul>
<li>create</li>
<li>get</li>
<li>delete</li>
<li>list</li>
<li>update</li>
<li>edit</li>
<li>watch</li>
<li>exec</li>
</ul>
<p>在更上层，这些资源和API Group 进行关联，比如Pods属于Core API Group，而Deployements属于 apps API Group，要在Kubernetes中进行RBAC的管理，除了上面的这些资源和操作以外，我们还需要另外的一些对象：</p>
<ol>
<li>Rule：规则，规则是一组属于不同API Group 资源上的一组操作的集合</li>
<li>Role 和 ClusterRole：角色和集群角色，这两个对象都包含上面的Rules 元素，二者的区别在于，在Role 中，定义的规则只适用于单个命名空间，也就是和namespace 关联的，而ClusterRole 是集群范围内的，因此定义的规则不受命名空间的约束。另外Role和 ClusterRole在Kubernetes中都被定义为集群内部的API 资源，和Pod、ConfigMap 这些类似，都是集群的资源对象，所以同样的可以使用kubectl相关的命令来进行操作</li>
<li><p>Subject：主题，对应在集群中尝试操作的对象，集群中定义了3种类型的主题资源：</p>
<pre><code>*   User Account：用户，这是有外部独立服务进行管理的，管理员进行私钥的分配，用户可以使用KeyStone或者Goolge 帐号，甚至一个用户名和密码的文件列表也可以。对于用户的管理集群内部没有一个关联的资源对象，所以用户不能通过集群内部的API 来进行管理
</code></pre><ul>
<li>Group：组，这是用来关联多个账户的，集群中有一些默认创建的组，比如cluster-admin</li>
<li>Service Account：服务帐号，通过Kubernetes API 来管理的一些用户帐号，和namespace 进行关联的，适用于集群内部运行的应用程序，需要通过API 来完成权限认证，所以在集群内部进行权限操作，都需要使用到 ServiceAccount</li>
</ul>
</li>
<li>RoleBinding和 ClusterRoleBinding：角色绑定和集群角色绑定，简单来说就是把声明的Subject和Role 进行绑定的过程(给某个用户绑定上操作的权限)，二者的区别也是作用范围的区别：RoleBinding只会影响到当前namespace 下面的资源操作权限，而ClusterRoleBinding会影响到所有的 namespace。<a id="more"></a></li>
</ol>
<hr>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a><a href="#示例" title="示例"></a>示例</h3><p>通过如下示例来演示RBAC的配置方法：</p>
<h4 id="创建一个只能访问某个-namespace-的用户"><a href="#创建一个只能访问某个-namespace-的用户" class="headerlink" title="创建一个只能访问某个 namespace 的用户"></a><a href="#创建一个只能访问某个-namespace-的用户" title="创建一个只能访问某个 namespace 的用户"></a>创建一个只能访问某个 namespace 的用户</h4><p>创建一个 User Account，只能访问 kube-system这个命名空间：</p>
<ul>
<li>username: martin</li>
<li>group: op</li>
</ul>
<h5 id="第一步：创建用户凭证"><a href="#第一步：创建用户凭证" class="headerlink" title="第一步：创建用户凭证"></a><a href="#第一步：创建用户凭证" title="第一步：创建用户凭证"></a>第一步：创建用户凭证</h5><p>Kubernetes没有User Account的API 对象，不过要创建一个用户帐号的话也是挺简单的，利用管理员分配的一个私钥就可以创建了。<br>创建方法有两种:</p>
<h6 id="1-使用OpenSSL证书来创建User；"><a href="#1-使用OpenSSL证书来创建User；" class="headerlink" title="1. 使用OpenSSL证书来创建User；"></a><a href="#1-使用OpenSSL证书来创建User；" title="1\. 使用OpenSSL证书来创建User；"></a>1. 使用OpenSSL证书来创建User；</h6><ul>
<li><p>给用户martin创建一个私钥，命名成：martin.key：<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -out martin.<span class="type">key</span> <span class="number">2048</span></span><br></pre></td></tr></table></figure></p>
</li>
<li><p>使用刚刚创建的私钥创建一个证书签名请求文件：martin.csr，要注意需要确保在-subj参数中指定用户名和组(CN表示用户名，O表示组)：<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -new -key martin<span class="selector-class">.key</span> -out martin<span class="selector-class">.csr</span> -subj <span class="string">“/CN=martin/O=op”</span></span><br></pre></td></tr></table></figure></p>
</li>
<li><p>然后找到Kubernetes集群的CA，我们使用的是kubeadm安装的集群，CA相关证书位于/etc/kubernetes/pki/目录下面，如果是二进制方式搭建的，应该在最开始搭建集群的时候就已经指定好了CA的目录(/data/kubernetes/ssl)，然后利用该目录下面的ca.crt和ca.key两个文件来批准上面的证书请求</p>
</li>
<li><p>生成最终的证书文件，这里设置证书的有效期为500天<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -req -<span class="keyword">in</span> martin<span class="selector-class">.csr</span> -CA /data/kubernetes/ssl/ca<span class="selector-class">.crt</span> -CAkey /data/kubernetes/ssl/ca<span class="selector-class">.key</span> -CAcreateserial -out martin<span class="selector-class">.crt</span> -days <span class="number">500</span></span><br><span class="line">现在查看当前文件夹下面是否生成了一个证书文件：</span><br><span class="line">$ ls</span><br><span class="line">martin<span class="selector-class">.csr</span> martin<span class="selector-class">.key</span> martin.crt</span><br></pre></td></tr></table></figure></p>
</li>
<li><p>现在可以使用刚刚创建的证书文件和私钥文件在集群中创建新的凭证和上下文(Context):<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl<span class="built_in"> config </span>set-credentials martin <span class="attribute">–client-certificate</span>=martin.crt  <span class="attribute">–client-key</span>=martin.key</span><br></pre></td></tr></table></figure></p>
</li>
<li><p>可以看到一个用户martin创建了，然后为这个用户设置新的 Context:<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl<span class="built_in"> config </span>set-context martin-context <span class="attribute">–cluster</span>=kubernetes <span class="attribute">–namespace</span>=kube-system <span class="attribute">–user</span>=martin</span><br></pre></td></tr></table></figure></p>
</li>
</ul>
<p>到这里，用户martin就已经创建成功了，现在使用当前的这个配置文件来操作kubectl命令的时候，应该会出现错误，因为还没有为该用户定义任何操作的权限：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> pods <span class="attribute">–context</span>=martin-context</span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Forbidden): pods is forbidden:<span class="built_in"> User </span><span class="string">“martin”</span> cannot list pods <span class="keyword">in</span> the namespace <span class="string">“default”</span></span><br></pre></td></tr></table></figure>

<h6 id="2-使用cfssl工具来创建，也是参考官方文档中的方法。"><a href="#2-使用cfssl工具来创建，也是参考官方文档中的方法。" class="headerlink" title="2. 使用cfssl工具来创建，也是参考官方文档中的方法。"></a><a href="#2-使用cfssl工具来创建，也是参考官方文档中的方法。" title="2\. 使用cfssl工具来创建，也是参考官方文档中的方法。"></a>2. 使用cfssl工具来创建，也是参考官方文档中的方法。</h6><ul>
<li><p>CFSSL是CloudFlare开源的一款PKI/TLS工具。 CFSSL 包含一个命令行工具和一个用于签名，验证并且捆绑TLS证书的HTTP API服务。使用Go语言编写。</p>
</li>
<li><p>CFSSL包括：</p>
<ul>
<li>一组用于生成自定义TLS PKI的工具</li>
<li>cfssl程序，是CFSSL的命令行工具</li>
<li>multirootca程序是可以使用多个签名密钥的证书颁发机构服务器</li>
<li>mkbundle程序用于构建证书池</li>
<li>cfssljson程序，从cfssl和multirootca程序获取JSON输出，并将证书，密钥，CSR和bundle写入磁盘</li>
</ul>
</li>
<li><p>PKI借助数字证书和公钥加密技术提供可信任的网络身份。通常，证书就是一个包含如下身份信息的文件：</p>
<ul>
<li>证书所有组织的信息</li>
<li>公钥</li>
<li>证书颁发组织的信息</li>
<li>证书颁发组织授予的权限，如证书有效期、适用的主机名、用途等</li>
<li>使用证书颁发组织私钥创建的数字签名</li>
</ul>
</li>
<li><p>cfssl工具，子命令介绍：</p>
<ul>
<li>bundle: 创建包含客户端证书的证书包</li>
<li>genkey: 生成一个key(私钥)和CSR(证书签名请求)</li>
<li>scan: 扫描主机问题</li>
<li>revoke: 吊销证书</li>
<li>certinfo: 输出给定证书的证书信息，跟cfssl-certinfo 工具作用一样</li>
<li>gencrl: 生成新的证书吊销列表</li>
<li>selfsign: 生成一个新的自签名密钥和签名证书</li>
<li>print-defaults: 打印默认配置，这个默认配置可以用作模板</li>
<li>serve: 启动一个HTTP API服务</li>
<li>gencert: 生成新的key(密钥)和签名证书</li>
<li>-ca：指明ca的证书</li>
<li>-ca-key：指明ca的私钥文件</li>
<li>-config：指明请求证书的json文件</li>
<li>-profile：与-config中的profile对应，是指根据config中的prof  ile段来生成证书的相关信息</li>
<li>ocspdump</li>
<li>ocspsign</li>
<li>info: 获取有关远程签名者的信息</li>
<li>sign: 签名一个客户端证书，通过给定的CA和CA密钥，和主机名</li>
<li>ocsprefresh</li>
<li>ocspserve</li>
</ul>
</li>
<li><p>创建认证中心(CA)，也就是Kubernetes集群的CA，上面用openssl时已经将其省略了，现cfssl操作说明下详细方法：</p>
<ol>
<li><p>CFSSL可以创建一个获取和操作证书的内部认证中心。运行认证中心需要一个CA证书和相应的CA私钥。任何知道私钥的人都可以充当CA颁发证书。因此，私钥的保护至关重要。</p>
<ol start="2">
<li>创建用来生成CA文件的JSON配置文件,配置证书生成策略，让CA软件知道颁发什么样的证书。<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ssl]# vim ca-config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“signing”</span>: &#123;</span><br><span class="line">    <span class="string">“default”</span>: &#123;</span><br><span class="line">      <span class="string">“expiry”</span>: <span class="string">“8760h”</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">“profiles”</span>: &#123;</span><br><span class="line">      <span class="string">“kubernetes”</span>: &#123;</span><br><span class="line">        <span class="string">“usages”</span>: [</span><br><span class="line">            <span class="string">“signing”</span>,</span><br><span class="line">            <span class="string">“key encipherment”</span>,</span><br><span class="line">            <span class="string">“server auth”</span>,</span><br><span class="line">            <span class="string">“client auth”</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">“expiry”</span>: <span class="string">“8760h”</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">这个策略，有一个默认的配置，和一个profile，可以设置多个profile，这里的profile   是kubernetes。</span><br><span class="line">默认策略，指定了证书的有效期是一年(8760h)</span><br><span class="line">kubernetes策略，指定了证书的用途</span><br><span class="line">signing, 表示该证书可用于签名其它证书；生成的ca.pem 证书中   <span class="attribute">CA</span>=<span class="literal">TRUE</span></span><br><span class="line">server auth：表示client可以用该CA对server提供的证书进行验证</span><br><span class="line">client auth：表示server可以用该CA对client提供的证书进行验证</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>创建用来生成CA证书签名请求（CSR）的JSON配置文件<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node1 ssl]<span class="comment"># vim ca-csr.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“CN”</span>: <span class="string">“kubernetes”</span>,</span><br><span class="line">  <span class="string">“key”</span>: &#123;</span><br><span class="line">    <span class="string">“algo”</span>: <span class="string">“rsa”</span>,</span><br><span class="line">    <span class="string">“size”</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“names”</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">“C”</span>: <span class="string">“CN”</span>,</span><br><span class="line">      <span class="string">“ST”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“L”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“O”</span>: <span class="string">“k8s”</span>,</span><br><span class="line">      <span class="string">“OU”</span>: <span class="string">“System”</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">术语介绍:</span></span><br><span class="line"><span class="section">CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。浏览器使用该字段验证网站是否合法</span></span><br><span class="line"><span class="section">C: Country， 国家</span></span><br><span class="line"><span class="section">L: Locality，地区，城市</span></span><br><span class="line"><span class="section">O: Organization Name，组织名称，公司名称</span></span><br><span class="line"><span class="section">OU: Organization Unit Name，组织单位名称，公司部门</span></span><br><span class="line"><span class="section">ST: State，州，省</span></span><br></pre></td></tr></table></figure></li>
<li>生成CA证书（ca.pem）和私钥（ca-key.pem）<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ linux-node1 ssl]<span class="comment"># cfssl gencert -initca ca-csr.json |   cfssljson -bare ca  </span></span><br><span class="line"><span class="comment">#初始化ca</span></span><br><span class="line">[root@ linux-node1 ssl]<span class="comment"># ls -l ca*</span></span><br><span class="line">-rw-r–r–<span class="number"> 1 </span>root root <span class="number"> 290 </span>Mar <span class="number"> 4 </span>13:45 ca-config.json</span><br><span class="line">-rw-r–r–<span class="number"> 1 </span>root root<span class="number"> 1001 </span>Mar <span class="number"> 4 </span>14:09 ca.csr</span><br><span class="line">-rw-r–r–<span class="number"> 1 </span>root root <span class="number"> 208 </span>Mar <span class="number"> 4 </span>13:51 ca-csr.json</span><br><span class="line">-rw——-<span class="number"> 1 </span>root root<span class="number"> 1679 </span>Mar <span class="number"> 4 </span>14:09 ca-key.pem</span><br><span class="line">-rw-r–r–<span class="number"> 1 </span>root root<span class="number"> 1359 </span>Mar <span class="number"> 4 </span>14:09 ca.pem</span><br><span class="line">该命令会生成运行CA所必需的文件ca-key.pem（私钥）和ca.pem（证书），还会生成ca.csr（证书签名请求），用于交叉签名或重新签名。</span><br></pre></td></tr></table></figure></li>
</ol>
<p>小提示：</p>
<ul>
<li>使用现有的CA私钥，重新生成：<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca -<span class="keyword">ca</span>-key key.pem <span class="keyword">ca</span>-csr.json |     cfssljson -bare <span class="keyword">ca</span></span><br></pre></td></tr></table></figure></li>
<li>使用现有的CA私钥和CA证书，重新生成：<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">cfssl</span> <span class="selector-tag">gencert</span> <span class="selector-tag">-renewca</span> <span class="selector-tag">-ca</span> <span class="selector-tag">cert</span><span class="selector-class">.pem</span> <span class="selector-tag">-ca-key</span> <span class="selector-tag">key</span><span class="selector-class">.pem</span></span><br></pre></td></tr></table></figure></li>
<li><p>查看cert(证书信息)：cfssl certinfo -cert ca.pem</p>
<ul>
<li>查看CSR(证书签名请求)信息：cfssl certinfo -csr ca.csr</li>
</ul>
</li>
</ul>
</li>
<li>创建martin证书签名请求(Kubernetes集群的CA创建好了，再根据该CA证书来创建一个只能访问某个namespace的用户)<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  martin cat martin-csr.json </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">“CN”</span>: <span class="string">“martin”</span>,</span><br><span class="line">  <span class="string">“hosts”</span>: [],</span><br><span class="line">  <span class="string">“key”</span>: &#123;</span><br><span class="line">    <span class="string">“algo”</span>: <span class="string">“rsa”</span>,</span><br><span class="line">    <span class="string">“size”</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“names”</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">“C”</span>: <span class="string">“CN”</span>,</span><br><span class="line">      <span class="string">“ST”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“L”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“O”</span>: <span class="string">“op”</span>, <span class="comment">#system:masters</span></span><br><span class="line">      <span class="string">“OU”</span>: <span class="string">“System”</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">➜  martin </span><br><span class="line">后续kube-apiserver使用RBAC对客户端(如kubelet、kube-proxy、Pod)请求进行授权；</span><br><span class="line">kube-apiserver预定义了一些RBAC使用的RoleBindings，如cluster-admin将<span class="keyword">Group</span> <span class="title">op</span>(system:masters)与 <span class="keyword">Role</span> <span class="title">cluster-admin</span> 绑定，该Role授予了调用kube-apiserver的所有API的权限；</span><br><span class="line">OU指定该证书的Group为<span class="keyword">op</span>(system:masters)，kubelet使用该证书访问 kube-apiserver时,由于证书被CA签名，所以认证通过，同时由于证书用户组为经过预授权的<span class="keyword">op</span>(system:masters)，所以被授予访问所有 API 的权限；</span><br></pre></td></tr></table></figure></li>
<li>生成martin证书和私钥<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="keyword">martin </span>ls -lth</span><br><span class="line"><span class="symbol">total</span> <span class="number">4</span>.<span class="number">0</span>K</span><br><span class="line">-rw-r–r– <span class="number">1</span> root root <span class="number">218</span> Jun <span class="number">26</span> <span class="number">11</span>:<span class="number">59</span> <span class="keyword">martin-csr.json</span></span><br><span class="line"><span class="keyword">➜ </span> <span class="keyword">martin </span>cfssl gencert -ca=/<span class="meta">data</span>/kubernetes/ssl/ca.pem -ca-key=/<span class="meta">data</span>/kubernetes/ssl/ca-key.pem -config=/<span class="meta">data</span>/kubernetes/ssl/ca-config.json -profile<span class="symbol">=kubernetes</span> <span class="keyword">martin-csr.json|cfssljson </span>-<span class="keyword">bare </span><span class="keyword">martin</span></span><br><span class="line"><span class="keyword">2018/06/26 </span><span class="number">16</span>:<span class="number">20</span>:<span class="number">37</span> [<span class="meta">INFO</span>] generate received request</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">37</span> [<span class="meta">INFO</span>] received CSR</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">37</span> [<span class="meta">INFO</span>] generating key: rsa-<span class="number">2048</span></span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">38</span> [<span class="meta">INFO</span>] encoded CSR</span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">38</span> [<span class="meta">INFO</span>] signed certificate with serial number <span class="number">451530418945753741698899402739082416074910829402</span></span><br><span class="line"><span class="number">2018</span>/<span class="number">06</span>/<span class="number">26</span> <span class="number">16</span>:<span class="number">20</span>:<span class="number">38</span> [WARNING] This certificate lacks a <span class="string">“hosts”</span> <span class="meta">field</span>. This makes <span class="keyword">it </span>unsuitable for</span><br><span class="line"><span class="symbol">websites.</span> For more information see the <span class="keyword">Baseline </span>Requirements for the Issuance <span class="keyword">and </span>Management</span><br><span class="line"><span class="symbol">of</span> Publicly-Trusted Certificates, v.<span class="number">1</span>.<span class="number">1</span>.<span class="number">6</span>, from the CA/<span class="keyword">Browser </span>Forum (<a href="https://cabforum.org" target="_blank" rel="noopener">https://cabforum.org</a>)<span class="comment">;</span></span><br><span class="line"><span class="symbol">specifically</span>, section <span class="number">10</span>.<span class="number">2</span>.<span class="number">3</span> (<span class="string">“Information Requirements”</span>).</span><br><span class="line">➜  <span class="keyword">martin </span>ls -lth</span><br><span class="line"><span class="symbol">total</span> <span class="number">16</span>K</span><br><span class="line">-rw-r–r– <span class="number">1</span> root root  <span class="number">993</span> Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> <span class="keyword">martin.csr</span></span><br><span class="line"><span class="keyword">-rw——- </span><span class="number">1</span> root root <span class="number">1</span>.<span class="number">7</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> <span class="keyword">martin-key.pem</span></span><br><span class="line"><span class="keyword">-rw-r–r– </span><span class="number">1</span> root root <span class="number">1</span>.<span class="number">4</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> <span class="keyword">martin.pem</span></span><br><span class="line"><span class="keyword">-rw-r–r– </span><span class="number">1</span> root root  <span class="number">218</span> Jun <span class="number">26</span> <span class="number">11</span>:<span class="number">59</span> <span class="keyword">martin-csr.json</span></span><br><span class="line"><span class="keyword">➜ </span> <span class="keyword">martin</span></span><br></pre></td></tr></table></figure></li>
<li>设置集群参数</li>
</ul>
<p>本段主要设置了需要访问的集群的信息。使用set-cluster设置了需要访问的集群，如下为kubernetes，这只是个名称，实际为–server指向的apiserver；–certificate-authority设置了该集群的公钥；–embed-certs为true表示将–certificate-authority证书写入到kubeconfig中；–server则表示该集群的kube-apiserver地址</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl config set-cluster kubernetes –certificate-authority=/data/kubernetes/ssl/ca<span class="selector-class">.pem</span> –embed-certs=true –server=https:<span class="comment">//192.168.0.14:6443 –kubeconfig=martin.kubeconfig</span></span><br><span class="line">Cluster <span class="string">“kubernetes”</span> set.</span><br><span class="line">➜  martin ls -lth</span><br><span class="line">total <span class="number">20</span>K</span><br><span class="line">-rw——- <span class="number">1</span> root root <span class="number">2.0</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">29</span> martin.kubeconfig</span><br><span class="line">-rw-r–r– <span class="number">1</span> root root  <span class="number">993</span> Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> martin.csr</span><br><span class="line">-rw——- <span class="number">1</span> root root <span class="number">1.7</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> martin-key.pem</span><br><span class="line">-rw-r–r– <span class="number">1</span> root root <span class="number">1.4</span>K Jun <span class="number">26</span> <span class="number">16</span>:<span class="number">20</span> martin.pem</span><br><span class="line">-rw-r–r– <span class="number">1</span> root root  <span class="number">218</span> Jun <span class="number">26</span> <span class="number">11</span>:<span class="number">59</span> martin-csr.json</span><br><span class="line">生成了新的文件：martin.kubeconfig</span><br><span class="line">➜  martin cat martin<span class="selector-class">.kubeconfig</span> </span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: xxx</span><br><span class="line">    server: https:<span class="comment">//192.168.0.14:6443</span></span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts: []</span><br><span class="line">current-context: <span class="string">“”</span></span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users: []</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>注意：–kubeconfig=martin.kubeconfig是将生成的相关信息全部写入martin.kubeconfig文件,如果不指定的话，默认是写入到“~/.kube/config ”</p>
<ul>
<li>设置客户端认证参数</li>
</ul>
<p>本段主要设置用户的相关信息，主要是用户证书。如下用户名为martin，证书为：/martin.pem，私钥为：./martin-key.pem。客户端的证书首先要经过集群CA的签署，否则不会被集群认可。此处使用的是ca认证方式，也可以使用token认证，如kubelet的TLS Boostrap机制下的bootstrapping使用的就是token认证方式。如下kubectl使用的是ca认证，不需要token字段</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl<span class="built_in"> config </span>set-credentials martin <span class="attribute">–client-certificate</span>=./martin.pem <span class="attribute">–client-key</span>=./martin-key.pem <span class="attribute">–embed-certs</span>=<span class="literal">true</span> <span class="attribute">–kubeconfig</span>=martin.kubeconfig                                      </span><br><span class="line">User <span class="string">“martin”</span> set.</span><br><span class="line">➜  martin </span><br><span class="line">可以看到martin.kubeconfig新增了如下内容：</span><br><span class="line">users:</span><br><span class="line">- name: martin</span><br><span class="line">  user:</span><br><span class="line">    xxx</span><br></pre></td></tr></table></figure>

<ul>
<li>设置上下文参数,指定命名空间为：kube-system</li>
</ul>
<p>集群参数和用户参数可以同时设置多对，在上下文参数中将集群参数和用户参数关联起来。下面的上下文名称为martin-context，集群为kubenetes，用户为martin，表示使用martin的用户凭证来访问kubenetes集群的kube-system命名空间(增加–namspace来指定访问的命名空间)。</p>
<p>执行之前先看下:martin.kubeconfig文件内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">martin</span> <span class="string">cat</span> <span class="string">martin.kubeconfig</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="attr">- cluster:</span></span><br><span class="line"><span class="attr">    certificate-authority-data:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">    server:</span> <span class="attr"><a href="https://192.168.0.14:6443" target="_blank" rel="noopener">https://192.168.0.14:6443</a></span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">kubernetes</span></span><br><span class="line"><span class="attr">contexts:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">“”</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">martin</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line"><span class="attr">    client-certificate-data:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">    client-key-data:</span> <span class="string">xxx</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">martin</span></span><br></pre></td></tr></table></figure>

<p>执行：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl<span class="built_in"> config </span>set-context martin-context <span class="attribute">–cluster</span>=kubernetes <span class="attribute">–namespace</span>=kube-system <span class="attribute">–user</span>=martin <span class="attribute">–kubeconfig</span>=martin.kubeconfig   </span><br><span class="line">Context <span class="string">“martin-context”</span> created.</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>再次查看martin.kubeconfig文件,发现内容做了如下改变：<br>之前：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contexts: <span class="string">[]</span></span><br></pre></td></tr></table></figure>

<p>现在：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">contexts</span>:</span><br><span class="line">- <span class="attribute">context</span>:</span><br><span class="line">    <span class="attribute">cluster</span>: kubernetes</span><br><span class="line">    <span class="attribute">namespace</span>: kube-system</span><br><span class="line">    <span class="attribute">user</span>: martin</span><br><span class="line">  <span class="attribute">name</span>: martin-context</span><br></pre></td></tr></table></figure>

<p>增加了上下文的相关信息。</p>
<ul>
<li>设置默认上下文<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl<span class="built_in"> config </span>use-context martin-context <span class="attribute">–kubeconfig</span>=martin.kubeconfig</span><br><span class="line">Switched <span class="keyword">to</span> context <span class="string">“martin-context”</span>.</span><br></pre></td></tr></table></figure></li>
</ul>
<p>如果配置了多个环境项，可以通过切换不同的环境项名字或指定kubeconfig文件来访问到不同的集群环境。</p>
<ul>
<li>现在martin用户通过cfssl创建成功,可以看到所有关于martin用户的信息都写入了配置文件：martin.kubeconfig,不指定”-kubeconfig=”的话，默认是写入到”~/.kube/config”，如果之前有admin的相关信息，会追加到后面。martin.kubeconfig配置文件描述了集群、用户和上下文</li>
</ul>
<p>kubectl只是个go编写的可执行程序，只要为kubectl配置合适的kubeconfig，就可以在集群中的任意节点使用。kubectl默认会从$HOME/.kube目录下查找文件名为config的文件，也可以通过设置环境变量KUBECONFIG或者通过设置–kubeconfig去指定其它kubeconfig文件,总之kubeconfig就是为访问集群所作的配置。</p>
<p>如果之前”~/.kube/config”下配置的是admin账号信息，要用martin账号，则指定kubeconfig文件即可：</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="string">martin </span><span class="string">kubectl </span><span class="string">config </span><span class="built_in">get-contexts</span>                               </span><br><span class="line"><span class="string">CURRENT </span>  <span class="string">NAME </span>        <span class="string">CLUSTER </span>     <span class="string">AUTHINFO </span>  <span class="string">NAMESPACE</span></span><br><span class="line"><span class="string"><em></em></span>         <span class="string">kubernetes </span>  <span class="string">kubernetes </span>  <span class="string">admin </span>     </span><br><span class="line">➜  <span class="string">martin </span></span><br><span class="line">➜  <span class="string">martin </span><span class="string">kubectl </span><span class="string">config </span><span class="built_in">get-contexts</span> <span class="built_in">–kubeconfig</span> <span class="string">martin.</span><span class="string">kubeconfig</span></span><br><span class="line"><span class="string">CURRENT </span>  <span class="string">NAME </span>            <span class="string">CLUSTER </span>     <span class="string">AUTHINFO </span>  <span class="string">NAMESPACE</span></span><br><span class="line"><span class="string"></span>         <span class="string">martin-context </span>  <span class="string">kubernetes </span>  <span class="string">martin </span>    <span class="string">kube-system</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">martin</span></span><br></pre></td></tr></table></figure>

<p>现在使用当前的这个配置文件来操作kubectl命令的时候，应该会出现错误，因为还没有为该用户定义任何操作的权限呢：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl <span class="builtin-name">get</span> pods –kubeconfig martin.kubeconfig</span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Forbidden): pods is forbidden:<span class="built_in"> User </span><span class="string">“martin”</span> cannot list pods <span class="keyword">in</span> the namespace <span class="string">“default”</span></span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>如果提示：“kubectl error: You must be logged in to the server (Unauthorized)”<br>则是没有指定martin.kubeconfig文件或者默认的”~/.kube/config”里面没有martin用户的相关证书信息，因为前面设置客户端认证的时候没有指定password，而是用了证书。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl<span class="built_in"> config </span>set-credentials kubeuser/foo.kubernetes.com <span class="attribute">–username</span>=kubeuser <span class="attribute">–password</span>=kubepassword (用户名密码认证方式)</span><br><span class="line"></span><br><span class="line">kubectl<span class="built_in"> config </span>set-credentials martin <span class="attribute">–client-certificate</span>=./martin.pem <span class="attribute">–client-key</span>=./martin-key.pem <span class="attribute">–embed-certs</span>=<span class="literal">true</span> <span class="attribute">–kubeconfig</span>=martin.kubeconfig</span><br><span class="line">(证书认证方式)</span><br></pre></td></tr></table></figure>

<p>另外可以通过：”Cfssl-Certinfo“命令来查看martin证书信息</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="keyword">martin </span>cfssl-certinfo -cert <span class="keyword">martin.pem</span></span><br><span class="line"><span class="keyword">&#123;</span></span><br><span class="line"><span class="keyword"> </span> <span class="string">“subject”</span>: &#123;</span><br><span class="line">    <span class="string">“common_name”</span>: <span class="string">“martin”</span>,</span><br><span class="line">    <span class="string">“country”</span>: <span class="string">“CN”</span>,</span><br><span class="line">    <span class="string">“organization”</span>: <span class="string">“op”</span>,</span><br><span class="line">    <span class="string">“organizational_unit”</span>: <span class="string">“System”</span>,</span><br><span class="line">    <span class="string">“locality”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">    <span class="string">“province”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">    <span class="string">“names”</span>: [</span><br><span class="line">      <span class="string">“CN”</span>,</span><br><span class="line">      <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“op”</span>,</span><br><span class="line">      <span class="string">“System”</span>,</span><br><span class="line">      <span class="string">“martin”</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">“issuer”</span>: &#123;</span><br><span class="line">    <span class="string">“common_name”</span>: <span class="string">“kubernetes”</span>,</span><br><span class="line">    <span class="string">“country”</span>: <span class="string">“CN”</span>,</span><br><span class="line">    <span class="string">“organization”</span>: <span class="string">“k8s”</span>,</span><br><span class="line">    <span class="string">“organizational_unit”</span>: <span class="string">“System”</span>,</span><br><span class="line">    <span class="string">“locality”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">    <span class="string">“province”</span>: <span class="string">“BeiJing”</span>,</span><br><span class="line">    <span class="string">“names”</span>: [</span><br><span class="line">      <span class="string">“CN”</span>,</span><br><span class="line">      <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“BeiJing”</span>,</span><br><span class="line">      <span class="string">“k8s”</span>,</span><br><span class="line">      <span class="string">“System”</span>,</span><br><span class="line">      <span class="string">“kubernetes”</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<h5 id="第二步：创建角色"><a href="#第二步：创建角色" class="headerlink" title="第二步：创建角色"></a><a href="#第二步：创建角色" title="第二步：创建角色"></a>第二步：创建角色</h5><p>用户创建完成后，接下来就需要给该用户添加操作权限，定义一个YAML文件，创建一个允许用户操作Deployment、Pod、ReplicaSets 的角色，如下定义：(martin-role.yaml)</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  martin cat martin-role.yaml </span><br><span class="line"><span class="symbol">apiVersion:</span> rbac.authorization.k8s.io/v1</span><br><span class="line"><span class="symbol">kind:</span> Role</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> martin-role</span><br><span class="line"><span class="symbol">  namespace:</span> kube-system</span><br><span class="line"><span class="symbol">rules:</span></span><br><span class="line">- apiGroups: [<span class="string">“”</span>, <span class="string">“extensions”</span>, <span class="string">“apps”</span>]</span><br><span class="line"><span class="symbol">  resources:</span> [<span class="string">“deployments”</span>, <span class="string">“replicasets”</span>, <span class="string">“pods”</span>]</span><br><span class="line"><span class="symbol">  verbs:</span> [<span class="string">“get”</span>, <span class="string">“list”</span>, <span class="string">“watch”</span>, <span class="string">“create”</span>, <span class="string">“update”</span>, <span class="string">“patch”</span>, <span class="string">“delete”</span>] <span class="meta"># 也可以使用[<span class="string">‘*’</span>]</span></span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>其中Pod属于core这个API Group，在YAML中用空字符就可以，而Deployment属于apps 这个API Group，ReplicaSets属于extensions这个API Group(<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.10/" target="_blank" rel="noopener">点这里查文档</a>)，所以 rules下面的apiGroups 就综合了这几个资源的 API Group：[“”, “extensions”, “apps”]，其中verbs就是上面提到的可以对这些资源对象执行的操作，这里需要所有的操作方法，所以也可以使用[‘*’]来代替。</p>
<p>然后创建这个Role:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl create -f martin-role<span class="selector-class">.yaml</span> </span><br><span class="line">role<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">“martin-role”</span> created</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>注意这里没有使用上面的martin-context这个上下文，因为木有权限</p>
<h5 id="第三步：创建角色权限绑定"><a href="#第三步：创建角色权限绑定" class="headerlink" title="第三步：创建角色权限绑定"></a><a href="#第三步：创建角色权限绑定" title="第三步：创建角色权限绑定"></a>第三步：创建角色权限绑定</h5><p>Role创建完成了，但是很明显现在这个Role和我们的用户martin 还没有任何关系，这里就需要创建一个RoleBinding对象，在 kube-system这个命名空间下面将上面的martin-role角色和用户 martin进行绑定:(martin-rolebinding.yaml)</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  martin cat martin-rolebinding<span class="selector-class">.yaml</span> </span><br><span class="line">apiVersion: rbac<span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span>/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: martin-rolebinding</span><br><span class="line">  namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  <span class="selector-id">#apiGroup</span>: rbac<span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span></span><br><span class="line">  <span class="selector-id">#kind</span>: ClusterRole</span><br><span class="line">  kind: Role</span><br><span class="line">  name: martin-role</span><br><span class="line">  apiGroup: <span class="string">“”</span></span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: <span class="string">“”</span></span><br><span class="line">  kind: User</span><br><span class="line">  name: martin</span><br><span class="line">  <span class="selector-id">#apiGroup</span>: <span class="string">“”</span>  #会提示语法错误</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>上面的YAML文件中看到了subjects关键字，这里就是上面提到的用来尝试操作集群的对象，这里对应上面的 User帐号martin，使用kubectl创建上面的资源对象：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl create -f martin-rolebinding.yaml</span><br><span class="line">rolebinding<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">“martin-rolebinding”</span> created</span><br></pre></td></tr></table></figure>

<p>使用admin账号(martin账号无权限查看)查看role和rolebinding相关信息：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl <span class="built_in">get</span> rolebinding <span class="comment">–all-namespaces</span></span><br><span class="line">NAMESPACE     NAME                                             AGE</span><br><span class="line">kube-public   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   martin-rolebinding                               <span class="number">18</span>h</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-controller-manager   <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-scheduler            <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:cloud-provider                 <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:<span class="keyword">token</span>-cleaner                  <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   ui-admin-binding                                 <span class="number">11</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   ui-<span class="built_in">read</span>-binding                                  <span class="number">11</span>d</span><br><span class="line">➜  martin </span><br><span class="line">➜  martin kubectl <span class="built_in">get</span> role <span class="comment">–all-namespaces            </span></span><br><span class="line">NAMESPACE     NAME                                             AGE</span><br><span class="line">kube-public   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   extension-apiserver-authentication-reader        <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   martin-role                                      <span class="number">18</span>h</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-controller-manager   <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>::leader-locking-kube-scheduler            <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:bootstrap-signer               <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:cloud-provider                 <span class="number">19</span>d</span><br><span class="line">kube-<span class="keyword">system</span>   <span class="keyword">system</span>:controller:<span class="keyword">token</span>-cleaner                  <span class="number">19</span>d</span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<h5 id="第四步：测试"><a href="#第四步：测试" class="headerlink" title="第四步：测试"></a><a href="#第四步：测试" title="第四步：测试"></a>第四步：测试</h5><p>现在应该可以用上面的martin-context上下文来操作集群了：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl get pods                                          </span><br><span class="line">NAME                              READY     STATUS    RESTARTS   AGE</span><br><span class="line">nexus3<span class="number">-68</span>f55d9746-vfnf8           <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">5</span>d</span><br><span class="line">rbd-rest-api-registrykey-m262<span class="number">-1</span>   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">4</span>d</span><br><span class="line">➜  martin </span><br><span class="line">➜  martin kubectl get pods -n <span class="section">default</span></span><br><span class="line">NAME                              READY     STATUS    RESTARTS   AGE</span><br><span class="line">nexus3<span class="number">-68</span>f55d9746-vfnf8           <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">5</span>d</span><br><span class="line">rbd-rest-api-registrykey-m262<span class="number">-1</span>   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">4</span>d</span><br><span class="line">➜  martin </span><br><span class="line">➜  martin kubectl get pods –kubeconfig martin.kubeconfig</span><br><span class="line">NAME                                    READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns<span class="number">-77</span>c989547b-lcbfw                <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">1</span>          <span class="number">15</span>d</span><br><span class="line">coredns<span class="number">-77</span>c989547b-xq4dr                <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">1</span>          <span class="number">15</span>d</span><br><span class="line">heapster<span class="number">-77</span>b9c5bd7b-l5ms6               <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br><span class="line">kubernetes-dashboard<span class="number">-66</span>c9d98865-g8l6l   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br><span class="line">monitoring-grafana<span class="number">-7</span>c674cb7f6-nqvlw     <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br><span class="line">monitoring-influxdb<span class="number">-644</span>db5c5b6-llnp9    <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">11</span>d</span><br></pre></td></tr></table></figure>

<p>使用kubectl时并没有指定namespace，这是因为之前已经为该用户分配了权限，并且指定了kube-system命名空间写入到martin.kubeconfig文件中，如果使用default命名空间，在后面加上一个-n default，则会提示forbidden,如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  martin kubectl <span class="builtin-name">get</span> pods -n<span class="built_in"> default </span>–kubeconfig martin.kubeconfig </span><br><span class="line"><span class="builtin-name">Error</span> <span class="keyword">from</span><span class="built_in"> server </span>(Forbidden): pods is forbidden:<span class="built_in"> User </span><span class="string">“martin”</span> cannot list pods <span class="keyword">in</span> the namespace <span class="string">“default”</span></span><br><span class="line">➜  martin</span><br></pre></td></tr></table></figure>

<p>这是因为该用户并没有default这个命名空间的操作权限。</p>
<hr>
<h4 id="创建一个只能访问某个namespace的ServiceAccount"><a href="#创建一个只能访问某个namespace的ServiceAccount" class="headerlink" title="创建一个只能访问某个namespace的ServiceAccount"></a><a href="#创建一个只能访问某个namespace的ServiceAccount" title="创建一个只能访问某个namespace的ServiceAccount"></a>创建一个只能访问某个namespace的ServiceAccount</h4><p>上面创建了一个只能访问某个命名空间下面的普通用户，前面也提到过subjects,下面还有一种类型的主题资源：ServiceAccount。</p>
<h5 id="第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments"><a href="#第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments" class="headerlink" title="第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments"></a><a href="#第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments" title="第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments"></a>第一步：创建一个集群内部的用户只能操作kube-system这个命名空间下面的pods和deployments</h5><p>首先来创建一个ServiceAccount对象：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl create sa martin-sa -n kube-system</span><br><span class="line">serviceaccount <span class="string">“martin-sa”</span> created</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa </span><br><span class="line">NAME      SECRETS   AGE</span><br><span class="line">default   1         20d</span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa -n kube-system</span><br><span class="line">NAME                   SECRETS   AGE</span><br><span class="line">admin-user             1         11d</span><br><span class="line">coredns                1         15d</span><br><span class="line">default                1         20d</span><br><span class="line">heapster               1         11d</span><br><span class="line">kubernetes-dashboard   1         11d</span><br><span class="line">martin-sa              1         13s</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>当然也可以定义成YAML文件的形式来创建:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> ServiceAccount</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> martin-sa</span><br><span class="line"><span class="symbol">  namespace:</span> kube-system</span><br></pre></td></tr></table></figure>

<h5 id="第二步：创建一个Role对象：-martin-sa-role-yaml"><a href="#第二步：创建一个Role对象：-martin-sa-role-yaml" class="headerlink" title="第二步：创建一个Role对象：(martin-sa-role.yaml)"></a><a href="#第二步：创建一个Role对象：-martin-sa-role-yaml" title="第二步：创建一个Role对象：(martin-sa-role.yaml)"></a>第二步：创建一个Role对象：(martin-sa-role.yaml)</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount <span class="keyword">cat</span> martin-<span class="keyword">sa</span>-role.yaml </span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: Role</span><br><span class="line">metadat<span class="variable">a:</span></span><br><span class="line">  name: martin-<span class="keyword">sa</span>-role</span><br><span class="line">  namespace: kube-<span class="built_in">system</span></span><br><span class="line">rule<span class="variable">s:</span></span><br><span class="line">- apiGroup<span class="variable">s:</span> [<span class="string">“”</span>]</span><br><span class="line">  resource<span class="variable">s:</span> [<span class="string">“pods”</span>]</span><br><span class="line">  <span class="keyword">verb</span><span class="variable">s:</span> [<span class="string">“get”</span>, <span class="string">“list”</span>, <span class="string">“watch”</span>] # 也可以使用[<span class="string">‘*’</span>]</span><br><span class="line">- apiGroup<span class="variable">s:</span> [<span class="string">“apps”</span>]</span><br><span class="line">  resource<span class="variable">s:</span> [<span class="string">“deployments”</span>]</span><br><span class="line">  <span class="keyword">verb</span><span class="variable">s:</span> [<span class="string">“get”</span>, <span class="string">“list”</span>, <span class="string">“watch”</span>, <span class="string">“create”</span>, <span class="string">“update”</span>, <span class="string">“patch”</span>, <span class="string">“delete”</span>]</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>可以看到这里定义的角色没有创建、删除、更新Pod的权限，等会可以重点测试一下。</p>
<p>创建该Role对象：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl create -f martin-sa-role<span class="selector-class">.yaml</span> </span><br><span class="line">role<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">“martin-sa-role”</span> created</span><br></pre></td></tr></table></figure>

<h5 id="第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：-martin-sa-rolebinding-yaml"><a href="#第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：-martin-sa-rolebinding-yaml" class="headerlink" title="第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：(martin-sa-rolebinding.yaml)"></a><a href="#第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：-martin-sa-rolebinding-yaml" title="第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：(martin-sa-rolebinding.yaml)"></a>第三步，创建一个RoleBinding对象，将上面的martin-sa和角色martin-sa-role进行绑定：(martin-sa-rolebinding.yaml)</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span> <span class="string">cat</span> <span class="string">martin-sa-rolebinding.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-rolebinding</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-role</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>

<p>创建这个资源对象：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="built_in">get</span> rolebinding -n kube-<span class="built_in">system</span></span><br><span class="line">NAME                                             AGE</span><br><span class="line">kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">martin-rolebinding                               <span class="number">22</span>h</span><br><span class="line">➜  serviceaccount </span><br><span class="line"></span><br><span class="line">➜  serviceaccount kubectl create -<span class="keyword">f</span> martin-<span class="keyword">sa</span>-rolebinding.yaml </span><br><span class="line">rolebinding.rbac.authorization.k8s.io <span class="string">“martin-sa-rolebinding”</span> created</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl <span class="built_in">get</span> rolebinding               </span><br><span class="line">No resources found.</span><br><span class="line">➜  serviceaccount kubectl <span class="built_in">get</span> rolebinding -n kube-<span class="built_in">system</span></span><br><span class="line">NAME                                             AGE</span><br><span class="line">kubernetes-dashboard-minimal                     <span class="number">11</span>d</span><br><span class="line">martin-rolebinding                               <span class="number">23</span>h</span><br><span class="line">martin-<span class="keyword">sa</span>-rolebinding                            <span class="number">26</span>s</span><br><span class="line">可以看到martin-<span class="keyword">sa</span>-rolebinding已经添加</span><br></pre></td></tr></table></figure>

<h5 id="第四步，验证这个ServiceAccount"><a href="#第四步，验证这个ServiceAccount" class="headerlink" title="第四步，验证这个ServiceAccount"></a><a href="#第四步，验证这个ServiceAccount" title="第四步，验证这个ServiceAccount"></a>第四步，验证这个ServiceAccount</h5><p>一个ServiceAccount会生成一个Secret对象和它进行映射，这个Secret里面包含一个token：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>-n kube-system</span><br><span class="line">NAME                              <span class="built_in"> TYPE </span>                                 DATA      AGE</span><br><span class="line">admin-user-token-xszp7             kubernetes.io/service-account-token   3         11d</span><br><span class="line">coredns-token-9ppnq                kubernetes.io/service-account-token   3         15d</span><br><span class="line">default-token-fs7zj                kubernetes.io/service-account-token   3         20d</span><br><span class="line">heapster-token-gn8g5               kubernetes.io/service-account-token   3         11d</span><br><span class="line">kubernetes-dashboard-certs         Opaque                                0         11d</span><br><span class="line">kubernetes-dashboard-key-holder    Opaque                                2         15d</span><br><span class="line">kubernetes-dashboard-token-tg782   kubernetes.io/service-account-token   3         11d</span><br><span class="line">martin-sa-token-78s5j              kubernetes.io/service-account-token   3         41m  #新增</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl describe<span class="built_in"> secret </span>martin-sa-token-78s5j -n kube-system</span><br><span class="line">Name:         martin-sa-token-78s5j</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.<span class="attribute">name</span>=martin-sa</span><br><span class="line">              kubernetes.io/service-account.<span class="attribute">uid</span>=576ef41d-79e2-11e8-bede-5254004f2222</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1359 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      xxx</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>==注意：查看时需要-n指定kube-system命名空间！==</p>
<p>然后可以利用这个token去登录Dashboard，就可以在Dashboard中来验证功能是否符合预期：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>martin-sa-token-78s5j -o jsonpath=&#123;.data.token&#125; -n kube-system |base64 -d #会生成一串很长的base64后的字符串</span><br><span class="line">xxxxxxxxxxxxxxxx</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>使用这里的xxx token去Dashboard页面进行登录：<br>会出现如下提示信息：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">configmaps is forbidden:<span class="built_in"> User </span><span class="string">“system:serviceaccount:kube-system:martin-sa”</span> cannot list configmaps <span class="keyword">in</span> the namespace <span class="string">“default”</span></span><br><span class="line">close</span><br><span class="line">warning</span><br><span class="line">persistentvolumeclaims is forbidden:<span class="built_in"> User </span><span class="string">“system:serviceaccount:kube-system:martin-sa”</span> cannot list persistentvolumeclaims <span class="keyword">in</span> the namespace <span class="string">“default”</span></span><br></pre></td></tr></table></figure>

<p>这是因为登录进来后默认跳转到default命名空间，但是却没有改空间的权限，因此需要切换到kube-system命名空间下面:</p>
<p>原来url:<br><a href="https://xxx/#!/deployment?namespace=default" target="_blank" rel="noopener">https://xxx/#!/deployment?namespace=default</a></p>
<p>修改为新url:<br><a href="https://xxx/#!/deployment?namespace=kube-system" target="_blank" rel="noopener">https://xxx/#!/deployment?namespace=kube-system</a></p>
<p>可以看到能访问pod列表了，但是也会有一些其他额外的提示：events is forbidden: User “system:serviceaccount:kube-system:martin-sa” cannot list events in the namespace “kube-system”，这是因为当前登录用只被授权了访问pod和deployment的权限，同样的，访问下deployment看看可以了吗？</p>
<p>同样的，可以根据自己的需求来对访问用户的权限进行限制，可以自己通过Role定义更加细粒度的权限，也可以使用系统内置的一些权限……</p>
<hr>
<h4 id="创建一个可以访问所有-namespace-的ServiceAccount"><a href="#创建一个可以访问所有-namespace-的ServiceAccount" class="headerlink" title="创建一个可以访问所有 namespace 的ServiceAccount"></a><a href="#创建一个可以访问所有-namespace-的ServiceAccount" title="创建一个可以访问所有 namespace 的ServiceAccount"></a>创建一个可以访问所有 namespace 的ServiceAccount</h4><p>刚刚创建的martin-sa这个ServiceAccount和一个Role角色进行绑定的，如果现在创建一个新的ServiceAccount，需要他操作的权限作用于所有的namespace，这个时候就需要使用到ClusterRole 和 ClusterRoleBinding 这两种资源对象了。</p>
<h5 id="第一步，同样，首先新建一个ServiceAcount对象：-martin-sa2-yaml"><a href="#第一步，同样，首先新建一个ServiceAcount对象：-martin-sa2-yaml" class="headerlink" title="第一步，同样，首先新建一个ServiceAcount对象：(martin-sa2.yaml)"></a><a href="#第一步，同样，首先新建一个ServiceAcount对象：-martin-sa2-yaml" title="第一步，同样，首先新建一个ServiceAcount对象：(martin-sa2.yaml)"></a>第一步，同样，首先新建一个ServiceAcount对象：(martin-sa2.yaml)</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount cat martin-sa2.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: martin-sa2</span><br><span class="line">  namespace: kube-system</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl create -f martin-sa2.yaml </span><br><span class="line">serviceaccount <span class="string">“martin-sa2”</span> created</span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa   </span><br><span class="line">NAME      SECRETS   AGE</span><br><span class="line">default   1         20d</span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span> sa -n kube-system</span><br><span class="line">NAME                   SECRETS   AGE</span><br><span class="line">admin-user             1         12d</span><br><span class="line">coredns                1         15d</span><br><span class="line">default                1         20d</span><br><span class="line">heapster               1         12d</span><br><span class="line">kubernetes-dashboard   1         12d</span><br><span class="line">martin-sa              1         1h</span><br><span class="line">martin-sa2             1         12s</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<h5 id="第二步，创建一个ClusterRoleBinding-对象-martin-clusterolebinding-yaml"><a href="#第二步，创建一个ClusterRoleBinding-对象-martin-clusterolebinding-yaml" class="headerlink" title="第二步，创建一个ClusterRoleBinding 对象(martin-clusterolebinding.yaml):"></a><a href="#第二步，创建一个ClusterRoleBinding-对象-martin-clusterolebinding-yaml" title="第二步，创建一个ClusterRoleBinding 对象(martin-clusterolebinding.yaml):"></a>第二步，创建一个ClusterRoleBinding 对象(martin-clusterolebinding.yaml):</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span> <span class="string">cat</span> <span class="string">martin-clusterolebinding.yaml</span>   </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa2-clusterrolebinding</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa2</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span></span><br></pre></td></tr></table></figure>

<p>对比下之前的”martin-sa-rolebinding.yaml”</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span> <span class="string">cat</span> <span class="string">martin-sa-rolebinding.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-rolebinding</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">- kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">martin-sa-role</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">➜</span>  <span class="string">serviceaccount</span></span><br></pre></td></tr></table></figure>

<p>从上面可以看到没有为这个资源对象声明namespace，因为这是一个ClusterRoleBinding 资源对象，是作用于整个集群的，也没有单独新建一个ClusterRole对象，而是使用的 cluster-admin这个对象，这是Kubernetes集群内置的ClusterRole对象，可以使用kubectl get clusterrole 和kubectl get clusterrolebinding查看系统内置的一些集群角色和集群角色绑定，这里使用的 cluster-admin这个集群角色是拥有最高权限的集群角色，所以一般需要谨慎使用该集群角色。</p>
<p>创建上面集群角色绑定资源对象：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl create -f martin-clusterolebinding<span class="selector-class">.yaml</span> </span><br><span class="line">clusterrolebinding<span class="selector-class">.rbac</span><span class="selector-class">.authorization</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span> <span class="string">“martin-sa2-clusterrolebinding”</span> created</span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>通过ubectl get clusterrolebinding可以看到”martin-sa2-clusterrolebinding”已经加入其中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl get clusterrolebinding </span><br><span class="line">NAME                                                   AGE</span><br><span class="line">admin-user                                             <span class="number">12d</span></span><br><span class="line">cluster-admin                                          <span class="number">20d</span></span><br><span class="line">heapster                                               <span class="number">12d</span></span><br><span class="line">kubelet-bootstrap                                      <span class="number">19d</span></span><br><span class="line">martin-sa2-clusterrolebinding                          <span class="number">22s</span></span><br></pre></td></tr></table></figure>

<h5 id="第三步，使用-ServiceAccount对应的token去登录Dashboard验证："><a href="#第三步，使用-ServiceAccount对应的token去登录Dashboard验证：" class="headerlink" title="第三步，使用 ServiceAccount对应的token去登录Dashboard验证："></a><a href="#第三步，使用-ServiceAccount对应的token去登录Dashboard验证：" title="第三步，使用 ServiceAccount对应的token去登录Dashboard验证："></a>第三步，使用 ServiceAccount对应的token去登录Dashboard验证：</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>-n kube-system|grep martin-sa2-token-q7bhr</span><br><span class="line">martin-sa2-token-q7bhr             kubernetes.io/service-account-token   3         34m</span><br><span class="line">➜  serviceaccount </span><br><span class="line">➜  serviceaccount kubectl <span class="builtin-name">get</span><span class="built_in"> secret </span>martin-sa2-token-q7bhr -o jsonpath=&#123;.data.token&#125; -n kube-system |base64 -d</span><br><span class="line">xxxxxxx</span><br><span class="line"><span class="comment">#会生成一串很长的base64后的字符串</span></span><br><span class="line">➜  serviceaccount</span><br></pre></td></tr></table></figure>

<p>在最开始接触到RBAC认证的时候，可能不太熟悉，特别是不知道应该怎么去编写rules规则，可以去分析系统自带的clusterrole、clusterrolebinding这些资源对象的编写方法，利用 kubectl的get、describe、-o yaml这些操作，所以kubectl最基本的操作一定要掌握好。</p>
<p>RBAC只是Kubernetes中安全认证的一种方式，当然也是现在最重要的一种方式。</p>
<hr>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://chucz.club/2018/08/19/只在移动端网页内显示”Fork-me-on-Github”/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chucz">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="诗和田野">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/19/只在移动端网页内显示”Fork-me-on-Github”/" itemprop="url">只在移动端网页内显示”Fork me on Github”</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-19T09:48:41+08:00">
                2018-08-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="1-修改文件hexo博客根目录-themes-next-layout-layout-swig-找到如下代码块"><a href="#1-修改文件hexo博客根目录-themes-next-layout-layout-swig-找到如下代码块" class="headerlink" title="1.修改文件hexo博客根目录\themes\next\layout_layout.swig 找到如下代码块"></a><a href="#1-修改文件hexo博客根目录-themes-next-layout-layout-swig-找到如下代码块" title="1.修改文件hexo博客根目录\themes\next\layout_layout.swig 找到如下代码块"></a>1.修改文件hexo博客根目录\themes\next\layout_layout.swig 找到如下代码块</h5><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">class</span>=<span class="string">“</span></span></span><span class="template-variable">&#123;&#123; html_class | lower &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">“</span> <span class="attr">lang</span>=<span class="string">“</span></span></span><span class="template-variable">&#123;&#123; config.language &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">“</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> ‘_partials/head.swig’ %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h5 id="2-添加代码，结果如下："><a href="#2-添加代码，结果如下：" class="headerlink" title="2.添加代码，结果如下："></a><a href="#2-添加代码，结果如下：" title="2.添加代码，结果如下："></a>2.添加代码，结果如下：</h5><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">class</span>=<span class="string">“</span></span></span><span class="template-variable">&#123;&#123; html_class | lower &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">“</span> <span class="attr">lang</span>=<span class="string">“</span></span></span><span class="template-variable">&#123;&#123; config.language &#125;&#125;</span><span class="xml"><span class="tag"><span class="string">“</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> ‘_partials/head.swig’ %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><span class="template-tag">&#123;% <span class="name"><span class="name">block</span></span> title %&#125;</span><span class="xml"></span><span class="template-tag">&#123;% <span class="name"><span class="name">endblock</span></span> %&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">  </span><span class="template-tag">&#123;% <span class="name"><span class="name">include</span></span> ‘_third-party/analytics/index.swig’ %&#125;</span><span class="xml"></span></span><br><span class="line"><span class="xml">  </span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span></span><br><span class="line"><span class="xml">  .forkMeOnGithub&#123;</span></span><br><span class="line"><span class="xml">  display: none;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">  @media (min-width: 768px) &#123;</span></span><br><span class="line"><span class="xml">  .forkMeOnGithub&#123;</span></span><br><span class="line"><span class="xml">   display: inline;</span></span><br><span class="line"><span class="xml">   &#125;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h5 id="3-最后在之前引用代码块上套上div加上class就行了，代码如下"><a href="#3-最后在之前引用代码块上套上div加上class就行了，代码如下" class="headerlink" title="3.最后在之前引用代码块上套上div加上class就行了，代码如下"></a><a href="#3-最后在之前引用代码块上套上div加上class就行了，代码如下" title="3.最后在之前引用代码块上套上div加上class就行了，代码如下"></a>3.最后在之前引用代码块上套上div加上class就行了，代码如下</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div <span class="attribute">class</span>=<span class="string">“forkMeOnGithub”</span>&gt;</span><br><span class="line">&lt;a <span class="attribute">href</span>=<span class="string">“<a href="https://github.com/hannius&quot;" target="_blank" rel="noopener">https://github.com/hannius&quot;</a></span>&gt;&lt;img <span class="attribute">style</span>=<span class="string">“position……..&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">chucz</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/归档/">
              
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/livecityccz" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:livecityccz@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/livecityccz" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/livecityccz" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/livecityccz" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i>FB Page</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://youtube.com/livecityccz" target="_blank" title="YouTube">
                      
                        <i class="fa fa-fw fa-youtube"></i>YouTube</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chucz</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
